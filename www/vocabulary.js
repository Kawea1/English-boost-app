// vocabulary.js - æ ¸å¿ƒè¯æ±‡æ¨¡å—ï¼ˆå¸¦ä¸­æ–‡é‡Šä¹‰ï¼‰
window.vocabularyData = [
    // GREæ ¸å¿ƒè¯æ±‡ (50è¯)
    { word: 'aberrant', phonetic: '/É™ËˆberÉ™nt/', meaningEn: 'departing from the accepted standard', meaningCn: 'å¼‚å¸¸çš„ï¼Œåç¦»æ­£é“çš„', example: 'His aberrant behavior worried his parents.' },
    { word: 'abstruse', phonetic: '/Ã¦bËˆstruËs/', meaningEn: 'difficult to understand', meaningCn: 'æ·±å¥¥çš„ï¼Œéš¾æ‡‚çš„', example: 'The professor made abstruse concepts accessible.' },
    { word: 'acerbic', phonetic: '/É™ËˆsÉœËrbÉªk/', meaningEn: 'sharp and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè¾›è¾£çš„', example: 'Her acerbic wit made her famous.' },
    { word: 'acumen', phonetic: '/É™ËˆkjuËmÉ™n/', meaningEn: 'keen insight', meaningCn: 'æ•é”ï¼Œèªæ˜', example: 'His business acumen led to success.' },
    { word: 'adamant', phonetic: '/ËˆÃ¦dÉ™mÉ™nt/', meaningEn: 'refusing to change', meaningCn: 'åšå®šä¸ç§»çš„', example: 'She was adamant about her decision.' },
    { word: 'admonish', phonetic: '/É™dËˆmÉ‘ËnÉªÊƒ/', meaningEn: 'warn or reprimand firmly', meaningCn: 'å‘Šè¯«ï¼Œè­¦å‘Š', example: 'The teacher admonished the students.' },
    { word: 'aesthetic', phonetic: '/esËˆÎ¸etÉªk/', meaningEn: 'relating to beauty', meaningCn: 'ç¾å­¦çš„ï¼Œå®¡ç¾çš„', example: 'The building has great aesthetic appeal.' },
    { word: 'affable', phonetic: '/ËˆÃ¦fÉ™bl/', meaningEn: 'friendly and easy to talk to', meaningCn: 'å’Œè”¼å¯äº²çš„', example: 'The affable host welcomed everyone.' },
    { word: 'alacrity', phonetic: '/É™ËˆlÃ¦krÉ™ti/', meaningEn: 'brisk eagerness', meaningCn: 'æ•æ·ï¼Œæ¬£ç„¶', example: 'She accepted the offer with alacrity.' },
    { word: 'alleviate', phonetic: '/É™ËˆliËvieÉªt/', meaningEn: 'make less severe', meaningCn: 'å‡è½»ï¼Œç¼“è§£', example: 'The medicine helped alleviate the pain.' },
    { word: 'amalgamate', phonetic: '/É™ËˆmÃ¦lÉ¡É™meÉªt/', meaningEn: 'combine or unite', meaningCn: 'åˆå¹¶ï¼Œæ··åˆ', example: 'The two companies amalgamated.' },
    { word: 'ambiguous', phonetic: '/Ã¦mËˆbÉªÉ¡juÉ™s/', meaningEn: 'unclear in meaning', meaningCn: 'æ¨¡ç³Šçš„ï¼Œæ­§ä¹‰çš„', example: 'The statement was deliberately ambiguous.' },
    { word: 'ameliorate', phonetic: '/É™ËˆmiËliÉ™reÉªt/', meaningEn: 'make better', meaningCn: 'æ”¹å–„ï¼Œæ”¹è¿›', example: 'Steps were taken to ameliorate conditions.' },
    { word: 'amenable', phonetic: '/É™ËˆmiËnÉ™bl/', meaningEn: 'willing to agree', meaningCn: 'é¡ºä»çš„ï¼Œæ„¿æ„æ¥å—çš„', example: 'He was amenable to suggestions.' },
    { word: 'anachronistic', phonetic: '/É™ËŒnÃ¦krÉ™ËˆnÉªstÉªk/', meaningEn: 'belonging to a different time', meaningCn: 'æ—¶ä»£é”™è¯¯çš„', example: 'The customs seemed anachronistic.' },
    { word: 'analogous', phonetic: '/É™ËˆnÃ¦lÉ™É¡É™s/', meaningEn: 'comparable in certain respects', meaningCn: 'ç±»ä¼¼çš„ï¼Œç›¸ä¼¼çš„', example: 'The situation is analogous to ours.' },
    { word: 'anomaly', phonetic: '/É™ËˆnÉ‘ËmÉ™li/', meaningEn: 'something unusual', meaningCn: 'å¼‚å¸¸ï¼Œåå¸¸ç°è±¡', example: 'The results revealed an anomaly.' },
    { word: 'antipathy', phonetic: '/Ã¦nËˆtÉªpÉ™Î¸i/', meaningEn: 'strong dislike', meaningCn: 'åæ„Ÿï¼ŒåŒæ¶', example: 'She felt antipathy toward him.' },
    { word: 'apathy', phonetic: '/ËˆÃ¦pÉ™Î¸i/', meaningEn: 'lack of interest', meaningCn: 'å†·æ¼ ï¼Œæ— åŠ¨äºè¡·', example: 'Voter apathy was widespread.' },
    { word: 'appease', phonetic: '/É™ËˆpiËz/', meaningEn: 'pacify by giving in', meaningCn: 'å¹³æ¯ï¼Œå®‰æŠš', example: 'They tried to appease the angry crowd.' },
    { word: 'arbitrary', phonetic: '/ËˆÉ‘ËrbÉªtreri/', meaningEn: 'based on random choice', meaningCn: 'ä»»æ„çš„ï¼Œæ­¦æ–­çš„', example: 'The decision seemed arbitrary.' },
    { word: 'archaic', phonetic: '/É‘ËrËˆkeÉªÉªk/', meaningEn: 'very old or outdated', meaningCn: 'å¤è€çš„ï¼Œè¿‡æ—¶çš„', example: 'The law is archaic and needs reform.' },
    { word: 'arduous', phonetic: '/ËˆÉ‘ËrdÊ’uÉ™s/', meaningEn: 'difficult and tiring', meaningCn: 'è‰°è‹¦çš„ï¼Œè´¹åŠ›çš„', example: 'The climb was arduous but rewarding.' },
    { word: 'articulate', phonetic: '/É‘ËrËˆtÉªkjÉ™lÉ™t/', meaningEn: 'express clearly', meaningCn: 'æ¸…æ¥šè¡¨è¾¾çš„ï¼Œå–„äºè¡¨è¾¾çš„', example: 'She is an articulate speaker.' },
    { word: 'ascetic', phonetic: '/É™ËˆsetÉªk/', meaningEn: 'practicing self-denial', meaningCn: 'è‹¦è¡Œçš„ï¼Œç¦æ¬²çš„', example: 'He lived an ascetic life.' },
    { word: 'assiduous', phonetic: '/É™ËˆsÉªdÊ’uÉ™s/', meaningEn: 'showing great care', meaningCn: 'å‹¤å‹‰çš„ï¼Œåˆ»è‹¦çš„', example: 'She was assiduous in her studies.' },
    { word: 'astute', phonetic: '/É™ËˆstuËt/', meaningEn: 'shrewd and perceptive', meaningCn: 'ç²¾æ˜çš„ï¼Œæ•é”çš„', example: 'An astute observer noticed the change.' },
    { word: 'audacious', phonetic: '/É”ËËˆdeÉªÊƒÉ™s/', meaningEn: 'bold and daring', meaningCn: 'å¤§èƒ†çš„ï¼Œæ— ç•çš„', example: 'It was an audacious plan.' },
    { word: 'austere', phonetic: '/É”ËËˆstÉªr/', meaningEn: 'severe or strict', meaningCn: 'ç®€æœ´çš„ï¼Œä¸¥å³»çš„', example: 'The room had an austere appearance.' },
    { word: 'avarice', phonetic: '/ËˆÃ¦vÉ™rÉªs/', meaningEn: 'extreme greed', meaningCn: 'è´ªå©ªï¼Œè´ªè´¢', example: 'His avarice knew no bounds.' },
    { word: 'banal', phonetic: '/bÉ™ËˆnÉ‘Ël/', meaningEn: 'lacking originality', meaningCn: 'å¹³åº¸çš„ï¼Œé™ˆè…çš„', example: 'The movie had a banal plot.' },
    { word: 'belligerent', phonetic: '/bÉ™ËˆlÉªdÊ’É™rÉ™nt/', meaningEn: 'hostile and aggressive', meaningCn: 'å¥½æˆ˜çš„ï¼ŒæŒ‘è¡…çš„', example: 'His belligerent attitude caused problems.' },
    { word: 'benevolent', phonetic: '/bÉ™ËˆnevÉ™lÉ™nt/', meaningEn: 'well-meaning and kind', meaningCn: 'ä»æ…ˆçš„ï¼Œå–„æ„çš„', example: 'A benevolent donor funded the project.' },
    { word: 'bolster', phonetic: '/ËˆboÊŠlstÉ™r/', meaningEn: 'support or strengthen', meaningCn: 'æ”¯æŒï¼ŒåŠ å¼º', example: 'Evidence bolstered his argument.' },
    { word: 'burgeon', phonetic: '/ËˆbÉœËrdÊ’É™n/', meaningEn: 'grow rapidly', meaningCn: 'è¿…é€Ÿå‘å±•ï¼ŒèŒèŠ½', example: 'The industry began to burgeon.' },
    { word: 'cacophony', phonetic: '/kÉ™ËˆkÉ‘ËfÉ™ni/', meaningEn: 'harsh mixture of sounds', meaningCn: 'åˆºè€³çš„å£°éŸ³ï¼Œä¸å’Œè°', example: 'A cacophony of car horns filled the air.' },
    { word: 'candid', phonetic: '/ËˆkÃ¦ndÉªd/', meaningEn: 'truthful and straightforward', meaningCn: 'å¦ç‡çš„ï¼Œç›´è¨€ä¸è®³çš„', example: 'She gave a candid assessment.' },
    { word: 'capricious', phonetic: '/kÉ™ËˆprÉªÊƒÉ™s/', meaningEn: 'unpredictable', meaningCn: 'åå¤æ— å¸¸çš„ï¼Œä»»æ€§çš„', example: 'The weather was capricious.' },
    { word: 'castigate', phonetic: '/ËˆkÃ¦stÉªÉ¡eÉªt/', meaningEn: 'criticize severely', meaningCn: 'ä¸¥å‰æ‰¹è¯„ï¼Œæƒ©ç½š', example: 'Critics castigated the decision.' },
    { word: 'catalyst', phonetic: '/ËˆkÃ¦tÉ™lÉªst/', meaningEn: 'agent that causes change', meaningCn: 'å‚¬åŒ–å‰‚ï¼Œä¿ƒè¿›å› ç´ ', example: 'The event was a catalyst for reform.' },
    { word: 'caustic', phonetic: '/ËˆkÉ”ËstÉªk/', meaningEn: 'sarcastic and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè…èš€æ€§çš„', example: 'His caustic remarks hurt her.' },
    { word: 'chicanery', phonetic: '/ÊƒÉªËˆkeÉªnÉ™ri/', meaningEn: 'trickery and deception', meaningCn: 'æ¬ºéª—ï¼Œè¯¡è®¡', example: 'Political chicanery undermined trust.' },
    { word: 'circumspect', phonetic: '/ËˆsÉœËrkÉ™mspekt/', meaningEn: 'cautious and prudent', meaningCn: 'è°¨æ…çš„ï¼Œå°å¿ƒçš„', example: 'Be circumspect in your decisions.' },
    { word: 'clandestine', phonetic: '/klÃ¦nËˆdestÉªn/', meaningEn: 'kept secret', meaningCn: 'ç§˜å¯†çš„ï¼Œæš—ä¸­çš„', example: 'They held clandestine meetings.' },
    { word: 'coalesce', phonetic: '/ËŒkoÊŠÉ™Ëˆles/', meaningEn: 'come together', meaningCn: 'è”åˆï¼Œåˆå¹¶', example: 'Different groups coalesced into one.' },
    { word: 'cogent', phonetic: '/ËˆkoÊŠdÊ’É™nt/', meaningEn: 'clear and convincing', meaningCn: 'æœ‰è¯´æœåŠ›çš„ï¼Œä»¤äººä¿¡æœçš„', example: 'She presented a cogent argument.' },
    { word: 'commensurate', phonetic: '/kÉ™ËˆmenÊƒÉ™rÉ™t/', meaningEn: 'corresponding in size', meaningCn: 'ç›¸ç§°çš„ï¼Œç›¸å½“çš„', example: 'Salary commensurate with experience.' },
    { word: 'compelling', phonetic: '/kÉ™mËˆpelÉªÅ‹/', meaningEn: 'powerfully convincing', meaningCn: 'ä»¤äººä¿¡æœçš„ï¼Œå¼•äººæ³¨ç›®çš„', example: 'The evidence was compelling.' },
    { word: 'complacent', phonetic: '/kÉ™mËˆpleÉªsnt/', meaningEn: 'self-satisfied', meaningCn: 'è‡ªæ»¡çš„ï¼Œå¾—æ„çš„', example: 'Success made him complacent.' },
    { word: 'comprehensive', phonetic: '/ËŒkÉ‘ËmprÉªËˆhensÉªv/', meaningEn: 'complete and thorough', meaningCn: 'å…¨é¢çš„ï¼Œç»¼åˆçš„', example: 'A comprehensive study was conducted.' }
];

// å½“å‰å­¦ä¹ çŠ¶æ€
var currentWordIndex = 0;
var wordsPerSession = parseInt(localStorage.getItem('wordsPerSession') || '20'); // æ¯æ¬¡å­¦ä¹ å•è¯æ•°
var requiredLearningTimes = parseInt(localStorage.getItem('requiredLearningTimes') || '3'); // æ¯ä¸ªå•è¯éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
var sessionWords = []; // æœ¬æ¬¡å­¦ä¹ çš„å•è¯ï¼ˆåŸå§‹åˆ—è¡¨ï¼‰
var learningQueue = []; // å­¦ä¹ é˜Ÿåˆ—ï¼ˆåŒ…å«é‡å¤å‡ºç°çš„å•è¯ï¼‰
var currentQueueIndex = 0; // å½“å‰é˜Ÿåˆ—ç´¢å¼•
var learnedWords = [];
var wordRatings = {};
var wordLearningProgress = {}; // è®°å½•æ¯ä¸ªå•è¯çš„å­¦ä¹ è¿›åº¦
var sessionWordProgress = {}; // æœ¬è½®å­¦ä¹ ä¸­æ¯ä¸ªå•è¯çš„è¿›åº¦ï¼ˆç”¨äºé—´éš”é‡å¤ï¼‰

// ==================== V1: å•è¯æŒæ¡åº¦è¿½è¸ªç³»ç»Ÿ ====================
// å¤šç»´åº¦è¿½è¸ªæ¯ä¸ªå•è¯çš„æŒæ¡ç¨‹åº¦

var wordMasteryData = {};  // å•è¯æŒæ¡åº¦æ•°æ®
try {
    wordMasteryData = JSON.parse(localStorage.getItem('wordMasteryData') || '{}');
} catch(e) {
    wordMasteryData = {};
}

// æŒæ¡åº¦ç­‰çº§å®šä¹‰
var MASTERY_LEVELS = {
    0: { name: 'æœªå­¦ä¹ ', icon: 'â—‹', color: '#9ca3af', bgColor: '#f3f4f6' },
    1: { name: 'åˆè¯†', icon: 'â—”', color: '#f59e0b', bgColor: '#fef3c7' },
    2: { name: 'ç†Ÿæ‚‰', icon: 'â—‘', color: '#3b82f6', bgColor: '#dbeafe' },
    3: { name: 'æŒæ¡', icon: 'â—•', color: '#10b981', bgColor: '#d1fae5' },
    4: { name: 'ç²¾é€š', icon: 'â—', color: '#8b5cf6', bgColor: '#ede9fe' },
    5: { name: 'å®Œç¾', icon: 'â˜…', color: '#ec4899', bgColor: '#fce7f3' }
};

// åˆå§‹åŒ–å•è¯æŒæ¡åº¦
function initWordMastery(word) {
    if (!wordMasteryData[word]) {
        wordMasteryData[word] = {
            level: 0,                    // æŒæ¡ç­‰çº§ 0-5
            totalViews: 0,               // æ€»æŸ¥çœ‹æ¬¡æ•°
            correctCount: 0,             // æ­£ç¡®æ¬¡æ•°
            wrongCount: 0,               // é”™è¯¯æ¬¡æ•°
            lastStudied: null,           // æœ€åå­¦ä¹ æ—¶é—´
            firstStudied: null,          // é¦–æ¬¡å­¦ä¹ æ—¶é—´
            studyHistory: [],            // å­¦ä¹ å†å² [{date, result, duration}]
            pronunciationScore: 0,       // å‘éŸ³å¾—åˆ†
            spellingScore: 0,            // æ‹¼å†™å¾—åˆ†
            meaningScore: 0,             // é‡Šä¹‰è®°å¿†å¾—åˆ†
            retentionRate: 0,            // è®°å¿†ä¿æŒç‡
            difficulty: 'medium',        // ä¸ªäººéš¾åº¦è¯„ä¼°
            notes: ''                    // ç”¨æˆ·ç¬”è®°
        };
    }
    return wordMasteryData[word];
}

// æ›´æ–°å•è¯æŒæ¡åº¦
function updateWordMastery(word, result, options) {
    options = options || {};
    var mastery = initWordMastery(word);
    var now = Date.now();
    
    // æ›´æ–°åŸºç¡€ç»Ÿè®¡
    mastery.totalViews++;
    mastery.lastStudied = now;
    if (!mastery.firstStudied) {
        mastery.firstStudied = now;
    }
    
    // è®°å½•å­¦ä¹ å†å²
    mastery.studyHistory.push({
        date: now,
        result: result,  // 'correct', 'wrong', 'partial', 'skip'
        duration: options.duration || 0,
        type: options.type || 'review'  // 'learn', 'review', 'quiz', 'pronunciation'
    });
    
    // ä¿ç•™æœ€è¿‘50æ¡å†å²
    if (mastery.studyHistory.length > 50) {
        mastery.studyHistory = mastery.studyHistory.slice(-50);
    }
    
    // æ›´æ–°æ­£ç¡®/é”™è¯¯æ¬¡æ•°
    if (result === 'correct') {
        mastery.correctCount++;
    } else if (result === 'wrong') {
        mastery.wrongCount++;
    }
    
    // æ›´æ–°ç»´åº¦å¾—åˆ†
    if (options.pronunciationScore !== undefined) {
        mastery.pronunciationScore = Math.round(
            mastery.pronunciationScore * 0.7 + options.pronunciationScore * 0.3
        );
    }
    if (options.spellingScore !== undefined) {
        mastery.spellingScore = Math.round(
            mastery.spellingScore * 0.7 + options.spellingScore * 0.3
        );
    }
    if (options.meaningScore !== undefined) {
        mastery.meaningScore = Math.round(
            mastery.meaningScore * 0.7 + options.meaningScore * 0.3
        );
    }
    
    // è®¡ç®—è®°å¿†ä¿æŒç‡
    mastery.retentionRate = calculateRetentionRate(mastery);
    
    // è®¡ç®—æŒæ¡ç­‰çº§
    mastery.level = calculateMasteryLevel(mastery);
    
    // è¯„ä¼°ä¸ªäººéš¾åº¦
    mastery.difficulty = assessPersonalDifficulty(mastery);
    
    // ä¿å­˜æ•°æ®
    saveWordMastery();
    
    return mastery;
}

// è®¡ç®—è®°å¿†ä¿æŒç‡
function calculateRetentionRate(mastery) {
    if (mastery.correctCount + mastery.wrongCount === 0) return 0;
    
    // åŸºäºæ­£ç¡®ç‡è®¡ç®—ï¼ŒåŠ æƒæœ€è¿‘çš„è¡¨ç°
    var recentHistory = mastery.studyHistory.slice(-10);
    var recentCorrect = recentHistory.filter(function(h) { 
        return h.result === 'correct'; 
    }).length;
    
    var overallRate = mastery.correctCount / (mastery.correctCount + mastery.wrongCount);
    var recentRate = recentHistory.length > 0 ? recentCorrect / recentHistory.length : 0;
    
    // 70%æƒé‡ç»™æœ€è¿‘è¡¨ç°ï¼Œ30%ç»™æ€»ä½“è¡¨ç°
    return Math.round((recentRate * 0.7 + overallRate * 0.3) * 100);
}

// è®¡ç®—æŒæ¡ç­‰çº§
function calculateMasteryLevel(mastery) {
    var score = 0;
    
    // å› ç´ 1: å­¦ä¹ æ¬¡æ•° (æœ€é«˜20åˆ†)
    score += Math.min(mastery.totalViews * 2, 20);
    
    // å› ç´ 2: è®°å¿†ä¿æŒç‡ (æœ€é«˜30åˆ†)
    score += mastery.retentionRate * 0.3;
    
    // å› ç´ 3: å‘éŸ³å¾—åˆ† (æœ€é«˜15åˆ†)
    score += mastery.pronunciationScore * 0.15;
    
    // å› ç´ 4: æ‹¼å†™å¾—åˆ† (æœ€é«˜15åˆ†)
    score += mastery.spellingScore * 0.15;
    
    // å› ç´ 5: é‡Šä¹‰è®°å¿† (æœ€é«˜20åˆ†)
    score += mastery.meaningScore * 0.2;
    
    // è½¬æ¢ä¸ºç­‰çº§
    if (score >= 90) return 5;  // å®Œç¾
    if (score >= 75) return 4;  // ç²¾é€š
    if (score >= 55) return 3;  // æŒæ¡
    if (score >= 35) return 2;  // ç†Ÿæ‚‰
    if (score >= 15) return 1;  // åˆè¯†
    return 0;  // æœªå­¦ä¹ 
}

// è¯„ä¼°ä¸ªäººéš¾åº¦
function assessPersonalDifficulty(mastery) {
    var errorRate = mastery.wrongCount / Math.max(1, mastery.totalViews);
    var avgDuration = 0;
    
    if (mastery.studyHistory.length > 0) {
        var totalDuration = mastery.studyHistory.reduce(function(sum, h) {
            return sum + (h.duration || 0);
        }, 0);
        avgDuration = totalDuration / mastery.studyHistory.length;
    }
    
    // é”™è¯¯ç‡é«˜æˆ–å­¦ä¹ æ—¶é—´é•¿è¡¨ç¤ºéš¾åº¦å¤§
    if (errorRate > 0.5 || avgDuration > 10000) return 'hard';
    if (errorRate > 0.2 || avgDuration > 5000) return 'medium';
    return 'easy';
}

// ä¿å­˜æŒæ¡åº¦æ•°æ®
function saveWordMastery() {
    try {
        localStorage.setItem('wordMasteryData', JSON.stringify(wordMasteryData));
    } catch(e) {
        console.warn('ä¿å­˜æŒæ¡åº¦æ•°æ®å¤±è´¥:', e);
    }
}

// è·å–å•è¯æŒæ¡åº¦ä¿¡æ¯
function getWordMastery(word) {
    return wordMasteryData[word] || initWordMastery(word);
}

// è·å–æŒæ¡åº¦ç­‰çº§ä¿¡æ¯
function getMasteryLevelInfo(level) {
    return MASTERY_LEVELS[level] || MASTERY_LEVELS[0];
}

// ç”ŸæˆæŒæ¡åº¦æ˜¾ç¤ºHTML
function renderMasteryBadge(word, options) {
    options = options || {};
    var mastery = getWordMastery(word);
    var levelInfo = getMasteryLevelInfo(mastery.level);
    var size = options.size || 'normal';  // 'mini', 'normal', 'large'
    
    var sizeClasses = {
        mini: 'mastery-badge-mini',
        normal: 'mastery-badge-normal',
        large: 'mastery-badge-large'
    };
    
    var html = '<div class="mastery-badge ' + sizeClasses[size] + '" ';
    html += 'style="background:' + levelInfo.bgColor + ';color:' + levelInfo.color + ';" ';
    html += 'data-word="' + word + '" title="' + levelInfo.name + ' - ä¿æŒç‡' + mastery.retentionRate + '%">';
    html += '<span class="mastery-icon">' + levelInfo.icon + '</span>';
    
    if (size !== 'mini') {
        html += '<span class="mastery-text">' + levelInfo.name + '</span>';
    }
    
    if (size === 'large') {
        html += '<span class="mastery-rate">' + mastery.retentionRate + '%</span>';
    }
    
    html += '</div>';
    
    return html;
}

// ç”Ÿæˆè¯¦ç»†æŒæ¡åº¦å¡ç‰‡
function renderMasteryCard(word) {
    var mastery = getWordMastery(word);
    var levelInfo = getMasteryLevelInfo(mastery.level);
    
    var html = '<div class="mastery-card">';
    
    // å¤´éƒ¨ï¼šç­‰çº§å’Œä¿æŒç‡
    html += '<div class="mastery-card-header" style="background:' + levelInfo.bgColor + '">';
    html += '<div class="mastery-level-display">';
    html += '<span class="mastery-level-icon" style="color:' + levelInfo.color + '">' + levelInfo.icon + '</span>';
    html += '<span class="mastery-level-name">' + levelInfo.name + '</span>';
    html += '</div>';
    html += '<div class="mastery-retention">';
    html += '<span class="retention-value">' + mastery.retentionRate + '%</span>';
    html += '<span class="retention-label">è®°å¿†ä¿æŒ</span>';
    html += '</div>';
    html += '</div>';
    
    // ä¸‰ç»´åº¦è¿›åº¦æ¡
    html += '<div class="mastery-dimensions">';
    html += renderDimensionBar('ğŸ¤ å‘éŸ³', mastery.pronunciationScore);
    html += renderDimensionBar('âœï¸ æ‹¼å†™', mastery.spellingScore);
    html += renderDimensionBar('ğŸ“– é‡Šä¹‰', mastery.meaningScore);
    html += '</div>';
    
    // ç»Ÿè®¡ä¿¡æ¯
    html += '<div class="mastery-stats">';
    html += '<div class="stat-item"><span class="stat-value">' + mastery.totalViews + '</span><span class="stat-label">å­¦ä¹ æ¬¡æ•°</span></div>';
    html += '<div class="stat-item"><span class="stat-value">' + mastery.correctCount + '</span><span class="stat-label">æ­£ç¡®</span></div>';
    html += '<div class="stat-item"><span class="stat-value">' + mastery.wrongCount + '</span><span class="stat-label">é”™è¯¯</span></div>';
    
    var difficultyLabels = { easy: 'ç®€å•', medium: 'é€‚ä¸­', hard: 'å›°éš¾' };
    var difficultyColors = { easy: '#10b981', medium: '#f59e0b', hard: '#ef4444' };
    html += '<div class="stat-item"><span class="stat-value" style="color:' + difficultyColors[mastery.difficulty] + '">' + difficultyLabels[mastery.difficulty] + '</span><span class="stat-label">éš¾åº¦</span></div>';
    html += '</div>';
    
    // å­¦ä¹ æ—¶é—´çº¿
    if (mastery.firstStudied) {
        html += '<div class="mastery-timeline">';
        html += '<span class="timeline-item">é¦–æ¬¡: ' + formatDate(mastery.firstStudied) + '</span>';
        if (mastery.lastStudied) {
            html += '<span class="timeline-item">æœ€è¿‘: ' + formatTimeAgo(mastery.lastStudied) + '</span>';
        }
        html += '</div>';
    }
    
    html += '</div>';
    
    return html;
}

// æ¸²æŸ“ç»´åº¦è¿›åº¦æ¡
function renderDimensionBar(label, score) {
    var color = score >= 80 ? '#10b981' : (score >= 50 ? '#3b82f6' : (score >= 30 ? '#f59e0b' : '#ef4444'));
    
    var html = '<div class="dimension-bar-item">';
    html += '<span class="dimension-label">' + label + '</span>';
    html += '<div class="dimension-bar-track">';
    html += '<div class="dimension-bar-fill" style="width:' + score + '%;background:' + color + '"></div>';
    html += '</div>';
    html += '<span class="dimension-value">' + score + '</span>';
    html += '</div>';
    
    return html;
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(timestamp) {
    var date = new Date(timestamp);
    return (date.getMonth() + 1) + '/' + date.getDate();
}

// æ ¼å¼åŒ–æ—¶é—´å·®
function formatTimeAgo(timestamp) {
    var now = Date.now();
    var diff = now - timestamp;
    
    var minutes = Math.floor(diff / 60000);
    var hours = Math.floor(diff / 3600000);
    var days = Math.floor(diff / 86400000);
    
    if (days > 0) return days + 'å¤©å‰';
    if (hours > 0) return hours + 'å°æ—¶å‰';
    if (minutes > 0) return minutes + 'åˆ†é’Ÿå‰';
    return 'åˆšåˆš';
}

// è·å–æŒæ¡åº¦ç»Ÿè®¡
function getMasteryStats() {
    var stats = {
        total: window.vocabularyData ? window.vocabularyData.length : 0,
        byLevel: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        avgRetention: 0,
        hardWords: [],
        masteredWords: [],
        needReview: []
    };
    
    var totalRetention = 0;
    var retentionCount = 0;
    
    Object.keys(wordMasteryData).forEach(function(word) {
        var m = wordMasteryData[word];
        stats.byLevel[m.level]++;
        
        if (m.retentionRate > 0) {
            totalRetention += m.retentionRate;
            retentionCount++;
        }
        
        if (m.difficulty === 'hard') {
            stats.hardWords.push(word);
        }
        
        if (m.level >= 4) {
            stats.masteredWords.push(word);
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤ä¹ ï¼ˆè¶…è¿‡3å¤©æœªå­¦ä¹ ä¸”ä¿æŒç‡ä½äº80%ï¼‰
        if (m.lastStudied && (Date.now() - m.lastStudied > 3 * 86400000) && m.retentionRate < 80) {
            stats.needReview.push({ word: word, urgency: 100 - m.retentionRate });
        }
    });
    
    stats.avgRetention = retentionCount > 0 ? Math.round(totalRetention / retentionCount) : 0;
    stats.needReview.sort(function(a, b) { return b.urgency - a.urgency; });
    
    return stats;
}

// æ·»åŠ æŒæ¡åº¦è¿½è¸ªæ ·å¼
function addMasteryTrackingStyles() {
    if (document.getElementById('masteryTrackingStyles')) return;
    
    var style = document.createElement('style');
    style.id = 'masteryTrackingStyles';
    style.textContent = `
        /* V1: æŒæ¡åº¦å¾½ç« æ ·å¼ */
        .mastery-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .mastery-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .mastery-badge-mini {
            padding: 2px 6px;
            font-size: 12px;
        }
        
        .mastery-badge-normal {
            padding: 4px 10px;
            font-size: 13px;
        }
        
        .mastery-badge-large {
            padding: 6px 14px;
            font-size: 14px;
        }
        
        .mastery-icon {
            font-size: 1.1em;
        }
        
        .mastery-rate {
            margin-left: 4px;
            opacity: 0.8;
        }
        
        /* æŒæ¡åº¦å¡ç‰‡ */
        .mastery-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .mastery-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
        }
        
        .mastery-level-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mastery-level-icon {
            font-size: 28px;
        }
        
        .mastery-level-name {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .mastery-retention {
            text-align: right;
        }
        
        .retention-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .retention-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* ç»´åº¦è¿›åº¦æ¡ */
        .mastery-dimensions {
            padding: 16px;
        }
        
        .dimension-bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .dimension-label {
            width: 60px;
            font-size: 13px;
            color: #4b5563;
        }
        
        .dimension-bar-track {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dimension-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .dimension-value {
            width: 30px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .mastery-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .stat-label {
            font-size: 11px;
            color: #6b7280;
        }
        
        /* æ—¶é—´çº¿ */
        .mastery-timeline {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 12px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
        }
        
        /* å•è¯å¡ç‰‡ä¸­çš„æŒæ¡åº¦æŒ‡ç¤º */
        .word-mastery-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
        }
    `;
    document.head.appendChild(style);
}

// å¯¼å‡ºV1åŠŸèƒ½
window.initWordMastery = initWordMastery;
window.updateWordMastery = updateWordMastery;
window.getWordMastery = getWordMastery;
window.getMasteryLevelInfo = getMasteryLevelInfo;
window.renderMasteryBadge = renderMasteryBadge;
window.renderMasteryCard = renderMasteryCard;
window.getMasteryStats = getMasteryStats;
window.addMasteryTrackingStyles = addMasteryTrackingStyles;

// V11: åŒä¹‰è¯/åä¹‰è¯æ•°æ®
var wordRelationsData = null;

// V12: æ™ºèƒ½åŠ©è®°è¯æ•°æ®
var wordMnemonicsData = null;

// V13: è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
var wordDifficultyData = null;

// V15: ä¸°å¯Œä¾‹å¥æ•°æ®
var wordExamplesData = null;

// V16: çœŸé¢˜è¯æ±‡æ ‡è®°æ•°æ®
var wordExamTagsData = null;

// ==================== V14: ç§‘å­¦åŠ©è®°ç³»ç»Ÿ ====================
// åŸºäºè®¤çŸ¥å¿ƒç†å­¦çš„10ä¸ªç»´åº¦æ”¹è¿›

// V14.1: åŠ©è®°æ•ˆæœè¯„ä¼°æ•°æ®
var mnemonicEffectivenessData = {};
try {
    mnemonicEffectivenessData = JSON.parse(localStorage.getItem('mnemonicEffectiveness') || '{}');
} catch(e) {
    mnemonicEffectivenessData = {};
}

// V14.2: ç”¨æˆ·è‡ªå®šä¹‰åŠ©è®°è¯
var userCustomMnemonics = {};
try {
    userCustomMnemonics = JSON.parse(localStorage.getItem('userCustomMnemonics') || '{}');
} catch(e) {
    userCustomMnemonics = {};
}

// V14.3: è®°å¿†å®«æ®¿æ•°æ®
var memoryPalaceData = {};
try {
    memoryPalaceData = JSON.parse(localStorage.getItem('memoryPalace') || '{}');
} catch(e) {
    memoryPalaceData = {};
}

// V14.4: æƒ…æ„Ÿé”šå®šæ•°æ®
var emotionalAnchorData = {};
try {
    emotionalAnchorData = JSON.parse(localStorage.getItem('emotionalAnchors') || '{}');
} catch(e) {
    emotionalAnchorData = {};
}

// V14.5: åˆ†å—è®°å¿†ç»„
var chunkingGroups = {};
try {
    chunkingGroups = JSON.parse(localStorage.getItem('chunkingGroups') || '{}');
} catch(e) {
    chunkingGroups = {};
}

// V14-V19: ç§‘å­¦è®°å¿†æ–¹æ³•ç±»å‹ï¼ˆåŸºäºç ”ç©¶ï¼‰- UI/Emojiä¼˜åŒ–ç‰ˆ
var MNEMONIC_SCIENCE = {
    types: {
        'etymology': { 
            name: 'è¯æºåˆ†æ', 
            icon: 'ğŸŒ³', 
            iconAlt: 'ğŸ“œ',
            color: '#166534', 
            bg: '#dcfce7', 
            bgGradient: 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)',
            effectiveness: 0.85, 
            description: 'è¿½æº¯è¯æ ¹è¯ç¼€ï¼Œå»ºç«‹æ·±å±‚è¯­ä¹‰è”ç³»',
            shortDesc: 'è¯æ ¹è¯ç¼€'
        },
        'phonetic': { 
            name: 'è°éŸ³è®°å¿†', 
            icon: 'ğŸµ', 
            iconAlt: 'ğŸ””',
            color: '#92400e', 
            bg: '#fef3c7', 
            bgGradient: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
            effectiveness: 0.72, 
            description: 'å£°éŸ³ç›¸ä¼¼æ€§ï¼Œå¿«é€Ÿè”æƒ³è®°å¿†',
            shortDesc: 'å£°éŸ³è”æƒ³'
        },
        'visual': { 
            name: 'å½¢è±¡è”æƒ³', 
            icon: 'ğŸ–¼ï¸', 
            iconAlt: 'ğŸ‘ï¸',
            color: '#1e40af', 
            bg: '#dbeafe', 
            bgGradient: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
            effectiveness: 0.88, 
            description: 'ç”ŸåŠ¨è§†è§‰ç”»é¢ï¼Œæ¿€æ´»è§†è§‰çš®å±‚',
            shortDesc: 'ç”»é¢æƒ³è±¡'
        },
        'story': { 
            name: 'æ•…äº‹è®°å¿†', 
            icon: 'ğŸ“š', 
            iconAlt: 'ğŸ¬',
            color: '#7c2d12', 
            bg: '#ffedd5', 
            bgGradient: 'linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%)',
            effectiveness: 0.90, 
            description: 'ç¼–ç»‡å™äº‹æƒ…èŠ‚ï¼Œåˆ©ç”¨æƒ…èŠ‚è®°å¿†ä¼˜åŠ¿',
            shortDesc: 'ç¼–æ•…äº‹'
        },
        'loci': { 
            name: 'è®°å¿†å®«æ®¿', 
            icon: 'ğŸ°', 
            iconAlt: 'ğŸ—ºï¸',
            color: '#5b21b6', 
            bg: '#ede9fe', 
            bgGradient: 'linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%)',
            effectiveness: 0.92, 
            description: 'ç©ºé—´å®šä½æ³•ï¼Œä¸–ç•Œè®°å¿†å† å†›æŠ€æœ¯',
            shortDesc: 'ç©ºé—´å®šä½'
        },
        'chunking': { 
            name: 'åˆ†å—è®°å¿†', 
            icon: 'ğŸ§±', 
            iconAlt: 'ğŸ“¦',
            color: '#0f766e', 
            bg: '#ccfbf1', 
            bgGradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%)',
            effectiveness: 0.80, 
            description: 'ä¿¡æ¯åˆ†ç»„ï¼Œå‡è½»å·¥ä½œè®°å¿†è´Ÿæ‹…',
            shortDesc: 'åˆ†ç»„è®°å¿†'
        },
        'emotional': { 
            name: 'æƒ…æ„Ÿé”šå®š', 
            icon: 'ğŸ’', 
            iconAlt: 'ğŸ­',
            color: '#be123c', 
            bg: '#ffe4e6', 
            bgGradient: 'linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%)',
            effectiveness: 0.87, 
            description: 'å»ºç«‹æƒ…æ„Ÿè¿æ¥ï¼Œå¢å¼ºé•¿æœŸè®°å¿†',
            shortDesc: 'æƒ…æ„Ÿè¿æ¥'
        },
        'kinesthetic': { 
            name: 'åŠ¨ä½œè®°å¿†', 
            icon: 'ğŸƒ', 
            iconAlt: 'âœ‹',
            color: '#4338ca', 
            bg: '#e0e7ff', 
            bgGradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)',
            effectiveness: 0.78, 
            description: 'èº«ä½“åŠ¨ä½œå‚ä¸ï¼Œå¤šæ„Ÿå®˜ç¼–ç ',
            shortDesc: 'åŠ¨ä½œå‚ä¸'
        },
        'elaboration': { 
            name: 'ç²¾ç»†åŠ å·¥', 
            icon: 'ğŸ”', 
            iconAlt: 'âš—ï¸',
            color: '#6d28d9', 
            bg: '#f3e8ff', 
            bgGradient: 'linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)',
            effectiveness: 0.86, 
            description: 'æ·±åº¦å¤„ç†ä¿¡æ¯ï¼Œå»ºç«‹å¤šé‡è”ç»“',
            shortDesc: 'æ·±åº¦åŠ å·¥'
        },
        'dual_coding': { 
            name: 'åŒé‡ç¼–ç ', 
            icon: 'ğŸ”€', 
            iconAlt: 'ğŸ¯',
            color: '#0369a1', 
            bg: '#e0f2fe', 
            bgGradient: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)',
            effectiveness: 0.89, 
            description: 'è¯­è¨€+å›¾åƒåŒé€šé“ç¼–ç ',
            shortDesc: 'åŒé€šé“'
        }
    },
    // V15: æ•ˆæœç­‰çº§emojiæ˜ å°„
    effectivenessEmoji: function(score) {
        if (score >= 0.9) return { emoji: 'ğŸ†', label: 'é¡¶çº§', color: '#f59e0b' };
        if (score >= 0.85) return { emoji: 'â­', label: 'ä¼˜ç§€', color: '#22c55e' };
        if (score >= 0.8) return { emoji: 'âœ¨', label: 'è‰¯å¥½', color: '#3b82f6' };
        if (score >= 0.7) return { emoji: 'ğŸ‘', label: 'ä¸é”™', color: '#8b5cf6' };
        return { emoji: 'ğŸ’ª', label: 'åŠ æ²¹', color: '#6b7280' };
    },
    // è®°å¿†å¼ºåº¦è®¡ç®—ï¼ˆåŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿ä¿®æ­£ï¼‰
    calculateRetention: function(initialStrength, hoursSinceEncoding, reviewCount) {
        // R = S * e^(-t/Ï„) + reinforcement_bonus
        var tau = 24 * (1 + reviewCount * 0.5); // å¤ä¹ å¢åŠ è®°å¿†åŠè¡°æœŸ
        var retention = initialStrength * Math.exp(-hoursSinceEncoding / tau);
        var bonus = Math.min(0.3, reviewCount * 0.05);
        return Math.min(1, retention + bonus);
    },
    // æ¨èæœ€ä½³åŠ©è®°ç±»å‹ï¼ˆåŸºäºç”¨æˆ·å†å²è¡¨ç°ï¼‰
    recommendType: function(word, userHistory) {
        var scores = {};
        var types = Object.keys(this.types);
        
        types.forEach(function(type) {
            var baseScore = MNEMONIC_SCIENCE.types[type].effectiveness;
            var userScore = userHistory[type] || baseScore;
            scores[type] = (baseScore + userScore) / 2;
        });
        
        // æ ¹æ®è¯æ±‡ç‰¹å¾è°ƒæ•´æ¨è
        if (word.length > 8) scores['chunking'] *= 1.2;
        if (/^(un|re|pre|dis|mis)/.test(word)) scores['etymology'] *= 1.3;
        if (/tion$|sion$|ment$|ness$/.test(word)) scores['etymology'] *= 1.2;
        
        var best = types.reduce(function(a, b) {
            return scores[a] > scores[b] ? a : b;
        });
        
        return { type: best, score: scores[best], allScores: scores };
    }
};

// V14.1: è®°å½•åŠ©è®°æ•ˆæœ
function recordMnemonicEffectiveness(word, mnemonicType, wasEffective) {
    if (!mnemonicEffectivenessData[word]) {
        mnemonicEffectivenessData[word] = {
            type: mnemonicType,
            exposures: 0,
            successes: 0,
            lastReview: null,
            effectiveness: 0.5
        };
    }
    
    var data = mnemonicEffectivenessData[word];
    data.exposures++;
    if (wasEffective) data.successes++;
    data.lastReview = Date.now();
    data.effectiveness = data.successes / data.exposures;
    
    // æ›´æ–°ç±»å‹æ€»ä½“æ•ˆæœ
    if (!mnemonicEffectivenessData._typeStats) {
        mnemonicEffectivenessData._typeStats = {};
    }
    if (!mnemonicEffectivenessData._typeStats[mnemonicType]) {
        mnemonicEffectivenessData._typeStats[mnemonicType] = { total: 0, success: 0 };
    }
    mnemonicEffectivenessData._typeStats[mnemonicType].total++;
    if (wasEffective) mnemonicEffectivenessData._typeStats[mnemonicType].success++;
    
    localStorage.setItem('mnemonicEffectiveness', JSON.stringify(mnemonicEffectivenessData));
}

// V14.2: ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰åŠ©è®°è¯
function saveCustomMnemonic(word, mnemonic) {
    userCustomMnemonics[word.toLowerCase()] = {
        mnemonic: mnemonic.text,
        type: mnemonic.type || 'custom',
        createdAt: Date.now(),
        visual: mnemonic.visual || null,
        emotional: mnemonic.emotional || null,
        story: mnemonic.story || null
    };
    localStorage.setItem('userCustomMnemonics', JSON.stringify(userCustomMnemonics));
}

// V14.3: æ·»åŠ åˆ°è®°å¿†å®«æ®¿
function addToMemoryPalace(word, location, imageDescription) {
    if (!memoryPalaceData.locations) {
        memoryPalaceData.locations = [
            { id: 'home_entrance', name: 'å®¶é—¨å£', description: 'ç†Ÿæ‚‰çš„å®¶é—¨å…¥å£' },
            { id: 'living_room', name: 'å®¢å…', description: 'èˆ’é€‚çš„å®¢å…' },
            { id: 'kitchen', name: 'å¨æˆ¿', description: 'å¨æˆ¿' },
            { id: 'bedroom', name: 'å§å®¤', description: 'å§å®¤' },
            { id: 'bathroom', name: 'å«ç”Ÿé—´', description: 'å«ç”Ÿé—´' },
            { id: 'balcony', name: 'é˜³å°', description: 'é˜³å°' },
            { id: 'study', name: 'ä¹¦æˆ¿', description: 'ä¹¦æˆ¿' },
            { id: 'garden', name: 'èŠ±å›­', description: 'èŠ±å›­' }
        ];
    }
    
    if (!memoryPalaceData.placements) {
        memoryPalaceData.placements = {};
    }
    
    memoryPalaceData.placements[word.toLowerCase()] = {
        locationId: location,
        image: imageDescription,
        placedAt: Date.now()
    };
    
    localStorage.setItem('memoryPalace', JSON.stringify(memoryPalaceData));
}

// V14.4: è®¾ç½®æƒ…æ„Ÿé”šå®š
function setEmotionalAnchor(word, emotion, intensity) {
    var emotions = {
        'joy': { icon: 'ğŸ˜Š', name: 'å¿«ä¹', color: '#fbbf24' },
        'surprise': { icon: 'ğŸ˜²', name: 'æƒŠè®¶', color: '#8b5cf6' },
        'fear': { icon: 'ğŸ˜¨', name: 'ææƒ§', color: '#6b7280' },
        'disgust': { icon: 'ğŸ¤¢', name: 'åŒæ¶', color: '#22c55e' },
        'anger': { icon: 'ğŸ˜ ', name: 'æ„¤æ€’', color: '#ef4444' },
        'sadness': { icon: 'ğŸ˜¢', name: 'æ‚²ä¼¤', color: '#3b82f6' },
        'love': { icon: 'â¤ï¸', name: 'çˆ±', color: '#ec4899' },
        'curiosity': { icon: 'ğŸ¤”', name: 'å¥½å¥‡', color: '#f59e0b' }
    };
    
    emotionalAnchorData[word.toLowerCase()] = {
        emotion: emotion,
        intensity: intensity || 5,
        data: emotions[emotion],
        setAt: Date.now()
    };
    
    localStorage.setItem('emotionalAnchors', JSON.stringify(emotionalAnchorData));
}

// V14.5: åˆ›å»ºåˆ†å—è®°å¿†ç»„
function createChunkingGroup(groupName, words, commonPattern) {
    var groupId = 'chunk_' + Date.now();
    chunkingGroups[groupId] = {
        name: groupName,
        words: words,
        pattern: commonPattern,
        createdAt: Date.now()
    };
    
    // æ ‡è®°æ¯ä¸ªå•è¯å±äºå“ªä¸ªç»„
    words.forEach(function(word) {
        if (!chunkingGroups._wordToGroup) chunkingGroups._wordToGroup = {};
        chunkingGroups._wordToGroup[word.toLowerCase()] = groupId;
    });
    
    localStorage.setItem('chunkingGroups', JSON.stringify(chunkingGroups));
    return groupId;
}

// V14.6: è·å–å¢å¼ºç‰ˆåŠ©è®°ä¿¡æ¯
function getEnhancedMnemonic(word) {
    var lowerWord = word.toLowerCase();
    var baseMnemonic = getWordMnemonic(word);
    var customMnemonic = userCustomMnemonics[lowerWord];
    var effectiveness = mnemonicEffectivenessData[lowerWord];
    var palace = memoryPalaceData.placements ? memoryPalaceData.placements[lowerWord] : null;
    var emotion = emotionalAnchorData[lowerWord];
    var chunk = chunkingGroups._wordToGroup ? chunkingGroups[chunkingGroups._wordToGroup[lowerWord]] : null;
    
    return {
        base: baseMnemonic,
        custom: customMnemonic,
        effectiveness: effectiveness,
        memoryPalace: palace,
        emotionalAnchor: emotion,
        chunkGroup: chunk,
        hasEnhancements: !!(customMnemonic || palace || emotion || chunk),
        recommended: MNEMONIC_SCIENCE.recommendType(word, mnemonicEffectivenessData._typeStats || {})
    };
}

// V11: åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®
function loadWordRelations() {
    if (wordRelationsData) return Promise.resolve(wordRelationsData);
    
    return fetch('word_relations.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word relations');
            return response.json();
        })
        .then(function(data) {
            wordRelationsData = data;
            console.log('[V11] åŒä¹‰è¯/åä¹‰è¯æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ç»„');
            return data;
        })
        .catch(function(err) {
            console.warn('[V11] åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®å¤±è´¥:', err);
            wordRelationsData = {};
            return {};
        });
}

// V12: åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®
function loadWordMnemonics() {
    if (wordMnemonicsData) return Promise.resolve(wordMnemonicsData);
    
    return fetch('word_mnemonics.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word mnemonics');
            return response.json();
        })
        .then(function(data) {
            wordMnemonicsData = data;
            console.log('[V12] æ™ºèƒ½åŠ©è®°è¯æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V12] åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®å¤±è´¥:', err);
            wordMnemonicsData = {};
            return {};
        });
}

// V13: åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
function loadWordDifficulty() {
    if (wordDifficultyData) return Promise.resolve(wordDifficultyData);
    
    return fetch('word_difficulty.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word difficulty');
            return response.json();
        })
        .then(function(data) {
            wordDifficultyData = data;
            console.log('[V13] è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V13] åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®å¤±è´¥:', err);
            wordDifficultyData = {};
            return {};
        });
}

// V15: åŠ è½½ä¸°å¯Œä¾‹å¥æ•°æ®
function loadWordExamples() {
    if (wordExamplesData) return Promise.resolve(wordExamplesData);
    
    return fetch('word_examples.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word examples');
            return response.json();
        })
        .then(function(data) {
            wordExamplesData = data;
            console.log('[V15] ä¸°å¯Œä¾‹å¥æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V15] åŠ è½½ä¸°å¯Œä¾‹å¥æ•°æ®å¤±è´¥:', err);
            wordExamplesData = {};
            return {};
        });
}

// V11: è·å–å•è¯çš„åŒä¹‰è¯/åä¹‰è¯
function getWordRelations(word) {
    if (!wordRelationsData) return null;
    var lowerWord = word.toLowerCase();
    return wordRelationsData[lowerWord] || null;
}

// V12: è·å–å•è¯çš„åŠ©è®°è¯
function getWordMnemonic(word) {
    if (!wordMnemonicsData) return null;
    var lowerWord = word.toLowerCase();
    return wordMnemonicsData[lowerWord] || null;
}

// V13: è·å–å•è¯éš¾åº¦ç­‰çº§
function getWordDifficulty(word) {
    if (!wordDifficultyData) return null;
    var lowerWord = word.toLowerCase();
    return wordDifficultyData[lowerWord] || null;
}

// V15: è·å–å•è¯ä¸°å¯Œä¾‹å¥
function getWordExamples(word) {
    if (!wordExamplesData) return null;
    var lowerWord = word.toLowerCase();
    return wordExamplesData[lowerWord] || null;
}

// V16: åŠ è½½çœŸé¢˜è¯æ±‡æ ‡è®°æ•°æ®
function loadWordExamTags() {
    if (wordExamTagsData) return Promise.resolve(wordExamTagsData);
    
    return fetch('word_exam_tags.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load exam tags');
            return response.json();
        })
        .then(function(data) {
            wordExamTagsData = data;
            console.log('[V16] çœŸé¢˜è¯æ±‡æ ‡è®°åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V16] åŠ è½½çœŸé¢˜è¯æ±‡æ ‡è®°å¤±è´¥:', err);
            wordExamTagsData = {};
            return {};
        });
}

// V16: è·å–å•è¯çœŸé¢˜æ ‡è®°
function getWordExamTags(word) {
    if (!wordExamTagsData) return null;
    var lowerWord = word.toLowerCase();
    return wordExamTagsData[lowerWord] || null;
}

try {
    learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
    wordRatings = JSON.parse(localStorage.getItem('wordRatings') || '{}');
    wordLearningProgress = JSON.parse(localStorage.getItem('wordLearningProgress') || '{}');
} catch(e) {
    learnedWords = [];
    wordRatings = {};
    wordLearningProgress = {};
}

// åˆå§‹åŒ–è¯æ±‡æ¨¡å—
function initVocabulary() {
    // V8: åŠ è½½è‡ªé€‚åº”éš¾åº¦æ•°æ®
    loadAdaptiveDifficulty();
    // V11: åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®
    loadWordRelations();
    // V12: åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®
    loadWordMnemonics();
    // V13: åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
    loadWordDifficulty();
    // V15: åŠ è½½ä¸°å¯Œä¾‹å¥æ•°æ®
    loadWordExamples();
    // V16: åŠ è½½çœŸé¢˜è¯æ±‡æ ‡è®°æ•°æ®
    loadWordExamTags();
    // æ˜¾ç¤ºè®¾ç½®é¢æ¿
    showVocabSettings();
    // åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
    // speakWordå·²åœ¨showCurrentWordä¸­è°ƒç”¨ï¼Œæ— éœ€é‡å¤
}

// æ˜¾ç¤ºå•è¯æ•°é‡è®¾ç½®
function showVocabSettings() {
    var settingsEl = document.getElementById('vocabSettings');
    if (!settingsEl) {
        // åœ¨è¯æ±‡æ¨¡å—é¡¶éƒ¨æ·»åŠ è®¾ç½®
        var modalHeader = document.querySelector('#vocabularyModal .modal-header');
        if (modalHeader) {
            var settingsDiv = document.createElement('div');
            settingsDiv.id = 'vocabSettings';
            settingsDiv.className = 'vocab-settings-panel';
            settingsDiv.innerHTML = 
                '<div class="settings-row">' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">âœ¦</span> æ¯æ¬¡å­¦ä¹ </span>' +
                        '<select id="wordsPerSessionSelect" onchange="changeWordsPerSession(this.value)" class="setting-select">' +
                            '<option value="10"' + (wordsPerSession === 10 ? ' selected' : '') + '>10ä¸ª</option>' +
                            '<option value="20"' + (wordsPerSession === 20 ? ' selected' : '') + '>20ä¸ª</option>' +
                            '<option value="30"' + (wordsPerSession === 30 ? ' selected' : '') + '>30ä¸ª</option>' +
                            '<option value="50"' + (wordsPerSession === 50 ? ' selected' : '') + '>50ä¸ª</option>' +
                            '<option value="100"' + (wordsPerSession === 100 ? ' selected' : '') + '>100ä¸ª</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">â—ˆ</span> å­¦ä¹ æ¬¡æ•°</span>' +
                        '<select id="learningTimesSelect" onchange="changeLearningTimes(this.value)" class="setting-select">' +
                            '<option value="1"' + (requiredLearningTimes === 1 ? ' selected' : '') + '>1æ¬¡</option>' +
                            '<option value="2"' + (requiredLearningTimes === 2 ? ' selected' : '') + '>2æ¬¡</option>' +
                            '<option value="3"' + (requiredLearningTimes === 3 ? ' selected' : '') + '>3æ¬¡</option>' +
                            '<option value="4"' + (requiredLearningTimes === 4 ? ' selected' : '') + '>4æ¬¡</option>' +
                            '<option value="5"' + (requiredLearningTimes === 5 ? ' selected' : '') + '>5æ¬¡</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="settings-tip"><span class="tip-icon">âœ§</span> æ¯ä¸ªå•è¯å­¦ä¹  <strong id="timesDisplay">' + requiredLearningTimes + '</strong> æ¬¡åæ‰ç®—æŒæ¡</div>';
            modalHeader.after(settingsDiv);
            
            // æ·»åŠ æ ·å¼
            addVocabSettingsStyles();
        }
    }
}

// æ·»åŠ è®¾ç½®é¢æ¿æ ·å¼
function addVocabSettingsStyles() {
    if (document.getElementById('vocabSettingsStyles')) return;
    
    var style = document.createElement('style');
    style.id = 'vocabSettingsStyles';
    style.textContent = `
        .vocab-settings-panel {
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8f7ff 0%, #e0e7ff 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-label {
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .setting-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        
        .tip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .setting-select {
            padding: 8px 14px;
            border-radius: 10px;
            border: 2px solid #6366f1;
            background: white;
            color: #1e1b4b;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .setting-select:hover {
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        .setting-select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .settings-tip {
            color: #6b7280;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .settings-tip strong {
            color: #6366f1;
            font-weight: 700;
        }
        
        /* å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨ */
        .learning-progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border-radius: 12px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .progress-dot.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        .progress-dot.current {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .progress-label {
            margin-left: 8px;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* è¯å¡ä¼˜åŒ–æ ·å¼ */
        .word-card-enhanced {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .word-main-enhanced {
            font-size: 42px;
            font-weight: 800;
            color: #1e1b4b;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .word-phonetic-enhanced {
            font-size: 18px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* è¯„åˆ†æŒ‰é’®ä¼˜åŒ– */
        .rate-btn-enhanced {
            flex: 1;
            padding: 16px 12px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .rate-btn-enhanced.hard {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 2px solid #fecaca;
        }
        
        .rate-btn-enhanced.hard:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
        }
        
        .rate-btn-enhanced.medium {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #d97706;
            border: 2px solid #fde68a;
        }
        
        .rate-btn-enhanced.medium:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.2);
        }
        
        .rate-btn-enhanced.easy {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
            border: 2px solid #a7f3d0;
        }
        
        .rate-btn-enhanced.easy:hover {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.2);
        }
        
        .rate-emoji {
            font-size: 24px;
        }
        
        .rate-text {
            font-size: 14px;
        }
        
        .rate-hint {
            font-size: 11px;
            opacity: 0.7;
            font-weight: 500;
        }
        
        /* å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç«  */
        .learning-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .learning-badge.new {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #fcd34d;
        }
        
        .learning-badge.new .badge-icon {
            font-size: 14px;
            animation: sparkle 1.5s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .learning-badge.learning {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 2px solid #a5b4fc;
        }
        
        .learning-badge.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #6ee7b7;
        }
        
        .learning-badge.completed .badge-icon {
            font-size: 14px;
            animation: checkBounce 0.5s ease;
        }
        
        @keyframes checkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .badge-count {
            font-size: 16px;
            font-weight: 800;
            color: #4f46e5;
        }
        
        .badge-separator {
            font-size: 12px;
            color: #9ca3af;
            margin: 0 1px;
        }
        
        .badge-total {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .badge-text {
            font-size: 12px;
            margin-left: 2px;
        }
        
        /* Toast åŠ¨ç”» */
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    `;
    document.head.appendChild(style);
}

// ä¿®æ”¹å­¦ä¹ æ¬¡æ•°è®¾ç½®
function changeLearningTimes(value) {
    requiredLearningTimes = parseInt(value);
    localStorage.setItem('requiredLearningTimes', requiredLearningTimes.toString());
    
    var timesDisplay = document.getElementById('timesDisplay');
    if (timesDisplay) {
        timesDisplay.textContent = requiredLearningTimes;
    }
    
    // ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šå­¦ä¹ æ¬¡æ•°æ›´æ–°åè‡ªåŠ¨åˆ·æ–° ======
    // é‡æ–°è®¡ç®—æ‰€æœ‰å•è¯çš„å®ŒæˆçŠ¶æ€
    sessionWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        if (progress) {
            // æ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼Œé‡æ–°åˆ¤æ–­æ˜¯å¦å®Œæˆ
            progress.completed = progress.times >= requiredLearningTimes;
        }
    });
    
    // é‡æ–°æ„å»ºå­¦ä¹ é˜Ÿåˆ—ï¼ˆæ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼‰
    buildLearningQueue();
    
    // å¦‚æœå½“å‰é˜Ÿåˆ—ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®
    if (currentQueueIndex >= learningQueue.length) {
        currentQueueIndex = Math.max(0, learningQueue.length - 1);
    }
    
    // åˆ·æ–°è¿›åº¦æ˜¾ç¤º
    updateVocabProgress();
    
    // æ›´æ–°å½“å‰å•è¯çš„è¿›åº¦æ˜¾ç¤º
    updateLearningProgressIndicator();
    
    // æ›´æ–°å­¦ä¹ å¾½ç« 
    updateLearningBadge();
    
    // æ˜¾ç¤ºè®¾ç½®æ›´æ–°æç¤º
    showSettingsUpdateToast('å­¦ä¹ æ¬¡æ•°å·²æ›´æ–°ä¸º ' + requiredLearningTimes + ' æ¬¡');
    
    // è§¦å‘è®¾ç½®æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularySettingsUpdated', {
            detail: {
                setting: 'learningTimes',
                value: requiredLearningTimes,
                queueLength: learningQueue.length
            }
        }));
    } catch(e) {}
}

// åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
function initSessionWords() {
    currentWordIndex = 0;
    currentQueueIndex = 0;
    sessionWords = [];
    learningQueue = [];
    sessionWordProgress = {}; // é‡ç½®æœ¬è½®å­¦ä¹ è¿›åº¦
    
    if (!window.vocabularyData || window.vocabularyData.length === 0) return;
    
    // V2.6: æ ¹æ®å­¦ä¹ ç›®æ ‡è¿‡æ»¤è¯æ±‡
    var goalVocabulary = getGoalFilteredVocabulary();
    var effectiveWordsPerSession = getEffectiveWordsPerSession();
    
    // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å•è¯
    var allIndices = [];
    for (var i = 0; i < goalVocabulary.length; i++) {
        allIndices.push(i);
    }
    
    // æ‰“ä¹±é¡ºåº
    for (var j = allIndices.length - 1; j > 0; j--) {
        var k = Math.floor(Math.random() * (j + 1));
        var temp = allIndices[j];
        allIndices[j] = allIndices[k];
        allIndices[k] = temp;
    }
    
    // å–å‰Nä¸ªï¼ˆæ ¹æ®ç›®æ ‡è°ƒæ•´æ•°é‡ï¼‰
    var count = Math.min(effectiveWordsPerSession, allIndices.length);
    for (var m = 0; m < count; m++) {
        var wordData = goalVocabulary[allIndices[m]];
        sessionWords.push(wordData);
        // åˆå§‹åŒ–æœ¬è½®å­¦ä¹ è¿›åº¦
        sessionWordProgress[wordData.word] = {
            times: 0,           // æœ¬è½®å·²å­¦ä¹ æ¬¡æ•°
            completed: false,   // æœ¬è½®æ˜¯å¦å®Œæˆ
            lastIndex: -1       // ä¸Šæ¬¡å‡ºç°çš„ä½ç½®
        };
    }
    
    // æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
    buildLearningQueue();
}

// V2.6: æ ¹æ®å­¦ä¹ ç›®æ ‡è·å–è¿‡æ»¤åçš„è¯æ±‡åˆ—è¡¨
function getGoalFilteredVocabulary() {
    var goal = null;
    
    // å°è¯•ä»ActivationSystemè·å–å­¦ä¹ ç›®æ ‡
    if (typeof ActivationSystem !== 'undefined' && ActivationSystem.getLearningGoal) {
        goal = ActivationSystem.getLearningGoal();
    } else {
        // å¤‡ç”¨ï¼šç›´æ¥ä»localStorageè·å–
        try {
            var goalData = JSON.parse(localStorage.getItem('eb_learning_goal') || '{}');
            goal = goalData.goal;
        } catch(e) {
            goal = null;
        }
    }
    
    console.log('[V2.6] å½“å‰å­¦ä¹ ç›®æ ‡:', goal);
    
    // å¦‚æœæ²¡æœ‰è®¾ç½®ç›®æ ‡æˆ–ä½¿ç”¨æ‰€æœ‰è¯æ±‡
    if (!goal) {
        return window.vocabularyData;
    }
    
    // æ ¹æ®ç›®æ ‡è¿‡æ»¤è¯æ±‡
    var filteredWords = [];
    var examTagsLoaded = wordExamTagsData && Object.keys(wordExamTagsData).length > 0;
    
    window.vocabularyData.forEach(function(wordData) {
        var shouldInclude = false;
        var wordLower = wordData.word.toLowerCase();
        
        if (goal === 'gre') {
            // GREæ¨¡å¼ï¼šä¼˜å…ˆGREé«˜é¢‘è¯
            if (examTagsLoaded && wordExamTagsData[wordLower]) {
                var tags = wordExamTagsData[wordLower];
                shouldInclude = tags.gre || tags.gre_high_freq || tags.graduate;
            }
            // å¦‚æœæ²¡æœ‰æ ‡ç­¾æ•°æ®ï¼Œé»˜è®¤åŒ…å«éš¾åº¦è¾ƒé«˜çš„è¯
            if (!shouldInclude && wordDifficultyData && wordDifficultyData[wordLower]) {
                var diff = wordDifficultyData[wordLower];
                shouldInclude = diff.level === 'advanced' || diff.level === 'expert';
            }
            // å…œåº•ï¼šåŒ…å«æ‰€æœ‰è¯æ±‡
            if (!shouldInclude && (!examTagsLoaded || !wordDifficultyData)) {
                shouldInclude = true;
            }
        } else if (goal === 'toefl') {
            // æ‰˜ç¦æ¨¡å¼ï¼šæ‰˜ç¦å¸¸è€ƒè¯
            if (examTagsLoaded && wordExamTagsData[wordLower]) {
                var tags = wordExamTagsData[wordLower];
                shouldInclude = tags.toefl || tags.toefl_high_freq || tags.academic;
            }
            if (!shouldInclude && wordDifficultyData && wordDifficultyData[wordLower]) {
                var diff = wordDifficultyData[wordLower];
                shouldInclude = diff.level === 'intermediate' || diff.level === 'advanced';
            }
            if (!shouldInclude && (!examTagsLoaded || !wordDifficultyData)) {
                shouldInclude = true;
            }
        } else if (goal === 'academic') {
            // å­¦æœ¯è‹±è¯­æ¨¡å¼ï¼šAWLå­¦æœ¯è¯æ±‡
            if (examTagsLoaded && wordExamTagsData[wordLower]) {
                var tags = wordExamTagsData[wordLower];
                shouldInclude = tags.awl || tags.academic || tags.research;
            }
            // æ£€æŸ¥æ˜¯å¦ä¸ºAWLè¯æ±‡ï¼ˆé€šè¿‡æ ‡ç­¾æˆ–å…¶ä»–æ–¹å¼ï¼‰
            if (!shouldInclude && window.awlWordList && window.awlWordList.includes(wordLower)) {
                shouldInclude = true;
            }
            if (!shouldInclude && (!examTagsLoaded || !window.awlWordList)) {
                shouldInclude = true;
            }
        } else {
            // æœªçŸ¥ç›®æ ‡ï¼ŒåŒ…å«æ‰€æœ‰
            shouldInclude = true;
        }
        
        if (shouldInclude) {
            filteredWords.push(wordData);
        }
    });
    
    console.log('[V2.6] ç›®æ ‡è¿‡æ»¤åè¯æ±‡æ•°:', filteredWords.length, '/', window.vocabularyData.length);
    
    // å¦‚æœè¿‡æ»¤åè¯æ±‡å¤ªå°‘ï¼Œè¿”å›å…¨éƒ¨
    if (filteredWords.length < 20) {
        console.log('[V2.6] è¿‡æ»¤åè¯æ±‡ä¸è¶³ï¼Œä½¿ç”¨å…¨éƒ¨è¯æ±‡');
        return window.vocabularyData;
    }
    
    return filteredWords;
}

// V2.7: æ ¹æ®å­¦ä¹ ç›®æ ‡è·å–æœ‰æ•ˆçš„æ¯æ¬¡å­¦ä¹ å•è¯æ•°
function getEffectiveWordsPerSession() {
    var goal = null;
    
    if (typeof ActivationSystem !== 'undefined' && ActivationSystem.getGoalDailyWords) {
        var goalDailyWords = ActivationSystem.getGoalDailyWords();
        if (goalDailyWords) {
            // ä½¿ç”¨ç›®æ ‡é…ç½®çš„æ¯æ—¥å•è¯æ•°ï¼Œä½†ä¸è¶…è¿‡ç”¨æˆ·è®¾ç½®
            return Math.min(goalDailyWords, wordsPerSession);
        }
    }
    
    return wordsPerSession;
}

// æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
function buildLearningQueue() {
    learningQueue = [];
    
    // è·å–æ‰€æœ‰æœªå®Œæˆçš„å•è¯
    var pendingWords = sessionWords.filter(function(w) {
        return !sessionWordProgress[w.word].completed;
    });
    
    if (pendingWords.length === 0) return;
    
    // è®¡ç®—æ¯ä¸ªå•è¯è¿˜éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
    var wordsNeedReview = [];
    pendingWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        var remaining = requiredLearningTimes - progress.times;
        for (var i = 0; i < remaining; i++) {
            wordsNeedReview.push({
                wordData: wordData,
                reviewRound: progress.times + i + 1
            });
        }
    });
    
    // æŒ‰ç…§é—´éš”é‡å¤çš„åŸåˆ™é‡æ–°æ’åˆ—
    // ç­–ç•¥ï¼šå…ˆå­¦æ–°è¯ï¼Œç„¶åç©¿æ’å¤ä¹ 
    var newWords = wordsNeedReview.filter(function(w) { return w.reviewRound === 1; });
    var reviewWords = wordsNeedReview.filter(function(w) { return w.reviewRound > 1; });
    
    // æ‰“ä¹±æ–°è¯é¡ºåº
    shuffleArray(newWords);
    
    // æ„å»ºé˜Ÿåˆ—ï¼šæ¯å­¦ä¹ 2-3ä¸ªæ–°è¯åï¼Œæ’å…¥éœ€è¦å¤ä¹ çš„è¯
    var result = [];
    var newWordIndex = 0;
    var reviewWordIndex = 0;
    var wordsSinceLastReview = {};
    var minGap = 3; // åŒä¸€ä¸ªå•è¯è‡³å°‘é—´éš”3ä¸ªä½ç½®å†å‡ºç°
    
    while (newWordIndex < newWords.length || reviewWordIndex < reviewWords.length) {
        // ä¼˜å…ˆæ·»åŠ æ–°è¯
        var addedNewWord = false;
        if (newWordIndex < newWords.length) {
            var newWord = newWords[newWordIndex];
            result.push(newWord.wordData);
            wordsSinceLastReview[newWord.wordData.word] = 0;
            newWordIndex++;
            addedNewWord = true;
        }
        
        // æ›´æ–°æ‰€æœ‰å•è¯çš„é—´éš”è®¡æ•°
        Object.keys(wordsSinceLastReview).forEach(function(w) {
            wordsSinceLastReview[w]++;
        });
        
        // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼ˆé—´éš”è¶³å¤Ÿï¼‰
        if (reviewWordIndex < reviewWords.length && result.length >= minGap) {
            // æ‰¾åˆ°ä¸€ä¸ªé—´éš”è¶³å¤Ÿçš„å¤ä¹ å•è¯
            for (var i = reviewWordIndex; i < reviewWords.length; i++) {
                var reviewWord = reviewWords[i];
                var gap = wordsSinceLastReview[reviewWord.wordData.word] || 999;
                
                if (gap >= minGap) {
                    // å¯ä»¥æ’å…¥è¿™ä¸ªå¤ä¹ å•è¯
                    result.push(reviewWord.wordData);
                    wordsSinceLastReview[reviewWord.wordData.word] = 0;
                    
                    // ä»å¤ä¹ åˆ—è¡¨ä¸­ç§»é™¤
                    reviewWords.splice(i, 1);
                    
                    // æ›´æ–°é—´éš”è®¡æ•°
                    Object.keys(wordsSinceLastReview).forEach(function(w) {
                        wordsSinceLastReview[w]++;
                    });
                    break;
                }
            }
        }
        
        // å¦‚æœæ²¡æœ‰æ–°è¯å¯åŠ ï¼Œç»§ç»­æ·»åŠ å¤ä¹ è¯
        if (!addedNewWord && reviewWordIndex < reviewWords.length) {
            var nextReview = reviewWords[0];
            var nextGap = wordsSinceLastReview[nextReview.wordData.word] || 999;
            
            if (nextGap >= minGap) {
                result.push(nextReview.wordData);
                wordsSinceLastReview[nextReview.wordData.word] = 0;
                reviewWords.shift();
            } else {
                // é—´éš”ä¸å¤Ÿï¼Œæ·»åŠ å ä½æˆ–è·³è¿‡
                // æ‰¾å…¶ä»–å¯ä»¥å¤ä¹ çš„è¯
                var foundAlternative = false;
                for (var j = 1; j < reviewWords.length; j++) {
                    var altWord = reviewWords[j];
                    var altGap = wordsSinceLastReview[altWord.wordData.word] || 999;
                    if (altGap >= minGap) {
                        result.push(altWord.wordData);
                        wordsSinceLastReview[altWord.wordData.word] = 0;
                        reviewWords.splice(j, 1);
                        foundAlternative = true;
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°æ›¿ä»£ï¼Œå¼ºåˆ¶æ·»åŠ ï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
                if (!foundAlternative) {
                    result.push(nextReview.wordData);
                    wordsSinceLastReview[nextReview.wordData.word] = 0;
                    reviewWords.shift();
                }
            }
            
            Object.keys(wordsSinceLastReview).forEach(function(w) {
                wordsSinceLastReview[w]++;
            });
        }
    }
    
    learningQueue = result;
}

// æ•°ç»„éšæœºæ‰“ä¹±
function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

// ä¿®æ”¹æ¯æ¬¡å­¦ä¹ å•è¯æ•°
function changeWordsPerSession(value) {
    wordsPerSession = parseInt(value);
    localStorage.setItem('wordsPerSession', wordsPerSession.toString());
    
    // è‡ªåŠ¨åˆ·æ–°ï¼Œé‡æ–°å¼€å§‹å­¦ä¹ 
    initSessionWords();
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    updateVocabProgress();
    showCurrentWord();
}

function updateVocabProgress() {
    var progress = document.getElementById('vocabProgress');
    if (progress) {
        // æ˜¾ç¤ºé˜Ÿåˆ—è¿›åº¦å’Œå•è¯å®Œæˆæ•°
        var completedCount = 0;
        sessionWords.forEach(function(w) {
            if (sessionWordProgress[w.word] && sessionWordProgress[w.word].completed) {
                completedCount++;
            }
        });
        progress.textContent = (currentQueueIndex + 1) + '/' + learningQueue.length + ' (å·²æŒæ¡: ' + completedCount + '/' + sessionWords.length + ')';
    }
}

// V6: å­¦ä¹ æ¨¡å¼çŠ¶æ€
var learningModeState = {
    mode: 'normal', // normal, review, difficult
    isFirstTime: true, // æ˜¯å¦é¦–æ¬¡å­¦ä¹ æ­¤è¯
    consecutiveCorrect: 0 // è¿ç»­æ­£ç¡®æ¬¡æ•°
};

function showCurrentWord() {
    if (!learningQueue || learningQueue.length === 0) {
        initSessionWords();
    }
    if (!learningQueue || learningQueue.length === 0) return;
    
    // ç¡®ä¿æŒæ¡åº¦æ ·å¼å·²åŠ è½½
    addMasteryTrackingStyles();
    
    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰å­¦ä¹ 
    if (currentQueueIndex >= learningQueue.length) {
        showSessionSummary();
        return;
    }
    
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    // V6: æ£€æµ‹å­¦ä¹ æ¨¡å¼
    var word = wordData.word;
    var sessionProgress = sessionWordProgress[word] || { times: 0, completed: false };
    var isReview = sessionProgress.times > 0;
    var isHardWord = hardWordsInSession && hardWordsInSession.indexOf(word) > -1;
    var isImmediateReview = immediateReviewQueue && immediateReviewQueue.some(function(r) { return r.word === word; });
    
    // ç¡®å®šå­¦ä¹ æ¨¡å¼
    if (isImmediateReview) {
        learningModeState.mode = 'immediate';
    } else if (isHardWord) {
        learningModeState.mode = 'difficult';
    } else if (isReview) {
        learningModeState.mode = 'review';
    } else {
        learningModeState.mode = 'normal';
    }
    learningModeState.isFirstTime = !isReview;
    
    // V6: æ˜¾ç¤ºå­¦ä¹ æ¨¡å¼æç¤º
    showLearningModeIndicator(learningModeState.mode);
    
    document.getElementById('wordMain').textContent = wordData.word;
    document.getElementById('wordPhonetic').textContent = wordData.phonetic || '';
    
    // V1: æ˜¾ç¤ºæŒæ¡åº¦å¾½ç« 
    showMasteryBadge(wordData.word);
    
    // V13: æ˜¾ç¤ºéš¾åº¦ç­‰çº§æ ‡ç­¾
    showDifficultyBadge(wordData.word);
    
    // V16: æ˜¾ç¤ºçœŸé¢˜æ ‡è®°æ ‡ç­¾
    showExamTagsBadge(wordData.word);
    
    // éšè—é‡Šä¹‰åŒºåŸŸ
    document.getElementById('wordMeaning').classList.add('hidden');
    document.getElementById('rateButtons').classList.add('hidden');
    document.getElementById('showMeaningBtn').classList.remove('hidden');
    
    updateVocabProgress();
    
    // æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
    updateLearningBadge();
    
    // æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
    updateLearningProgressIndicator();
    
    // è‡ªåŠ¨æœ—è¯»æ–°å•è¯
    speakWord();
}

// V1: æ˜¾ç¤ºæŒæ¡åº¦å¾½ç« 
function showMasteryBadge(word) {
    var masteryContainer = document.getElementById('masteryBadgeContainer');
    var wordMainEl = document.getElementById('wordMain');
    
    if (!masteryContainer && wordMainEl) {
        masteryContainer = document.createElement('div');
        masteryContainer.id = 'masteryBadgeContainer';
        masteryContainer.style.cssText = 'display:flex;justify-content:center;margin-top:8px;';
        wordMainEl.parentNode.insertBefore(masteryContainer, wordMainEl.nextSibling);
    }
    
    if (masteryContainer) {
        var mastery = getWordMastery(word);
        masteryContainer.innerHTML = renderMasteryBadge(word, { size: 'normal' });
        
        // ç‚¹å‡»å¾½ç« æ˜¾ç¤ºè¯¦ç»†å¡ç‰‡
        masteryContainer.onclick = function() {
            showMasteryDetailPopup(word);
        };
        masteryContainer.style.cursor = 'pointer';
    }
}

// V1: æ˜¾ç¤ºæŒæ¡åº¦è¯¦æƒ…å¼¹çª—
function showMasteryDetailPopup(word) {
    var overlay = document.createElement('div');
    overlay.id = 'masteryDetailOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.2s ease;';
    
    var popup = document.createElement('div');
    popup.style.cssText = 'background:white;border-radius:20px;max-width:340px;width:90%;max-height:80vh;overflow-y:auto;animation:slideUp 0.3s ease;';
    
    // æ ‡é¢˜æ 
    var header = '<div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">';
    header += '<span style="font-size:18px;font-weight:700;">ğŸ“Š ' + word + ' æŒæ¡åº¦</span>';
    header += '<button onclick="document.getElementById(\'masteryDetailOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280;">âœ•</button>';
    header += '</div>';
    
    popup.innerHTML = header + renderMasteryCard(word);
    overlay.appendChild(popup);
    
    overlay.onclick = function(e) {
        if (e.target === overlay) overlay.remove();
    };
    
    document.body.appendChild(overlay);
}

// V13: æ˜¾ç¤ºéš¾åº¦ç­‰çº§æ ‡ç­¾
function showDifficultyBadge(word) {
    var difficulty = getWordDifficulty(word);
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºéš¾åº¦æ ‡ç­¾å®¹å™¨
    var badge = document.getElementById('difficultyBadge');
    var phoneticEl = document.getElementById('wordPhonetic');
    
    if (!badge && phoneticEl) {
        badge = document.createElement('span');
        badge.id = 'difficultyBadge';
        badge.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:10px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;vertical-align:middle;';
        phoneticEl.parentNode.insertBefore(badge, phoneticEl.nextSibling);
    }
    
    if (badge) {
        if (difficulty) {
            // æ ¹æ®éš¾åº¦ç­‰çº§è®¾ç½®ä¸åŒé¢œè‰²
            var levelStyles = {
                1: { bg: '#dcfce7', color: '#166534', border: '#bbf7d0', icon: 'ğŸŒ±', label: 'åŸºç¡€' },
                2: { bg: '#dbeafe', color: '#1e40af', border: '#bfdbfe', icon: 'ğŸ“˜', label: 'ä¸­ç­‰' },
                3: { bg: '#fef3c7', color: '#92400e', border: '#fde68a', icon: 'ğŸ“™', label: 'ä¸­é«˜çº§' },
                4: { bg: '#fce7f3', color: '#9d174d', border: '#fbcfe8', icon: 'ğŸ“•', label: 'é«˜çº§' },
                5: { bg: '#ede9fe', color: '#5b21b6', border: '#ddd6fe', icon: 'ğŸ“', label: 'ä¸“ä¸š' }
            };
            var style = levelStyles[difficulty.level] || levelStyles[3];
            badge.style.background = style.bg;
            badge.style.color = style.color;
            badge.style.border = '1px solid ' + style.border;
            badge.style.display = 'inline-flex';
            
            // æ„å»ºæ ‡ç­¾å†…å®¹
            var sourceTags = '';
            if (difficulty.sources && difficulty.sources.length > 0) {
                difficulty.sources.slice(0, 2).forEach(function(src) {
                    var srcStyle = src === 'GRE' ? 'background:#fee2e2;color:#991b1b;' : 
                                   src === 'TOEFL' ? 'background:#e0e7ff;color:#3730a3;' : 
                                   'background:#f3f4f6;color:#374151;';
                    sourceTags += '<span style="' + srcStyle + 'padding:1px 5px;border-radius:4px;font-size:9px;margin-left:4px;">' + src + '</span>';
                });
            }
            
            badge.innerHTML = '<span>' + style.icon + '</span><span>' + style.label + '</span>' + sourceTags;
        } else {
            badge.style.display = 'none';
        }
    }
}

// V16: æ˜¾ç¤ºçœŸé¢˜æ ‡è®°æ ‡ç­¾
function showExamTagsBadge(word) {
    var examTags = getWordExamTags(word);
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºçœŸé¢˜æ ‡ç­¾å®¹å™¨
    var examBadge = document.getElementById('examTagsBadge');
    var difficultyBadge = document.getElementById('difficultyBadge');
    var phoneticEl = document.getElementById('wordPhonetic');
    
    if (!examBadge && (difficultyBadge || phoneticEl)) {
        examBadge = document.createElement('span');
        examBadge.id = 'examTagsBadge';
        examBadge.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:8px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;vertical-align:middle;';
        
        // æ’å…¥åˆ°éš¾åº¦æ ‡ç­¾ä¹‹åï¼Œæˆ–éŸ³æ ‡ä¹‹å
        if (difficultyBadge && difficultyBadge.parentNode) {
            difficultyBadge.parentNode.insertBefore(examBadge, difficultyBadge.nextSibling);
        } else if (phoneticEl && phoneticEl.parentNode) {
            phoneticEl.parentNode.insertBefore(examBadge, phoneticEl.nextSibling);
        }
    }
    
    if (examBadge) {
        if (examTags) {
            examBadge.style.display = 'inline-flex';
            examBadge.style.background = 'linear-gradient(135deg,#fef3c7 0%,#fde68a 100%)';
            examBadge.style.color = '#92400e';
            examBadge.style.border = '1px solid #fcd34d';
            
            var content = '<span>ğŸ“š</span>';
            if (examTags.gre) {
                var greHeat = examTags.gre.count >= 12 ? 'ğŸ”¥ğŸ”¥' : examTags.gre.count >= 8 ? 'ğŸ”¥' : '';
                content += '<span style="background:#7c3aed;color:white;padding:1px 6px;border-radius:4px;font-size:9px;">GREÃ—' + examTags.gre.count + greHeat + '</span>';
            }
            if (examTags.toefl) {
                var toeflHeat = examTags.toefl.count >= 10 ? 'ğŸ”¥ğŸ”¥' : examTags.toefl.count >= 6 ? 'ğŸ”¥' : '';
                content += '<span style="background:#2563eb;color:white;padding:1px 6px;border-radius:4px;font-size:9px;margin-left:2px;">TOEFLÃ—' + examTags.toefl.count + toeflHeat + '</span>';
            }
            
            examBadge.innerHTML = content;
        } else {
            examBadge.style.display = 'none';
        }
    }
}

// æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
function updateLearningBadge() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºå¾½ç« å®¹å™¨
    var badge = document.getElementById('learningBadge');
    if (!badge) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            // ç¡®ä¿ wordCard æ˜¯ç›¸å¯¹å®šä½
            wordCard.style.position = 'relative';
            
            badge = document.createElement('div');
            badge.id = 'learningBadge';
            badge.className = 'learning-badge';
            wordCard.insertBefore(badge, wordCard.firstChild);
        }
    }
    
    if (badge) {
        if (progress.completed) {
            badge.className = 'learning-badge completed';
            badge.innerHTML = '<span class="badge-icon">âœ“</span><span class="badge-text">å·²æŒæ¡</span>';
        } else {
            var remaining = requiredLearningTimes - currentTimes;
            badge.className = 'learning-badge';
            if (currentTimes === 0) {
                badge.classList.add('new');
                badge.innerHTML = '<span class="badge-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg></span><span class="badge-text">æ–°è¯</span>';
            } else {
                badge.classList.add('learning');
                badge.innerHTML = '<span class="badge-count">' + currentTimes + '</span><span class="badge-separator">/</span><span class="badge-total">' + requiredLearningTimes + '</span><span class="badge-text" style="margin-left:4px;">å¤ä¹ ä¸­</span>';
            }
        }
    }
}

// æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
function updateLearningProgressIndicator() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºè¿›åº¦æŒ‡ç¤ºå™¨å®¹å™¨
    var indicatorContainer = document.getElementById('learningProgressIndicator');
    if (!indicatorContainer) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            indicatorContainer = document.createElement('div');
            indicatorContainer.id = 'learningProgressIndicator';
            indicatorContainer.className = 'learning-progress-indicator';
            wordCard.appendChild(indicatorContainer);
        }
    }
    
    if (indicatorContainer) {
        var dotsHtml = '';
        for (var i = 0; i < requiredLearningTimes; i++) {
            var dotClass = 'progress-dot';
            if (i < currentTimes) {
                dotClass += ' completed';
            } else if (i === currentTimes) {
                dotClass += ' current';
            }
            dotsHtml += '<div class="' + dotClass + '"></div>';
        }
        
        var statusText = '';
        if (progress.completed) {
            statusText = '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#10b981" stroke-width="2.5" style="vertical-align:middle;margin-right:4px;"><polyline points="20 6 9 17 4 12"/></svg>å·²æŒæ¡';
        } else {
            statusText = 'ç¬¬ ' + (currentTimes + 1) + '/' + requiredLearningTimes + ' æ¬¡å­¦ä¹ ';
        }
        
        indicatorContainer.innerHTML = dotsHtml + '<span class="progress-label">' + statusText + '</span>';
    }
}

function showMeaning() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    // æŸ¥è¯¢å­—å…¸æ•°æ®
    var dictData = null;
    if (typeof queryDictionary === 'function') {
        dictData = queryDictionary(wordData.word);
    }
    
    // V11: è·å–åŒä¹‰è¯/åä¹‰è¯
    var relations = getWordRelations(wordData.word);
    
    // V12: è·å–åŠ©è®°è¯
    var mnemonic = getWordMnemonic(wordData.word);
    
    // V14: è·å–å¢å¼ºç‰ˆåŠ©è®°ä¿¡æ¯
    var enhancedMnemonic = getEnhancedMnemonic(wordData.word);
    
    // æ„å»ºé‡Šä¹‰HTMLï¼ˆä¸­è‹±æ–‡åŒè¯­ï¼‰
    var meaningHtml = '';
    
    // å¦‚æœæœ‰å­—å…¸æ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (dictData) {
        meaningHtml += '<div class="dict-container" style="background:linear-gradient(135deg,#f8f7ff 0%,#eef2ff 100%);padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.1);">';
        if (dictData.definitions && dictData.definitions.length > 0) {
            meaningHtml += '<div style="font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;"><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);border-radius:6px;box-shadow:0 2px 6px rgba(99,102,241,0.3);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span style="color:#4338ca;">è¯å…¸é‡Šä¹‰</span></div>';
            dictData.definitions.slice(0, 3).forEach(function(def, idx) {
                meaningHtml += '<div style="margin-bottom:6px;font-size:14px;color:#555;">â€¢ ' + def + '</div>';
            });
        }
        meaningHtml += '</div>';
    }
    
    meaningHtml += '<div class="meaning-cn" style="font-size:20px;color:#1e1b4b;margin-bottom:12px;font-weight:700;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:8px;box-shadow:0 2px 6px rgba(16,185,129,0.3);flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span><span>' + (wordData.meaningCn || 'æš‚æ— ä¸­æ–‡é‡Šä¹‰') + '</span></div>';
    meaningHtml += '<div class="meaning-en" style="color:#4b5563;font-size:15px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:7px;box-shadow:0 2px 6px rgba(59,130,246,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span><span>' + (wordData.meaningEn || wordData.meaning || '') + '</span></div>';
    
    // V16: çœŸé¢˜è¯æ±‡æ ‡è®°å±•ç¤º
    var examTags = getWordExamTags(wordData.word);
    if (examTags) {
        meaningHtml += '<div class="exam-tags-section" style="margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border-radius:16px;border:1px solid #fcd34d;">';
        meaningHtml += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">';
        meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:8px;box-shadow:0 2px 6px rgba(245,158,11,0.3);">';
        meaningHtml += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>';
        meaningHtml += '</span>';
        meaningHtml += '<span style="font-weight:700;font-size:14px;color:#92400e;">ğŸ“š çœŸé¢˜é«˜é¢‘è¯æ±‡</span>';
        meaningHtml += '</div>';
        meaningHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        
        if (examTags.gre) {
            var greHeat = examTags.gre.count >= 12 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' : examTags.gre.count >= 8 ? 'ğŸ”¥ğŸ”¥' : 'ğŸ”¥';
            meaningHtml += '<div style="background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);color:white;padding:8px 14px;border-radius:12px;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(124,58,237,0.3);">';
            meaningHtml += '<span style="font-weight:700;font-size:13px;">GRE</span>';
            meaningHtml += '<span style="font-size:12px;opacity:0.9;">å‡ºç° ' + examTags.gre.count + ' æ¬¡</span>';
            meaningHtml += '<span style="font-size:11px;">' + greHeat + '</span>';
            meaningHtml += '</div>';
            if (examTags.gre.years && examTags.gre.years.length > 0) {
                meaningHtml += '<div style="background:rgba(124,58,237,0.1);color:#6d28d9;padding:6px 12px;border-radius:10px;font-size:11px;display:flex;align-items:center;gap:4px;">';
                meaningHtml += '<span>ğŸ“…</span><span>' + examTags.gre.years.join(', ') + '</span>';
                meaningHtml += '</div>';
            }
        }
        
        if (examTags.toefl) {
            var toeflHeat = examTags.toefl.count >= 10 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' : examTags.toefl.count >= 6 ? 'ğŸ”¥ğŸ”¥' : 'ğŸ”¥';
            meaningHtml += '<div style="background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;padding:8px 14px;border-radius:12px;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(37,99,235,0.3);">';
            meaningHtml += '<span style="font-weight:700;font-size:13px;">TOEFL</span>';
            meaningHtml += '<span style="font-size:12px;opacity:0.9;">å‡ºç° ' + examTags.toefl.count + ' æ¬¡</span>';
            meaningHtml += '<span style="font-size:11px;">' + toeflHeat + '</span>';
            meaningHtml += '</div>';
            if (examTags.toefl.years && examTags.toefl.years.length > 0) {
                meaningHtml += '<div style="background:rgba(37,99,235,0.1);color:#1d4ed8;padding:6px 12px;border-radius:10px;font-size:11px;display:flex;align-items:center;gap:4px;">';
                meaningHtml += '<span>ğŸ“…</span><span>' + examTags.toefl.years.join(', ') + '</span>';
                meaningHtml += '</div>';
            }
        }
        
        meaningHtml += '</div>';
        meaningHtml += '</div>';
    }
    
    // V14-V19: ç§‘å­¦åŠ©è®°ç³»ç»Ÿ - UIä¼˜åŒ–å¢å¼ºç‰ˆ
    if (mnemonic || enhancedMnemonic.hasEnhancements) {
        meaningHtml += '<div class="word-mnemonic-v14" style="margin-bottom:16px;padding:0;border-radius:20px;overflow:hidden;border:1px solid rgba(192,132,252,0.15);box-shadow:0 8px 24px rgba(168,85,247,0.12),0 2px 8px rgba(0,0,0,0.04);">';
        
        // V16: å¤´éƒ¨é‡æ–°è®¾è®¡ - æ›´ç°ä»£çš„æ¸å˜å’Œå›¾æ ‡
        meaningHtml += '<div style="background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 35%,#6366f1 70%,#4f46e5 100%);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;position:relative;overflow:hidden;">';
        // V17: æ·»åŠ è£…é¥°æ€§èƒŒæ™¯å…ƒç´ 
        meaningHtml += '<div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(255,255,255,0.08);border-radius:50%;"></div>';
        meaningHtml += '<div style="position:absolute;bottom:-30px;left:40%;width:100px;height:100px;background:rgba(255,255,255,0.05);border-radius:50%;"></div>';
        meaningHtml += '<div style="display:flex;align-items:center;gap:12px;position:relative;z-index:1;">';
        // V18: æ›´ç²¾ç¾çš„å›¾æ ‡å®¹å™¨
        meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;background:rgba(255,255,255,0.18);border-radius:12px;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.2);box-shadow:0 2px 8px rgba(0,0,0,0.1);"><span style="font-size:20px;">ğŸ§¬</span></span>';
        meaningHtml += '<div><div style="color:white;font-weight:700;font-size:15px;text-shadow:0 1px 2px rgba(0,0,0,0.1);">ğŸ’¡ ç§‘å­¦è®°å¿†æ³•</div>';
        meaningHtml += '<div style="color:rgba(255,255,255,0.85);font-size:11px;display:flex;align-items:center;gap:4px;"><span style="font-size:10px;">ğŸ”¬</span> è®¤çŸ¥å¿ƒç†å­¦ Â· è®°å¿†å¢å¼º</div></div>';
        meaningHtml += '</div>';
        
        // V19: æ•ˆæœè¯„ä¼°æŒ‡ç¤ºå™¨ - å¢å¼ºè§†è§‰æ•ˆæœ
        var effectivenessScore = enhancedMnemonic.effectiveness ? Math.round(enhancedMnemonic.effectiveness.effectiveness * 100) : null;
        if (effectivenessScore !== null) {
            var scoreEmoji = effectivenessScore >= 90 ? 'ğŸ†' : effectivenessScore >= 75 ? 'â­' : effectivenessScore >= 50 ? 'ğŸ“ˆ' : 'ğŸ’ª';
            var scoreColor = effectivenessScore >= 80 ? '#4ade80' : effectivenessScore >= 50 ? '#fbbf24' : '#f87171';
            var scoreBg = effectivenessScore >= 80 ? 'rgba(74,222,128,0.2)' : effectivenessScore >= 50 ? 'rgba(251,191,36,0.2)' : 'rgba(248,113,113,0.2)';
            meaningHtml += '<div style="display:flex;align-items:center;gap:6px;background:' + scoreBg + ';padding:6px 12px;border-radius:24px;border:1px solid rgba(255,255,255,0.2);position:relative;z-index:1;">';
            meaningHtml += '<span style="font-size:14px;">' + scoreEmoji + '</span>';
            meaningHtml += '<span style="font-size:11px;color:white;opacity:0.9;">æ•ˆæœ</span>';
            meaningHtml += '<span style="font-weight:700;color:' + scoreColor + ';text-shadow:0 1px 2px rgba(0,0,0,0.2);">' + effectivenessScore + '%</span>';
            meaningHtml += '</div>';
        } else {
            // æ–°è¯æ˜¾ç¤º
            meaningHtml += '<div style="display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.15);padding:5px 10px;border-radius:20px;position:relative;z-index:1;">';
            meaningHtml += '<span style="font-size:12px;">âœ¨</span>';
            meaningHtml += '<span style="font-size:11px;color:white;font-weight:500;">æ–°å­¦ä¹ </span>';
            meaningHtml += '</div>';
        }
        meaningHtml += '</div>';
        
        // ä¸»ä½“å†…å®¹åŒº
        meaningHtml += '<div style="background:linear-gradient(135deg,#fdf4ff 0%,#fae8ff 100%);padding:16px;">';
        
        // é€‰æ‹©æœ€ä½³åŠ©è®°æ¥æºï¼ˆç”¨æˆ·è‡ªå®šä¹‰ > ç³»ç»Ÿç”Ÿæˆï¼‰
        var activeMnemonic = enhancedMnemonic.custom || mnemonic;
        
        if (activeMnemonic) {
            // V16: åŠ©è®°ç±»å‹æ ‡ç­¾ - é‡æ–°è®¾è®¡
            var mnemonicType = activeMnemonic.type || 'etymology';
            var typeInfo = MNEMONIC_SCIENCE.types[mnemonicType] || MNEMONIC_SCIENCE.types['etymology'];
            var effEmoji = MNEMONIC_SCIENCE.effectivenessEmoji(typeInfo.effectiveness);
            
            meaningHtml += '<div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:14px;">';
            // ç±»å‹å›¾æ ‡å®¹å™¨
            meaningHtml += '<div style="display:flex;align-items:center;gap:8px;padding:6px 14px;background:' + (typeInfo.bgGradient || typeInfo.bg) + ';border-radius:24px;border:1px solid ' + typeInfo.color + '22;box-shadow:0 2px 6px ' + typeInfo.color + '15;">';
            meaningHtml += '<span style="font-size:18px;filter:drop-shadow(0 1px 1px rgba(0,0,0,0.1));">' + typeInfo.icon + '</span>';
            meaningHtml += '<span style="font-size:13px;color:' + typeInfo.color + ';font-weight:700;">' + typeInfo.name + '</span>';
            meaningHtml += '</div>';
            // æœ‰æ•ˆæ€§å¾½ç« 
            meaningHtml += '<div style="display:flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,#fefce8,#fef9c3);border-radius:16px;border:1px solid #fde04733;">';
            meaningHtml += '<span style="font-size:12px;">' + effEmoji.emoji + '</span>';
            meaningHtml += '<span style="font-size:11px;color:#854d0e;font-weight:600;">' + Math.round(typeInfo.effectiveness * 100) + '% æœ‰æ•ˆ</span>';
            meaningHtml += '</div>';
            if (enhancedMnemonic.custom) {
                meaningHtml += '<div style="display:flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,#eff6ff,#dbeafe);border-radius:16px;border:1px solid #3b82f622;">';
                meaningHtml += '<span style="font-size:11px;">âœ¨</span>';
                meaningHtml += '<span style="font-size:11px;color:#1e40af;font-weight:600;">æˆ‘çš„åˆ›ä½œ</span>';
                meaningHtml += '</div>';
            }
            meaningHtml += '</div>';
            
            // V17: ä¸»åŠ©è®°å†…å®¹ - æ›´ç²¾ç¾çš„å¡ç‰‡è®¾è®¡
            meaningHtml += '<div style="font-size:16px;color:#581c87;line-height:1.8;font-weight:500;padding:14px 16px;background:linear-gradient(135deg,#ffffff,#fefbff);border-radius:14px;border-left:5px solid;border-image:linear-gradient(180deg,#a855f7,#7c3aed) 1;margin-bottom:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.8),0 2px 8px rgba(168,85,247,0.08);position:relative;">';
            meaningHtml += '<span style="position:absolute;top:8px;right:10px;font-size:16px;opacity:0.15;">ğŸ’¡</span>';
            meaningHtml += activeMnemonic.mnemonic;
            meaningHtml += '</div>';
            
            // V18: è¯æ ¹ä¿¡æ¯ - æ›´ç²¾ç¾çš„ä¿¡æ¯å¡ç‰‡
            if (activeMnemonic.roots) {
                meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(139,92,246,0.04));border-radius:12px;margin-bottom:10px;border:1px solid rgba(139,92,246,0.12);">';
                meaningHtml += '<span style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:linear-gradient(135deg,#a855f7,#7c3aed);border-radius:10px;font-size:16px;box-shadow:0 2px 6px rgba(168,85,247,0.3);flex-shrink:0;">ğŸŒ³</span>';
                meaningHtml += '<div style="flex:1;"><div style="font-size:11px;color:#7c3aed;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:4px;"><span style="font-size:10px;">ğŸ“œ</span> è¯æ ¹è§£æ Etymology</div>';
                meaningHtml += '<div style="font-size:13px;color:#6b21a8;line-height:1.6;">' + activeMnemonic.roots + '</div></div>';
                meaningHtml += '</div>';
            }
            
            // V18: è”æƒ³ç”»é¢ - æ›´ç”ŸåŠ¨çš„è§†è§‰è®¾è®¡
            if (activeMnemonic.association) {
                meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(59,130,246,0.08),rgba(59,130,246,0.03));border-radius:12px;margin-bottom:10px;border:1px solid rgba(59,130,246,0.12);">';
                meaningHtml += '<span style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:10px;font-size:16px;box-shadow:0 2px 6px rgba(59,130,246,0.3);flex-shrink:0;">ğŸ–¼ï¸</span>';
                meaningHtml += '<div style="flex:1;"><div style="font-size:11px;color:#2563eb;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:4px;"><span style="font-size:10px;">ğŸ‘ï¸</span> è§†è§‰è”æƒ³ Dual Coding</div>';
                meaningHtml += '<div style="font-size:13px;color:#1e40af;font-style:italic;line-height:1.6;padding:8px 10px;background:rgba(255,255,255,0.6);border-radius:8px;border-left:3px solid #3b82f6;">"' + activeMnemonic.association + '"</div></div>';
                meaningHtml += '</div>';
            }
        }
        
        // V19: è®°å¿†å®«æ®¿ä½ç½® - å¢å¼ºè§†è§‰è®¾è®¡
        if (enhancedMnemonic.memoryPalace) {
            var location = memoryPalaceData.locations.find(function(l) { return l.id === enhancedMnemonic.memoryPalace.locationId; });
            var locIcon = location ? location.icon : 'ğŸ›ï¸';
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(139,92,246,0.12),rgba(139,92,246,0.05));border-radius:14px;margin-bottom:10px;border:1px solid rgba(139,92,246,0.15);position:relative;overflow:hidden;">';
            meaningHtml += '<div style="position:absolute;top:-10px;right:-10px;font-size:40px;opacity:0.08;">' + locIcon + '</div>';
            meaningHtml += '<span style="display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:linear-gradient(135deg,#8b5cf6,#6366f1);border-radius:12px;font-size:18px;box-shadow:0 3px 10px rgba(139,92,246,0.35);flex-shrink:0;">ğŸ°</span>';
            meaningHtml += '<div style="flex:1;"><div style="font-size:11px;color:#7c3aed;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:4px;"><span style="font-size:12px;">ğŸ“</span> è®°å¿†å®«æ®¿å®šä½</div>';
            meaningHtml += '<div style="font-size:13px;color:#5b21b6;line-height:1.6;"><span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(139,92,246,0.15);border-radius:6px;margin-right:6px;"><span style="font-size:14px;">' + locIcon + '</span><strong>' + (location ? location.name : 'ä½ç½®') + '</strong></span>' + enhancedMnemonic.memoryPalace.image + '</div></div>';
            meaningHtml += '</div>';
        }
        
        // V19: æƒ…æ„Ÿé”šå®š - æ›´ç”ŸåŠ¨çš„è§†è§‰è¡¨è¾¾
        if (enhancedMnemonic.emotionalAnchor) {
            var emo = enhancedMnemonic.emotionalAnchor;
            var intensityBars = '';
            for (var i = 1; i <= 10; i++) {
                var isActive = i <= emo.intensity;
                intensityBars += '<span style="display:inline-block;width:8px;height:' + (4 + i * 1.5) + 'px;background:' + (isActive ? emo.data.color : 'rgba(0,0,0,0.1)') + ';border-radius:2px;margin-right:1px;transition:all 0.2s;"></span>';
            }
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(236,72,153,0.1),rgba(236,72,153,0.04));border-radius:14px;margin-bottom:10px;border:1px solid rgba(236,72,153,0.15);position:relative;overflow:hidden;">';
            meaningHtml += '<div style="position:absolute;top:-15px;right:-15px;font-size:50px;opacity:0.06;">' + emo.data.icon + '</div>';
            meaningHtml += '<span style="display:flex;align-items:center;justify-content:center;width:42px;height:42px;background:linear-gradient(135deg,#ec4899,#db2777);border-radius:50%;font-size:22px;box-shadow:0 3px 10px rgba(236,72,153,0.35);flex-shrink:0;animation:pulse-soft 2s infinite;">' + emo.data.icon + '</span>';
            meaningHtml += '<div style="flex:1;"><div style="font-size:11px;color:#be185d;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:4px;"><span style="font-size:12px;">ğŸ’«</span> æƒ…æ„Ÿè®°å¿†é”šç‚¹</div>';
            meaningHtml += '<div style="font-size:14px;color:#9d174d;font-weight:600;margin-bottom:6px;">' + emo.data.name + '</div>';
            meaningHtml += '<div style="display:flex;align-items:flex-end;gap:2px;">' + intensityBars + '<span style="margin-left:6px;font-size:11px;color:#be185d;font-weight:600;">' + emo.intensity + '/10</span></div></div>';
            meaningHtml += '</div>';
        }
        
        // V19: åˆ†å—è®°å¿†ç»„ - æ›´ç²¾ç¾çš„æ ‡ç­¾è®¾è®¡
        if (enhancedMnemonic.chunkGroup) {
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:linear-gradient(135deg,rgba(20,184,166,0.1),rgba(20,184,166,0.04));border-radius:14px;margin-bottom:10px;border:1px solid rgba(20,184,166,0.15);position:relative;overflow:hidden;">';
            meaningHtml += '<div style="position:absolute;top:-10px;right:-10px;font-size:40px;opacity:0.06;">ğŸ§©</div>';
            meaningHtml += '<span style="display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:linear-gradient(135deg,#14b8a6,#0d9488);border-radius:12px;font-size:18px;box-shadow:0 3px 10px rgba(20,184,166,0.35);flex-shrink:0;">ğŸ§©</span>';
            meaningHtml += '<div style="flex:1;"><div style="font-size:11px;color:#0f766e;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:4px;"><span style="font-size:12px;">ğŸ”—</span> è®°å¿†åˆ†å—: <span style="padding:2px 8px;background:linear-gradient(135deg,#14b8a6,#0d9488);color:white;border-radius:10px;font-size:10px;">' + enhancedMnemonic.chunkGroup.name + '</span></div>';
            meaningHtml += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
            enhancedMnemonic.chunkGroup.words.slice(0, 6).forEach(function(w, idx) {
                var isCurrent = w.toLowerCase() === wordData.word.toLowerCase();
                if (isCurrent) {
                    meaningHtml += '<span style="padding:4px 12px;background:linear-gradient(135deg,#14b8a6,#0d9488);color:white;border-radius:20px;font-size:12px;font-weight:700;box-shadow:0 2px 6px rgba(20,184,166,0.4);display:flex;align-items:center;gap:4px;"><span>ğŸ‘‰</span>' + w + '</span>';
                } else {
                    meaningHtml += '<span style="padding:4px 12px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);color:#0f766e;border-radius:20px;font-size:12px;font-weight:500;border:1px solid rgba(20,184,166,0.2);display:flex;align-items:center;gap:3px;"><span style=\"opacity:0.6;font-size:10px;\">' + (idx + 1) + '</span>' + w + '</span>';
                }
            });
            if (enhancedMnemonic.chunkGroup.words.length > 6) {
                meaningHtml += '<span style="padding:4px 10px;background:#f0fdfa;color:#0d9488;border-radius:20px;font-size:11px;font-weight:600;border:1px dashed #99f6e4;">+' + (enhancedMnemonic.chunkGroup.words.length - 6) + ' more</span>';
            }
            meaningHtml += '</div></div></div>';
        }
        
        // V19: æ“ä½œæŒ‰é’®åŒº - å®Œå…¨é‡æ–°è®¾è®¡çš„åœ†è§’èƒ¶å›ŠæŒ‰é’®
        meaningHtml += '<div style="margin-top:16px;padding-top:16px;border-top:2px solid rgba(168,85,247,0.1);position:relative;">';
        meaningHtml += '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#fdf4ff,#fae8ff);padding:2px 12px;border-radius:10px;border:1px solid rgba(168,85,247,0.15);"><span style="font-size:10px;color:#9333ea;font-weight:600;">âœ¨ è®°å¿†å·¥å…·ç®± âœ¨</span></div>';
        
        // ç¬¬ä¸€è¡Œï¼šåé¦ˆæŒ‰é’®
        meaningHtml += '<div style="display:flex;gap:10px;margin-bottom:10px;margin-top:8px;">';
        meaningHtml += '<button onclick="rateMnemonicEffectiveness(\'' + wordData.word + '\', true)" style="flex:1;padding:12px 16px;background:linear-gradient(135deg,#10b981 0%,#059669 50%,#047857 100%);border:none;border-radius:28px;color:white;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 14px rgba(16,185,129,0.35),inset 0 1px 0 rgba(255,255,255,0.2);transition:all 0.2s ease;position:relative;overflow:hidden;"><span style=\"font-size:18px;\">âœ…</span><span>è®°ä½äº†!</span></button>';
        meaningHtml += '<button onclick="rateMnemonicEffectiveness(\'' + wordData.word + '\', false)" style="flex:1;padding:12px 16px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 50%,#b45309 100%);border:none;border-radius:28px;color:white;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 14px rgba(245,158,11,0.35),inset 0 1px 0 rgba(255,255,255,0.2);transition:all 0.2s ease;"><span style=\"font-size:18px;\">ğŸ”</span><span>å†å¼ºåŒ–</span></button>';
        meaningHtml += '</div>';
        
        // ç¬¬äºŒè¡Œï¼šåŠŸèƒ½æŒ‰é’®
        meaningHtml += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">';
        
        // ç»ƒä¹ æŒ‰é’® - é»„è‰²
        meaningHtml += '<button onclick="startMnemonicPractice(\'' + wordData.word + '\')" style="padding:10px 6px;background:linear-gradient(180deg,#fef3c7 0%,#fde68a 100%);border:1px solid #fcd34d;border-radius:14px;color:#92400e;font-size:10px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 2px 8px rgba(251,191,36,0.2);transition:all 0.15s ease;"><span style=\"font-size:20px;\">ğŸ‹ï¸</span><span>ç»ƒä¹ </span></button>';
        
        // è‡ªå®šä¹‰æŒ‰é’® - ç´«è‰²
        meaningHtml += '<button onclick="showCustomMnemonicEditor(\'' + wordData.word + '\')" style="padding:10px 6px;background:linear-gradient(180deg,#f3e8ff 0%,#e9d5ff 100%);border:1px solid #d8b4fe;border-radius:14px;color:#7c3aed;font-size:10px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 2px 8px rgba(139,92,246,0.2);transition:all 0.15s ease;"><span style=\"font-size:20px;\">ğŸ¨</span><span>åˆ›ä½œ</span></button>';
        
        // å®«æ®¿æŒ‰é’® - é›è“è‰²
        meaningHtml += '<button onclick="showMemoryPalaceEditor(\'' + wordData.word + '\')" style="padding:10px 6px;background:linear-gradient(180deg,#e0e7ff 0%,#c7d2fe 100%);border:1px solid #a5b4fc;border-radius:14px;color:#4338ca;font-size:10px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 2px 8px rgba(99,102,241,0.2);transition:all 0.15s ease;"><span style=\"font-size:20px;\">ğŸ°</span><span>å®«æ®¿</span></button>';
        
        // ç»Ÿè®¡æŒ‰é’® - ç²‰è‰²
        meaningHtml += '<button onclick="showMnemonicStats()" style="padding:10px 6px;background:linear-gradient(180deg,#fce7f3 0%,#fbcfe8 100%);border:1px solid #f9a8d4;border-radius:14px;color:#be185d;font-size:10px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 2px 8px rgba(236,72,153,0.2);transition:all 0.15s ease;"><span style=\"font-size:20px;\">ğŸ“ˆ</span><span>ç»Ÿè®¡</span></button>';
        
        meaningHtml += '</div>';
        meaningHtml += '</div>';
        
        meaningHtml += '</div>'; // ä¸»ä½“å†…å®¹åŒºç»“æŸ
        meaningHtml += '</div>'; // æ•´ä¸ªåŠ©è®°å¡ç‰‡ç»“æŸ
    } else {
        // æ²¡æœ‰åŠ©è®°æ—¶æ˜¾ç¤ºæ·»åŠ å»ºè®®
        var recommended = MNEMONIC_SCIENCE.recommendType(wordData.word, mnemonicEffectivenessData._typeStats || {});
        var recType = MNEMONIC_SCIENCE.types[recommended.type];
        
        meaningHtml += '<div style="margin-bottom:16px;padding:16px;background:linear-gradient(135deg,#f9fafb 0%,#f3f4f6 100%);border-radius:12px;border:2px dashed #d1d5db;">';
        meaningHtml += '<div style="text-align:center;">';
        meaningHtml += '<div style="font-size:32px;margin-bottom:8px;">ğŸ’¡</div>';
        meaningHtml += '<div style="font-size:14px;color:#6b7280;margin-bottom:12px;">æš‚æ— è®°å¿†æŠ€å·§ï¼Œå»ºè®®æ·»åŠ </div>';
        meaningHtml += '<div style="margin-bottom:12px;padding:8px;background:' + recType.bg + ';border-radius:8px;display:inline-block;">';
        meaningHtml += '<span style="font-size:16px;margin-right:6px;">' + recType.icon + '</span>';
        meaningHtml += '<span style="color:' + recType.color + ';font-weight:600;font-size:13px;">æ¨è: ' + recType.name + '</span>';
        meaningHtml += '<div style="font-size:11px;color:' + recType.color + ';opacity:0.8;margin-top:4px;">' + recType.description + '</div>';
        meaningHtml += '</div>';
        meaningHtml += '<button onclick="showCustomMnemonicEditor(\'' + wordData.word + '\')" style="padding:10px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;border-radius:10px;color:white;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,0.3);">âœ¨ åˆ›å»ºæˆ‘çš„è®°å¿†æ³•</button>';
        meaningHtml += '</div></div>';
    }
    
    // V11: åŒä¹‰è¯/åä¹‰è¯æ˜¾ç¤º
    if (relations) {
        meaningHtml += '<div class="word-relations" style="margin-bottom:16px;padding:14px;background:linear-gradient(135deg,#fefce8 0%,#fef9c3 100%);border-radius:12px;border:1px solid rgba(234,179,8,0.2);">';
        
        // åŒä¹‰è¯
        if (relations.synonyms && relations.synonyms.length > 0) {
            meaningHtml += '<div style="margin-bottom:10px;display:flex;align-items:flex-start;gap:10px;">';
            meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);border-radius:7px;box-shadow:0 2px 6px rgba(34,197,94,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg></span>';
            meaningHtml += '<div><span style="font-weight:700;color:#15803d;font-size:13px;">åŒä¹‰è¯ Synonyms</span><div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:6px;">';
            relations.synonyms.forEach(function(syn) {
                meaningHtml += '<span style="display:inline-block;padding:4px 10px;background:white;border-radius:6px;font-size:13px;color:#166534;border:1px solid #bbf7d0;font-weight:500;">' + syn + '</span>';
            });
            meaningHtml += '</div></div></div>';
        }
        
        // åä¹‰è¯
        if (relations.antonyms && relations.antonyms.length > 0) {
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;">';
            meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);border-radius:7px;box-shadow:0 2px 6px rgba(239,68,68,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M5 12h14"/></svg></span>';
            meaningHtml += '<div><span style="font-weight:700;color:#b91c1c;font-size:13px;">åä¹‰è¯ Antonyms</span><div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:6px;">';
            relations.antonyms.forEach(function(ant) {
                meaningHtml += '<span style="display:inline-block;padding:4px 10px;background:white;border-radius:6px;font-size:13px;color:#991b1b;border:1px solid #fecaca;font-weight:500;">' + ant + '</span>';
            });
            meaningHtml += '</div></div></div>';
        }
        
        meaningHtml += '</div>';
    }
    
    if (wordData.example) {
        meaningHtml += '<div class="word-example" style="color:#6b7280;font-size:14px;font-style:italic;padding-top:16px;border-top:1px solid #e5e7eb;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:7px;box-shadow:0 2px 6px rgba(245,158,11,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>' + wordData.example + '</span></div>';
    }
    
    // V15: ä¸°å¯Œä¾‹å¥å±•ç¤º
    var wordExamples = getWordExamples(wordData.word);
    if (wordExamples && wordExamples.examples && wordExamples.examples.length > 0) {
        meaningHtml += '<div class="rich-examples-section" style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">';
        meaningHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">';
        meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border-radius:8px;box-shadow:0 2px 6px rgba(139,92,246,0.3);">';
        meaningHtml += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>';
        meaningHtml += '</span>';
        meaningHtml += '<span style="font-weight:600;font-size:14px;color:#7c3aed;">ä¸°å¯Œè¯­å¢ƒä¾‹å¥</span>';
        meaningHtml += '<span style="font-size:12px;color:#9ca3af;margin-left:auto;">' + wordExamples.examples.length + ' ä¸ªä¾‹å¥</span>';
        meaningHtml += '</div>';
        
        wordExamples.examples.forEach(function(example, index) {
            var sourceColors = {
                'GREçœŸé¢˜': { bg: '#fef3c7', text: '#d97706', border: '#fcd34d' },
                'TOEFLçœŸé¢˜': { bg: '#dbeafe', text: '#2563eb', border: '#93c5fd' },
                'å­¦æœ¯æœŸåˆŠ': { bg: '#dcfce7', text: '#16a34a', border: '#86efac' },
                'ç»æµå­¦äºº': { bg: '#fce7f3', text: '#db2777', border: '#f9a8d4' },
                'çº½çº¦æ—¶æŠ¥': { bg: '#e0e7ff', text: '#4f46e5', border: '#a5b4fc' },
                'ç§‘å­¦ç¾å›½äºº': { bg: '#ccfbf1', text: '#0d9488', border: '#5eead4' },
                'å¤§è¥¿æ´‹æœˆåˆŠ': { bg: '#fef9c3', text: '#ca8a04', border: '#fde047' },
                'åè‘—æ–‡å­¦': { bg: '#f3e8ff', text: '#9333ea', border: '#d8b4fe' }
            };
            var sourceStyle = sourceColors[example.source] || { bg: '#f3f4f6', text: '#6b7280', border: '#d1d5db' };
            
            meaningHtml += '<div style="background:linear-gradient(135deg,#fafafa 0%,#f5f5f5 100%);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid #e5e7eb;">';
            meaningHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">';
            meaningHtml += '<span style="width:20px;height:20px;background:#8b5cf6;color:white;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;">' + (index + 1) + '</span>';
            meaningHtml += '<span style="font-size:11px;padding:3px 8px;background:' + sourceStyle.bg + ';color:' + sourceStyle.text + ';border:1px solid ' + sourceStyle.border + ';border-radius:12px;font-weight:500;">' + example.source + '</span>';
            meaningHtml += '</div>';
            meaningHtml += '<p style="font-size:14px;color:#374151;line-height:1.6;margin:0 0 8px 0;font-style:italic;">"' + example.en + '"</p>';
            meaningHtml += '<p style="font-size:13px;color:#6b7280;line-height:1.5;margin:0;padding-left:12px;border-left:3px solid #8b5cf6;">' + example.cn + '</p>';
            meaningHtml += '</div>';
        });
        
        meaningHtml += '</div>';
    }
    
    document.getElementById('meaningCn').innerHTML = meaningHtml;
    document.getElementById('meaningEn').innerHTML = '';
    document.getElementById('wordExample').innerHTML = '';
    
    document.getElementById('wordMeaning').classList.remove('hidden');
    document.getElementById('showMeaningBtn').classList.add('hidden');
    document.getElementById('rateButtons').classList.remove('hidden');
    
    // V3: æ›´æ–°å¤ä¹ é—´éš”æ˜¾ç¤º
    updateIntervalDisplay();
}

// ==================== V1-V10: Ankié£æ ¼æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ ====================

// V2: æ™ºèƒ½å³æ—¶å¤ä¹ é˜Ÿåˆ—ç®¡ç†å™¨
var immediateReviewQueue = []; // å³æ—¶å¤ä¹ é˜Ÿåˆ—ï¼ˆå›°éš¾/é‡å­¦çš„å•è¯ï¼‰
var hardWordsInSession = []; // æœ¬è½®æ ‡è®°ä¸ºå›°éš¾çš„å•è¯

// V8: è‡ªé€‚åº”éš¾åº¦ç³»ç»Ÿ
var adaptiveDifficulty = {
    // ç”¨æˆ·å†å²è¡¨ç°
    recentPerformance: [], // æœ€è¿‘20æ¬¡è¯„åˆ†
    averageAccuracy: 0.7, // å¹³å‡å‡†ç¡®ç‡
    learningSpeed: 'normal', // slow, normal, fast
    preferredMode: 'balanced' // easy, balanced, challenging
};

// V8: åŠ è½½ç”¨æˆ·å­¦ä¹ ç‰¹å¾
function loadAdaptiveDifficulty() {
    try {
        var saved = localStorage.getItem('adaptiveDifficulty');
        if (saved) {
            adaptiveDifficulty = JSON.parse(saved);
        }
    } catch(e) {}
}

// V8: æ›´æ–°è‡ªé€‚åº”éš¾åº¦
function updateAdaptiveDifficulty(rating) {
    var isCorrect = (rating === 'good' || rating === 'easy');
    adaptiveDifficulty.recentPerformance.push(isCorrect ? 1 : 0);
    
    // ä¿æŒæœ€è¿‘20æ¬¡è®°å½•
    if (adaptiveDifficulty.recentPerformance.length > 20) {
        adaptiveDifficulty.recentPerformance.shift();
    }
    
    // è®¡ç®—å¹³å‡å‡†ç¡®ç‡
    var sum = adaptiveDifficulty.recentPerformance.reduce(function(a, b) { return a + b; }, 0);
    adaptiveDifficulty.averageAccuracy = sum / adaptiveDifficulty.recentPerformance.length;
    
    // ç¡®å®šå­¦ä¹ é€Ÿåº¦
    if (adaptiveDifficulty.averageAccuracy >= 0.85) {
        adaptiveDifficulty.learningSpeed = 'fast';
    } else if (adaptiveDifficulty.averageAccuracy <= 0.55) {
        adaptiveDifficulty.learningSpeed = 'slow';
    } else {
        adaptiveDifficulty.learningSpeed = 'normal';
    }
    
    // ä¿å­˜
    localStorage.setItem('adaptiveDifficulty', JSON.stringify(adaptiveDifficulty));
}

// V8: è·å–è‡ªé€‚åº”è°ƒæ•´å› å­
function getAdaptiveFactor(rating) {
    var factor = 1.0;
    
    switch(adaptiveDifficulty.learningSpeed) {
        case 'fast':
            // å­¦å¾—å¿«ï¼šå¢åŠ é—´éš”ï¼Œå‡å°‘å¤ä¹ é¢‘ç‡
            if (rating === 'good' || rating === 'easy') factor = 1.15;
            break;
        case 'slow':
            // å­¦å¾—æ…¢ï¼šå‡å°‘é—´éš”ï¼Œå¢åŠ å¤ä¹ é¢‘ç‡
            if (rating === 'hard' || rating === 'again') factor = 0.85;
            break;
    }
    
    return factor;
}

// V3 & V8: è®¡ç®—å¹¶æ˜¾ç¤ºå¤ä¹ é—´éš”ï¼ˆå¸¦è‡ªé€‚åº”è°ƒæ•´ï¼‰
function calculateReviewInterval(word, rating) {
    var wordProgress = wordLearningProgress[word] || {};
    var easeFactor = wordProgress.easeFactor || 2.5;
    var currentInterval = wordProgress.interval || 0;
    var repetitions = wordProgress.repetitions || 0;
    
    // V8: è·å–è‡ªé€‚åº”å› å­
    var adaptiveFactor = getAdaptiveFactor(rating);
    
    var interval = 0;
    var nextEaseFactor = easeFactor;
    
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³å¤ä¹ 
            interval = 0; // ç«‹å³ï¼ˆ<1åˆ†é’Ÿï¼‰
            nextEaseFactor = Math.max(1.3, easeFactor - 0.2);
            break;
        case 'hard': // å›°éš¾ - 1å¤©å
            interval = Math.max(1, Math.round(currentInterval * 1.2 * adaptiveFactor));
            nextEaseFactor = Math.max(1.3, easeFactor - 0.15);
            break;
        case 'good': // è‰¯å¥½ - æ­£å¸¸é—´éš”
            if (repetitions === 0) {
                interval = 1;
            } else if (repetitions === 1) {
                interval = 3;
            } else {
                interval = Math.round(currentInterval * easeFactor * adaptiveFactor);
            }
            break;
        case 'easy': // ç®€å• - å»¶é•¿é—´éš”
            if (repetitions === 0) {
                interval = 4;
            } else {
                interval = Math.round(currentInterval * easeFactor * 1.3 * adaptiveFactor);
            }
            nextEaseFactor = Math.min(2.5, easeFactor + 0.15);
            break;
    }
    
    return {
        interval: interval,
        easeFactor: nextEaseFactor,
        displayText: formatInterval(interval)
    };
}

// æ ¼å¼åŒ–é—´éš”æ—¶é—´æ˜¾ç¤º
function formatInterval(days) {
    if (days === 0) return '<1åˆ†é’Ÿ';
    if (days === 1) return '1å¤©';
    if (days < 7) return days + 'å¤©';
    if (days < 30) return Math.round(days / 7) + 'å‘¨';
    if (days < 365) return Math.round(days / 30) + 'æœˆ';
    return Math.round(days / 365) + 'å¹´';
}

// V3: æ›´æ–°é—´éš”æ˜¾ç¤º
function updateIntervalDisplay() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // è®¡ç®—å„è¯„åˆ†å¯¹åº”çš„é—´éš”
    var intervals = {
        again: calculateReviewInterval(word, 'again'),
        hard: calculateReviewInterval(word, 'hard'),
        good: calculateReviewInterval(word, 'good'),
        easy: calculateReviewInterval(word, 'easy')
    };
    
    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    var againInterval = document.getElementById('againInterval');
    var hardInterval = document.getElementById('hardInterval');
    var goodInterval = document.getElementById('goodInterval');
    var easyInterval = document.getElementById('easyInterval');
    
    if (againInterval) againInterval.textContent = intervals.again.displayText;
    if (hardInterval) hardInterval.textContent = intervals.hard.displayText;
    if (goodInterval) goodInterval.textContent = intervals.good.displayText;
    if (easyInterval) easyInterval.textContent = intervals.easy.displayText;
}

// V1 & V2 & V4 & V8: é‡å†™è¯„åˆ†å‡½æ•° - Ankié£æ ¼æ™ºèƒ½å¤ä¹ ï¼ˆå¸¦è‡ªé€‚åº”éš¾åº¦ï¼‰
function rateWord(rating) {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // V8: æ›´æ–°è‡ªé€‚åº”éš¾åº¦
    updateAdaptiveDifficulty(rating);
    
    // V1: æ›´æ–°æŒæ¡åº¦è¿½è¸ª
    var masteryResult = 'partial';
    var masteryOptions = { type: 'review' };
    
    switch(rating) {
        case 'again':
            masteryResult = 'wrong';
            masteryOptions.meaningScore = 20;
            break;
        case 'hard':
            masteryResult = 'partial';
            masteryOptions.meaningScore = 50;
            break;
        case 'good':
            masteryResult = 'correct';
            masteryOptions.meaningScore = 80;
            break;
        case 'easy':
            masteryResult = 'correct';
            masteryOptions.meaningScore = 100;
            break;
    }
    
    updateWordMastery(word, masteryResult, masteryOptions);
    
    // æ›´æ–°æœ¬è½®å­¦ä¹ è¿›åº¦
    var sessionProgress = sessionWordProgress[word] || { times: 0, completed: false };
    
    // V2: æ ¹æ®è¯„åˆ†å¤„ç†å³æ—¶å¤ä¹ é˜Ÿåˆ—
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³åŠ å…¥å³æ—¶å¤ä¹ é˜Ÿåˆ—
            // ä¸å¢åŠ å­¦ä¹ æ¬¡æ•°
            addToImmediateReview(wordData, 1); // 1ä¸ªå•è¯åç«‹å³å¤ä¹ 
            showRatingFeedback('again', 'é©¬ä¸Šå†æ¥ä¸€æ¬¡ï¼ğŸ’ª');
            break;
            
        case 'hard': // å›°éš¾ - ç¨ååœ¨æœ¬ç»„å†…å¤ä¹ 
            // å¢åŠ å­¦ä¹ æ¬¡æ•°ä½†æ ‡è®°ä¸ºå›°éš¾
            sessionProgress.times++;
            if (hardWordsInSession.indexOf(word) === -1) {
                hardWordsInSession.push(word);
            }
            addToImmediateReview(wordData, 3); // 3ä¸ªå•è¯åå¤ä¹ 
            showRatingFeedback('hard', 'ç¨åå†å¤ä¹  ğŸ“');
            break;
            
        case 'good': // è‰¯å¥½ - æ­£å¸¸è¿›åº¦
            sessionProgress.times++;
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var hardIndex = hardWordsInSession.indexOf(word);
            if (hardIndex > -1) hardWordsInSession.splice(hardIndex, 1);
            showRatingFeedback('good', 'ç»§ç»­ä¿æŒï¼âœ“');
            break;
            
        case 'easy': // ç®€å• - åŠ é€ŸæŒæ¡
            sessionProgress.times += 2; // ç®€å•ç›´æ¥+2æ¬¡è¿›åº¦
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var easyHardIndex = hardWordsInSession.indexOf(word);
            if (easyHardIndex > -1) hardWordsInSession.splice(easyHardIndex, 1);
            showRatingFeedback('easy', 'å¤ªæ£’äº†ï¼ğŸ‰');
            break;
            
        // å…¼å®¹æ—§ç‰ˆè¯„åˆ†
        case 'medium':
            rating = 'good';
            sessionProgress.times++;
            break;
    }
    
    // åˆ¤æ–­æœ¬è½®æ˜¯å¦å®Œæˆ
    if (sessionProgress.times >= requiredLearningTimes) {
        sessionProgress.completed = true;
        showCompletionToast(word);
        
        // æ›´æ–°å…¨å±€å­¦ä¹ è¿›åº¦ (V4: SM-2ç®—æ³•)
        var intervalData = calculateReviewInterval(word, rating);
        var globalProgress = wordLearningProgress[word] || { 
            times: 0, 
            completed: false, 
            ratings: [],
            easeFactor: 2.5,
            interval: 0,
            repetitions: 0
        };
        
        globalProgress.times = sessionProgress.times;
        globalProgress.completed = true;
        globalProgress.ratings.push(rating);
        globalProgress.lastReview = new Date().toISOString();
        globalProgress.easeFactor = intervalData.easeFactor;
        globalProgress.interval = intervalData.interval;
        globalProgress.repetitions = (globalProgress.repetitions || 0) + 1;
        
        // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        var nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + intervalData.interval);
        globalProgress.nextReview = nextReview.toISOString();
        
        wordLearningProgress[word] = globalProgress;
        localStorage.setItem('wordLearningProgress', JSON.stringify(wordLearningProgress));
        
        // è®°å½•ä¸ºå·²å­¦
        if (learnedWords.indexOf(word) === -1) {
            learnedWords.push(word);
            localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
            localStorage.setItem('learnedCount', learnedWords.length.toString());
            
            // æ›´æ–°ä»Šæ—¥ç›®æ ‡è¿›åº¦
            if (typeof updateDailyProgress === 'function') {
                updateDailyProgress('vocabulary', 1);
            }
            
            // v3.5.0: è§¦å‘æˆå°±æ£€æŸ¥
            if (window.UX && window.UX.Achievements) {
                window.UX.Achievements.checkWordCount(learnedWords.length);
                if (learnedWords.length % 10 === 0) {
                    const msg = window.UX.EncouragementSystem.getRandom('milestone');
                    window.UX.showSmartToast(msg, 'achievement');
                } else if (Math.random() < 0.3) {
                    const msg = window.UX.EncouragementSystem.getRandom('progress');
                    window.UX.showSmartToast(msg, 'success');
                }
                window.UX.LevelSystem.checkLevelUp();
            }
        }
        
        // å¦‚æœè¯„åˆ†ä¸ºç®€å•ï¼Œæ ‡è®°ä¸ºå·²æŒæ¡
        if (rating === 'easy') {
            var mastered = parseInt(localStorage.getItem('masteredCount') || '0');
            localStorage.setItem('masteredCount', (mastered + 1).toString());
        }
    }
    
    sessionWordProgress[word] = sessionProgress;
    
    // ä¿å­˜è¯„åˆ†ï¼ˆV4: åŒ…å«SM-2æ•°æ®ï¼‰
    var intervalInfo = calculateReviewInterval(word, rating);
    var prevCount = wordRatings[word] ? wordRatings[word].count : 0;
    wordRatings[word] = {
        rating: rating,
        lastReview: new Date().toISOString(),
        count: prevCount + 1,
        interval: intervalInfo.interval,
        easeFactor: intervalInfo.easeFactor,
        learningProgress: sessionProgress
    };
    localStorage.setItem('wordRatings', JSON.stringify(wordRatings));
    
    // åˆ·æ–°UI
    updateVocabProgress();
    updateLearningBadge();
    updateLearningProgressIndicator();
    
    // V9: æ›´æ–°å­¦ä¹ ç»Ÿè®¡
    updateSessionStats(rating);
    
    // è§¦å‘å…¨å±€å­¦ä¹ è¿›åº¦æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularyProgressUpdated', {
            detail: {
                word: word,
                rating: rating,
                sessionProgress: sessionProgress,
                totalLearned: learnedWords.length,
                interval: intervalInfo.interval
            }
        }));
    } catch(e) {}
    
    // ä¸‹ä¸€ä¸ªè¯
    nextWord();
}

// V2: æ·»åŠ åˆ°å³æ—¶å¤ä¹ é˜Ÿåˆ—
function addToImmediateReview(wordData, gap) {
    var insertIndex = Math.min(currentQueueIndex + gap, learningQueue.length);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„ç›¸è¿‘ä½ç½®
    var alreadyNearby = false;
    for (var i = currentQueueIndex + 1; i < Math.min(currentQueueIndex + gap + 2, learningQueue.length); i++) {
        if (learningQueue[i] && learningQueue[i].word === wordData.word) {
            alreadyNearby = true;
            break;
        }
    }
    
    if (!alreadyNearby) {
        learningQueue.splice(insertIndex, 0, wordData);
        immediateReviewQueue.push({
            word: wordData.word,
            insertedAt: insertIndex,
            timestamp: Date.now()
        });
    }
}

// V5: æ˜¾ç¤ºè¯„åˆ†åé¦ˆï¼ˆå¸¦çŠ¶æ€å¡ç‰‡æ•ˆæœï¼‰
function showRatingFeedback(rating, message) {
    var colors = {
        again: { bg: 'linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)', border: '#fecaca', text: '#dc2626', icon: 'ğŸ”„' },
        hard: { bg: 'linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%)', border: '#fed7aa', text: '#ea580c', icon: 'ğŸ’ª' },
        good: { bg: 'linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)', border: '#bbf7d0', text: '#16a34a', icon: 'âœ“' },
        easy: { bg: 'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)', border: '#bfdbfe', text: '#2563eb', icon: 'ğŸ‰' }
    };
    
    var style = colors[rating] || colors.good;
    
    var feedback = document.createElement('div');
    feedback.className = 'rating-feedback-card';
    feedback.innerHTML = '<span class="feedback-icon">' + style.icon + '</span><span class="feedback-text">' + message + '</span>';
    feedback.style.cssText = 'position:fixed;top:25%;left:50%;transform:translateX(-50%);background:' + style.bg + ';color:' + style.text + ';padding:16px 28px;border-radius:16px;font-size:16px;font-weight:700;z-index:10001;box-shadow:0 10px 40px rgba(0,0,0,0.15);animation:feedbackBounce 0.4s ease;border:2px solid ' + style.border + ';display:flex;align-items:center;gap:10px;';
    document.body.appendChild(feedback);
    
    setTimeout(function() {
        feedback.style.animation = 'feedbackOut 0.3s ease forwards';
        setTimeout(function() {
            if (feedback.parentNode) feedback.parentNode.removeChild(feedback);
        }, 300);
    }, 800);
}

// V9: å­¦ä¹ ç»Ÿè®¡
var sessionStats = {
    again: 0,
    hard: 0,
    good: 0,
    easy: 0,
    startTime: null
};

function updateSessionStats(rating) {
    if (!sessionStats.startTime) {
        sessionStats.startTime = Date.now();
    }
    
    if (sessionStats[rating] !== undefined) {
        sessionStats[rating]++;
    }
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('currentSessionStats', JSON.stringify(sessionStats));
}

function getSessionStats() {
    var duration = sessionStats.startTime ? Math.round((Date.now() - sessionStats.startTime) / 1000) : 0;
    var total = sessionStats.again + sessionStats.hard + sessionStats.good + sessionStats.easy;
    
    return {
        again: sessionStats.again,
        hard: sessionStats.hard,
        good: sessionStats.good,
        easy: sessionStats.easy,
        total: total,
        duration: duration,
        accuracy: total > 0 ? Math.round(((sessionStats.good + sessionStats.easy) / total) * 100) : 0
    };
}

// å°†å•è¯æ·»åŠ åˆ°é˜Ÿåˆ—åé¢ï¼ˆç”¨äºå›°éš¾å•è¯é‡å¤å­¦ä¹ ï¼‰- å…¼å®¹æ—§ç‰ˆ
function addWordToQueueLater(wordData, gap) {
    addToImmediateReview(wordData, gap);
}

// æ˜¾ç¤ºå›°éš¾åé¦ˆ - æ›´æ–°ä¸ºæ–°ç‰ˆ
function showDifficultyFeedback(message) {
    showRatingFeedback('hard', message);
}

// ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šè®¾ç½®æ›´æ–°æç¤º ======
function showSettingsUpdateToast(message) {
    var toast = document.createElement('div');
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:10px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span><span style="font-weight:600;">' + message + '</span>';
    toast.style.cssText = 'position:fixed;top:15%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:white;padding:14px 24px;border-radius:14px;font-size:14px;z-index:10001;box-shadow:0 8px 30px rgba(99,102,241,0.35);animation:toastIn 0.3s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

// æ˜¾ç¤ºå•è¯å®Œæˆæç¤º
function showCompletionToast(word) {
    var toast = document.createElement('div');
    toast.className = 'word-completion-toast';
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:12px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><div><strong style="font-size:18px;">' + word + '</strong><div style="font-size:13px;opacity:0.9;margin-top:2px;">å­¦ä¹ å®Œæˆï¼ç»§ç»­åŠ æ²¹ âœ“</div></div>';
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:20px 32px;border-radius:20px;font-size:16px;font-weight:600;z-index:10001;box-shadow:0 15px 50px rgba(16,185,129,0.45);animation:toastIn 0.4s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

// V6: æ˜¾ç¤ºå­¦ä¹ æ¨¡å¼æŒ‡ç¤ºå™¨
function showLearningModeIndicator(mode) {
    // ç§»é™¤æ—§çš„æŒ‡ç¤ºå™¨
    var oldIndicator = document.getElementById('learningModeIndicator');
    if (oldIndicator) oldIndicator.remove();
    
    var modeConfig = {
        normal: { 
            text: 'æ–°è¯å­¦ä¹ ', 
            icon: 'ğŸ“–', 
            color: '#6366f1',
            bgGradient: 'linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)',
            borderColor: '#c7d2fe',
            hint: 'è®¤çœŸè®°å¿†'
        },
        review: { 
            text: 'å¤ä¹ å·©å›º', 
            icon: 'ğŸ”„', 
            color: '#f59e0b',
            bgGradient: 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)',
            borderColor: '#fde68a',
            hint: 'åŠ æ·±å°è±¡'
        },
        immediate: { 
            text: 'ç«‹å³å¤ä¹ ', 
            icon: 'âš¡', 
            color: '#ef4444',
            bgGradient: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
            borderColor: '#fecaca',
            hint: 'å†æ¥ä¸€æ¬¡'
        },
        difficult: { 
            text: 'æ”»å…‹éš¾è¯', 
            icon: 'ğŸ’ª', 
            color: '#ea580c',
            bgGradient: 'linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%)',
            borderColor: '#fed7aa',
            hint: 'ä¸“æ³¨è®°å¿†'
        }
    };
    
    var config = modeConfig[mode] || modeConfig.normal;
    
    var indicator = document.createElement('div');
    indicator.id = 'learningModeIndicator';
    indicator.className = 'learning-mode-indicator mode-' + mode;
    indicator.innerHTML = '<span class="mode-icon">' + config.icon + '</span><span class="mode-text">' + config.text + '</span><span class="mode-hint">' + config.hint + '</span>';
    indicator.style.cssText = 'position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:' + config.bgGradient + ';color:' + config.color + ';padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;z-index:10;display:flex;align-items:center;gap:6px;border:2px solid ' + config.borderColor + ';box-shadow:0 4px 12px rgba(0,0,0,0.1);animation:modeIndicatorIn 0.3s ease;white-space:nowrap;';
    
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.style.position = 'relative';
        wordCard.insertBefore(indicator, wordCard.firstChild);
    }
}

function nextWord() {
    currentQueueIndex++;
    
    // V6: ä»å³æ—¶å¤ä¹ é˜Ÿåˆ—ç§»é™¤å·²å¤„ç†çš„è¯
    if (immediateReviewQueue && immediateReviewQueue.length > 0) {
        var prevWord = learningQueue[currentQueueIndex - 1];
        if (prevWord) {
            immediateReviewQueue = immediateReviewQueue.filter(function(r) {
                return r.word !== prevWord.word;
            });
        }
    }
    
    if (currentQueueIndex < learningQueue.length) {
        showCurrentWord();
    } else {
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å•è¯éƒ½å·²å®Œæˆ
        var allCompleted = true;
        sessionWords.forEach(function(w) {
            if (!sessionWordProgress[w.word] || !sessionWordProgress[w.word].completed) {
                allCompleted = false;
            }
        });
        
        if (allCompleted) {
            // å­¦å®Œæœ¬ç»„ï¼Œæ˜¾ç¤ºæ€»ç»“é¡µé¢
            showSessionSummary();
        } else {
            // è¿˜æœ‰æœªå®Œæˆçš„å•è¯ï¼Œé‡æ–°æ„å»ºé˜Ÿåˆ—
            buildLearningQueue();
            currentQueueIndex = 0;
            if (learningQueue.length > 0) {
                showCurrentWord();
            } else {
                showSessionSummary();
            }
        }
    }
}

// V7 & V9: æ˜¾ç¤ºå¢å¼ºç‰ˆæœ¬è½®å­¦ä¹ æ€»ç»“
function showSessionSummary() {
    var wordCard = document.getElementById('wordCard');
    var rateButtons = document.getElementById('rateButtons');
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    var vocabProgress = document.getElementById('vocabProgress');
    
    if (rateButtons) rateButtons.classList.add('hidden');
    if (showMeaningBtn) showMeaningBtn.classList.add('hidden');
    
    // V9: è·å–å­¦ä¹ ç»Ÿè®¡
    var stats = getSessionStats();
    var duration = stats.duration;
    var minutes = Math.floor(duration / 60);
    var seconds = duration % 60;
    var timeStr = minutes > 0 ? minutes + 'åˆ†' + seconds + 'ç§’' : seconds + 'ç§’';
    
    // è®¡ç®—å„è¯„åˆ†æ•°é‡
    var againCount = stats.again || 0;
    var hardCount = stats.hard || 0;
    var goodCount = stats.good || 0;
    var easyCount = stats.easy || 0;
    var totalRatings = againCount + hardCount + goodCount + easyCount;
    
    // V7: æ„å»ºå¢å¼ºç‰ˆæ€»ç»“HTML
    var summaryHtml = '<div style="padding:20px;">';
    
    // é¡¶éƒ¨æˆå°±å¾½ç« 
    summaryHtml += '<div style="text-align:center;margin-bottom:20px;">';
    summaryHtml += '<div style="width:80px;height:80px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 10px 40px rgba(16,185,129,0.35);animation:completionBounce 0.6s ease;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>';
    summaryHtml += '<h2 style="margin:0;color:#1e1b4b;font-size:26px;font-weight:800;">ğŸ‰ å­¦ä¹ å®Œæˆï¼</h2>';
    summaryHtml += '<p style="color:#6b7280;margin-top:10px;font-size:15px;">å…±å­¦ä¹  <span style="color:#6366f1;font-weight:700;">' + sessionWords.length + '</span> ä¸ªå•è¯</p>';
    summaryHtml += '</div>';
    
    // V9: å­¦ä¹ ç»Ÿè®¡å¡ç‰‡
    summaryHtml += '<div class="session-stats-card" style="background:linear-gradient(135deg,#f8fafc 0%,#eef2ff 100%);border-radius:16px;padding:16px;margin-bottom:20px;border:1px solid rgba(99,102,241,0.15);display:flex;flex-wrap:wrap;gap:10px;justify-content:space-around;">';
    
    // ç”¨æ—¶ç»Ÿè®¡
    summaryHtml += '<div style="text-align:center;min-width:60px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">â±ï¸ ç”¨æ—¶</div><div style="font-size:16px;font-weight:700;color:#1e1b4b;">' + timeStr + '</div></div>';
    
    // å‡†ç¡®ç‡
    summaryHtml += '<div style="text-align:center;min-width:60px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">ğŸ¯ å‡†ç¡®ç‡</div><div style="font-size:16px;font-weight:700;color:' + (stats.accuracy >= 80 ? '#10b981' : stats.accuracy >= 60 ? '#f59e0b' : '#ef4444') + ';">' + stats.accuracy + '%</div></div>';
    
    // è¯„åˆ†åˆ†å¸ƒ - ç®€åŒ–å±•ç¤º
    summaryHtml += '<div style="text-align:center;min-width:80px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">ğŸ“Š è¯„åˆ†åˆ†å¸ƒ</div><div style="display:flex;gap:4px;justify-content:center;font-size:11px;font-weight:600;">';
    if (easyCount > 0) summaryHtml += '<span style="color:#2563eb;" title="ç®€å•">' + easyCount + 'ğŸ‰</span>';
    if (goodCount > 0) summaryHtml += '<span style="color:#16a34a;" title="è‰¯å¥½">' + goodCount + 'âœ“</span>';
    if (hardCount > 0) summaryHtml += '<span style="color:#ea580c;" title="å›°éš¾">' + hardCount + 'ğŸ’ª</span>';
    if (againCount > 0) summaryHtml += '<span style="color:#dc2626;" title="é‡å­¦">' + againCount + 'ğŸ”„</span>';
    summaryHtml += '</div></div>';
    
    summaryHtml += '</div>';
    
    // V7: è¿›åº¦å¯è§†åŒ–ç¯å½¢å›¾
    var masteryRate = totalRatings > 0 ? Math.round(((easyCount + goodCount) / totalRatings) * 100) : 0;
    summaryHtml += '<div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;">';
    summaryHtml += '<div style="position:relative;width:80px;height:80px;">';
    summaryHtml += '<svg viewBox="0 0 36 36" style="width:80px;height:80px;transform:rotate(-90deg);">';
    summaryHtml += '<circle cx="18" cy="18" r="16" fill="none" stroke="#e5e7eb" stroke-width="3"/>';
    summaryHtml += '<circle cx="18" cy="18" r="16" fill="none" stroke="url(#progressGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="' + masteryRate + ' ' + (100 - masteryRate) + '" style="transition:stroke-dasharray 1s ease;"/>';
    summaryHtml += '<defs><linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#6366f1"/><stop offset="100%" style="stop-color:#10b981"/></linearGradient></defs>';
    summaryHtml += '</svg>';
    summaryHtml += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;"><div style="font-size:18px;font-weight:800;color:#1e1b4b;">' + masteryRate + '%</div><div style="font-size:9px;color:#6b7280;">æŒæ¡åº¦</div></div>';
    summaryHtml += '</div>';
    summaryHtml += '<div style="text-align:left;"><div style="font-size:12px;color:#6b7280;margin-bottom:6px;">å­¦ä¹ å»ºè®®</div><div style="font-size:13px;color:#374151;font-weight:600;">' + getLearningAdvice(masteryRate, hardCount, againCount) + '</div></div>';
    summaryHtml += '</div>';
    
    // å•è¯åˆ—è¡¨
    summaryHtml += '<div style="max-height:300px;overflow-y:auto;">';
    
    sessionWords.forEach(function(wordData, index) {
        var rating = wordRatings[wordData.word] ? wordRatings[wordData.word].rating : 'good';
        var ratingConfig = {
            easy: { icon: 'ğŸ‰', bg: 'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)', border: '#bfdbfe' },
            good: { icon: 'âœ“', bg: 'linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)', border: '#bbf7d0' },
            hard: { icon: 'ğŸ’ª', bg: 'linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%)', border: '#fed7aa' },
            again: { icon: 'ğŸ”„', bg: 'linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)', border: '#fecaca' },
            medium: { icon: 'â€¢', bg: 'linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%)', border: '#fde68a' }
        };
        var config = ratingConfig[rating] || ratingConfig.good;
        
        summaryHtml += '<div style="background:' + config.bg + ';border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid ' + config.border + ';">';
        summaryHtml += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">';
        summaryHtml += '<div style="display:flex;align-items:center;gap:10px;">';
        summaryHtml += '<span style="background:linear-gradient(135deg,#6366f1,#a855f7);color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">' + (index + 1) + '</span>';
        summaryHtml += '<span style="font-size:17px;font-weight:700;color:#1e1b4b;">' + wordData.word + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<span style="font-size:18px;">' + config.icon + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<div style="font-size:14px;color:#374151;font-weight:600;">' + (wordData.meaningCn || '') + '</div>';
        summaryHtml += '</div>';
    });
    
    summaryHtml += '</div>';
    
    // æ“ä½œæŒ‰é’®
    summaryHtml += '<div style="display:flex;gap:12px;margin-top:20px;">';
    summaryHtml += '<button onclick="restartSession()" style="flex:1;padding:16px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#a855f7 100%);color:white;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(99,102,241,0.35);display:flex;align-items:center;justify-content:center;gap:8px;"><span>ğŸš€</span>ç»§ç»­å­¦ä¹ </button>';
    summaryHtml += '<button onclick="closeModule()" style="flex:1;padding:16px;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#6366f1;border:2px solid rgba(99,102,241,0.3);border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;"><span>âœ…</span>å®Œæˆ</button>';
    summaryHtml += '</div>';
    summaryHtml += '</div>';
    
    if (wordCard) {
        wordCard.innerHTML = summaryHtml;
    }
    
    // é‡ç½®ä¼šè¯ç»Ÿè®¡
    sessionStats = { again: 0, hard: 0, good: 0, easy: 0, startTime: null };
    
    // æ›´æ–°ç»Ÿè®¡
    var statWords = document.getElementById('stat_words');
    if (statWords) statWords.textContent = learnedWords.length;
}

// V7: è·å–å­¦ä¹ å»ºè®®
function getLearningAdvice(masteryRate, hardCount, againCount) {
    if (masteryRate >= 90) {
        return 'ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼';
    } else if (masteryRate >= 70) {
        return 'ğŸ‘ å­¦å¾—ä¸é”™ï¼Œå†åŠªåŠ›ä¸€ä¸‹ï¼';
    } else if (hardCount > 0 || againCount > 0) {
        return 'ğŸ’¡ å»ºè®®å¤ä¹ å›°éš¾å•è¯';
    } else {
        return 'ğŸ“š å¤šçœ‹å‡ éï¼ŒåŠ æ·±è®°å¿†';
    }
}

// é‡æ–°å¼€å§‹å­¦ä¹ 
function restartSession() {
    currentWordIndex = 0;
    
    // æ¢å¤åŸå§‹è¯å¡ç»“æ„ï¼ˆåªæ¢å¤wordCardå†…éƒ¨çš„å†…å®¹ï¼Œä¸åŒ…æ‹¬æŒ‰é’®ï¼‰
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.innerHTML = '<div class="word-main" id="wordMain">Loading...</div>' +
            '<div class="word-phonetic" id="wordPhonetic">/ËˆlÉ™ÊŠdÉªÅ‹/</div>' +
            '<div class="word-meaning hidden" id="wordMeaning">' +
            '<div id="dictContainer"></div>' +
            '<div class="meaning-cn" id="meaningCn"></div>' +
            '<div class="meaning-en" id="meaningEn"></div>' +
            '<div class="word-example" id="wordExample"></div>' +
            '</div>';
    }
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    // é‡æ–°åˆå§‹åŒ–å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
}

function prevWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
    } else {
        currentWordIndex = sessionWords.length - 1;
    }
    showCurrentWord();
}

// é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
var cachedVoices = [];
var preferredVoice = null;

if ('speechSynthesis' in window) {
    cachedVoices = speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = function() {
        cachedVoices = speechSynthesis.getVoices();
        preferredVoice = selectBestUSVoice(cachedVoices);
        console.log('å¯ç”¨è¯­éŸ³:', cachedVoices.map(v => v.name + ' (' + v.lang + ')'));
        console.log('å·²é€‰æ‹©è¯­éŸ³:', preferredVoice ? preferredVoice.name : 'é»˜è®¤');
    };
}

// é€‰æ‹©æœ€ä½³ç¾å¼è‹±è¯­è¯­éŸ³
function selectBestUSVoice(voices) {
    if (!voices || voices.length === 0) return null;
    
    // macOS ä¸Šä¼˜è´¨ç¾å¼è‹±è¯­è¯­éŸ³ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    var preferredNames = [
        // macOS é«˜è´¨é‡ç¾å¼è¯­éŸ³
        'Samantha',           // ç¾å¼å¥³å£° - éå¸¸è‡ªç„¶
        'Alex',               // ç¾å¼ç”·å£° - éå¸¸è‡ªç„¶
        'Allison',            // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Ava',                // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Susan',              // ç¾å¼å¥³å£°
        'Tom',                // ç¾å¼ç”·å£°
        'Zoe',                // ç¾å¼å¥³å£°
        // iOS è¯­éŸ³
        'Samantha (Enhanced)',
        'Alex (Enhanced)',
        // Chrome/Edge è¯­éŸ³
        'Google US English',
        'Microsoft Zira',
        'Microsoft David',
    ];
    
    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾
    for (var i = 0; i < preferredNames.length; i++) {
        var voice = voices.find(function(v) {
            return v.name.includes(preferredNames[i]) && 
                   (v.lang === 'en-US' || v.lang.startsWith('en-US'));
        });
        if (voice) return voice;
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼ŒæŸ¥æ‰¾ä»»ä½•ç¾å¼è‹±è¯­è¯­éŸ³
    var usVoice = voices.find(function(v) {
        return v.lang === 'en-US' || v.lang.startsWith('en-US');
    });
    if (usVoice) return usVoice;
    
    // æœ€åé™çº§åˆ°ä»»ä½•è‹±è¯­è¯­éŸ³
    return voices.find(function(v) {
        return v.lang.startsWith('en');
    });
}

// ç¾å¼å‘éŸ³ - ä½¿ç”¨æµè§ˆå™¨å†…ç½®TTS
function speakWord() {
    var wordEl = document.getElementById('wordMain');
    var word = wordEl ? wordEl.textContent : '';
    if (!word) return;
    
    speakText(word);
}

// é€šç”¨è¯­éŸ³æ’­æ”¾å‡½æ•°
function speakText(text) {
    if (!('speechSynthesis' in window)) {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
        return;
    }
    
    // å–æ¶ˆæ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    speechSynthesis.cancel();
    
    // åˆ›å»ºè¯­éŸ³å¯¹è±¡
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.85;  // ç¨å¾®æ”¾æ…¢ï¼Œæ›´æ¸…æ™°
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // é€‰æ‹©æœ€ä½³è¯­éŸ³
    var voices = cachedVoices.length > 0 ? cachedVoices : speechSynthesis.getVoices();
    var voice = preferredVoice || selectBestUSVoice(voices);
    
    if (voice) {
        utterance.voice = voice;
        console.log('ä½¿ç”¨è¯­éŸ³:', voice.name);
    }
    
    // æ’­æ”¾
    speechSynthesis.speak(utterance);
}

// ä¿ç•™æ—§å‡½æ•°åå…¼å®¹
function speakWordTTS(word) {
    speakText(word);
}

function setVoiceAndSpeak(utterance, voices) {
    speechSynthesis.speak(utterance);
}

window.initVocabulary = initVocabulary;
window.showMeaning = showMeaning;
window.rateWord = rateWord;
window.speakWord = speakWord;
window.nextWord = nextWord;
window.prevWord = prevWord;
window.changeWordsPerSession = changeWordsPerSession;
window.changeLearningTimes = changeLearningTimes;
window.initSessionWords = initSessionWords;
window.restartSession = restartSession;
window.showSessionSummary = showSessionSummary;
window.updateLearningProgressIndicator = updateLearningProgressIndicator;
window.updateLearningBadge = updateLearningBadge;

// ==================== V14: ç§‘å­¦åŠ©è®°äº¤äº’åŠŸèƒ½ ====================

// V14.7: è®°å½•åŠ©è®°æ•ˆæœåé¦ˆ
function rateMnemonicEffectiveness(word, wasEffective) {
    var mnemonic = getWordMnemonic(word);
    var mnemonicType = mnemonic ? (mnemonic.type || 'etymology') : 'unknown';
    
    recordMnemonicEffectiveness(word, mnemonicType, wasEffective);
    
    // æ˜¾ç¤ºåé¦ˆåŠ¨ç”»
    var feedbackEl = document.createElement('div');
    feedbackEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:' + 
        (wasEffective ? 'linear-gradient(135deg,#22c55e,#16a34a)' : 'linear-gradient(135deg,#f97316,#ea580c)') + 
        ';color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;' +
        'box-shadow:0 8px 32px rgba(0,0,0,0.2);animation:mnemonicFeedback 0.5s ease-out;';
    feedbackEl.innerHTML = wasEffective ? 'ğŸ‘ å·²è®°å½•ï¼ç»§ç»­åŠ æ²¹' : 'ğŸ”„ å·²æ ‡è®°ï¼Œä¼šåŠ å¼ºå¤ä¹ ';
    document.body.appendChild(feedbackEl);
    
    setTimeout(function() { feedbackEl.remove(); }, 1500);
    
    // å¦‚æœéœ€è¦å¼ºåŒ–ï¼Œæ·»åŠ åˆ°å³æ—¶å¤ä¹ é˜Ÿåˆ—
    if (!wasEffective && typeof immediateReviewQueue !== 'undefined') {
        var wordData = learningQueue.find(function(w) { return w.word.toLowerCase() === word.toLowerCase(); });
        if (wordData && immediateReviewQueue.indexOf(wordData) === -1) {
            immediateReviewQueue.push(wordData);
            console.log('[V14] æ·»åŠ åˆ°å¼ºåŒ–å¤ä¹ é˜Ÿåˆ—:', word);
        }
    }
}

// V14.8: æ˜¾ç¤ºè‡ªå®šä¹‰åŠ©è®°ç¼–è¾‘å™¨
function showCustomMnemonicEditor(word) {
    var existingCustom = userCustomMnemonics[word.toLowerCase()];
    var baseMnemonic = getWordMnemonic(word);
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'customMnemonicOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    
    var editorHtml = '<div style="background:white;border-radius:20px;width:90%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">';
    
    // å¤´éƒ¨
    editorHtml += '<div style="background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 50%,#6366f1 100%);padding:20px;border-radius:20px 20px 0 0;">';
    editorHtml += '<div style="display:flex;align-items:center;justify-content:space-between;">';
    editorHtml += '<div style="display:flex;align-items:center;gap:12px;">';
    editorHtml += '<span style="font-size:32px;">âœ¨</span>';
    editorHtml += '<div><div style="color:white;font-size:18px;font-weight:700;">åˆ›å»ºæˆ‘çš„è®°å¿†æ³•</div>';
    editorHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;">' + word + '</div></div>';
    editorHtml += '</div>';
    editorHtml += '<button onclick="closeCustomMnemonicEditor()" style="background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:12px;color:white;font-size:20px;cursor:pointer;">Ã—</button>';
    editorHtml += '</div></div>';
    
    // å†…å®¹åŒº
    editorHtml += '<div style="padding:20px;">';
    
    // ç§‘å­¦æ–¹æ³•é€‰æ‹©
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ”¬ é€‰æ‹©è®°å¿†æ–¹æ³•ï¼ˆåŸºäºç§‘å­¦ç ”ç©¶ï¼‰</label>';
    editorHtml += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;" id="mnemonicTypeGrid">';
    
    var types = Object.keys(MNEMONIC_SCIENCE.types);
    types.forEach(function(type) {
        var info = MNEMONIC_SCIENCE.types[type];
        var isSelected = existingCustom && existingCustom.type === type;
        editorHtml += '<div onclick="selectMnemonicType(\'' + type + '\')" id="typeBtn_' + type + '" style="padding:10px;background:' + (isSelected ? info.bg : '#f9fafb') + ';border:2px solid ' + (isSelected ? info.color : '#e5e7eb') + ';border-radius:10px;cursor:pointer;transition:all 0.2s;" data-type="' + type + '">';
        editorHtml += '<div style="display:flex;align-items:center;gap:8px;">';
        editorHtml += '<span style="font-size:18px;">' + info.icon + '</span>';
        editorHtml += '<div><div style="font-size:12px;font-weight:600;color:' + info.color + ';">' + info.name + '</div>';
        editorHtml += '<div style="font-size:10px;color:#9ca3af;">' + Math.round(info.effectiveness * 100) + '% æœ‰æ•ˆ</div></div>';
        editorHtml += '</div></div>';
    });
    editorHtml += '</div></div>';
    
    // åŠ©è®°å†…å®¹è¾“å…¥
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ’¡ æˆ‘çš„è®°å¿†æŠ€å·§</label>';
    editorHtml += '<textarea id="customMnemonicText" placeholder="è¾“å…¥ä½ ç‹¬ç‰¹çš„è®°å¿†æ–¹æ³•..." style="width:100%;height:80px;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;resize:none;box-sizing:border-box;">' + (existingCustom ? existingCustom.mnemonic : (baseMnemonic ? baseMnemonic.mnemonic : '')) + '</textarea>';
    editorHtml += '</div>';
    
    // è§†è§‰è”æƒ³
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ¨ è§†è§‰ç”»é¢æè¿°ï¼ˆåŒé‡ç¼–ç ï¼‰</label>';
    editorHtml += '<input id="customVisual" type="text" placeholder="æè¿°ä¸€ä¸ªç”ŸåŠ¨çš„ç”»é¢..." value="' + (existingCustom && existingCustom.visual ? existingCustom.visual : (baseMnemonic && baseMnemonic.association ? baseMnemonic.association : '')) + '" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;box-sizing:border-box;">';
    editorHtml += '</div>';
    
    // æƒ…æ„Ÿé”šå®š
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ’– æƒ…æ„Ÿè¿æ¥ï¼ˆé€‰æ‹©ä¸€ä¸ªæƒ…æ„Ÿï¼‰</label>';
    editorHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;" id="emotionGrid">';
    var emotions = ['joy', 'surprise', 'fear', 'love', 'curiosity', 'anger'];
    var emotionData = {
        'joy': { icon: 'ğŸ˜Š', name: 'å¿«ä¹' },
        'surprise': { icon: 'ğŸ˜²', name: 'æƒŠè®¶' },
        'fear': { icon: 'ğŸ˜¨', name: 'ææƒ§' },
        'love': { icon: 'â¤ï¸', name: 'çˆ±' },
        'curiosity': { icon: 'ğŸ¤”', name: 'å¥½å¥‡' },
        'anger': { icon: 'ğŸ˜ ', name: 'æ„¤æ€’' }
    };
    emotions.forEach(function(emo) {
        var data = emotionData[emo];
        var isSelected = existingCustom && existingCustom.emotional === emo;
        editorHtml += '<div onclick="selectEmotion(\'' + emo + '\')" id="emoBtn_' + emo + '" style="padding:8px 12px;background:' + (isSelected ? '#fce7f3' : '#f9fafb') + ';border:2px solid ' + (isSelected ? '#ec4899' : '#e5e7eb') + ';border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:4px;">';
        editorHtml += '<span style="font-size:16px;">' + data.icon + '</span>';
        editorHtml += '<span style="font-size:12px;color:#374151;">' + data.name + '</span>';
        editorHtml += '</div>';
    });
    editorHtml += '</div></div>';
    
    // ä¿å­˜æŒ‰é’®
    editorHtml += '<button onclick="saveCustomMnemonicFromEditor(\'' + word + '\')" style="width:100%;padding:14px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;border-radius:12px;color:white;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,0.3);">ğŸ’¾ ä¿å­˜æˆ‘çš„è®°å¿†æ³•</button>';
    
    editorHtml += '</div></div>';
    
    overlayEl.innerHTML = editorHtml;
    document.body.appendChild(overlayEl);
    
    // æ·»åŠ é€‰æ‹©çŠ¶æ€å˜é‡
    window._selectedMnemonicType = existingCustom ? existingCustom.type : 'etymology';
    window._selectedEmotion = existingCustom ? existingCustom.emotional : null;
}

// é€‰æ‹©åŠ©è®°ç±»å‹
function selectMnemonicType(type) {
    window._selectedMnemonicType = type;
    var grid = document.getElementById('mnemonicTypeGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[data-type]');
        buttons.forEach(function(btn) {
            var btnType = btn.getAttribute('data-type');
            var info = MNEMONIC_SCIENCE.types[btnType];
            if (btnType === type) {
                btn.style.background = info.bg;
                btn.style.borderColor = info.color;
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// é€‰æ‹©æƒ…æ„Ÿ
function selectEmotion(emotion) {
    window._selectedEmotion = window._selectedEmotion === emotion ? null : emotion;
    var grid = document.getElementById('emotionGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[id^="emoBtn_"]');
        buttons.forEach(function(btn) {
            var emo = btn.id.replace('emoBtn_', '');
            if (emo === window._selectedEmotion) {
                btn.style.background = '#fce7f3';
                btn.style.borderColor = '#ec4899';
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// ä¿å­˜è‡ªå®šä¹‰åŠ©è®°
function saveCustomMnemonicFromEditor(word) {
    var text = document.getElementById('customMnemonicText').value.trim();
    var visual = document.getElementById('customVisual').value.trim();
    
    if (!text) {
        alert('è¯·è¾“å…¥è®°å¿†æŠ€å·§ï¼');
        return;
    }
    
    saveCustomMnemonic(word, {
        text: text,
        type: window._selectedMnemonicType || 'etymology',
        visual: visual || null,
        emotional: window._selectedEmotion || null
    });
    
    // å¦‚æœé€‰æ‹©äº†æƒ…æ„Ÿï¼Œä¹Ÿä¿å­˜æƒ…æ„Ÿé”šå®š
    if (window._selectedEmotion) {
        setEmotionalAnchor(word, window._selectedEmotion, 7);
    }
    
    closeCustomMnemonicEditor();
    
    // åˆ·æ–°æ˜¾ç¤º
    showMeaning();
    
    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.2);';
    toast.innerHTML = 'âœ… ä¿å­˜æˆåŠŸï¼';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 1500);
}

// å…³é—­è‡ªå®šä¹‰åŠ©è®°ç¼–è¾‘å™¨
function closeCustomMnemonicEditor() {
    var overlay = document.getElementById('customMnemonicOverlay');
    if (overlay) overlay.remove();
}

// V14.9: æ˜¾ç¤ºè®°å¿†å®«æ®¿ç¼–è¾‘å™¨
function showMemoryPalaceEditor(word) {
    var existingPlacement = memoryPalaceData.placements ? memoryPalaceData.placements[word.toLowerCase()] : null;
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'memoryPalaceOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    
    // åˆå§‹åŒ–ä½ç½®æ•°æ®
    if (!memoryPalaceData.locations) {
        memoryPalaceData.locations = [
            { id: 'home_entrance', name: 'ğŸšª å®¶é—¨å£', description: 'æ¨å¼€é—¨ï¼Œç¬¬ä¸€çœ¼çœ‹åˆ°çš„åœ°æ–¹' },
            { id: 'living_room', name: 'ğŸ›‹ï¸ å®¢å…', description: 'èˆ’é€‚çš„æ²™å‘å’ŒèŒ¶å‡ ' },
            { id: 'kitchen', name: 'ğŸ³ å¨æˆ¿', description: 'é”…ç¢—ç“¢ç›†çš„åœ°æ–¹' },
            { id: 'bedroom', name: 'ğŸ›ï¸ å§å®¤', description: 'ä¼‘æ¯çš„ç§äººç©ºé—´' },
            { id: 'bathroom', name: 'ğŸš¿ å«ç”Ÿé—´', description: 'æ´—æ¼±çš„åœ°æ–¹' },
            { id: 'balcony', name: 'ğŸŒ¿ é˜³å°', description: 'é˜³å…‰å……è¶³çš„åœ°æ–¹' },
            { id: 'study', name: 'ğŸ“š ä¹¦æˆ¿', description: 'å­¦ä¹ å’Œå·¥ä½œçš„åœ°æ–¹' },
            { id: 'garden', name: 'ğŸŒ¸ èŠ±å›­', description: 'èŠ±è‰æ ‘æœ¨çš„å¤©åœ°' }
        ];
    }
    
    var editorHtml = '<div style="background:white;border-radius:20px;width:90%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">';
    
    // å¤´éƒ¨
    editorHtml += '<div style="background:linear-gradient(135deg,#6366f1 0%,#4f46e5 50%,#4338ca 100%);padding:20px;border-radius:20px 20px 0 0;">';
    editorHtml += '<div style="display:flex;align-items:center;justify-content:space-between;">';
    editorHtml += '<div style="display:flex;align-items:center;gap:12px;">';
    editorHtml += '<span style="font-size:32px;">ğŸ›ï¸</span>';
    editorHtml += '<div><div style="color:white;font-size:18px;font-weight:700;">è®°å¿†å®«æ®¿</div>';
    editorHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;">å°† "' + word + '" æ”¾ç½®åœ¨ç†Ÿæ‚‰çš„ä½ç½®</div></div>';
    editorHtml += '</div>';
    editorHtml += '<button onclick="closeMemoryPalaceEditor()" style="background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:12px;color:white;font-size:20px;cursor:pointer;">Ã—</button>';
    editorHtml += '</div></div>';
    
    // ç§‘å­¦è¯´æ˜
    editorHtml += '<div style="padding:16px 20px;background:#eef2ff;border-bottom:1px solid #c7d2fe;">';
    editorHtml += '<div style="font-size:12px;color:#4338ca;">ğŸ’¡ <strong>è®°å¿†å®«æ®¿æ³•</strong>æ˜¯ä¸–ç•Œè®°å¿†å† å†›ä½¿ç”¨çš„æŠ€æœ¯ã€‚å°†å•è¯ä¸ç†Ÿæ‚‰åœ°ç‚¹ç»“åˆï¼Œåˆ©ç”¨ç©ºé—´è®°å¿†å¢å¼ºè¯æ±‡è®°å¿†ã€‚</div>';
    editorHtml += '</div>';
    
    // ä½ç½®é€‰æ‹©
    editorHtml += '<div style="padding:20px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:12px;">ğŸ“ é€‰æ‹©ä¸€ä¸ªä½ç½®</label>';
    editorHtml += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;" id="locationGrid">';
    
    memoryPalaceData.locations.forEach(function(loc) {
        var isSelected = existingPlacement && existingPlacement.locationId === loc.id;
        editorHtml += '<div onclick="selectPalaceLocation(\'' + loc.id + '\')" id="locBtn_' + loc.id + '" style="padding:14px;background:' + (isSelected ? '#e0e7ff' : '#f9fafb') + ';border:2px solid ' + (isSelected ? '#6366f1' : '#e5e7eb') + ';border-radius:12px;cursor:pointer;transition:all 0.2s;">';
        editorHtml += '<div style="font-size:16px;margin-bottom:4px;">' + loc.name + '</div>';
        editorHtml += '<div style="font-size:11px;color:#6b7280;">' + loc.description + '</div>';
        editorHtml += '</div>';
    });
    editorHtml += '</div>';
    
    // ç”»é¢æè¿°
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ¨ æè¿°ä½ çœ‹åˆ°çš„ç”»é¢</label>';
    editorHtml += '<textarea id="palaceImage" placeholder="æƒ³è±¡è¿™ä¸ªå•è¯åœ¨è¿™ä¸ªä½ç½®å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…..." style="width:100%;height:80px;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;resize:none;box-sizing:border-box;">' + (existingPlacement ? existingPlacement.image : '') + '</textarea>';
    editorHtml += '<div style="font-size:11px;color:#9ca3af;margin-top:6px;">ğŸ’¡ æç¤ºï¼šç”»é¢è¶Šå¤¸å¼ ã€è¶Šæœ‰è¶£ï¼Œè®°å¿†è¶Šæ·±åˆ»ï¼</div>';
    editorHtml += '</div>';
    
    // ä¿å­˜æŒ‰é’®
    editorHtml += '<button onclick="saveMemoryPalacePlacement(\'' + word + '\')" style="width:100%;padding:14px;background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);border:none;border-radius:12px;color:white;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.3);">ğŸ›ï¸ æ”¾å…¥è®°å¿†å®«æ®¿</button>';
    
    editorHtml += '</div></div>';
    
    overlayEl.innerHTML = editorHtml;
    document.body.appendChild(overlayEl);
    
    window._selectedLocation = existingPlacement ? existingPlacement.locationId : null;
}

// é€‰æ‹©å®«æ®¿ä½ç½®
function selectPalaceLocation(locId) {
    window._selectedLocation = locId;
    var grid = document.getElementById('locationGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[id^="locBtn_"]');
        buttons.forEach(function(btn) {
            var id = btn.id.replace('locBtn_', '');
            if (id === locId) {
                btn.style.background = '#e0e7ff';
                btn.style.borderColor = '#6366f1';
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// ä¿å­˜è®°å¿†å®«æ®¿ä½ç½®
function saveMemoryPalacePlacement(word) {
    var imageDesc = document.getElementById('palaceImage').value.trim();
    
    if (!window._selectedLocation) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªä½ç½®ï¼');
        return;
    }
    if (!imageDesc) {
        alert('è¯·æè¿°è¿™ä¸ªç”»é¢ï¼');
        return;
    }
    
    addToMemoryPalace(word, window._selectedLocation, imageDesc);
    
    closeMemoryPalaceEditor();
    showMeaning();
    
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.2);';
    toast.innerHTML = 'ğŸ›ï¸ å·²æ”¾å…¥è®°å¿†å®«æ®¿ï¼';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 1500);
}

// å…³é—­è®°å¿†å®«æ®¿ç¼–è¾‘å™¨
function closeMemoryPalaceEditor() {
    var overlay = document.getElementById('memoryPalaceOverlay');
    if (overlay) overlay.remove();
}

// V14.10: æ·»åŠ åŠ©è®°åŠ¨ç”»æ ·å¼
(function addMnemonicAnimationStyles() {
    if (document.getElementById('mnemonicAnimStyles')) return;
    var style = document.createElement('style');
    style.id = 'mnemonicAnimStyles';
    style.textContent = `
        @keyframes mnemonicFeedback {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .word-mnemonic-v14 {
            animation: mnemonicSlideIn 0.4s ease-out;
        }
        
        @keyframes mnemonicSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #customMnemonicOverlay, #memoryPalaceOverlay {
            animation: overlayFadeIn 0.3s ease-out;
        }
        
        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #customMnemonicOverlay > div, #memoryPalaceOverlay > div {
            animation: modalSlideUp 0.3s ease-out;
        }
        
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
})();

// å¯¼å‡ºæ–°åŠŸèƒ½
window.rateMnemonicEffectiveness = rateMnemonicEffectiveness;
window.showCustomMnemonicEditor = showCustomMnemonicEditor;
window.selectMnemonicType = selectMnemonicType;
window.selectEmotion = selectEmotion;
window.saveCustomMnemonicFromEditor = saveCustomMnemonicFromEditor;
window.closeCustomMnemonicEditor = closeCustomMnemonicEditor;
window.showMemoryPalaceEditor = showMemoryPalaceEditor;
window.selectPalaceLocation = selectPalaceLocation;
window.saveMemoryPalacePlacement = saveMemoryPalacePlacement;
window.closeMemoryPalaceEditor = closeMemoryPalaceEditor;

// ==================== V14.7-10: é«˜çº§ç§‘å­¦è®°å¿†åŠŸèƒ½ ====================

// V14.7: é—´éš”å¼ºåŒ–æœºåˆ¶ - æ ¹æ®é—å¿˜æ›²çº¿ä¼˜åŒ–å¤ä¹ æ—¶æœº
var spacedReinforcementData = {};
try {
    spacedReinforcementData = JSON.parse(localStorage.getItem('spacedReinforcement') || '{}');
} catch(e) {
    spacedReinforcementData = {};
}

function calculateOptimalReviewTime(word) {
    var data = spacedReinforcementData[word.toLowerCase()];
    if (!data) {
        return { nextReview: Date.now(), interval: 1 }; // æ–°è¯ï¼Œç«‹å³å¤ä¹ 
    }
    
    // åŸºäºSM-2ç®—æ³•å˜ä½“
    var lastReview = data.lastReview || Date.now();
    var easeFactor = data.easeFactor || 2.5;
    var interval = data.interval || 1;
    var reviews = data.reviews || 0;
    
    // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´ï¼ˆå°æ—¶ï¼‰
    var nextIntervalHours = interval * easeFactor * (1 + reviews * 0.1);
    var nextReviewTime = lastReview + nextIntervalHours * 60 * 60 * 1000;
    
    return {
        nextReview: nextReviewTime,
        interval: nextIntervalHours,
        isOverdue: Date.now() > nextReviewTime,
        urgency: Math.max(0, (Date.now() - nextReviewTime) / (24 * 60 * 60 * 1000)) // é€¾æœŸå¤©æ•°
    };
}

function updateSpacedReinforcement(word, quality) {
    // quality: 0-5 (0=å®Œå…¨å¿˜è®°, 5=å®Œç¾è®°å¿†)
    var lowerWord = word.toLowerCase();
    var data = spacedReinforcementData[lowerWord] || {
        easeFactor: 2.5,
        interval: 1,
        reviews: 0,
        lastReview: null
    };
    
    // æ›´æ–°æ˜“åº¦å› å­
    data.easeFactor = Math.max(1.3, data.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
    
    // æ›´æ–°é—´éš”
    if (quality >= 3) {
        if (data.reviews === 0) {
            data.interval = 1;
        } else if (data.reviews === 1) {
            data.interval = 6;
        } else {
            data.interval = data.interval * data.easeFactor;
        }
        data.reviews++;
    } else {
        data.reviews = 0;
        data.interval = 1;
    }
    
    data.lastReview = Date.now();
    spacedReinforcementData[lowerWord] = data;
    localStorage.setItem('spacedReinforcement', JSON.stringify(spacedReinforcementData));
    
    return data;
}

// V14.8: åˆ†å—è®°å¿†ä¼˜åŒ– - è‡ªåŠ¨æ£€æµ‹è¯æ ¹è¯ç¼€åˆ†ç»„
function autoDetectChunkingPattern(word) {
    var patterns = {
        prefixes: {
            'un': 'å¦å®š/ç›¸å',
            're': 'å†æ¬¡/è¿”å›',
            'pre': 'é¢„å…ˆ/ä¹‹å‰',
            'dis': 'å¦å®š/åˆ†ç¦»',
            'mis': 'é”™è¯¯',
            'sub': 'åœ¨ä¸‹/æ¬¡çº§',
            'super': 'è¶…çº§/ä¸Šæ–¹',
            'inter': 'ç›¸äº’/ä¹‹é—´',
            'trans': 'è·¨è¶Š/è½¬å˜',
            'anti': 'åå¯¹',
            'auto': 'è‡ªåŠ¨',
            'bi': 'åŒ',
            'co': 'å…±åŒ',
            'de': 'å‘ä¸‹/å»é™¤',
            'ex': 'å‘å¤–/å‰ä»»',
            'in': 'åœ¨å†…/å¦å®š',
            'im': 'åœ¨å†…/å¦å®š',
            'non': 'é',
            'over': 'è¿‡åº¦/åœ¨ä¸Š',
            'post': 'ä¹‹å',
            'pro': 'å‘å‰/æ”¯æŒ',
            'semi': 'åŠ',
            'under': 'ä¸è¶³/åœ¨ä¸‹'
        },
        suffixes: {
            'tion': 'åè¯(åŠ¨ä½œ/çŠ¶æ€)',
            'sion': 'åè¯(åŠ¨ä½œ/çŠ¶æ€)',
            'ment': 'åè¯(ç»“æœ/çŠ¶æ€)',
            'ness': 'åè¯(æ€§è´¨)',
            'ity': 'åè¯(æ€§è´¨)',
            'able': 'å½¢å®¹è¯(èƒ½å¤Ÿ)',
            'ible': 'å½¢å®¹è¯(èƒ½å¤Ÿ)',
            'ful': 'å½¢å®¹è¯(å……æ»¡)',
            'less': 'å½¢å®¹è¯(ç¼ºä¹)',
            'ous': 'å½¢å®¹è¯(å…·æœ‰)',
            'ive': 'å½¢å®¹è¯(å€¾å‘)',
            'al': 'å½¢å®¹è¯/åè¯',
            'ly': 'å‰¯è¯',
            'ize': 'åŠ¨è¯(ä½¿æˆä¸º)',
            'ify': 'åŠ¨è¯(ä½¿æˆä¸º)',
            'er': 'åè¯(äºº/ç‰©)',
            'or': 'åè¯(äºº/ç‰©)',
            'ist': 'åè¯(ä»äº‹è€…)',
            'ism': 'åè¯(ä¸»ä¹‰/è¡Œä¸º)'
        }
    };
    
    var detected = {
        prefix: null,
        suffix: null,
        root: word
    };
    
    // æ£€æµ‹å‰ç¼€
    for (var pre in patterns.prefixes) {
        if (word.toLowerCase().startsWith(pre) && word.length > pre.length + 2) {
            detected.prefix = { text: pre, meaning: patterns.prefixes[pre] };
            detected.root = word.slice(pre.length);
            break;
        }
    }
    
    // æ£€æµ‹åç¼€
    for (var suf in patterns.suffixes) {
        if (word.toLowerCase().endsWith(suf) && word.length > suf.length + 2) {
            detected.suffix = { text: suf, meaning: patterns.suffixes[suf] };
            if (!detected.prefix) {
                detected.root = word.slice(0, -suf.length);
            } else {
                detected.root = detected.root.slice(0, -suf.length);
            }
            break;
        }
    }
    
    return detected;
}

// æŸ¥æ‰¾ç›¸ä¼¼è¯æ ¹çš„å•è¯ï¼ˆç”¨äºåˆ†ç»„è®°å¿†ï¼‰
function findSimilarRootWords(word) {
    var pattern = autoDetectChunkingPattern(word);
    if (!pattern.root || pattern.root.length < 3) return [];
    
    var similar = [];
    var root = pattern.root.toLowerCase();
    
    // ä»å­¦ä¹ é˜Ÿåˆ—ä¸­æŸ¥æ‰¾
    if (typeof learningQueue !== 'undefined' && learningQueue.length > 0) {
        learningQueue.forEach(function(w) {
            if (w.word.toLowerCase() !== word.toLowerCase()) {
                var otherPattern = autoDetectChunkingPattern(w.word);
                if (otherPattern.root && otherPattern.root.toLowerCase().includes(root.slice(0, 3))) {
                    similar.push(w.word);
                }
            }
        });
    }
    
    return similar.slice(0, 5);
}

// V14.9: äº¤äº’å¼è®°å¿†ç»ƒä¹ 
function startMnemonicPractice(word) {
    var mnemonic = getWordMnemonic(word);
    var enhanced = getEnhancedMnemonic(word);
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'mnemonicPracticeOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);';
    
    var practiceHtml = '<div style="background:white;border-radius:24px;width:90%;max-width:400px;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,0.4);">';
    
    // å¤´éƒ¨
    practiceHtml += '<div style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);padding:24px;text-align:center;">';
    practiceHtml += '<div style="font-size:40px;margin-bottom:8px;">ğŸ§ </div>';
    practiceHtml += '<div style="color:white;font-size:20px;font-weight:700;">è®°å¿†æµ‹éªŒ</div>';
    practiceHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;margin-top:4px;">æµ‹è¯•ä½ çš„è®°å¿†æ•ˆæœ</div>';
    practiceHtml += '</div>';
    
    // ç»ƒä¹ å†…å®¹
    practiceHtml += '<div style="padding:24px;">';
    
    // ç¬¬ä¸€æ­¥ï¼šæ˜¾ç¤ºå•è¯ï¼Œéšè—é‡Šä¹‰
    practiceHtml += '<div id="practiceStep1">';
    practiceHtml += '<div style="text-align:center;margin-bottom:20px;">';
    practiceHtml += '<div style="font-size:32px;font-weight:700;color:#1e1b4b;margin-bottom:8px;">' + word + '</div>';
    practiceHtml += '<div style="font-size:14px;color:#6b7280;">å°è¯•å›å¿†è¿™ä¸ªå•è¯çš„æ„æ€</div>';
    practiceHtml += '</div>';
    
    // æç¤ºæŒ‰é’®
    practiceHtml += '<div style="display:flex;gap:12px;margin-bottom:16px;">';
    practiceHtml += '<button onclick="showPracticeHint(1)" style="flex:1;padding:12px;background:#f3f4f6;border:2px solid #e5e7eb;border-radius:12px;font-size:13px;cursor:pointer;">ğŸ’¡ åŠ©è®°æç¤º</button>';
    practiceHtml += '<button onclick="showPracticeHint(2)" style="flex:1;padding:12px;background:#f3f4f6;border:2px solid #e5e7eb;border-radius:12px;font-size:13px;cursor:pointer;">ğŸ“š è¯æ ¹æç¤º</button>';
    practiceHtml += '</div>';
    
    // æç¤ºæ˜¾ç¤ºåŒº
    practiceHtml += '<div id="practiceHintArea" style="display:none;padding:16px;background:#fef3c7;border-radius:12px;margin-bottom:16px;"></div>';
    
    // æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®
    practiceHtml += '<button onclick="showPracticeAnswer()" style="width:100%;padding:14px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border:none;border-radius:12px;color:white;font-size:16px;font-weight:600;cursor:pointer;">ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ</button>';
    practiceHtml += '</div>';
    
    // ç¬¬äºŒæ­¥ï¼šè¯„ä¼°è®°å¿†ï¼ˆåˆå§‹éšè—ï¼‰
    practiceHtml += '<div id="practiceStep2" style="display:none;">';
    practiceHtml += '<div style="text-align:center;margin-bottom:20px;">';
    practiceHtml += '<div style="font-size:28px;font-weight:700;color:#1e1b4b;margin-bottom:12px;">' + word + '</div>';
    var wordData = learningQueue ? learningQueue.find(function(w) { return w.word.toLowerCase() === word.toLowerCase(); }) : null;
    practiceHtml += '<div style="font-size:18px;color:#059669;font-weight:600;">' + (wordData ? wordData.meaningCn : 'æš‚æ— é‡Šä¹‰') + '</div>';
    practiceHtml += '</div>';
    
    // è®°å¿†è¯„ä¼°æŒ‰é’®
    practiceHtml += '<div style="font-size:14px;color:#6b7280;text-align:center;margin-bottom:12px;">ä½ è®°ä½äº†å—ï¼Ÿ</div>';
    practiceHtml += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">';
    practiceHtml += '<button onclick="ratePracticeResult(\'' + word + '\', 1)" style="padding:16px 8px;background:#fee2e2;border:2px solid #fecaca;border-radius:12px;cursor:pointer;"><div style="font-size:24px;">ğŸ˜«</div><div style="font-size:12px;color:#991b1b;font-weight:600;">å¿˜è®°äº†</div></button>';
    practiceHtml += '<button onclick="ratePracticeResult(\'' + word + '\', 3)" style="padding:16px 8px;background:#fef3c7;border:2px solid #fde68a;border-radius:12px;cursor:pointer;"><div style="font-size:24px;">ğŸ¤”</div><div style="font-size:12px;color:#92400e;font-weight:600;">æœ‰ç‚¹å°è±¡</div></button>';
    practiceHtml += '<button onclick="ratePracticeResult(\'' + word + '\', 5)" style="padding:16px 8px;background:#dcfce7;border:2px solid #bbf7d0;border-radius:12px;cursor:pointer;"><div style="font-size:24px;">ğŸ˜Š</div><div style="font-size:12px;color:#166534;font-weight:600;">å®Œå…¨è®°ä½</div></button>';
    practiceHtml += '</div>';
    practiceHtml += '</div>';
    
    practiceHtml += '</div>';
    
    // å…³é—­æŒ‰é’®
    practiceHtml += '<div style="padding:16px 24px 24px;text-align:center;">';
    practiceHtml += '<button onclick="closeMnemonicPractice()" style="padding:10px 24px;background:#f3f4f6;border:none;border-radius:8px;color:#6b7280;font-size:14px;cursor:pointer;">å…³é—­ç»ƒä¹ </button>';
    practiceHtml += '</div>';
    
    practiceHtml += '</div>';
    
    overlayEl.innerHTML = practiceHtml;
    document.body.appendChild(overlayEl);
    
    // ä¿å­˜å½“å‰å•è¯ä¿¡æ¯ä¾›æç¤ºä½¿ç”¨
    window._practiceWord = word;
    window._practiceMnemonic = mnemonic;
    window._practiceEnhanced = enhanced;
}

function showPracticeHint(hintType) {
    var hintArea = document.getElementById('practiceHintArea');
    if (!hintArea) return;
    
    var hintContent = '';
    if (hintType === 1 && window._practiceMnemonic) {
        hintContent = 'ğŸ’¡ <strong>åŠ©è®°:</strong> ' + window._practiceMnemonic.mnemonic;
    } else if (hintType === 2 && window._practiceMnemonic && window._practiceMnemonic.roots) {
        hintContent = 'ğŸ“š <strong>è¯æ ¹:</strong> ' + window._practiceMnemonic.roots;
    } else {
        var pattern = autoDetectChunkingPattern(window._practiceWord);
        if (pattern.prefix) {
            hintContent = 'ğŸ“š <strong>å‰ç¼€:</strong> ' + pattern.prefix.text + ' (' + pattern.prefix.meaning + ')';
        } else if (pattern.suffix) {
            hintContent = 'ğŸ“š <strong>åç¼€:</strong> ' + pattern.suffix.text + ' (' + pattern.suffix.meaning + ')';
        } else {
            hintContent = 'ğŸ’¡ æ²¡æœ‰é¢å¤–æç¤ºï¼Œè¯•ç€å›å¿†ä¸€ä¸‹å§ï¼';
        }
    }
    
    hintArea.innerHTML = '<div style="font-size:14px;color:#92400e;">' + hintContent + '</div>';
    hintArea.style.display = 'block';
}

function showPracticeAnswer() {
    document.getElementById('practiceStep1').style.display = 'none';
    document.getElementById('practiceStep2').style.display = 'block';
}

function ratePracticeResult(word, quality) {
    // æ›´æ–°é—´éš”å¼ºåŒ–æ•°æ®
    updateSpacedReinforcement(word, quality);
    
    // æ›´æ–°åŠ©è®°æ•ˆæœ
    recordMnemonicEffectiveness(word, window._practiceMnemonic ? window._practiceMnemonic.type : 'unknown', quality >= 3);
    
    closeMnemonicPractice();
    
    // æ˜¾ç¤ºç»“æœåé¦ˆ
    var feedback = document.createElement('div');
    var feedbackText = quality >= 4 ? 'ğŸ‰ å¤ªæ£’äº†ï¼' : quality >= 3 ? 'ğŸ‘ ç»§ç»­åŠ æ²¹ï¼' : 'ğŸ’ª å¤šå¤ä¹ å‡ æ¬¡ï¼';
    feedback.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px 32px;border-radius:16px;font-size:20px;font-weight:700;z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.3);';
    feedback.innerHTML = feedbackText;
    document.body.appendChild(feedback);
    setTimeout(function() { feedback.remove(); }, 1500);
}

function closeMnemonicPractice() {
    var overlay = document.getElementById('mnemonicPracticeOverlay');
    if (overlay) overlay.remove();
}

// V14.10: è®°å¿†æ•ˆæœè¿½è¸ªé¢æ¿
function showMnemonicStats() {
    var stats = calculateMnemonicStats();
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'mnemonicStatsOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    
    var statsHtml = '<div style="background:white;border-radius:24px;width:90%;max-width:480px;max-height:85vh;overflow-y:auto;box-shadow:0 25px 80px rgba(0,0,0,0.4);">';
    
    // å¤´éƒ¨
    statsHtml += '<div style="background:linear-gradient(135deg,#8b5cf6 0%,#6366f1 50%,#3b82f6 100%);padding:24px;border-radius:24px 24px 0 0;">';
    statsHtml += '<div style="display:flex;align-items:center;justify-content:space-between;">';
    statsHtml += '<div style="display:flex;align-items:center;gap:14px;">';
    statsHtml += '<span style="font-size:36px;">ğŸ“Š</span>';
    statsHtml += '<div><div style="color:white;font-size:20px;font-weight:700;">è®°å¿†æ•ˆæœç»Ÿè®¡</div>';
    statsHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;">ç§‘å­¦è¿½è¸ªä½ çš„å­¦ä¹ è¿›å±•</div></div>';
    statsHtml += '</div>';
    statsHtml += '<button onclick="closeMnemonicStats()" style="background:rgba(255,255,255,0.2);border:none;width:40px;height:40px;border-radius:14px;color:white;font-size:22px;cursor:pointer;">Ã—</button>';
    statsHtml += '</div></div>';
    
    // æ€»ä½“ç»Ÿè®¡
    statsHtml += '<div style="padding:20px;">';
    
    // æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡
    statsHtml += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">';
    
    statsHtml += '<div style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:16px;border-radius:16px;text-align:center;">';
    statsHtml += '<div style="font-size:28px;font-weight:700;color:#166534;">' + stats.totalWords + '</div>';
    statsHtml += '<div style="font-size:12px;color:#15803d;font-weight:600;">å·²è®°å¿†å•è¯</div>';
    statsHtml += '</div>';
    
    statsHtml += '<div style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);padding:16px;border-radius:16px;text-align:center;">';
    statsHtml += '<div style="font-size:28px;font-weight:700;color:#1e40af;">' + Math.round(stats.avgEffectiveness * 100) + '%</div>';
    statsHtml += '<div style="font-size:12px;color:#1d4ed8;font-weight:600;">å¹³å‡è®°å¿†æ•ˆæœ</div>';
    statsHtml += '</div>';
    
    statsHtml += '<div style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:16px;border-radius:16px;text-align:center;">';
    statsHtml += '<div style="font-size:28px;font-weight:700;color:#92400e;">' + stats.customMnemonics + '</div>';
    statsHtml += '<div style="font-size:12px;color:#b45309;font-weight:600;">è‡ªå®šä¹‰è®°å¿†æ³•</div>';
    statsHtml += '</div>';
    
    statsHtml += '<div style="background:linear-gradient(135deg,#ede9fe,#ddd6fe);padding:16px;border-radius:16px;text-align:center;">';
    statsHtml += '<div style="font-size:28px;font-weight:700;color:#5b21b6;">' + stats.palacePlacements + '</div>';
    statsHtml += '<div style="font-size:12px;color:#6d28d9;font-weight:600;">è®°å¿†å®«æ®¿ä½ç½®</div>';
    statsHtml += '</div>';
    
    statsHtml += '</div>';
    
    // å„ç±»å‹æ•ˆæœåˆ†æ
    statsHtml += '<div style="margin-bottom:20px;">';
    statsHtml += '<div style="font-size:14px;font-weight:700;color:#1f2937;margin-bottom:12px;">ğŸ“ˆ å„è®°å¿†æ³•æ•ˆæœ</div>';
    
    if (stats.typeStats && Object.keys(stats.typeStats).length > 0) {
        Object.keys(stats.typeStats).forEach(function(type) {
            var typeStat = stats.typeStats[type];
            var typeInfo = MNEMONIC_SCIENCE.types[type] || { icon: 'ğŸ“', name: type, color: '#6b7280' };
            var effectiveness = typeStat.total > 0 ? Math.round((typeStat.success / typeStat.total) * 100) : 0;
            var barColor = effectiveness >= 80 ? '#22c55e' : effectiveness >= 50 ? '#f59e0b' : '#ef4444';
            
            statsHtml += '<div style="display:flex;align-items:center;gap:12px;padding:10px;background:#f9fafb;border-radius:10px;margin-bottom:8px;">';
            statsHtml += '<span style="font-size:20px;">' + typeInfo.icon + '</span>';
            statsHtml += '<div style="flex:1;">';
            statsHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
            statsHtml += '<span style="font-size:13px;font-weight:600;color:' + typeInfo.color + ';">' + typeInfo.name + '</span>';
            statsHtml += '<span style="font-size:12px;color:#6b7280;">' + typeStat.total + 'æ¬¡ä½¿ç”¨</span>';
            statsHtml += '</div>';
            statsHtml += '<div style="height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">';
            statsHtml += '<div style="height:100%;width:' + effectiveness + '%;background:' + barColor + ';border-radius:3px;"></div>';
            statsHtml += '</div>';
            statsHtml += '</div>';
            statsHtml += '<span style="font-size:14px;font-weight:700;color:' + barColor + ';min-width:45px;text-align:right;">' + effectiveness + '%</span>';
            statsHtml += '</div>';
        });
    } else {
        statsHtml += '<div style="text-align:center;padding:20px;color:#9ca3af;">æš‚æ— æ•°æ®ï¼Œç»§ç»­å­¦ä¹ ç§¯ç´¯å§ï¼</div>';
    }
    
    statsHtml += '</div>';
    
    // ç§‘å­¦å»ºè®®
    statsHtml += '<div style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);padding:16px;border-radius:14px;margin-bottom:16px;">';
    statsHtml += '<div style="display:flex;align-items:flex-start;gap:10px;">';
    statsHtml += '<span style="font-size:20px;">ğŸ’¡</span>';
    statsHtml += '<div><div style="font-size:13px;font-weight:600;color:#0369a1;margin-bottom:6px;">ç§‘å­¦å»ºè®®</div>';
    statsHtml += '<div style="font-size:12px;color:#0c4a6e;line-height:1.6;">' + generateScientificAdvice(stats) + '</div></div>';
    statsHtml += '</div></div>';
    
    // å¿«é€Ÿç»ƒä¹ æŒ‰é’®
    if (stats.overdueWords > 0) {
        statsHtml += '<button onclick="startOverduePractice();closeMnemonicStats();" style="width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:12px;color:white;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:12px;box-shadow:0 4px 12px rgba(245,158,11,0.3);">âš¡ ' + stats.overdueWords + 'ä¸ªå•è¯éœ€è¦å¤ä¹ </button>';
    }
    
    statsHtml += '</div></div>';
    
    overlayEl.innerHTML = statsHtml;
    document.body.appendChild(overlayEl);
}

function calculateMnemonicStats() {
    var stats = {
        totalWords: Object.keys(mnemonicEffectivenessData).filter(function(k) { return k !== '_typeStats'; }).length,
        avgEffectiveness: 0,
        customMnemonics: Object.keys(userCustomMnemonics).length,
        palacePlacements: memoryPalaceData.placements ? Object.keys(memoryPalaceData.placements).length : 0,
        emotionalAnchors: Object.keys(emotionalAnchorData).length,
        typeStats: mnemonicEffectivenessData._typeStats || {},
        overdueWords: 0
    };
    
    // è®¡ç®—å¹³å‡æ•ˆæœ
    var totalEff = 0;
    var effCount = 0;
    Object.keys(mnemonicEffectivenessData).forEach(function(word) {
        if (word !== '_typeStats' && mnemonicEffectivenessData[word].effectiveness) {
            totalEff += mnemonicEffectivenessData[word].effectiveness;
            effCount++;
        }
    });
    stats.avgEffectiveness = effCount > 0 ? totalEff / effCount : 0;
    
    // è®¡ç®—é€¾æœŸå¤ä¹ å•è¯
    Object.keys(spacedReinforcementData).forEach(function(word) {
        var review = calculateOptimalReviewTime(word);
        if (review.isOverdue) stats.overdueWords++;
    });
    
    return stats;
}

function generateScientificAdvice(stats) {
    var advice = [];
    
    if (stats.avgEffectiveness < 0.5) {
        advice.push('å°è¯•ä½¿ç”¨æ›´å¤šè§†è§‰è”æƒ³å’Œæƒ…æ„Ÿé”šå®šæ¥å¢å¼ºè®°å¿†æ•ˆæœã€‚');
    }
    if (stats.customMnemonics < 5) {
        advice.push('åˆ›å»ºä¸ªæ€§åŒ–è®°å¿†æ³•èƒ½æå‡20-30%çš„è®°å¿†æ•ˆæœã€‚');
    }
    if (stats.palacePlacements < 3) {
        advice.push('è®°å¿†å®«æ®¿æ³•æ˜¯ä¸–ç•Œè®°å¿†å† å†›å¸¸ç”¨æŠ€æœ¯ï¼Œæ•ˆæœæ˜¾è‘—ã€‚');
    }
    if (stats.overdueWords > 5) {
        advice.push('æœ‰' + stats.overdueWords + 'ä¸ªå•è¯å³å°†é—å¿˜ï¼Œå»ºè®®ç«‹å³å¤ä¹ ï¼');
    }
    
    if (advice.length === 0) {
        advice.push('ç»§ç»­ä¿æŒï¼ä½ çš„å­¦ä¹ æ–¹æ³•å¾ˆç§‘å­¦ï¼Œè®°å¿†æ•ˆæœè‰¯å¥½ã€‚');
    }
    
    return advice.join(' ');
}

function startOverduePractice() {
    var overdueWords = [];
    Object.keys(spacedReinforcementData).forEach(function(word) {
        var review = calculateOptimalReviewTime(word);
        if (review.isOverdue) {
            overdueWords.push({ word: word, urgency: review.urgency });
        }
    });
    
    // æŒ‰ç´§æ€¥ç¨‹åº¦æ’åº
    overdueWords.sort(function(a, b) { return b.urgency - a.urgency; });
    
    if (overdueWords.length > 0) {
        startMnemonicPractice(overdueWords[0].word);
    }
}

function closeMnemonicStats() {
    var overlay = document.getElementById('mnemonicStatsOverlay');
    if (overlay) overlay.remove();
}

// å¯¼å‡ºV14.7-10åŠŸèƒ½
window.startMnemonicPractice = startMnemonicPractice;
window.showPracticeHint = showPracticeHint;
window.showPracticeAnswer = showPracticeAnswer;
window.ratePracticeResult = ratePracticeResult;
window.closeMnemonicPractice = closeMnemonicPractice;
window.showMnemonicStats = showMnemonicStats;
window.closeMnemonicStats = closeMnemonicStats;
window.startOverduePractice = startOverduePractice;
