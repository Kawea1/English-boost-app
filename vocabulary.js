// vocabulary.js - æ ¸å¿ƒè¯æ±‡æ¨¡å—ï¼ˆå¸¦ä¸­æ–‡é‡Šä¹‰ï¼‰
window.vocabularyData = [
    // GREæ ¸å¿ƒè¯æ±‡ (50è¯)
    { word: 'aberrant', phonetic: '/É™ËˆberÉ™nt/', meaningEn: 'departing from the accepted standard', meaningCn: 'å¼‚å¸¸çš„ï¼Œåç¦»æ­£é“çš„', example: 'His aberrant behavior worried his parents.' },
    { word: 'abstruse', phonetic: '/Ã¦bËˆstruËs/', meaningEn: 'difficult to understand', meaningCn: 'æ·±å¥¥çš„ï¼Œéš¾æ‡‚çš„', example: 'The professor made abstruse concepts accessible.' },
    { word: 'acerbic', phonetic: '/É™ËˆsÉœËrbÉªk/', meaningEn: 'sharp and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè¾›è¾£çš„', example: 'Her acerbic wit made her famous.' },
    { word: 'acumen', phonetic: '/É™ËˆkjuËmÉ™n/', meaningEn: 'keen insight', meaningCn: 'æ•é”ï¼Œèªæ˜', example: 'His business acumen led to success.' },
    { word: 'adamant', phonetic: '/ËˆÃ¦dÉ™mÉ™nt/', meaningEn: 'refusing to change', meaningCn: 'åšå®šä¸ç§»çš„', example: 'She was adamant about her decision.' },
    { word: 'admonish', phonetic: '/É™dËˆmÉ‘ËnÉªÊƒ/', meaningEn: 'warn or reprimand firmly', meaningCn: 'å‘Šè¯«ï¼Œè­¦å‘Š', example: 'The teacher admonished the students.' },
    { word: 'aesthetic', phonetic: '/esËˆÎ¸etÉªk/', meaningEn: 'relating to beauty', meaningCn: 'ç¾å­¦çš„ï¼Œå®¡ç¾çš„', example: 'The building has great aesthetic appeal.' },
    { word: 'affable', phonetic: '/ËˆÃ¦fÉ™bl/', meaningEn: 'friendly and easy to talk to', meaningCn: 'å’Œè”¼å¯äº²çš„', example: 'The affable host welcomed everyone.' },
    { word: 'alacrity', phonetic: '/É™ËˆlÃ¦krÉ™ti/', meaningEn: 'brisk eagerness', meaningCn: 'æ•æ·ï¼Œæ¬£ç„¶', example: 'She accepted the offer with alacrity.' },
    { word: 'alleviate', phonetic: '/É™ËˆliËvieÉªt/', meaningEn: 'make less severe', meaningCn: 'å‡è½»ï¼Œç¼“è§£', example: 'The medicine helped alleviate the pain.' },
    { word: 'amalgamate', phonetic: '/É™ËˆmÃ¦lÉ¡É™meÉªt/', meaningEn: 'combine or unite', meaningCn: 'åˆå¹¶ï¼Œæ··åˆ', example: 'The two companies amalgamated.' },
    { word: 'ambiguous', phonetic: '/Ã¦mËˆbÉªÉ¡juÉ™s/', meaningEn: 'unclear in meaning', meaningCn: 'æ¨¡ç³Šçš„ï¼Œæ­§ä¹‰çš„', example: 'The statement was deliberately ambiguous.' },
    { word: 'ameliorate', phonetic: '/É™ËˆmiËliÉ™reÉªt/', meaningEn: 'make better', meaningCn: 'æ”¹å–„ï¼Œæ”¹è¿›', example: 'Steps were taken to ameliorate conditions.' },
    { word: 'amenable', phonetic: '/É™ËˆmiËnÉ™bl/', meaningEn: 'willing to agree', meaningCn: 'é¡ºä»çš„ï¼Œæ„¿æ„æ¥å—çš„', example: 'He was amenable to suggestions.' },
    { word: 'anachronistic', phonetic: '/É™ËŒnÃ¦krÉ™ËˆnÉªstÉªk/', meaningEn: 'belonging to a different time', meaningCn: 'æ—¶ä»£é”™è¯¯çš„', example: 'The customs seemed anachronistic.' },
    { word: 'analogous', phonetic: '/É™ËˆnÃ¦lÉ™É¡É™s/', meaningEn: 'comparable in certain respects', meaningCn: 'ç±»ä¼¼çš„ï¼Œç›¸ä¼¼çš„', example: 'The situation is analogous to ours.' },
    { word: 'anomaly', phonetic: '/É™ËˆnÉ‘ËmÉ™li/', meaningEn: 'something unusual', meaningCn: 'å¼‚å¸¸ï¼Œåå¸¸ç°è±¡', example: 'The results revealed an anomaly.' },
    { word: 'antipathy', phonetic: '/Ã¦nËˆtÉªpÉ™Î¸i/', meaningEn: 'strong dislike', meaningCn: 'åæ„Ÿï¼ŒåŒæ¶', example: 'She felt antipathy toward him.' },
    { word: 'apathy', phonetic: '/ËˆÃ¦pÉ™Î¸i/', meaningEn: 'lack of interest', meaningCn: 'å†·æ¼ ï¼Œæ— åŠ¨äºè¡·', example: 'Voter apathy was widespread.' },
    { word: 'appease', phonetic: '/É™ËˆpiËz/', meaningEn: 'pacify by giving in', meaningCn: 'å¹³æ¯ï¼Œå®‰æŠš', example: 'They tried to appease the angry crowd.' },
    { word: 'arbitrary', phonetic: '/ËˆÉ‘ËrbÉªtreri/', meaningEn: 'based on random choice', meaningCn: 'ä»»æ„çš„ï¼Œæ­¦æ–­çš„', example: 'The decision seemed arbitrary.' },
    { word: 'archaic', phonetic: '/É‘ËrËˆkeÉªÉªk/', meaningEn: 'very old or outdated', meaningCn: 'å¤è€çš„ï¼Œè¿‡æ—¶çš„', example: 'The law is archaic and needs reform.' },
    { word: 'arduous', phonetic: '/ËˆÉ‘ËrdÊ’uÉ™s/', meaningEn: 'difficult and tiring', meaningCn: 'è‰°è‹¦çš„ï¼Œè´¹åŠ›çš„', example: 'The climb was arduous but rewarding.' },
    { word: 'articulate', phonetic: '/É‘ËrËˆtÉªkjÉ™lÉ™t/', meaningEn: 'express clearly', meaningCn: 'æ¸…æ¥šè¡¨è¾¾çš„ï¼Œå–„äºè¡¨è¾¾çš„', example: 'She is an articulate speaker.' },
    { word: 'ascetic', phonetic: '/É™ËˆsetÉªk/', meaningEn: 'practicing self-denial', meaningCn: 'è‹¦è¡Œçš„ï¼Œç¦æ¬²çš„', example: 'He lived an ascetic life.' },
    { word: 'assiduous', phonetic: '/É™ËˆsÉªdÊ’uÉ™s/', meaningEn: 'showing great care', meaningCn: 'å‹¤å‹‰çš„ï¼Œåˆ»è‹¦çš„', example: 'She was assiduous in her studies.' },
    { word: 'astute', phonetic: '/É™ËˆstuËt/', meaningEn: 'shrewd and perceptive', meaningCn: 'ç²¾æ˜çš„ï¼Œæ•é”çš„', example: 'An astute observer noticed the change.' },
    { word: 'audacious', phonetic: '/É”ËËˆdeÉªÊƒÉ™s/', meaningEn: 'bold and daring', meaningCn: 'å¤§èƒ†çš„ï¼Œæ— ç•çš„', example: 'It was an audacious plan.' },
    { word: 'austere', phonetic: '/É”ËËˆstÉªr/', meaningEn: 'severe or strict', meaningCn: 'ç®€æœ´çš„ï¼Œä¸¥å³»çš„', example: 'The room had an austere appearance.' },
    { word: 'avarice', phonetic: '/ËˆÃ¦vÉ™rÉªs/', meaningEn: 'extreme greed', meaningCn: 'è´ªå©ªï¼Œè´ªè´¢', example: 'His avarice knew no bounds.' },
    { word: 'banal', phonetic: '/bÉ™ËˆnÉ‘Ël/', meaningEn: 'lacking originality', meaningCn: 'å¹³åº¸çš„ï¼Œé™ˆè…çš„', example: 'The movie had a banal plot.' },
    { word: 'belligerent', phonetic: '/bÉ™ËˆlÉªdÊ’É™rÉ™nt/', meaningEn: 'hostile and aggressive', meaningCn: 'å¥½æˆ˜çš„ï¼ŒæŒ‘è¡…çš„', example: 'His belligerent attitude caused problems.' },
    { word: 'benevolent', phonetic: '/bÉ™ËˆnevÉ™lÉ™nt/', meaningEn: 'well-meaning and kind', meaningCn: 'ä»æ…ˆçš„ï¼Œå–„æ„çš„', example: 'A benevolent donor funded the project.' },
    { word: 'bolster', phonetic: '/ËˆboÊŠlstÉ™r/', meaningEn: 'support or strengthen', meaningCn: 'æ”¯æŒï¼ŒåŠ å¼º', example: 'Evidence bolstered his argument.' },
    { word: 'burgeon', phonetic: '/ËˆbÉœËrdÊ’É™n/', meaningEn: 'grow rapidly', meaningCn: 'è¿…é€Ÿå‘å±•ï¼ŒèŒèŠ½', example: 'The industry began to burgeon.' },
    { word: 'cacophony', phonetic: '/kÉ™ËˆkÉ‘ËfÉ™ni/', meaningEn: 'harsh mixture of sounds', meaningCn: 'åˆºè€³çš„å£°éŸ³ï¼Œä¸å’Œè°', example: 'A cacophony of car horns filled the air.' },
    { word: 'candid', phonetic: '/ËˆkÃ¦ndÉªd/', meaningEn: 'truthful and straightforward', meaningCn: 'å¦ç‡çš„ï¼Œç›´è¨€ä¸è®³çš„', example: 'She gave a candid assessment.' },
    { word: 'capricious', phonetic: '/kÉ™ËˆprÉªÊƒÉ™s/', meaningEn: 'unpredictable', meaningCn: 'åå¤æ— å¸¸çš„ï¼Œä»»æ€§çš„', example: 'The weather was capricious.' },
    { word: 'castigate', phonetic: '/ËˆkÃ¦stÉªÉ¡eÉªt/', meaningEn: 'criticize severely', meaningCn: 'ä¸¥å‰æ‰¹è¯„ï¼Œæƒ©ç½š', example: 'Critics castigated the decision.' },
    { word: 'catalyst', phonetic: '/ËˆkÃ¦tÉ™lÉªst/', meaningEn: 'agent that causes change', meaningCn: 'å‚¬åŒ–å‰‚ï¼Œä¿ƒè¿›å› ç´ ', example: 'The event was a catalyst for reform.' },
    { word: 'caustic', phonetic: '/ËˆkÉ”ËstÉªk/', meaningEn: 'sarcastic and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè…èš€æ€§çš„', example: 'His caustic remarks hurt her.' },
    { word: 'chicanery', phonetic: '/ÊƒÉªËˆkeÉªnÉ™ri/', meaningEn: 'trickery and deception', meaningCn: 'æ¬ºéª—ï¼Œè¯¡è®¡', example: 'Political chicanery undermined trust.' },
    { word: 'circumspect', phonetic: '/ËˆsÉœËrkÉ™mspekt/', meaningEn: 'cautious and prudent', meaningCn: 'è°¨æ…çš„ï¼Œå°å¿ƒçš„', example: 'Be circumspect in your decisions.' },
    { word: 'clandestine', phonetic: '/klÃ¦nËˆdestÉªn/', meaningEn: 'kept secret', meaningCn: 'ç§˜å¯†çš„ï¼Œæš—ä¸­çš„', example: 'They held clandestine meetings.' },
    { word: 'coalesce', phonetic: '/ËŒkoÊŠÉ™Ëˆles/', meaningEn: 'come together', meaningCn: 'è”åˆï¼Œåˆå¹¶', example: 'Different groups coalesced into one.' },
    { word: 'cogent', phonetic: '/ËˆkoÊŠdÊ’É™nt/', meaningEn: 'clear and convincing', meaningCn: 'æœ‰è¯´æœåŠ›çš„ï¼Œä»¤äººä¿¡æœçš„', example: 'She presented a cogent argument.' },
    { word: 'commensurate', phonetic: '/kÉ™ËˆmenÊƒÉ™rÉ™t/', meaningEn: 'corresponding in size', meaningCn: 'ç›¸ç§°çš„ï¼Œç›¸å½“çš„', example: 'Salary commensurate with experience.' },
    { word: 'compelling', phonetic: '/kÉ™mËˆpelÉªÅ‹/', meaningEn: 'powerfully convincing', meaningCn: 'ä»¤äººä¿¡æœçš„ï¼Œå¼•äººæ³¨ç›®çš„', example: 'The evidence was compelling.' },
    { word: 'complacent', phonetic: '/kÉ™mËˆpleÉªsnt/', meaningEn: 'self-satisfied', meaningCn: 'è‡ªæ»¡çš„ï¼Œå¾—æ„çš„', example: 'Success made him complacent.' },
    { word: 'comprehensive', phonetic: '/ËŒkÉ‘ËmprÉªËˆhensÉªv/', meaningEn: 'complete and thorough', meaningCn: 'å…¨é¢çš„ï¼Œç»¼åˆçš„', example: 'A comprehensive study was conducted.' }
];

// å½“å‰å­¦ä¹ çŠ¶æ€
var currentWordIndex = 0;
var wordsPerSession = parseInt(localStorage.getItem('wordsPerSession') || '20'); // æ¯æ¬¡å­¦ä¹ å•è¯æ•°
var requiredLearningTimes = parseInt(localStorage.getItem('requiredLearningTimes') || '3'); // æ¯ä¸ªå•è¯éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
var sessionWords = []; // æœ¬æ¬¡å­¦ä¹ çš„å•è¯ï¼ˆåŸå§‹åˆ—è¡¨ï¼‰
var learningQueue = []; // å­¦ä¹ é˜Ÿåˆ—ï¼ˆåŒ…å«é‡å¤å‡ºç°çš„å•è¯ï¼‰
var currentQueueIndex = 0; // å½“å‰é˜Ÿåˆ—ç´¢å¼•
var learnedWords = [];
var wordRatings = {};
var wordLearningProgress = {}; // è®°å½•æ¯ä¸ªå•è¯çš„å­¦ä¹ è¿›åº¦
var sessionWordProgress = {}; // æœ¬è½®å­¦ä¹ ä¸­æ¯ä¸ªå•è¯çš„è¿›åº¦ï¼ˆç”¨äºé—´éš”é‡å¤ï¼‰

// V11: åŒä¹‰è¯/åä¹‰è¯æ•°æ®
var wordRelationsData = null;

// V12: æ™ºèƒ½åŠ©è®°è¯æ•°æ®
var wordMnemonicsData = null;

// V13: è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
var wordDifficultyData = null;

// ==================== V14: ç§‘å­¦åŠ©è®°ç³»ç»Ÿ ====================
// åŸºäºè®¤çŸ¥å¿ƒç†å­¦çš„10ä¸ªç»´åº¦æ”¹è¿›

// V14.1: åŠ©è®°æ•ˆæœè¯„ä¼°æ•°æ®
var mnemonicEffectivenessData = {};
try {
    mnemonicEffectivenessData = JSON.parse(localStorage.getItem('mnemonicEffectiveness') || '{}');
} catch(e) {
    mnemonicEffectivenessData = {};
}

// V14.2: ç”¨æˆ·è‡ªå®šä¹‰åŠ©è®°è¯
var userCustomMnemonics = {};
try {
    userCustomMnemonics = JSON.parse(localStorage.getItem('userCustomMnemonics') || '{}');
} catch(e) {
    userCustomMnemonics = {};
}

// V14.3: è®°å¿†å®«æ®¿æ•°æ®
var memoryPalaceData = {};
try {
    memoryPalaceData = JSON.parse(localStorage.getItem('memoryPalace') || '{}');
} catch(e) {
    memoryPalaceData = {};
}

// V14.4: æƒ…æ„Ÿé”šå®šæ•°æ®
var emotionalAnchorData = {};
try {
    emotionalAnchorData = JSON.parse(localStorage.getItem('emotionalAnchors') || '{}');
} catch(e) {
    emotionalAnchorData = {};
}

// V14.5: åˆ†å—è®°å¿†ç»„
var chunkingGroups = {};
try {
    chunkingGroups = JSON.parse(localStorage.getItem('chunkingGroups') || '{}');
} catch(e) {
    chunkingGroups = {};
}

// V14: ç§‘å­¦è®°å¿†æ–¹æ³•ç±»å‹ï¼ˆåŸºäºç ”ç©¶ï¼‰
var MNEMONIC_SCIENCE = {
    types: {
        'etymology': { name: 'è¯æºåˆ†æ', icon: 'ğŸ“š', color: '#166534', bg: '#dcfce7', effectiveness: 0.85, description: 'åŸºäºè¯æ ¹è¯ç¼€ï¼Œå»ºç«‹æ·±å±‚è¯­ä¹‰è”ç³»' },
        'phonetic': { name: 'è°éŸ³è®°å¿†', icon: 'ğŸ”Š', color: '#92400e', bg: '#fef3c7', effectiveness: 0.72, description: 'é€šè¿‡å£°éŸ³ç›¸ä¼¼æ€§å»ºç«‹å¿«é€Ÿè”æƒ³' },
        'visual': { name: 'å½¢è±¡è”æƒ³', icon: 'ğŸ¨', color: '#1e40af', bg: '#dbeafe', effectiveness: 0.88, description: 'åˆ›å»ºç”ŸåŠ¨è§†è§‰ç”»é¢ï¼Œæ¿€æ´»è§†è§‰çš®å±‚' },
        'story': { name: 'æ•…äº‹è®°å¿†', icon: 'ğŸ“–', color: '#7c2d12', bg: '#ffedd5', effectiveness: 0.90, description: 'ç¼–ç»‡å™äº‹æƒ…èŠ‚ï¼Œåˆ©ç”¨æƒ…èŠ‚è®°å¿†ä¼˜åŠ¿' },
        'loci': { name: 'è®°å¿†å®«æ®¿', icon: 'ğŸ›ï¸', color: '#5b21b6', bg: '#ede9fe', effectiveness: 0.92, description: 'ç©ºé—´å®šä½æ³•ï¼Œä¸–ç•Œè®°å¿†å¤§å¸ˆå¸¸ç”¨æŠ€æœ¯' },
        'chunking': { name: 'åˆ†å—è®°å¿†', icon: 'ğŸ§©', color: '#0f766e', bg: '#ccfbf1', effectiveness: 0.80, description: 'ä¿¡æ¯åˆ†ç»„ï¼Œå‡è½»å·¥ä½œè®°å¿†è´Ÿæ‹…' },
        'emotional': { name: 'æƒ…æ„Ÿé”šå®š', icon: 'ğŸ’–', color: '#be123c', bg: '#ffe4e6', effectiveness: 0.87, description: 'å»ºç«‹æƒ…æ„Ÿè¿æ¥ï¼Œå¢å¼ºé•¿æœŸè®°å¿†' },
        'kinesthetic': { name: 'åŠ¨ä½œè®°å¿†', icon: 'ğŸ¤¸', color: '#4338ca', bg: '#e0e7ff', effectiveness: 0.78, description: 'èº«ä½“åŠ¨ä½œå‚ä¸ï¼Œå¤šæ„Ÿå®˜ç¼–ç ' },
        'elaboration': { name: 'ç²¾ç»†åŠ å·¥', icon: 'ğŸ”¬', color: '#6d28d9', bg: '#f3e8ff', effectiveness: 0.86, description: 'æ·±åº¦å¤„ç†ä¿¡æ¯ï¼Œå»ºç«‹å¤šé‡è”ç»“' },
        'dual_coding': { name: 'åŒé‡ç¼–ç ', icon: 'ğŸ”—', color: '#0369a1', bg: '#e0f2fe', effectiveness: 0.89, description: 'åŒæ—¶ä½¿ç”¨è¯­è¨€å’Œå›¾åƒç¼–ç ' }
    },
    // è®°å¿†å¼ºåº¦è®¡ç®—ï¼ˆåŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿ä¿®æ­£ï¼‰
    calculateRetention: function(initialStrength, hoursSinceEncoding, reviewCount) {
        // R = S * e^(-t/Ï„) + reinforcement_bonus
        var tau = 24 * (1 + reviewCount * 0.5); // å¤ä¹ å¢åŠ è®°å¿†åŠè¡°æœŸ
        var retention = initialStrength * Math.exp(-hoursSinceEncoding / tau);
        var bonus = Math.min(0.3, reviewCount * 0.05);
        return Math.min(1, retention + bonus);
    },
    // æ¨èæœ€ä½³åŠ©è®°ç±»å‹ï¼ˆåŸºäºç”¨æˆ·å†å²è¡¨ç°ï¼‰
    recommendType: function(word, userHistory) {
        var scores = {};
        var types = Object.keys(this.types);
        
        types.forEach(function(type) {
            var baseScore = MNEMONIC_SCIENCE.types[type].effectiveness;
            var userScore = userHistory[type] || baseScore;
            scores[type] = (baseScore + userScore) / 2;
        });
        
        // æ ¹æ®è¯æ±‡ç‰¹å¾è°ƒæ•´æ¨è
        if (word.length > 8) scores['chunking'] *= 1.2;
        if (/^(un|re|pre|dis|mis)/.test(word)) scores['etymology'] *= 1.3;
        if (/tion$|sion$|ment$|ness$/.test(word)) scores['etymology'] *= 1.2;
        
        var best = types.reduce(function(a, b) {
            return scores[a] > scores[b] ? a : b;
        });
        
        return { type: best, score: scores[best], allScores: scores };
    }
};

// V14.1: è®°å½•åŠ©è®°æ•ˆæœ
function recordMnemonicEffectiveness(word, mnemonicType, wasEffective) {
    if (!mnemonicEffectivenessData[word]) {
        mnemonicEffectivenessData[word] = {
            type: mnemonicType,
            exposures: 0,
            successes: 0,
            lastReview: null,
            effectiveness: 0.5
        };
    }
    
    var data = mnemonicEffectivenessData[word];
    data.exposures++;
    if (wasEffective) data.successes++;
    data.lastReview = Date.now();
    data.effectiveness = data.successes / data.exposures;
    
    // æ›´æ–°ç±»å‹æ€»ä½“æ•ˆæœ
    if (!mnemonicEffectivenessData._typeStats) {
        mnemonicEffectivenessData._typeStats = {};
    }
    if (!mnemonicEffectivenessData._typeStats[mnemonicType]) {
        mnemonicEffectivenessData._typeStats[mnemonicType] = { total: 0, success: 0 };
    }
    mnemonicEffectivenessData._typeStats[mnemonicType].total++;
    if (wasEffective) mnemonicEffectivenessData._typeStats[mnemonicType].success++;
    
    localStorage.setItem('mnemonicEffectiveness', JSON.stringify(mnemonicEffectivenessData));
}

// V14.2: ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰åŠ©è®°è¯
function saveCustomMnemonic(word, mnemonic) {
    userCustomMnemonics[word.toLowerCase()] = {
        mnemonic: mnemonic.text,
        type: mnemonic.type || 'custom',
        createdAt: Date.now(),
        visual: mnemonic.visual || null,
        emotional: mnemonic.emotional || null,
        story: mnemonic.story || null
    };
    localStorage.setItem('userCustomMnemonics', JSON.stringify(userCustomMnemonics));
}

// V14.3: æ·»åŠ åˆ°è®°å¿†å®«æ®¿
function addToMemoryPalace(word, location, imageDescription) {
    if (!memoryPalaceData.locations) {
        memoryPalaceData.locations = [
            { id: 'home_entrance', name: 'å®¶é—¨å£', description: 'ç†Ÿæ‚‰çš„å®¶é—¨å…¥å£' },
            { id: 'living_room', name: 'å®¢å…', description: 'èˆ’é€‚çš„å®¢å…' },
            { id: 'kitchen', name: 'å¨æˆ¿', description: 'å¨æˆ¿' },
            { id: 'bedroom', name: 'å§å®¤', description: 'å§å®¤' },
            { id: 'bathroom', name: 'å«ç”Ÿé—´', description: 'å«ç”Ÿé—´' },
            { id: 'balcony', name: 'é˜³å°', description: 'é˜³å°' },
            { id: 'study', name: 'ä¹¦æˆ¿', description: 'ä¹¦æˆ¿' },
            { id: 'garden', name: 'èŠ±å›­', description: 'èŠ±å›­' }
        ];
    }
    
    if (!memoryPalaceData.placements) {
        memoryPalaceData.placements = {};
    }
    
    memoryPalaceData.placements[word.toLowerCase()] = {
        locationId: location,
        image: imageDescription,
        placedAt: Date.now()
    };
    
    localStorage.setItem('memoryPalace', JSON.stringify(memoryPalaceData));
}

// V14.4: è®¾ç½®æƒ…æ„Ÿé”šå®š
function setEmotionalAnchor(word, emotion, intensity) {
    var emotions = {
        'joy': { icon: 'ğŸ˜Š', name: 'å¿«ä¹', color: '#fbbf24' },
        'surprise': { icon: 'ğŸ˜²', name: 'æƒŠè®¶', color: '#8b5cf6' },
        'fear': { icon: 'ğŸ˜¨', name: 'ææƒ§', color: '#6b7280' },
        'disgust': { icon: 'ğŸ¤¢', name: 'åŒæ¶', color: '#22c55e' },
        'anger': { icon: 'ğŸ˜ ', name: 'æ„¤æ€’', color: '#ef4444' },
        'sadness': { icon: 'ğŸ˜¢', name: 'æ‚²ä¼¤', color: '#3b82f6' },
        'love': { icon: 'â¤ï¸', name: 'çˆ±', color: '#ec4899' },
        'curiosity': { icon: 'ğŸ¤”', name: 'å¥½å¥‡', color: '#f59e0b' }
    };
    
    emotionalAnchorData[word.toLowerCase()] = {
        emotion: emotion,
        intensity: intensity || 5,
        data: emotions[emotion],
        setAt: Date.now()
    };
    
    localStorage.setItem('emotionalAnchors', JSON.stringify(emotionalAnchorData));
}

// V14.5: åˆ›å»ºåˆ†å—è®°å¿†ç»„
function createChunkingGroup(groupName, words, commonPattern) {
    var groupId = 'chunk_' + Date.now();
    chunkingGroups[groupId] = {
        name: groupName,
        words: words,
        pattern: commonPattern,
        createdAt: Date.now()
    };
    
    // æ ‡è®°æ¯ä¸ªå•è¯å±äºå“ªä¸ªç»„
    words.forEach(function(word) {
        if (!chunkingGroups._wordToGroup) chunkingGroups._wordToGroup = {};
        chunkingGroups._wordToGroup[word.toLowerCase()] = groupId;
    });
    
    localStorage.setItem('chunkingGroups', JSON.stringify(chunkingGroups));
    return groupId;
}

// V14.6: è·å–å¢å¼ºç‰ˆåŠ©è®°ä¿¡æ¯
function getEnhancedMnemonic(word) {
    var lowerWord = word.toLowerCase();
    var baseMnemonic = getWordMnemonic(word);
    var customMnemonic = userCustomMnemonics[lowerWord];
    var effectiveness = mnemonicEffectivenessData[lowerWord];
    var palace = memoryPalaceData.placements ? memoryPalaceData.placements[lowerWord] : null;
    var emotion = emotionalAnchorData[lowerWord];
    var chunk = chunkingGroups._wordToGroup ? chunkingGroups[chunkingGroups._wordToGroup[lowerWord]] : null;
    
    return {
        base: baseMnemonic,
        custom: customMnemonic,
        effectiveness: effectiveness,
        memoryPalace: palace,
        emotionalAnchor: emotion,
        chunkGroup: chunk,
        hasEnhancements: !!(customMnemonic || palace || emotion || chunk),
        recommended: MNEMONIC_SCIENCE.recommendType(word, mnemonicEffectivenessData._typeStats || {})
    };
}

// V11: åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®
function loadWordRelations() {
    if (wordRelationsData) return Promise.resolve(wordRelationsData);
    
    return fetch('word_relations.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word relations');
            return response.json();
        })
        .then(function(data) {
            wordRelationsData = data;
            console.log('[V11] åŒä¹‰è¯/åä¹‰è¯æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ç»„');
            return data;
        })
        .catch(function(err) {
            console.warn('[V11] åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®å¤±è´¥:', err);
            wordRelationsData = {};
            return {};
        });
}

// V12: åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®
function loadWordMnemonics() {
    if (wordMnemonicsData) return Promise.resolve(wordMnemonicsData);
    
    return fetch('word_mnemonics.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word mnemonics');
            return response.json();
        })
        .then(function(data) {
            wordMnemonicsData = data;
            console.log('[V12] æ™ºèƒ½åŠ©è®°è¯æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V12] åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®å¤±è´¥:', err);
            wordMnemonicsData = {};
            return {};
        });
}

// V13: åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
function loadWordDifficulty() {
    if (wordDifficultyData) return Promise.resolve(wordDifficultyData);
    
    return fetch('word_difficulty.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load word difficulty');
            return response.json();
        })
        .then(function(data) {
            wordDifficultyData = data;
            console.log('[V13] è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', Object.keys(data).length, 'ä¸ª');
            return data;
        })
        .catch(function(err) {
            console.warn('[V13] åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®å¤±è´¥:', err);
            wordDifficultyData = {};
            return {};
        });
}

// V11: è·å–å•è¯çš„åŒä¹‰è¯/åä¹‰è¯
function getWordRelations(word) {
    if (!wordRelationsData) return null;
    var lowerWord = word.toLowerCase();
    return wordRelationsData[lowerWord] || null;
}

// V12: è·å–å•è¯çš„åŠ©è®°è¯
function getWordMnemonic(word) {
    if (!wordMnemonicsData) return null;
    var lowerWord = word.toLowerCase();
    return wordMnemonicsData[lowerWord] || null;
}

// V13: è·å–å•è¯éš¾åº¦ç­‰çº§
function getWordDifficulty(word) {
    if (!wordDifficultyData) return null;
    var lowerWord = word.toLowerCase();
    return wordDifficultyData[lowerWord] || null;
}

try {
    learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
    wordRatings = JSON.parse(localStorage.getItem('wordRatings') || '{}');
    wordLearningProgress = JSON.parse(localStorage.getItem('wordLearningProgress') || '{}');
} catch(e) {
    learnedWords = [];
    wordRatings = {};
    wordLearningProgress = {};
}

// åˆå§‹åŒ–è¯æ±‡æ¨¡å—
function initVocabulary() {
    // V8: åŠ è½½è‡ªé€‚åº”éš¾åº¦æ•°æ®
    loadAdaptiveDifficulty();
    // V11: åŠ è½½åŒä¹‰è¯/åä¹‰è¯æ•°æ®
    loadWordRelations();
    // V12: åŠ è½½æ™ºèƒ½åŠ©è®°è¯æ•°æ®
    loadWordMnemonics();
    // V13: åŠ è½½è¯æ±‡éš¾åº¦åˆ†çº§æ•°æ®
    loadWordDifficulty();
    // æ˜¾ç¤ºè®¾ç½®é¢æ¿
    showVocabSettings();
    // åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
    // speakWordå·²åœ¨showCurrentWordä¸­è°ƒç”¨ï¼Œæ— éœ€é‡å¤
}

// æ˜¾ç¤ºå•è¯æ•°é‡è®¾ç½®
function showVocabSettings() {
    var settingsEl = document.getElementById('vocabSettings');
    if (!settingsEl) {
        // åœ¨è¯æ±‡æ¨¡å—é¡¶éƒ¨æ·»åŠ è®¾ç½®
        var modalHeader = document.querySelector('#vocabularyModal .modal-header');
        if (modalHeader) {
            var settingsDiv = document.createElement('div');
            settingsDiv.id = 'vocabSettings';
            settingsDiv.className = 'vocab-settings-panel';
            settingsDiv.innerHTML = 
                '<div class="settings-row">' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">âœ¦</span> æ¯æ¬¡å­¦ä¹ </span>' +
                        '<select id="wordsPerSessionSelect" onchange="changeWordsPerSession(this.value)" class="setting-select">' +
                            '<option value="10"' + (wordsPerSession === 10 ? ' selected' : '') + '>10ä¸ª</option>' +
                            '<option value="20"' + (wordsPerSession === 20 ? ' selected' : '') + '>20ä¸ª</option>' +
                            '<option value="30"' + (wordsPerSession === 30 ? ' selected' : '') + '>30ä¸ª</option>' +
                            '<option value="50"' + (wordsPerSession === 50 ? ' selected' : '') + '>50ä¸ª</option>' +
                            '<option value="100"' + (wordsPerSession === 100 ? ' selected' : '') + '>100ä¸ª</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">â—ˆ</span> å­¦ä¹ æ¬¡æ•°</span>' +
                        '<select id="learningTimesSelect" onchange="changeLearningTimes(this.value)" class="setting-select">' +
                            '<option value="1"' + (requiredLearningTimes === 1 ? ' selected' : '') + '>1æ¬¡</option>' +
                            '<option value="2"' + (requiredLearningTimes === 2 ? ' selected' : '') + '>2æ¬¡</option>' +
                            '<option value="3"' + (requiredLearningTimes === 3 ? ' selected' : '') + '>3æ¬¡</option>' +
                            '<option value="4"' + (requiredLearningTimes === 4 ? ' selected' : '') + '>4æ¬¡</option>' +
                            '<option value="5"' + (requiredLearningTimes === 5 ? ' selected' : '') + '>5æ¬¡</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="settings-tip"><span class="tip-icon">âœ§</span> æ¯ä¸ªå•è¯å­¦ä¹  <strong id="timesDisplay">' + requiredLearningTimes + '</strong> æ¬¡åæ‰ç®—æŒæ¡</div>';
            modalHeader.after(settingsDiv);
            
            // æ·»åŠ æ ·å¼
            addVocabSettingsStyles();
        }
    }
}

// æ·»åŠ è®¾ç½®é¢æ¿æ ·å¼
function addVocabSettingsStyles() {
    if (document.getElementById('vocabSettingsStyles')) return;
    
    var style = document.createElement('style');
    style.id = 'vocabSettingsStyles';
    style.textContent = `
        .vocab-settings-panel {
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8f7ff 0%, #e0e7ff 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-label {
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .setting-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        
        .tip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .setting-select {
            padding: 8px 14px;
            border-radius: 10px;
            border: 2px solid #6366f1;
            background: white;
            color: #1e1b4b;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .setting-select:hover {
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        .setting-select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .settings-tip {
            color: #6b7280;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .settings-tip strong {
            color: #6366f1;
            font-weight: 700;
        }
        
        /* å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨ */
        .learning-progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border-radius: 12px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .progress-dot.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        .progress-dot.current {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .progress-label {
            margin-left: 8px;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* è¯å¡ä¼˜åŒ–æ ·å¼ */
        .word-card-enhanced {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .word-main-enhanced {
            font-size: 42px;
            font-weight: 800;
            color: #1e1b4b;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .word-phonetic-enhanced {
            font-size: 18px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* è¯„åˆ†æŒ‰é’®ä¼˜åŒ– */
        .rate-btn-enhanced {
            flex: 1;
            padding: 16px 12px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .rate-btn-enhanced.hard {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 2px solid #fecaca;
        }
        
        .rate-btn-enhanced.hard:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
        }
        
        .rate-btn-enhanced.medium {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #d97706;
            border: 2px solid #fde68a;
        }
        
        .rate-btn-enhanced.medium:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.2);
        }
        
        .rate-btn-enhanced.easy {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
            border: 2px solid #a7f3d0;
        }
        
        .rate-btn-enhanced.easy:hover {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.2);
        }
        
        .rate-emoji {
            font-size: 24px;
        }
        
        .rate-text {
            font-size: 14px;
        }
        
        .rate-hint {
            font-size: 11px;
            opacity: 0.7;
            font-weight: 500;
        }
        
        /* å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç«  */
        .learning-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .learning-badge.new {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #fcd34d;
        }
        
        .learning-badge.new .badge-icon {
            font-size: 14px;
            animation: sparkle 1.5s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .learning-badge.learning {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 2px solid #a5b4fc;
        }
        
        .learning-badge.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #6ee7b7;
        }
        
        .learning-badge.completed .badge-icon {
            font-size: 14px;
            animation: checkBounce 0.5s ease;
        }
        
        @keyframes checkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .badge-count {
            font-size: 16px;
            font-weight: 800;
            color: #4f46e5;
        }
        
        .badge-separator {
            font-size: 12px;
            color: #9ca3af;
            margin: 0 1px;
        }
        
        .badge-total {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .badge-text {
            font-size: 12px;
            margin-left: 2px;
        }
        
        /* Toast åŠ¨ç”» */
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    `;
    document.head.appendChild(style);
}

// ä¿®æ”¹å­¦ä¹ æ¬¡æ•°è®¾ç½®
function changeLearningTimes(value) {
    requiredLearningTimes = parseInt(value);
    localStorage.setItem('requiredLearningTimes', requiredLearningTimes.toString());
    
    var timesDisplay = document.getElementById('timesDisplay');
    if (timesDisplay) {
        timesDisplay.textContent = requiredLearningTimes;
    }
    
    // ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šå­¦ä¹ æ¬¡æ•°æ›´æ–°åè‡ªåŠ¨åˆ·æ–° ======
    // é‡æ–°è®¡ç®—æ‰€æœ‰å•è¯çš„å®ŒæˆçŠ¶æ€
    sessionWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        if (progress) {
            // æ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼Œé‡æ–°åˆ¤æ–­æ˜¯å¦å®Œæˆ
            progress.completed = progress.times >= requiredLearningTimes;
        }
    });
    
    // é‡æ–°æ„å»ºå­¦ä¹ é˜Ÿåˆ—ï¼ˆæ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼‰
    buildLearningQueue();
    
    // å¦‚æœå½“å‰é˜Ÿåˆ—ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®
    if (currentQueueIndex >= learningQueue.length) {
        currentQueueIndex = Math.max(0, learningQueue.length - 1);
    }
    
    // åˆ·æ–°è¿›åº¦æ˜¾ç¤º
    updateVocabProgress();
    
    // æ›´æ–°å½“å‰å•è¯çš„è¿›åº¦æ˜¾ç¤º
    updateLearningProgressIndicator();
    
    // æ›´æ–°å­¦ä¹ å¾½ç« 
    updateLearningBadge();
    
    // æ˜¾ç¤ºè®¾ç½®æ›´æ–°æç¤º
    showSettingsUpdateToast('å­¦ä¹ æ¬¡æ•°å·²æ›´æ–°ä¸º ' + requiredLearningTimes + ' æ¬¡');
    
    // è§¦å‘è®¾ç½®æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularySettingsUpdated', {
            detail: {
                setting: 'learningTimes',
                value: requiredLearningTimes,
                queueLength: learningQueue.length
            }
        }));
    } catch(e) {}
}

// åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
function initSessionWords() {
    currentWordIndex = 0;
    currentQueueIndex = 0;
    sessionWords = [];
    learningQueue = [];
    sessionWordProgress = {}; // é‡ç½®æœ¬è½®å­¦ä¹ è¿›åº¦
    
    if (!window.vocabularyData || window.vocabularyData.length === 0) return;
    
    // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å•è¯
    var allIndices = [];
    for (var i = 0; i < window.vocabularyData.length; i++) {
        allIndices.push(i);
    }
    
    // æ‰“ä¹±é¡ºåº
    for (var j = allIndices.length - 1; j > 0; j--) {
        var k = Math.floor(Math.random() * (j + 1));
        var temp = allIndices[j];
        allIndices[j] = allIndices[k];
        allIndices[k] = temp;
    }
    
    // å–å‰Nä¸ª
    var count = Math.min(wordsPerSession, allIndices.length);
    for (var m = 0; m < count; m++) {
        var wordData = window.vocabularyData[allIndices[m]];
        sessionWords.push(wordData);
        // åˆå§‹åŒ–æœ¬è½®å­¦ä¹ è¿›åº¦
        sessionWordProgress[wordData.word] = {
            times: 0,           // æœ¬è½®å·²å­¦ä¹ æ¬¡æ•°
            completed: false,   // æœ¬è½®æ˜¯å¦å®Œæˆ
            lastIndex: -1       // ä¸Šæ¬¡å‡ºç°çš„ä½ç½®
        };
    }
    
    // æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
    buildLearningQueue();
}

// æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
function buildLearningQueue() {
    learningQueue = [];
    
    // è·å–æ‰€æœ‰æœªå®Œæˆçš„å•è¯
    var pendingWords = sessionWords.filter(function(w) {
        return !sessionWordProgress[w.word].completed;
    });
    
    if (pendingWords.length === 0) return;
    
    // è®¡ç®—æ¯ä¸ªå•è¯è¿˜éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
    var wordsNeedReview = [];
    pendingWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        var remaining = requiredLearningTimes - progress.times;
        for (var i = 0; i < remaining; i++) {
            wordsNeedReview.push({
                wordData: wordData,
                reviewRound: progress.times + i + 1
            });
        }
    });
    
    // æŒ‰ç…§é—´éš”é‡å¤çš„åŸåˆ™é‡æ–°æ’åˆ—
    // ç­–ç•¥ï¼šå…ˆå­¦æ–°è¯ï¼Œç„¶åç©¿æ’å¤ä¹ 
    var newWords = wordsNeedReview.filter(function(w) { return w.reviewRound === 1; });
    var reviewWords = wordsNeedReview.filter(function(w) { return w.reviewRound > 1; });
    
    // æ‰“ä¹±æ–°è¯é¡ºåº
    shuffleArray(newWords);
    
    // æ„å»ºé˜Ÿåˆ—ï¼šæ¯å­¦ä¹ 2-3ä¸ªæ–°è¯åï¼Œæ’å…¥éœ€è¦å¤ä¹ çš„è¯
    var result = [];
    var newWordIndex = 0;
    var reviewWordIndex = 0;
    var wordsSinceLastReview = {};
    var minGap = 3; // åŒä¸€ä¸ªå•è¯è‡³å°‘é—´éš”3ä¸ªä½ç½®å†å‡ºç°
    
    while (newWordIndex < newWords.length || reviewWordIndex < reviewWords.length) {
        // ä¼˜å…ˆæ·»åŠ æ–°è¯
        var addedNewWord = false;
        if (newWordIndex < newWords.length) {
            var newWord = newWords[newWordIndex];
            result.push(newWord.wordData);
            wordsSinceLastReview[newWord.wordData.word] = 0;
            newWordIndex++;
            addedNewWord = true;
        }
        
        // æ›´æ–°æ‰€æœ‰å•è¯çš„é—´éš”è®¡æ•°
        Object.keys(wordsSinceLastReview).forEach(function(w) {
            wordsSinceLastReview[w]++;
        });
        
        // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼ˆé—´éš”è¶³å¤Ÿï¼‰
        if (reviewWordIndex < reviewWords.length && result.length >= minGap) {
            // æ‰¾åˆ°ä¸€ä¸ªé—´éš”è¶³å¤Ÿçš„å¤ä¹ å•è¯
            for (var i = reviewWordIndex; i < reviewWords.length; i++) {
                var reviewWord = reviewWords[i];
                var gap = wordsSinceLastReview[reviewWord.wordData.word] || 999;
                
                if (gap >= minGap) {
                    // å¯ä»¥æ’å…¥è¿™ä¸ªå¤ä¹ å•è¯
                    result.push(reviewWord.wordData);
                    wordsSinceLastReview[reviewWord.wordData.word] = 0;
                    
                    // ä»å¤ä¹ åˆ—è¡¨ä¸­ç§»é™¤
                    reviewWords.splice(i, 1);
                    
                    // æ›´æ–°é—´éš”è®¡æ•°
                    Object.keys(wordsSinceLastReview).forEach(function(w) {
                        wordsSinceLastReview[w]++;
                    });
                    break;
                }
            }
        }
        
        // å¦‚æœæ²¡æœ‰æ–°è¯å¯åŠ ï¼Œç»§ç»­æ·»åŠ å¤ä¹ è¯
        if (!addedNewWord && reviewWordIndex < reviewWords.length) {
            var nextReview = reviewWords[0];
            var nextGap = wordsSinceLastReview[nextReview.wordData.word] || 999;
            
            if (nextGap >= minGap) {
                result.push(nextReview.wordData);
                wordsSinceLastReview[nextReview.wordData.word] = 0;
                reviewWords.shift();
            } else {
                // é—´éš”ä¸å¤Ÿï¼Œæ·»åŠ å ä½æˆ–è·³è¿‡
                // æ‰¾å…¶ä»–å¯ä»¥å¤ä¹ çš„è¯
                var foundAlternative = false;
                for (var j = 1; j < reviewWords.length; j++) {
                    var altWord = reviewWords[j];
                    var altGap = wordsSinceLastReview[altWord.wordData.word] || 999;
                    if (altGap >= minGap) {
                        result.push(altWord.wordData);
                        wordsSinceLastReview[altWord.wordData.word] = 0;
                        reviewWords.splice(j, 1);
                        foundAlternative = true;
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°æ›¿ä»£ï¼Œå¼ºåˆ¶æ·»åŠ ï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
                if (!foundAlternative) {
                    result.push(nextReview.wordData);
                    wordsSinceLastReview[nextReview.wordData.word] = 0;
                    reviewWords.shift();
                }
            }
            
            Object.keys(wordsSinceLastReview).forEach(function(w) {
                wordsSinceLastReview[w]++;
            });
        }
    }
    
    learningQueue = result;
}

// æ•°ç»„éšæœºæ‰“ä¹±
function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

// ä¿®æ”¹æ¯æ¬¡å­¦ä¹ å•è¯æ•°
function changeWordsPerSession(value) {
    wordsPerSession = parseInt(value);
    localStorage.setItem('wordsPerSession', wordsPerSession.toString());
    
    // è‡ªåŠ¨åˆ·æ–°ï¼Œé‡æ–°å¼€å§‹å­¦ä¹ 
    initSessionWords();
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    updateVocabProgress();
    showCurrentWord();
}

function updateVocabProgress() {
    var progress = document.getElementById('vocabProgress');
    if (progress) {
        // æ˜¾ç¤ºé˜Ÿåˆ—è¿›åº¦å’Œå•è¯å®Œæˆæ•°
        var completedCount = 0;
        sessionWords.forEach(function(w) {
            if (sessionWordProgress[w.word] && sessionWordProgress[w.word].completed) {
                completedCount++;
            }
        });
        progress.textContent = (currentQueueIndex + 1) + '/' + learningQueue.length + ' (å·²æŒæ¡: ' + completedCount + '/' + sessionWords.length + ')';
    }
}

// V6: å­¦ä¹ æ¨¡å¼çŠ¶æ€
var learningModeState = {
    mode: 'normal', // normal, review, difficult
    isFirstTime: true, // æ˜¯å¦é¦–æ¬¡å­¦ä¹ æ­¤è¯
    consecutiveCorrect: 0 // è¿ç»­æ­£ç¡®æ¬¡æ•°
};

function showCurrentWord() {
    if (!learningQueue || learningQueue.length === 0) {
        initSessionWords();
    }
    if (!learningQueue || learningQueue.length === 0) return;
    
    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰å­¦ä¹ 
    if (currentQueueIndex >= learningQueue.length) {
        showSessionSummary();
        return;
    }
    
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    // V6: æ£€æµ‹å­¦ä¹ æ¨¡å¼
    var word = wordData.word;
    var sessionProgress = sessionWordProgress[word] || { times: 0, completed: false };
    var isReview = sessionProgress.times > 0;
    var isHardWord = hardWordsInSession && hardWordsInSession.indexOf(word) > -1;
    var isImmediateReview = immediateReviewQueue && immediateReviewQueue.some(function(r) { return r.word === word; });
    
    // ç¡®å®šå­¦ä¹ æ¨¡å¼
    if (isImmediateReview) {
        learningModeState.mode = 'immediate';
    } else if (isHardWord) {
        learningModeState.mode = 'difficult';
    } else if (isReview) {
        learningModeState.mode = 'review';
    } else {
        learningModeState.mode = 'normal';
    }
    learningModeState.isFirstTime = !isReview;
    
    // V6: æ˜¾ç¤ºå­¦ä¹ æ¨¡å¼æç¤º
    showLearningModeIndicator(learningModeState.mode);
    
    document.getElementById('wordMain').textContent = wordData.word;
    document.getElementById('wordPhonetic').textContent = wordData.phonetic || '';
    
    // V13: æ˜¾ç¤ºéš¾åº¦ç­‰çº§æ ‡ç­¾
    showDifficultyBadge(wordData.word);
    
    // éšè—é‡Šä¹‰åŒºåŸŸ
    document.getElementById('wordMeaning').classList.add('hidden');
    document.getElementById('rateButtons').classList.add('hidden');
    document.getElementById('showMeaningBtn').classList.remove('hidden');
    
    updateVocabProgress();
    
    // æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
    updateLearningBadge();
    
    // æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
    updateLearningProgressIndicator();
    
    // è‡ªåŠ¨æœ—è¯»æ–°å•è¯
    speakWord();
}

// V13: æ˜¾ç¤ºéš¾åº¦ç­‰çº§æ ‡ç­¾
function showDifficultyBadge(word) {
    var difficulty = getWordDifficulty(word);
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºéš¾åº¦æ ‡ç­¾å®¹å™¨
    var badge = document.getElementById('difficultyBadge');
    var phoneticEl = document.getElementById('wordPhonetic');
    
    if (!badge && phoneticEl) {
        badge = document.createElement('span');
        badge.id = 'difficultyBadge';
        badge.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:10px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;vertical-align:middle;';
        phoneticEl.parentNode.insertBefore(badge, phoneticEl.nextSibling);
    }
    
    if (badge) {
        if (difficulty) {
            // æ ¹æ®éš¾åº¦ç­‰çº§è®¾ç½®ä¸åŒé¢œè‰²
            var levelStyles = {
                1: { bg: '#dcfce7', color: '#166534', border: '#bbf7d0', icon: 'ğŸŒ±', label: 'åŸºç¡€' },
                2: { bg: '#dbeafe', color: '#1e40af', border: '#bfdbfe', icon: 'ğŸ“˜', label: 'ä¸­ç­‰' },
                3: { bg: '#fef3c7', color: '#92400e', border: '#fde68a', icon: 'ğŸ“™', label: 'ä¸­é«˜çº§' },
                4: { bg: '#fce7f3', color: '#9d174d', border: '#fbcfe8', icon: 'ğŸ“•', label: 'é«˜çº§' },
                5: { bg: '#ede9fe', color: '#5b21b6', border: '#ddd6fe', icon: 'ğŸ“', label: 'ä¸“ä¸š' }
            };
            var style = levelStyles[difficulty.level] || levelStyles[3];
            badge.style.background = style.bg;
            badge.style.color = style.color;
            badge.style.border = '1px solid ' + style.border;
            badge.style.display = 'inline-flex';
            
            // æ„å»ºæ ‡ç­¾å†…å®¹
            var sourceTags = '';
            if (difficulty.sources && difficulty.sources.length > 0) {
                difficulty.sources.slice(0, 2).forEach(function(src) {
                    var srcStyle = src === 'GRE' ? 'background:#fee2e2;color:#991b1b;' : 
                                   src === 'TOEFL' ? 'background:#e0e7ff;color:#3730a3;' : 
                                   'background:#f3f4f6;color:#374151;';
                    sourceTags += '<span style="' + srcStyle + 'padding:1px 5px;border-radius:4px;font-size:9px;margin-left:4px;">' + src + '</span>';
                });
            }
            
            badge.innerHTML = '<span>' + style.icon + '</span><span>' + style.label + '</span>' + sourceTags;
        } else {
            badge.style.display = 'none';
        }
    }
}

// æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
function updateLearningBadge() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºå¾½ç« å®¹å™¨
    var badge = document.getElementById('learningBadge');
    if (!badge) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            // ç¡®ä¿ wordCard æ˜¯ç›¸å¯¹å®šä½
            wordCard.style.position = 'relative';
            
            badge = document.createElement('div');
            badge.id = 'learningBadge';
            badge.className = 'learning-badge';
            wordCard.insertBefore(badge, wordCard.firstChild);
        }
    }
    
    if (badge) {
        if (progress.completed) {
            badge.className = 'learning-badge completed';
            badge.innerHTML = '<span class="badge-icon">âœ“</span><span class="badge-text">å·²æŒæ¡</span>';
        } else {
            var remaining = requiredLearningTimes - currentTimes;
            badge.className = 'learning-badge';
            if (currentTimes === 0) {
                badge.classList.add('new');
                badge.innerHTML = '<span class="badge-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg></span><span class="badge-text">æ–°è¯</span>';
            } else {
                badge.classList.add('learning');
                badge.innerHTML = '<span class="badge-count">' + currentTimes + '</span><span class="badge-separator">/</span><span class="badge-total">' + requiredLearningTimes + '</span><span class="badge-text" style="margin-left:4px;">å¤ä¹ ä¸­</span>';
            }
        }
    }
}

// æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
function updateLearningProgressIndicator() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºè¿›åº¦æŒ‡ç¤ºå™¨å®¹å™¨
    var indicatorContainer = document.getElementById('learningProgressIndicator');
    if (!indicatorContainer) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            indicatorContainer = document.createElement('div');
            indicatorContainer.id = 'learningProgressIndicator';
            indicatorContainer.className = 'learning-progress-indicator';
            wordCard.appendChild(indicatorContainer);
        }
    }
    
    if (indicatorContainer) {
        var dotsHtml = '';
        for (var i = 0; i < requiredLearningTimes; i++) {
            var dotClass = 'progress-dot';
            if (i < currentTimes) {
                dotClass += ' completed';
            } else if (i === currentTimes) {
                dotClass += ' current';
            }
            dotsHtml += '<div class="' + dotClass + '"></div>';
        }
        
        var statusText = '';
        if (progress.completed) {
            statusText = '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#10b981" stroke-width="2.5" style="vertical-align:middle;margin-right:4px;"><polyline points="20 6 9 17 4 12"/></svg>å·²æŒæ¡';
        } else {
            statusText = 'ç¬¬ ' + (currentTimes + 1) + '/' + requiredLearningTimes + ' æ¬¡å­¦ä¹ ';
        }
        
        indicatorContainer.innerHTML = dotsHtml + '<span class="progress-label">' + statusText + '</span>';
    }
}

function showMeaning() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    // æŸ¥è¯¢å­—å…¸æ•°æ®
    var dictData = null;
    if (typeof queryDictionary === 'function') {
        dictData = queryDictionary(wordData.word);
    }
    
    // V11: è·å–åŒä¹‰è¯/åä¹‰è¯
    var relations = getWordRelations(wordData.word);
    
    // V12: è·å–åŠ©è®°è¯
    var mnemonic = getWordMnemonic(wordData.word);
    
    // V14: è·å–å¢å¼ºç‰ˆåŠ©è®°ä¿¡æ¯
    var enhancedMnemonic = getEnhancedMnemonic(wordData.word);
    
    // æ„å»ºé‡Šä¹‰HTMLï¼ˆä¸­è‹±æ–‡åŒè¯­ï¼‰
    var meaningHtml = '';
    
    // å¦‚æœæœ‰å­—å…¸æ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (dictData) {
        meaningHtml += '<div class="dict-container" style="background:linear-gradient(135deg,#f8f7ff 0%,#eef2ff 100%);padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.1);">';
        if (dictData.definitions && dictData.definitions.length > 0) {
            meaningHtml += '<div style="font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;"><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);border-radius:6px;box-shadow:0 2px 6px rgba(99,102,241,0.3);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span style="color:#4338ca;">è¯å…¸é‡Šä¹‰</span></div>';
            dictData.definitions.slice(0, 3).forEach(function(def, idx) {
                meaningHtml += '<div style="margin-bottom:6px;font-size:14px;color:#555;">â€¢ ' + def + '</div>';
            });
        }
        meaningHtml += '</div>';
    }
    
    meaningHtml += '<div class="meaning-cn" style="font-size:20px;color:#1e1b4b;margin-bottom:12px;font-weight:700;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:8px;box-shadow:0 2px 6px rgba(16,185,129,0.3);flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span><span>' + (wordData.meaningCn || 'æš‚æ— ä¸­æ–‡é‡Šä¹‰') + '</span></div>';
    meaningHtml += '<div class="meaning-en" style="color:#4b5563;font-size:15px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:7px;box-shadow:0 2px 6px rgba(59,130,246,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span><span>' + (wordData.meaningEn || wordData.meaning || '') + '</span></div>';
    
    // V14: ç§‘å­¦åŠ©è®°ç³»ç»Ÿ - å¢å¼ºç‰ˆæ˜¾ç¤º
    if (mnemonic || enhancedMnemonic.hasEnhancements) {
        meaningHtml += '<div class="word-mnemonic-v14" style="margin-bottom:16px;padding:0;border-radius:16px;overflow:hidden;border:1px solid rgba(192,132,252,0.2);box-shadow:0 4px 12px rgba(168,85,247,0.1);">';
        
        // å¤´éƒ¨ï¼šç§‘å­¦è®°å¿†æ ‡ç­¾
        meaningHtml += '<div style="background:linear-gradient(135deg,#9333ea 0%,#7c3aed 50%,#6366f1 100%);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">';
        meaningHtml += '<div style="display:flex;align-items:center;gap:10px;">';
        meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:rgba(255,255,255,0.2);border-radius:10px;backdrop-filter:blur(4px);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548.547A3.374 3.374 0 0 0 14 18.469V19a2 2 0 1 1-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></span>';
        meaningHtml += '<div><div style="color:white;font-weight:700;font-size:14px;">ğŸ§  ç§‘å­¦è®°å¿†æ³•</div>';
        meaningHtml += '<div style="color:rgba(255,255,255,0.8);font-size:11px;">åŸºäºè®¤çŸ¥å¿ƒç†å­¦ç ”ç©¶</div></div>';
        meaningHtml += '</div>';
        
        // æ•ˆæœè¯„ä¼°æŒ‡ç¤ºå™¨
        var effectivenessScore = enhancedMnemonic.effectiveness ? Math.round(enhancedMnemonic.effectiveness.effectiveness * 100) : null;
        if (effectivenessScore !== null) {
            var scoreColor = effectivenessScore >= 80 ? '#4ade80' : effectivenessScore >= 50 ? '#fbbf24' : '#f87171';
            meaningHtml += '<div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.15);padding:4px 10px;border-radius:20px;">';
            meaningHtml += '<span style="font-size:11px;color:white;">æ•ˆæœ</span>';
            meaningHtml += '<span style="font-weight:700;color:' + scoreColor + ';">' + effectivenessScore + '%</span>';
            meaningHtml += '</div>';
        }
        meaningHtml += '</div>';
        
        // ä¸»ä½“å†…å®¹åŒº
        meaningHtml += '<div style="background:linear-gradient(135deg,#fdf4ff 0%,#fae8ff 100%);padding:16px;">';
        
        // é€‰æ‹©æœ€ä½³åŠ©è®°æ¥æºï¼ˆç”¨æˆ·è‡ªå®šä¹‰ > ç³»ç»Ÿç”Ÿæˆï¼‰
        var activeMnemonic = enhancedMnemonic.custom || mnemonic;
        
        if (activeMnemonic) {
            // åŠ©è®°ç±»å‹æ ‡ç­¾ï¼ˆç§‘å­¦åˆ†ç±»ï¼‰
            var mnemonicType = activeMnemonic.type || 'etymology';
            var typeInfo = MNEMONIC_SCIENCE.types[mnemonicType] || MNEMONIC_SCIENCE.types['etymology'];
            
            meaningHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">';
            meaningHtml += '<span style="font-size:20px;">' + typeInfo.icon + '</span>';
            meaningHtml += '<span style="display:inline-block;padding:4px 12px;background:' + typeInfo.bg + ';border-radius:6px;font-size:12px;color:' + typeInfo.color + ';font-weight:600;">' + typeInfo.name + '</span>';
            meaningHtml += '<span style="font-size:11px;color:#9ca3af;">ç§‘å­¦æœ‰æ•ˆæ€§: ' + Math.round(typeInfo.effectiveness * 100) + '%</span>';
            if (enhancedMnemonic.custom) {
                meaningHtml += '<span style="display:inline-block;padding:2px 8px;background:#dbeafe;border-radius:4px;font-size:10px;color:#1e40af;font-weight:600;">âœ¨ æˆ‘çš„è®°å¿†</span>';
            }
            meaningHtml += '</div>';
            
            // ä¸»åŠ©è®°å†…å®¹
            meaningHtml += '<div style="font-size:16px;color:#581c87;line-height:1.7;font-weight:500;padding:12px;background:white;border-radius:10px;border-left:4px solid #a855f7;margin-bottom:12px;">';
            meaningHtml += activeMnemonic.mnemonic;
            meaningHtml += '</div>';
            
            // è¯æ ¹ä¿¡æ¯ï¼ˆæ·±åº¦åŠ å·¥ï¼‰
            if (activeMnemonic.roots) {
                meaningHtml += '<div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:rgba(139,92,246,0.08);border-radius:8px;margin-bottom:10px;">';
                meaningHtml += '<span style="font-size:16px;">ğŸ“š</span>';
                meaningHtml += '<div><div style="font-size:11px;color:#7c3aed;font-weight:600;margin-bottom:4px;">è¯æ ¹è§£æ (Etymology)</div>';
                meaningHtml += '<div style="font-size:13px;color:#6b21a8;">' + activeMnemonic.roots + '</div></div>';
                meaningHtml += '</div>';
            }
            
            // è”æƒ³ç”»é¢ï¼ˆåŒé‡ç¼–ç ï¼‰
            if (activeMnemonic.association) {
                meaningHtml += '<div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:rgba(59,130,246,0.08);border-radius:8px;margin-bottom:10px;">';
                meaningHtml += '<span style="font-size:16px;">ğŸ¨</span>';
                meaningHtml += '<div><div style="font-size:11px;color:#2563eb;font-weight:600;margin-bottom:4px;">è§†è§‰è”æƒ³ (Dual Coding)</div>';
                meaningHtml += '<div style="font-size:13px;color:#1e40af;font-style:italic;">"' + activeMnemonic.association + '"</div></div>';
                meaningHtml += '</div>';
            }
        }
        
        // V14.3: è®°å¿†å®«æ®¿ä½ç½®
        if (enhancedMnemonic.memoryPalace) {
            var location = memoryPalaceData.locations.find(function(l) { return l.id === enhancedMnemonic.memoryPalace.locationId; });
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:rgba(139,92,246,0.12);border-radius:8px;margin-bottom:10px;">';
            meaningHtml += '<span style="font-size:16px;">ğŸ›ï¸</span>';
            meaningHtml += '<div><div style="font-size:11px;color:#7c3aed;font-weight:600;margin-bottom:4px;">è®°å¿†å®«æ®¿ä½ç½®</div>';
            meaningHtml += '<div style="font-size:13px;color:#5b21b6;"><strong>' + (location ? location.name : 'ä½ç½®') + '</strong>: ' + enhancedMnemonic.memoryPalace.image + '</div></div>';
            meaningHtml += '</div>';
        }
        
        // V14.4: æƒ…æ„Ÿé”šå®š
        if (enhancedMnemonic.emotionalAnchor) {
            var emo = enhancedMnemonic.emotionalAnchor;
            meaningHtml += '<div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(236,72,153,0.08);border-radius:8px;margin-bottom:10px;">';
            meaningHtml += '<span style="font-size:20px;">' + emo.data.icon + '</span>';
            meaningHtml += '<div><div style="font-size:11px;color:#be185d;font-weight:600;">æƒ…æ„Ÿé”šå®š</div>';
            meaningHtml += '<div style="font-size:13px;color:#9d174d;">' + emo.data.name + ' (å¼ºåº¦: ' + emo.intensity + '/10)</div></div>';
            meaningHtml += '</div>';
        }
        
        // V14.5: åˆ†å—è®°å¿†ç»„
        if (enhancedMnemonic.chunkGroup) {
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:rgba(20,184,166,0.08);border-radius:8px;margin-bottom:10px;">';
            meaningHtml += '<span style="font-size:16px;">ğŸ§©</span>';
            meaningHtml += '<div><div style="font-size:11px;color:#0f766e;font-weight:600;margin-bottom:4px;">è®°å¿†åˆ†å—: ' + enhancedMnemonic.chunkGroup.name + '</div>';
            meaningHtml += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
            enhancedMnemonic.chunkGroup.words.slice(0, 5).forEach(function(w) {
                var isCurrent = w.toLowerCase() === wordData.word.toLowerCase();
                meaningHtml += '<span style="padding:2px 8px;background:' + (isCurrent ? '#14b8a6' : '#ccfbf1') + ';color:' + (isCurrent ? 'white' : '#0f766e') + ';border-radius:4px;font-size:12px;font-weight:' + (isCurrent ? '700' : '500') + ';">' + w + '</span>';
            });
            if (enhancedMnemonic.chunkGroup.words.length > 5) {
                meaningHtml += '<span style="padding:2px 8px;background:#f0fdfa;color:#0d9488;border-radius:4px;font-size:11px;">+' + (enhancedMnemonic.chunkGroup.words.length - 5) + '</span>';
            }
            meaningHtml += '</div></div></div>';
        }
        
        // æ“ä½œæŒ‰é’®åŒº
        meaningHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:14px;padding-top:14px;border-top:1px dashed rgba(168,85,247,0.3);">';
        
        // æ•ˆæœåé¦ˆæŒ‰é’®
        meaningHtml += '<button onclick="rateMnemonicEffectiveness(\'' + wordData.word + '\', true)" style="flex:1;min-width:120px;padding:8px 12px;background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(34,197,94,0.3);">ğŸ‘ è®°ä½äº†</button>';
        meaningHtml += '<button onclick="rateMnemonicEffectiveness(\'' + wordData.word + '\', false)" style="flex:1;min-width:120px;padding:8px 12px;background:linear-gradient(135deg,#f97316 0%,#ea580c 100%);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(249,115,22,0.3);">ğŸ”„ éœ€å¼ºåŒ–</button>';
        
        // è‡ªå®šä¹‰æŒ‰é’®
        meaningHtml += '<button onclick="showCustomMnemonicEditor(\'' + wordData.word + '\')" style="padding:8px 12px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(139,92,246,0.3);">âœï¸ è‡ªå®šä¹‰</button>';
        
        // è®°å¿†å®«æ®¿æŒ‰é’®
        meaningHtml += '<button onclick="showMemoryPalaceEditor(\'' + wordData.word + '\')" style="padding:8px 12px;background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(99,102,241,0.3);">ğŸ›ï¸ å®«æ®¿</button>';
        
        meaningHtml += '</div>';
        
        meaningHtml += '</div>'; // ä¸»ä½“å†…å®¹åŒºç»“æŸ
        meaningHtml += '</div>'; // æ•´ä¸ªåŠ©è®°å¡ç‰‡ç»“æŸ
    } else {
        // æ²¡æœ‰åŠ©è®°æ—¶æ˜¾ç¤ºæ·»åŠ å»ºè®®
        var recommended = MNEMONIC_SCIENCE.recommendType(wordData.word, mnemonicEffectivenessData._typeStats || {});
        var recType = MNEMONIC_SCIENCE.types[recommended.type];
        
        meaningHtml += '<div style="margin-bottom:16px;padding:16px;background:linear-gradient(135deg,#f9fafb 0%,#f3f4f6 100%);border-radius:12px;border:2px dashed #d1d5db;">';
        meaningHtml += '<div style="text-align:center;">';
        meaningHtml += '<div style="font-size:32px;margin-bottom:8px;">ğŸ’¡</div>';
        meaningHtml += '<div style="font-size:14px;color:#6b7280;margin-bottom:12px;">æš‚æ— è®°å¿†æŠ€å·§ï¼Œå»ºè®®æ·»åŠ </div>';
        meaningHtml += '<div style="margin-bottom:12px;padding:8px;background:' + recType.bg + ';border-radius:8px;display:inline-block;">';
        meaningHtml += '<span style="font-size:16px;margin-right:6px;">' + recType.icon + '</span>';
        meaningHtml += '<span style="color:' + recType.color + ';font-weight:600;font-size:13px;">æ¨è: ' + recType.name + '</span>';
        meaningHtml += '<div style="font-size:11px;color:' + recType.color + ';opacity:0.8;margin-top:4px;">' + recType.description + '</div>';
        meaningHtml += '</div>';
        meaningHtml += '<button onclick="showCustomMnemonicEditor(\'' + wordData.word + '\')" style="padding:10px 20px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;border-radius:10px;color:white;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,0.3);">âœ¨ åˆ›å»ºæˆ‘çš„è®°å¿†æ³•</button>';
        meaningHtml += '</div></div>';
    }
    
    // V11: åŒä¹‰è¯/åä¹‰è¯æ˜¾ç¤º
    if (relations) {
        meaningHtml += '<div class="word-relations" style="margin-bottom:16px;padding:14px;background:linear-gradient(135deg,#fefce8 0%,#fef9c3 100%);border-radius:12px;border:1px solid rgba(234,179,8,0.2);">';
        
        // åŒä¹‰è¯
        if (relations.synonyms && relations.synonyms.length > 0) {
            meaningHtml += '<div style="margin-bottom:10px;display:flex;align-items:flex-start;gap:10px;">';
            meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);border-radius:7px;box-shadow:0 2px 6px rgba(34,197,94,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg></span>';
            meaningHtml += '<div><span style="font-weight:700;color:#15803d;font-size:13px;">åŒä¹‰è¯ Synonyms</span><div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:6px;">';
            relations.synonyms.forEach(function(syn) {
                meaningHtml += '<span style="display:inline-block;padding:4px 10px;background:white;border-radius:6px;font-size:13px;color:#166534;border:1px solid #bbf7d0;font-weight:500;">' + syn + '</span>';
            });
            meaningHtml += '</div></div></div>';
        }
        
        // åä¹‰è¯
        if (relations.antonyms && relations.antonyms.length > 0) {
            meaningHtml += '<div style="display:flex;align-items:flex-start;gap:10px;">';
            meaningHtml += '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);border-radius:7px;box-shadow:0 2px 6px rgba(239,68,68,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M5 12h14"/></svg></span>';
            meaningHtml += '<div><span style="font-weight:700;color:#b91c1c;font-size:13px;">åä¹‰è¯ Antonyms</span><div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:6px;">';
            relations.antonyms.forEach(function(ant) {
                meaningHtml += '<span style="display:inline-block;padding:4px 10px;background:white;border-radius:6px;font-size:13px;color:#991b1b;border:1px solid #fecaca;font-weight:500;">' + ant + '</span>';
            });
            meaningHtml += '</div></div></div>';
        }
        
        meaningHtml += '</div>';
    }
    
    if (wordData.example) {
        meaningHtml += '<div class="word-example" style="color:#6b7280;font-size:14px;font-style:italic;padding-top:16px;border-top:1px solid #e5e7eb;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:7px;box-shadow:0 2px 6px rgba(245,158,11,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>' + wordData.example + '</span></div>';
    }
    
    document.getElementById('meaningCn').innerHTML = meaningHtml;
    document.getElementById('meaningEn').innerHTML = '';
    document.getElementById('wordExample').innerHTML = '';
    
    document.getElementById('wordMeaning').classList.remove('hidden');
    document.getElementById('showMeaningBtn').classList.add('hidden');
    document.getElementById('rateButtons').classList.remove('hidden');
    
    // V3: æ›´æ–°å¤ä¹ é—´éš”æ˜¾ç¤º
    updateIntervalDisplay();
}

// ==================== V1-V10: Ankié£æ ¼æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ ====================

// V2: æ™ºèƒ½å³æ—¶å¤ä¹ é˜Ÿåˆ—ç®¡ç†å™¨
var immediateReviewQueue = []; // å³æ—¶å¤ä¹ é˜Ÿåˆ—ï¼ˆå›°éš¾/é‡å­¦çš„å•è¯ï¼‰
var hardWordsInSession = []; // æœ¬è½®æ ‡è®°ä¸ºå›°éš¾çš„å•è¯

// V8: è‡ªé€‚åº”éš¾åº¦ç³»ç»Ÿ
var adaptiveDifficulty = {
    // ç”¨æˆ·å†å²è¡¨ç°
    recentPerformance: [], // æœ€è¿‘20æ¬¡è¯„åˆ†
    averageAccuracy: 0.7, // å¹³å‡å‡†ç¡®ç‡
    learningSpeed: 'normal', // slow, normal, fast
    preferredMode: 'balanced' // easy, balanced, challenging
};

// V8: åŠ è½½ç”¨æˆ·å­¦ä¹ ç‰¹å¾
function loadAdaptiveDifficulty() {
    try {
        var saved = localStorage.getItem('adaptiveDifficulty');
        if (saved) {
            adaptiveDifficulty = JSON.parse(saved);
        }
    } catch(e) {}
}

// V8: æ›´æ–°è‡ªé€‚åº”éš¾åº¦
function updateAdaptiveDifficulty(rating) {
    var isCorrect = (rating === 'good' || rating === 'easy');
    adaptiveDifficulty.recentPerformance.push(isCorrect ? 1 : 0);
    
    // ä¿æŒæœ€è¿‘20æ¬¡è®°å½•
    if (adaptiveDifficulty.recentPerformance.length > 20) {
        adaptiveDifficulty.recentPerformance.shift();
    }
    
    // è®¡ç®—å¹³å‡å‡†ç¡®ç‡
    var sum = adaptiveDifficulty.recentPerformance.reduce(function(a, b) { return a + b; }, 0);
    adaptiveDifficulty.averageAccuracy = sum / adaptiveDifficulty.recentPerformance.length;
    
    // ç¡®å®šå­¦ä¹ é€Ÿåº¦
    if (adaptiveDifficulty.averageAccuracy >= 0.85) {
        adaptiveDifficulty.learningSpeed = 'fast';
    } else if (adaptiveDifficulty.averageAccuracy <= 0.55) {
        adaptiveDifficulty.learningSpeed = 'slow';
    } else {
        adaptiveDifficulty.learningSpeed = 'normal';
    }
    
    // ä¿å­˜
    localStorage.setItem('adaptiveDifficulty', JSON.stringify(adaptiveDifficulty));
}

// V8: è·å–è‡ªé€‚åº”è°ƒæ•´å› å­
function getAdaptiveFactor(rating) {
    var factor = 1.0;
    
    switch(adaptiveDifficulty.learningSpeed) {
        case 'fast':
            // å­¦å¾—å¿«ï¼šå¢åŠ é—´éš”ï¼Œå‡å°‘å¤ä¹ é¢‘ç‡
            if (rating === 'good' || rating === 'easy') factor = 1.15;
            break;
        case 'slow':
            // å­¦å¾—æ…¢ï¼šå‡å°‘é—´éš”ï¼Œå¢åŠ å¤ä¹ é¢‘ç‡
            if (rating === 'hard' || rating === 'again') factor = 0.85;
            break;
    }
    
    return factor;
}

// V3 & V8: è®¡ç®—å¹¶æ˜¾ç¤ºå¤ä¹ é—´éš”ï¼ˆå¸¦è‡ªé€‚åº”è°ƒæ•´ï¼‰
function calculateReviewInterval(word, rating) {
    var wordProgress = wordLearningProgress[word] || {};
    var easeFactor = wordProgress.easeFactor || 2.5;
    var currentInterval = wordProgress.interval || 0;
    var repetitions = wordProgress.repetitions || 0;
    
    // V8: è·å–è‡ªé€‚åº”å› å­
    var adaptiveFactor = getAdaptiveFactor(rating);
    
    var interval = 0;
    var nextEaseFactor = easeFactor;
    
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³å¤ä¹ 
            interval = 0; // ç«‹å³ï¼ˆ<1åˆ†é’Ÿï¼‰
            nextEaseFactor = Math.max(1.3, easeFactor - 0.2);
            break;
        case 'hard': // å›°éš¾ - 1å¤©å
            interval = Math.max(1, Math.round(currentInterval * 1.2 * adaptiveFactor));
            nextEaseFactor = Math.max(1.3, easeFactor - 0.15);
            break;
        case 'good': // è‰¯å¥½ - æ­£å¸¸é—´éš”
            if (repetitions === 0) {
                interval = 1;
            } else if (repetitions === 1) {
                interval = 3;
            } else {
                interval = Math.round(currentInterval * easeFactor * adaptiveFactor);
            }
            break;
        case 'easy': // ç®€å• - å»¶é•¿é—´éš”
            if (repetitions === 0) {
                interval = 4;
            } else {
                interval = Math.round(currentInterval * easeFactor * 1.3 * adaptiveFactor);
            }
            nextEaseFactor = Math.min(2.5, easeFactor + 0.15);
            break;
    }
    
    return {
        interval: interval,
        easeFactor: nextEaseFactor,
        displayText: formatInterval(interval)
    };
}

// æ ¼å¼åŒ–é—´éš”æ—¶é—´æ˜¾ç¤º
function formatInterval(days) {
    if (days === 0) return '<1åˆ†é’Ÿ';
    if (days === 1) return '1å¤©';
    if (days < 7) return days + 'å¤©';
    if (days < 30) return Math.round(days / 7) + 'å‘¨';
    if (days < 365) return Math.round(days / 30) + 'æœˆ';
    return Math.round(days / 365) + 'å¹´';
}

// V3: æ›´æ–°é—´éš”æ˜¾ç¤º
function updateIntervalDisplay() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // è®¡ç®—å„è¯„åˆ†å¯¹åº”çš„é—´éš”
    var intervals = {
        again: calculateReviewInterval(word, 'again'),
        hard: calculateReviewInterval(word, 'hard'),
        good: calculateReviewInterval(word, 'good'),
        easy: calculateReviewInterval(word, 'easy')
    };
    
    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    var againInterval = document.getElementById('againInterval');
    var hardInterval = document.getElementById('hardInterval');
    var goodInterval = document.getElementById('goodInterval');
    var easyInterval = document.getElementById('easyInterval');
    
    if (againInterval) againInterval.textContent = intervals.again.displayText;
    if (hardInterval) hardInterval.textContent = intervals.hard.displayText;
    if (goodInterval) goodInterval.textContent = intervals.good.displayText;
    if (easyInterval) easyInterval.textContent = intervals.easy.displayText;
}

// V1 & V2 & V4 & V8: é‡å†™è¯„åˆ†å‡½æ•° - Ankié£æ ¼æ™ºèƒ½å¤ä¹ ï¼ˆå¸¦è‡ªé€‚åº”éš¾åº¦ï¼‰
function rateWord(rating) {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // V8: æ›´æ–°è‡ªé€‚åº”éš¾åº¦
    updateAdaptiveDifficulty(rating);
    
    // æ›´æ–°æœ¬è½®å­¦ä¹ è¿›åº¦
    var sessionProgress = sessionWordProgress[word] || { times: 0, completed: false };
    
    // V2: æ ¹æ®è¯„åˆ†å¤„ç†å³æ—¶å¤ä¹ é˜Ÿåˆ—
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³åŠ å…¥å³æ—¶å¤ä¹ é˜Ÿåˆ—
            // ä¸å¢åŠ å­¦ä¹ æ¬¡æ•°
            addToImmediateReview(wordData, 1); // 1ä¸ªå•è¯åç«‹å³å¤ä¹ 
            showRatingFeedback('again', 'é©¬ä¸Šå†æ¥ä¸€æ¬¡ï¼ğŸ’ª');
            break;
            
        case 'hard': // å›°éš¾ - ç¨ååœ¨æœ¬ç»„å†…å¤ä¹ 
            // å¢åŠ å­¦ä¹ æ¬¡æ•°ä½†æ ‡è®°ä¸ºå›°éš¾
            sessionProgress.times++;
            if (hardWordsInSession.indexOf(word) === -1) {
                hardWordsInSession.push(word);
            }
            addToImmediateReview(wordData, 3); // 3ä¸ªå•è¯åå¤ä¹ 
            showRatingFeedback('hard', 'ç¨åå†å¤ä¹  ğŸ“');
            break;
            
        case 'good': // è‰¯å¥½ - æ­£å¸¸è¿›åº¦
            sessionProgress.times++;
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var hardIndex = hardWordsInSession.indexOf(word);
            if (hardIndex > -1) hardWordsInSession.splice(hardIndex, 1);
            showRatingFeedback('good', 'ç»§ç»­ä¿æŒï¼âœ“');
            break;
            
        case 'easy': // ç®€å• - åŠ é€ŸæŒæ¡
            sessionProgress.times += 2; // ç®€å•ç›´æ¥+2æ¬¡è¿›åº¦
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var easyHardIndex = hardWordsInSession.indexOf(word);
            if (easyHardIndex > -1) hardWordsInSession.splice(easyHardIndex, 1);
            showRatingFeedback('easy', 'å¤ªæ£’äº†ï¼ğŸ‰');
            break;
            
        // å…¼å®¹æ—§ç‰ˆè¯„åˆ†
        case 'medium':
            rating = 'good';
            sessionProgress.times++;
            break;
    }
    
    // åˆ¤æ–­æœ¬è½®æ˜¯å¦å®Œæˆ
    if (sessionProgress.times >= requiredLearningTimes) {
        sessionProgress.completed = true;
        showCompletionToast(word);
        
        // æ›´æ–°å…¨å±€å­¦ä¹ è¿›åº¦ (V4: SM-2ç®—æ³•)
        var intervalData = calculateReviewInterval(word, rating);
        var globalProgress = wordLearningProgress[word] || { 
            times: 0, 
            completed: false, 
            ratings: [],
            easeFactor: 2.5,
            interval: 0,
            repetitions: 0
        };
        
        globalProgress.times = sessionProgress.times;
        globalProgress.completed = true;
        globalProgress.ratings.push(rating);
        globalProgress.lastReview = new Date().toISOString();
        globalProgress.easeFactor = intervalData.easeFactor;
        globalProgress.interval = intervalData.interval;
        globalProgress.repetitions = (globalProgress.repetitions || 0) + 1;
        
        // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        var nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + intervalData.interval);
        globalProgress.nextReview = nextReview.toISOString();
        
        wordLearningProgress[word] = globalProgress;
        localStorage.setItem('wordLearningProgress', JSON.stringify(wordLearningProgress));
        
        // è®°å½•ä¸ºå·²å­¦
        if (learnedWords.indexOf(word) === -1) {
            learnedWords.push(word);
            localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
            localStorage.setItem('learnedCount', learnedWords.length.toString());
            
            // æ›´æ–°ä»Šæ—¥ç›®æ ‡è¿›åº¦
            if (typeof updateDailyProgress === 'function') {
                updateDailyProgress('vocabulary', 1);
            }
            
            // v3.5.0: è§¦å‘æˆå°±æ£€æŸ¥
            if (window.UX && window.UX.Achievements) {
                window.UX.Achievements.checkWordCount(learnedWords.length);
                if (learnedWords.length % 10 === 0) {
                    const msg = window.UX.EncouragementSystem.getRandom('milestone');
                    window.UX.showSmartToast(msg, 'achievement');
                } else if (Math.random() < 0.3) {
                    const msg = window.UX.EncouragementSystem.getRandom('progress');
                    window.UX.showSmartToast(msg, 'success');
                }
                window.UX.LevelSystem.checkLevelUp();
            }
        }
        
        // å¦‚æœè¯„åˆ†ä¸ºç®€å•ï¼Œæ ‡è®°ä¸ºå·²æŒæ¡
        if (rating === 'easy') {
            var mastered = parseInt(localStorage.getItem('masteredCount') || '0');
            localStorage.setItem('masteredCount', (mastered + 1).toString());
        }
    }
    
    sessionWordProgress[word] = sessionProgress;
    
    // ä¿å­˜è¯„åˆ†ï¼ˆV4: åŒ…å«SM-2æ•°æ®ï¼‰
    var intervalInfo = calculateReviewInterval(word, rating);
    var prevCount = wordRatings[word] ? wordRatings[word].count : 0;
    wordRatings[word] = {
        rating: rating,
        lastReview: new Date().toISOString(),
        count: prevCount + 1,
        interval: intervalInfo.interval,
        easeFactor: intervalInfo.easeFactor,
        learningProgress: sessionProgress
    };
    localStorage.setItem('wordRatings', JSON.stringify(wordRatings));
    
    // åˆ·æ–°UI
    updateVocabProgress();
    updateLearningBadge();
    updateLearningProgressIndicator();
    
    // V9: æ›´æ–°å­¦ä¹ ç»Ÿè®¡
    updateSessionStats(rating);
    
    // è§¦å‘å…¨å±€å­¦ä¹ è¿›åº¦æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularyProgressUpdated', {
            detail: {
                word: word,
                rating: rating,
                sessionProgress: sessionProgress,
                totalLearned: learnedWords.length,
                interval: intervalInfo.interval
            }
        }));
    } catch(e) {}
    
    // ä¸‹ä¸€ä¸ªè¯
    nextWord();
}

// V2: æ·»åŠ åˆ°å³æ—¶å¤ä¹ é˜Ÿåˆ—
function addToImmediateReview(wordData, gap) {
    var insertIndex = Math.min(currentQueueIndex + gap, learningQueue.length);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„ç›¸è¿‘ä½ç½®
    var alreadyNearby = false;
    for (var i = currentQueueIndex + 1; i < Math.min(currentQueueIndex + gap + 2, learningQueue.length); i++) {
        if (learningQueue[i] && learningQueue[i].word === wordData.word) {
            alreadyNearby = true;
            break;
        }
    }
    
    if (!alreadyNearby) {
        learningQueue.splice(insertIndex, 0, wordData);
        immediateReviewQueue.push({
            word: wordData.word,
            insertedAt: insertIndex,
            timestamp: Date.now()
        });
    }
}

// V5: æ˜¾ç¤ºè¯„åˆ†åé¦ˆï¼ˆå¸¦çŠ¶æ€å¡ç‰‡æ•ˆæœï¼‰
function showRatingFeedback(rating, message) {
    var colors = {
        again: { bg: 'linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)', border: '#fecaca', text: '#dc2626', icon: 'ğŸ”„' },
        hard: { bg: 'linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%)', border: '#fed7aa', text: '#ea580c', icon: 'ğŸ’ª' },
        good: { bg: 'linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)', border: '#bbf7d0', text: '#16a34a', icon: 'âœ“' },
        easy: { bg: 'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)', border: '#bfdbfe', text: '#2563eb', icon: 'ğŸ‰' }
    };
    
    var style = colors[rating] || colors.good;
    
    var feedback = document.createElement('div');
    feedback.className = 'rating-feedback-card';
    feedback.innerHTML = '<span class="feedback-icon">' + style.icon + '</span><span class="feedback-text">' + message + '</span>';
    feedback.style.cssText = 'position:fixed;top:25%;left:50%;transform:translateX(-50%);background:' + style.bg + ';color:' + style.text + ';padding:16px 28px;border-radius:16px;font-size:16px;font-weight:700;z-index:10001;box-shadow:0 10px 40px rgba(0,0,0,0.15);animation:feedbackBounce 0.4s ease;border:2px solid ' + style.border + ';display:flex;align-items:center;gap:10px;';
    document.body.appendChild(feedback);
    
    setTimeout(function() {
        feedback.style.animation = 'feedbackOut 0.3s ease forwards';
        setTimeout(function() {
            if (feedback.parentNode) feedback.parentNode.removeChild(feedback);
        }, 300);
    }, 800);
}

// V9: å­¦ä¹ ç»Ÿè®¡
var sessionStats = {
    again: 0,
    hard: 0,
    good: 0,
    easy: 0,
    startTime: null
};

function updateSessionStats(rating) {
    if (!sessionStats.startTime) {
        sessionStats.startTime = Date.now();
    }
    
    if (sessionStats[rating] !== undefined) {
        sessionStats[rating]++;
    }
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('currentSessionStats', JSON.stringify(sessionStats));
}

function getSessionStats() {
    var duration = sessionStats.startTime ? Math.round((Date.now() - sessionStats.startTime) / 1000) : 0;
    var total = sessionStats.again + sessionStats.hard + sessionStats.good + sessionStats.easy;
    
    return {
        again: sessionStats.again,
        hard: sessionStats.hard,
        good: sessionStats.good,
        easy: sessionStats.easy,
        total: total,
        duration: duration,
        accuracy: total > 0 ? Math.round(((sessionStats.good + sessionStats.easy) / total) * 100) : 0
    };
}

// å°†å•è¯æ·»åŠ åˆ°é˜Ÿåˆ—åé¢ï¼ˆç”¨äºå›°éš¾å•è¯é‡å¤å­¦ä¹ ï¼‰- å…¼å®¹æ—§ç‰ˆ
function addWordToQueueLater(wordData, gap) {
    addToImmediateReview(wordData, gap);
}

// æ˜¾ç¤ºå›°éš¾åé¦ˆ - æ›´æ–°ä¸ºæ–°ç‰ˆ
function showDifficultyFeedback(message) {
    showRatingFeedback('hard', message);
}

// ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šè®¾ç½®æ›´æ–°æç¤º ======
function showSettingsUpdateToast(message) {
    var toast = document.createElement('div');
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:10px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span><span style="font-weight:600;">' + message + '</span>';
    toast.style.cssText = 'position:fixed;top:15%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:white;padding:14px 24px;border-radius:14px;font-size:14px;z-index:10001;box-shadow:0 8px 30px rgba(99,102,241,0.35);animation:toastIn 0.3s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

// æ˜¾ç¤ºå•è¯å®Œæˆæç¤º
function showCompletionToast(word) {
    var toast = document.createElement('div');
    toast.className = 'word-completion-toast';
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:12px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><div><strong style="font-size:18px;">' + word + '</strong><div style="font-size:13px;opacity:0.9;margin-top:2px;">å­¦ä¹ å®Œæˆï¼ç»§ç»­åŠ æ²¹ âœ“</div></div>';
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:20px 32px;border-radius:20px;font-size:16px;font-weight:600;z-index:10001;box-shadow:0 15px 50px rgba(16,185,129,0.45);animation:toastIn 0.4s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

// V6: æ˜¾ç¤ºå­¦ä¹ æ¨¡å¼æŒ‡ç¤ºå™¨
function showLearningModeIndicator(mode) {
    // ç§»é™¤æ—§çš„æŒ‡ç¤ºå™¨
    var oldIndicator = document.getElementById('learningModeIndicator');
    if (oldIndicator) oldIndicator.remove();
    
    var modeConfig = {
        normal: { 
            text: 'æ–°è¯å­¦ä¹ ', 
            icon: 'ğŸ“–', 
            color: '#6366f1',
            bgGradient: 'linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)',
            borderColor: '#c7d2fe',
            hint: 'è®¤çœŸè®°å¿†'
        },
        review: { 
            text: 'å¤ä¹ å·©å›º', 
            icon: 'ğŸ”„', 
            color: '#f59e0b',
            bgGradient: 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)',
            borderColor: '#fde68a',
            hint: 'åŠ æ·±å°è±¡'
        },
        immediate: { 
            text: 'ç«‹å³å¤ä¹ ', 
            icon: 'âš¡', 
            color: '#ef4444',
            bgGradient: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
            borderColor: '#fecaca',
            hint: 'å†æ¥ä¸€æ¬¡'
        },
        difficult: { 
            text: 'æ”»å…‹éš¾è¯', 
            icon: 'ğŸ’ª', 
            color: '#ea580c',
            bgGradient: 'linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%)',
            borderColor: '#fed7aa',
            hint: 'ä¸“æ³¨è®°å¿†'
        }
    };
    
    var config = modeConfig[mode] || modeConfig.normal;
    
    var indicator = document.createElement('div');
    indicator.id = 'learningModeIndicator';
    indicator.className = 'learning-mode-indicator mode-' + mode;
    indicator.innerHTML = '<span class="mode-icon">' + config.icon + '</span><span class="mode-text">' + config.text + '</span><span class="mode-hint">' + config.hint + '</span>';
    indicator.style.cssText = 'position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:' + config.bgGradient + ';color:' + config.color + ';padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;z-index:10;display:flex;align-items:center;gap:6px;border:2px solid ' + config.borderColor + ';box-shadow:0 4px 12px rgba(0,0,0,0.1);animation:modeIndicatorIn 0.3s ease;white-space:nowrap;';
    
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.style.position = 'relative';
        wordCard.insertBefore(indicator, wordCard.firstChild);
    }
}

function nextWord() {
    currentQueueIndex++;
    
    // V6: ä»å³æ—¶å¤ä¹ é˜Ÿåˆ—ç§»é™¤å·²å¤„ç†çš„è¯
    if (immediateReviewQueue && immediateReviewQueue.length > 0) {
        var prevWord = learningQueue[currentQueueIndex - 1];
        if (prevWord) {
            immediateReviewQueue = immediateReviewQueue.filter(function(r) {
                return r.word !== prevWord.word;
            });
        }
    }
    
    if (currentQueueIndex < learningQueue.length) {
        showCurrentWord();
    } else {
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å•è¯éƒ½å·²å®Œæˆ
        var allCompleted = true;
        sessionWords.forEach(function(w) {
            if (!sessionWordProgress[w.word] || !sessionWordProgress[w.word].completed) {
                allCompleted = false;
            }
        });
        
        if (allCompleted) {
            // å­¦å®Œæœ¬ç»„ï¼Œæ˜¾ç¤ºæ€»ç»“é¡µé¢
            showSessionSummary();
        } else {
            // è¿˜æœ‰æœªå®Œæˆçš„å•è¯ï¼Œé‡æ–°æ„å»ºé˜Ÿåˆ—
            buildLearningQueue();
            currentQueueIndex = 0;
            if (learningQueue.length > 0) {
                showCurrentWord();
            } else {
                showSessionSummary();
            }
        }
    }
}

// V7 & V9: æ˜¾ç¤ºå¢å¼ºç‰ˆæœ¬è½®å­¦ä¹ æ€»ç»“
function showSessionSummary() {
    var wordCard = document.getElementById('wordCard');
    var rateButtons = document.getElementById('rateButtons');
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    var vocabProgress = document.getElementById('vocabProgress');
    
    if (rateButtons) rateButtons.classList.add('hidden');
    if (showMeaningBtn) showMeaningBtn.classList.add('hidden');
    
    // V9: è·å–å­¦ä¹ ç»Ÿè®¡
    var stats = getSessionStats();
    var duration = stats.duration;
    var minutes = Math.floor(duration / 60);
    var seconds = duration % 60;
    var timeStr = minutes > 0 ? minutes + 'åˆ†' + seconds + 'ç§’' : seconds + 'ç§’';
    
    // è®¡ç®—å„è¯„åˆ†æ•°é‡
    var againCount = stats.again || 0;
    var hardCount = stats.hard || 0;
    var goodCount = stats.good || 0;
    var easyCount = stats.easy || 0;
    var totalRatings = againCount + hardCount + goodCount + easyCount;
    
    // V7: æ„å»ºå¢å¼ºç‰ˆæ€»ç»“HTML
    var summaryHtml = '<div style="padding:20px;">';
    
    // é¡¶éƒ¨æˆå°±å¾½ç« 
    summaryHtml += '<div style="text-align:center;margin-bottom:20px;">';
    summaryHtml += '<div style="width:80px;height:80px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 10px 40px rgba(16,185,129,0.35);animation:completionBounce 0.6s ease;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>';
    summaryHtml += '<h2 style="margin:0;color:#1e1b4b;font-size:26px;font-weight:800;">ğŸ‰ å­¦ä¹ å®Œæˆï¼</h2>';
    summaryHtml += '<p style="color:#6b7280;margin-top:10px;font-size:15px;">å…±å­¦ä¹  <span style="color:#6366f1;font-weight:700;">' + sessionWords.length + '</span> ä¸ªå•è¯</p>';
    summaryHtml += '</div>';
    
    // V9: å­¦ä¹ ç»Ÿè®¡å¡ç‰‡
    summaryHtml += '<div class="session-stats-card" style="background:linear-gradient(135deg,#f8fafc 0%,#eef2ff 100%);border-radius:16px;padding:16px;margin-bottom:20px;border:1px solid rgba(99,102,241,0.15);display:flex;flex-wrap:wrap;gap:10px;justify-content:space-around;">';
    
    // ç”¨æ—¶ç»Ÿè®¡
    summaryHtml += '<div style="text-align:center;min-width:60px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">â±ï¸ ç”¨æ—¶</div><div style="font-size:16px;font-weight:700;color:#1e1b4b;">' + timeStr + '</div></div>';
    
    // å‡†ç¡®ç‡
    summaryHtml += '<div style="text-align:center;min-width:60px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">ğŸ¯ å‡†ç¡®ç‡</div><div style="font-size:16px;font-weight:700;color:' + (stats.accuracy >= 80 ? '#10b981' : stats.accuracy >= 60 ? '#f59e0b' : '#ef4444') + ';">' + stats.accuracy + '%</div></div>';
    
    // è¯„åˆ†åˆ†å¸ƒ - ç®€åŒ–å±•ç¤º
    summaryHtml += '<div style="text-align:center;min-width:80px;"><div style="font-size:10px;color:#6b7280;margin-bottom:4px;">ğŸ“Š è¯„åˆ†åˆ†å¸ƒ</div><div style="display:flex;gap:4px;justify-content:center;font-size:11px;font-weight:600;">';
    if (easyCount > 0) summaryHtml += '<span style="color:#2563eb;" title="ç®€å•">' + easyCount + 'ğŸ‰</span>';
    if (goodCount > 0) summaryHtml += '<span style="color:#16a34a;" title="è‰¯å¥½">' + goodCount + 'âœ“</span>';
    if (hardCount > 0) summaryHtml += '<span style="color:#ea580c;" title="å›°éš¾">' + hardCount + 'ğŸ’ª</span>';
    if (againCount > 0) summaryHtml += '<span style="color:#dc2626;" title="é‡å­¦">' + againCount + 'ğŸ”„</span>';
    summaryHtml += '</div></div>';
    
    summaryHtml += '</div>';
    
    // V7: è¿›åº¦å¯è§†åŒ–ç¯å½¢å›¾
    var masteryRate = totalRatings > 0 ? Math.round(((easyCount + goodCount) / totalRatings) * 100) : 0;
    summaryHtml += '<div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;">';
    summaryHtml += '<div style="position:relative;width:80px;height:80px;">';
    summaryHtml += '<svg viewBox="0 0 36 36" style="width:80px;height:80px;transform:rotate(-90deg);">';
    summaryHtml += '<circle cx="18" cy="18" r="16" fill="none" stroke="#e5e7eb" stroke-width="3"/>';
    summaryHtml += '<circle cx="18" cy="18" r="16" fill="none" stroke="url(#progressGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="' + masteryRate + ' ' + (100 - masteryRate) + '" style="transition:stroke-dasharray 1s ease;"/>';
    summaryHtml += '<defs><linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#6366f1"/><stop offset="100%" style="stop-color:#10b981"/></linearGradient></defs>';
    summaryHtml += '</svg>';
    summaryHtml += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;"><div style="font-size:18px;font-weight:800;color:#1e1b4b;">' + masteryRate + '%</div><div style="font-size:9px;color:#6b7280;">æŒæ¡åº¦</div></div>';
    summaryHtml += '</div>';
    summaryHtml += '<div style="text-align:left;"><div style="font-size:12px;color:#6b7280;margin-bottom:6px;">å­¦ä¹ å»ºè®®</div><div style="font-size:13px;color:#374151;font-weight:600;">' + getLearningAdvice(masteryRate, hardCount, againCount) + '</div></div>';
    summaryHtml += '</div>';
    
    // å•è¯åˆ—è¡¨
    summaryHtml += '<div style="max-height:300px;overflow-y:auto;">';
    
    sessionWords.forEach(function(wordData, index) {
        var rating = wordRatings[wordData.word] ? wordRatings[wordData.word].rating : 'good';
        var ratingConfig = {
            easy: { icon: 'ğŸ‰', bg: 'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)', border: '#bfdbfe' },
            good: { icon: 'âœ“', bg: 'linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)', border: '#bbf7d0' },
            hard: { icon: 'ğŸ’ª', bg: 'linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%)', border: '#fed7aa' },
            again: { icon: 'ğŸ”„', bg: 'linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)', border: '#fecaca' },
            medium: { icon: 'â€¢', bg: 'linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%)', border: '#fde68a' }
        };
        var config = ratingConfig[rating] || ratingConfig.good;
        
        summaryHtml += '<div style="background:' + config.bg + ';border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid ' + config.border + ';">';
        summaryHtml += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">';
        summaryHtml += '<div style="display:flex;align-items:center;gap:10px;">';
        summaryHtml += '<span style="background:linear-gradient(135deg,#6366f1,#a855f7);color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">' + (index + 1) + '</span>';
        summaryHtml += '<span style="font-size:17px;font-weight:700;color:#1e1b4b;">' + wordData.word + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<span style="font-size:18px;">' + config.icon + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<div style="font-size:14px;color:#374151;font-weight:600;">' + (wordData.meaningCn || '') + '</div>';
        summaryHtml += '</div>';
    });
    
    summaryHtml += '</div>';
    
    // æ“ä½œæŒ‰é’®
    summaryHtml += '<div style="display:flex;gap:12px;margin-top:20px;">';
    summaryHtml += '<button onclick="restartSession()" style="flex:1;padding:16px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#a855f7 100%);color:white;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(99,102,241,0.35);display:flex;align-items:center;justify-content:center;gap:8px;"><span>ğŸš€</span>ç»§ç»­å­¦ä¹ </button>';
    summaryHtml += '<button onclick="closeModule()" style="flex:1;padding:16px;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#6366f1;border:2px solid rgba(99,102,241,0.3);border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;"><span>âœ…</span>å®Œæˆ</button>';
    summaryHtml += '</div>';
    summaryHtml += '</div>';
    
    if (wordCard) {
        wordCard.innerHTML = summaryHtml;
    }
    
    // é‡ç½®ä¼šè¯ç»Ÿè®¡
    sessionStats = { again: 0, hard: 0, good: 0, easy: 0, startTime: null };
    
    // æ›´æ–°ç»Ÿè®¡
    var statWords = document.getElementById('stat_words');
    if (statWords) statWords.textContent = learnedWords.length;
}

// V7: è·å–å­¦ä¹ å»ºè®®
function getLearningAdvice(masteryRate, hardCount, againCount) {
    if (masteryRate >= 90) {
        return 'ğŸŒŸ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼';
    } else if (masteryRate >= 70) {
        return 'ğŸ‘ å­¦å¾—ä¸é”™ï¼Œå†åŠªåŠ›ä¸€ä¸‹ï¼';
    } else if (hardCount > 0 || againCount > 0) {
        return 'ğŸ’¡ å»ºè®®å¤ä¹ å›°éš¾å•è¯';
    } else {
        return 'ğŸ“š å¤šçœ‹å‡ éï¼ŒåŠ æ·±è®°å¿†';
    }
}

// é‡æ–°å¼€å§‹å­¦ä¹ 
function restartSession() {
    currentWordIndex = 0;
    
    // æ¢å¤åŸå§‹è¯å¡ç»“æ„ï¼ˆåªæ¢å¤wordCardå†…éƒ¨çš„å†…å®¹ï¼Œä¸åŒ…æ‹¬æŒ‰é’®ï¼‰
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.innerHTML = '<div class="word-main" id="wordMain">Loading...</div>' +
            '<div class="word-phonetic" id="wordPhonetic">/ËˆlÉ™ÊŠdÉªÅ‹/</div>' +
            '<div class="word-meaning hidden" id="wordMeaning">' +
            '<div id="dictContainer"></div>' +
            '<div class="meaning-cn" id="meaningCn"></div>' +
            '<div class="meaning-en" id="meaningEn"></div>' +
            '<div class="word-example" id="wordExample"></div>' +
            '</div>';
    }
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    // é‡æ–°åˆå§‹åŒ–å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
}

function prevWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
    } else {
        currentWordIndex = sessionWords.length - 1;
    }
    showCurrentWord();
}

// é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
var cachedVoices = [];
var preferredVoice = null;

if ('speechSynthesis' in window) {
    cachedVoices = speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = function() {
        cachedVoices = speechSynthesis.getVoices();
        preferredVoice = selectBestUSVoice(cachedVoices);
        console.log('å¯ç”¨è¯­éŸ³:', cachedVoices.map(v => v.name + ' (' + v.lang + ')'));
        console.log('å·²é€‰æ‹©è¯­éŸ³:', preferredVoice ? preferredVoice.name : 'é»˜è®¤');
    };
}

// é€‰æ‹©æœ€ä½³ç¾å¼è‹±è¯­è¯­éŸ³
function selectBestUSVoice(voices) {
    if (!voices || voices.length === 0) return null;
    
    // macOS ä¸Šä¼˜è´¨ç¾å¼è‹±è¯­è¯­éŸ³ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    var preferredNames = [
        // macOS é«˜è´¨é‡ç¾å¼è¯­éŸ³
        'Samantha',           // ç¾å¼å¥³å£° - éå¸¸è‡ªç„¶
        'Alex',               // ç¾å¼ç”·å£° - éå¸¸è‡ªç„¶
        'Allison',            // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Ava',                // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Susan',              // ç¾å¼å¥³å£°
        'Tom',                // ç¾å¼ç”·å£°
        'Zoe',                // ç¾å¼å¥³å£°
        // iOS è¯­éŸ³
        'Samantha (Enhanced)',
        'Alex (Enhanced)',
        // Chrome/Edge è¯­éŸ³
        'Google US English',
        'Microsoft Zira',
        'Microsoft David',
    ];
    
    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾
    for (var i = 0; i < preferredNames.length; i++) {
        var voice = voices.find(function(v) {
            return v.name.includes(preferredNames[i]) && 
                   (v.lang === 'en-US' || v.lang.startsWith('en-US'));
        });
        if (voice) return voice;
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼ŒæŸ¥æ‰¾ä»»ä½•ç¾å¼è‹±è¯­è¯­éŸ³
    var usVoice = voices.find(function(v) {
        return v.lang === 'en-US' || v.lang.startsWith('en-US');
    });
    if (usVoice) return usVoice;
    
    // æœ€åé™çº§åˆ°ä»»ä½•è‹±è¯­è¯­éŸ³
    return voices.find(function(v) {
        return v.lang.startsWith('en');
    });
}

// ç¾å¼å‘éŸ³ - ä½¿ç”¨æµè§ˆå™¨å†…ç½®TTS
function speakWord() {
    var wordEl = document.getElementById('wordMain');
    var word = wordEl ? wordEl.textContent : '';
    if (!word) return;
    
    speakText(word);
}

// é€šç”¨è¯­éŸ³æ’­æ”¾å‡½æ•°
function speakText(text) {
    if (!('speechSynthesis' in window)) {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
        return;
    }
    
    // å–æ¶ˆæ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    speechSynthesis.cancel();
    
    // åˆ›å»ºè¯­éŸ³å¯¹è±¡
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.85;  // ç¨å¾®æ”¾æ…¢ï¼Œæ›´æ¸…æ™°
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // é€‰æ‹©æœ€ä½³è¯­éŸ³
    var voices = cachedVoices.length > 0 ? cachedVoices : speechSynthesis.getVoices();
    var voice = preferredVoice || selectBestUSVoice(voices);
    
    if (voice) {
        utterance.voice = voice;
        console.log('ä½¿ç”¨è¯­éŸ³:', voice.name);
    }
    
    // æ’­æ”¾
    speechSynthesis.speak(utterance);
}

// ä¿ç•™æ—§å‡½æ•°åå…¼å®¹
function speakWordTTS(word) {
    speakText(word);
}

function setVoiceAndSpeak(utterance, voices) {
    speechSynthesis.speak(utterance);
}

window.initVocabulary = initVocabulary;
window.showMeaning = showMeaning;
window.rateWord = rateWord;
window.speakWord = speakWord;
window.nextWord = nextWord;
window.prevWord = prevWord;
window.changeWordsPerSession = changeWordsPerSession;
window.changeLearningTimes = changeLearningTimes;
window.initSessionWords = initSessionWords;
window.restartSession = restartSession;
window.showSessionSummary = showSessionSummary;
window.updateLearningProgressIndicator = updateLearningProgressIndicator;
window.updateLearningBadge = updateLearningBadge;

// ==================== V14: ç§‘å­¦åŠ©è®°äº¤äº’åŠŸèƒ½ ====================

// V14.7: è®°å½•åŠ©è®°æ•ˆæœåé¦ˆ
function rateMnemonicEffectiveness(word, wasEffective) {
    var mnemonic = getWordMnemonic(word);
    var mnemonicType = mnemonic ? (mnemonic.type || 'etymology') : 'unknown';
    
    recordMnemonicEffectiveness(word, mnemonicType, wasEffective);
    
    // æ˜¾ç¤ºåé¦ˆåŠ¨ç”»
    var feedbackEl = document.createElement('div');
    feedbackEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:' + 
        (wasEffective ? 'linear-gradient(135deg,#22c55e,#16a34a)' : 'linear-gradient(135deg,#f97316,#ea580c)') + 
        ';color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;' +
        'box-shadow:0 8px 32px rgba(0,0,0,0.2);animation:mnemonicFeedback 0.5s ease-out;';
    feedbackEl.innerHTML = wasEffective ? 'ğŸ‘ å·²è®°å½•ï¼ç»§ç»­åŠ æ²¹' : 'ğŸ”„ å·²æ ‡è®°ï¼Œä¼šåŠ å¼ºå¤ä¹ ';
    document.body.appendChild(feedbackEl);
    
    setTimeout(function() { feedbackEl.remove(); }, 1500);
    
    // å¦‚æœéœ€è¦å¼ºåŒ–ï¼Œæ·»åŠ åˆ°å³æ—¶å¤ä¹ é˜Ÿåˆ—
    if (!wasEffective && typeof immediateReviewQueue !== 'undefined') {
        var wordData = learningQueue.find(function(w) { return w.word.toLowerCase() === word.toLowerCase(); });
        if (wordData && immediateReviewQueue.indexOf(wordData) === -1) {
            immediateReviewQueue.push(wordData);
            console.log('[V14] æ·»åŠ åˆ°å¼ºåŒ–å¤ä¹ é˜Ÿåˆ—:', word);
        }
    }
}

// V14.8: æ˜¾ç¤ºè‡ªå®šä¹‰åŠ©è®°ç¼–è¾‘å™¨
function showCustomMnemonicEditor(word) {
    var existingCustom = userCustomMnemonics[word.toLowerCase()];
    var baseMnemonic = getWordMnemonic(word);
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'customMnemonicOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    
    var editorHtml = '<div style="background:white;border-radius:20px;width:90%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">';
    
    // å¤´éƒ¨
    editorHtml += '<div style="background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 50%,#6366f1 100%);padding:20px;border-radius:20px 20px 0 0;">';
    editorHtml += '<div style="display:flex;align-items:center;justify-content:space-between;">';
    editorHtml += '<div style="display:flex;align-items:center;gap:12px;">';
    editorHtml += '<span style="font-size:32px;">âœ¨</span>';
    editorHtml += '<div><div style="color:white;font-size:18px;font-weight:700;">åˆ›å»ºæˆ‘çš„è®°å¿†æ³•</div>';
    editorHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;">' + word + '</div></div>';
    editorHtml += '</div>';
    editorHtml += '<button onclick="closeCustomMnemonicEditor()" style="background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:12px;color:white;font-size:20px;cursor:pointer;">Ã—</button>';
    editorHtml += '</div></div>';
    
    // å†…å®¹åŒº
    editorHtml += '<div style="padding:20px;">';
    
    // ç§‘å­¦æ–¹æ³•é€‰æ‹©
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ”¬ é€‰æ‹©è®°å¿†æ–¹æ³•ï¼ˆåŸºäºç§‘å­¦ç ”ç©¶ï¼‰</label>';
    editorHtml += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;" id="mnemonicTypeGrid">';
    
    var types = Object.keys(MNEMONIC_SCIENCE.types);
    types.forEach(function(type) {
        var info = MNEMONIC_SCIENCE.types[type];
        var isSelected = existingCustom && existingCustom.type === type;
        editorHtml += '<div onclick="selectMnemonicType(\'' + type + '\')" id="typeBtn_' + type + '" style="padding:10px;background:' + (isSelected ? info.bg : '#f9fafb') + ';border:2px solid ' + (isSelected ? info.color : '#e5e7eb') + ';border-radius:10px;cursor:pointer;transition:all 0.2s;" data-type="' + type + '">';
        editorHtml += '<div style="display:flex;align-items:center;gap:8px;">';
        editorHtml += '<span style="font-size:18px;">' + info.icon + '</span>';
        editorHtml += '<div><div style="font-size:12px;font-weight:600;color:' + info.color + ';">' + info.name + '</div>';
        editorHtml += '<div style="font-size:10px;color:#9ca3af;">' + Math.round(info.effectiveness * 100) + '% æœ‰æ•ˆ</div></div>';
        editorHtml += '</div></div>';
    });
    editorHtml += '</div></div>';
    
    // åŠ©è®°å†…å®¹è¾“å…¥
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ’¡ æˆ‘çš„è®°å¿†æŠ€å·§</label>';
    editorHtml += '<textarea id="customMnemonicText" placeholder="è¾“å…¥ä½ ç‹¬ç‰¹çš„è®°å¿†æ–¹æ³•..." style="width:100%;height:80px;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;resize:none;box-sizing:border-box;">' + (existingCustom ? existingCustom.mnemonic : (baseMnemonic ? baseMnemonic.mnemonic : '')) + '</textarea>';
    editorHtml += '</div>';
    
    // è§†è§‰è”æƒ³
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ¨ è§†è§‰ç”»é¢æè¿°ï¼ˆåŒé‡ç¼–ç ï¼‰</label>';
    editorHtml += '<input id="customVisual" type="text" placeholder="æè¿°ä¸€ä¸ªç”ŸåŠ¨çš„ç”»é¢..." value="' + (existingCustom && existingCustom.visual ? existingCustom.visual : (baseMnemonic && baseMnemonic.association ? baseMnemonic.association : '')) + '" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;box-sizing:border-box;">';
    editorHtml += '</div>';
    
    // æƒ…æ„Ÿé”šå®š
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ’– æƒ…æ„Ÿè¿æ¥ï¼ˆé€‰æ‹©ä¸€ä¸ªæƒ…æ„Ÿï¼‰</label>';
    editorHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;" id="emotionGrid">';
    var emotions = ['joy', 'surprise', 'fear', 'love', 'curiosity', 'anger'];
    var emotionData = {
        'joy': { icon: 'ğŸ˜Š', name: 'å¿«ä¹' },
        'surprise': { icon: 'ğŸ˜²', name: 'æƒŠè®¶' },
        'fear': { icon: 'ğŸ˜¨', name: 'ææƒ§' },
        'love': { icon: 'â¤ï¸', name: 'çˆ±' },
        'curiosity': { icon: 'ğŸ¤”', name: 'å¥½å¥‡' },
        'anger': { icon: 'ğŸ˜ ', name: 'æ„¤æ€’' }
    };
    emotions.forEach(function(emo) {
        var data = emotionData[emo];
        var isSelected = existingCustom && existingCustom.emotional === emo;
        editorHtml += '<div onclick="selectEmotion(\'' + emo + '\')" id="emoBtn_' + emo + '" style="padding:8px 12px;background:' + (isSelected ? '#fce7f3' : '#f9fafb') + ';border:2px solid ' + (isSelected ? '#ec4899' : '#e5e7eb') + ';border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:4px;">';
        editorHtml += '<span style="font-size:16px;">' + data.icon + '</span>';
        editorHtml += '<span style="font-size:12px;color:#374151;">' + data.name + '</span>';
        editorHtml += '</div>';
    });
    editorHtml += '</div></div>';
    
    // ä¿å­˜æŒ‰é’®
    editorHtml += '<button onclick="saveCustomMnemonicFromEditor(\'' + word + '\')" style="width:100%;padding:14px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border:none;border-radius:12px;color:white;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(139,92,246,0.3);">ğŸ’¾ ä¿å­˜æˆ‘çš„è®°å¿†æ³•</button>';
    
    editorHtml += '</div></div>';
    
    overlayEl.innerHTML = editorHtml;
    document.body.appendChild(overlayEl);
    
    // æ·»åŠ é€‰æ‹©çŠ¶æ€å˜é‡
    window._selectedMnemonicType = existingCustom ? existingCustom.type : 'etymology';
    window._selectedEmotion = existingCustom ? existingCustom.emotional : null;
}

// é€‰æ‹©åŠ©è®°ç±»å‹
function selectMnemonicType(type) {
    window._selectedMnemonicType = type;
    var grid = document.getElementById('mnemonicTypeGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[data-type]');
        buttons.forEach(function(btn) {
            var btnType = btn.getAttribute('data-type');
            var info = MNEMONIC_SCIENCE.types[btnType];
            if (btnType === type) {
                btn.style.background = info.bg;
                btn.style.borderColor = info.color;
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// é€‰æ‹©æƒ…æ„Ÿ
function selectEmotion(emotion) {
    window._selectedEmotion = window._selectedEmotion === emotion ? null : emotion;
    var grid = document.getElementById('emotionGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[id^="emoBtn_"]');
        buttons.forEach(function(btn) {
            var emo = btn.id.replace('emoBtn_', '');
            if (emo === window._selectedEmotion) {
                btn.style.background = '#fce7f3';
                btn.style.borderColor = '#ec4899';
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// ä¿å­˜è‡ªå®šä¹‰åŠ©è®°
function saveCustomMnemonicFromEditor(word) {
    var text = document.getElementById('customMnemonicText').value.trim();
    var visual = document.getElementById('customVisual').value.trim();
    
    if (!text) {
        alert('è¯·è¾“å…¥è®°å¿†æŠ€å·§ï¼');
        return;
    }
    
    saveCustomMnemonic(word, {
        text: text,
        type: window._selectedMnemonicType || 'etymology',
        visual: visual || null,
        emotional: window._selectedEmotion || null
    });
    
    // å¦‚æœé€‰æ‹©äº†æƒ…æ„Ÿï¼Œä¹Ÿä¿å­˜æƒ…æ„Ÿé”šå®š
    if (window._selectedEmotion) {
        setEmotionalAnchor(word, window._selectedEmotion, 7);
    }
    
    closeCustomMnemonicEditor();
    
    // åˆ·æ–°æ˜¾ç¤º
    showMeaning();
    
    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.2);';
    toast.innerHTML = 'âœ… ä¿å­˜æˆåŠŸï¼';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 1500);
}

// å…³é—­è‡ªå®šä¹‰åŠ©è®°ç¼–è¾‘å™¨
function closeCustomMnemonicEditor() {
    var overlay = document.getElementById('customMnemonicOverlay');
    if (overlay) overlay.remove();
}

// V14.9: æ˜¾ç¤ºè®°å¿†å®«æ®¿ç¼–è¾‘å™¨
function showMemoryPalaceEditor(word) {
    var existingPlacement = memoryPalaceData.placements ? memoryPalaceData.placements[word.toLowerCase()] : null;
    
    var overlayEl = document.createElement('div');
    overlayEl.id = 'memoryPalaceOverlay';
    overlayEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    
    // åˆå§‹åŒ–ä½ç½®æ•°æ®
    if (!memoryPalaceData.locations) {
        memoryPalaceData.locations = [
            { id: 'home_entrance', name: 'ğŸšª å®¶é—¨å£', description: 'æ¨å¼€é—¨ï¼Œç¬¬ä¸€çœ¼çœ‹åˆ°çš„åœ°æ–¹' },
            { id: 'living_room', name: 'ğŸ›‹ï¸ å®¢å…', description: 'èˆ’é€‚çš„æ²™å‘å’ŒèŒ¶å‡ ' },
            { id: 'kitchen', name: 'ğŸ³ å¨æˆ¿', description: 'é”…ç¢—ç“¢ç›†çš„åœ°æ–¹' },
            { id: 'bedroom', name: 'ğŸ›ï¸ å§å®¤', description: 'ä¼‘æ¯çš„ç§äººç©ºé—´' },
            { id: 'bathroom', name: 'ğŸš¿ å«ç”Ÿé—´', description: 'æ´—æ¼±çš„åœ°æ–¹' },
            { id: 'balcony', name: 'ğŸŒ¿ é˜³å°', description: 'é˜³å…‰å……è¶³çš„åœ°æ–¹' },
            { id: 'study', name: 'ğŸ“š ä¹¦æˆ¿', description: 'å­¦ä¹ å’Œå·¥ä½œçš„åœ°æ–¹' },
            { id: 'garden', name: 'ğŸŒ¸ èŠ±å›­', description: 'èŠ±è‰æ ‘æœ¨çš„å¤©åœ°' }
        ];
    }
    
    var editorHtml = '<div style="background:white;border-radius:20px;width:90%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">';
    
    // å¤´éƒ¨
    editorHtml += '<div style="background:linear-gradient(135deg,#6366f1 0%,#4f46e5 50%,#4338ca 100%);padding:20px;border-radius:20px 20px 0 0;">';
    editorHtml += '<div style="display:flex;align-items:center;justify-content:space-between;">';
    editorHtml += '<div style="display:flex;align-items:center;gap:12px;">';
    editorHtml += '<span style="font-size:32px;">ğŸ›ï¸</span>';
    editorHtml += '<div><div style="color:white;font-size:18px;font-weight:700;">è®°å¿†å®«æ®¿</div>';
    editorHtml += '<div style="color:rgba(255,255,255,0.8);font-size:13px;">å°† "' + word + '" æ”¾ç½®åœ¨ç†Ÿæ‚‰çš„ä½ç½®</div></div>';
    editorHtml += '</div>';
    editorHtml += '<button onclick="closeMemoryPalaceEditor()" style="background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:12px;color:white;font-size:20px;cursor:pointer;">Ã—</button>';
    editorHtml += '</div></div>';
    
    // ç§‘å­¦è¯´æ˜
    editorHtml += '<div style="padding:16px 20px;background:#eef2ff;border-bottom:1px solid #c7d2fe;">';
    editorHtml += '<div style="font-size:12px;color:#4338ca;">ğŸ’¡ <strong>è®°å¿†å®«æ®¿æ³•</strong>æ˜¯ä¸–ç•Œè®°å¿†å† å†›ä½¿ç”¨çš„æŠ€æœ¯ã€‚å°†å•è¯ä¸ç†Ÿæ‚‰åœ°ç‚¹ç»“åˆï¼Œåˆ©ç”¨ç©ºé—´è®°å¿†å¢å¼ºè¯æ±‡è®°å¿†ã€‚</div>';
    editorHtml += '</div>';
    
    // ä½ç½®é€‰æ‹©
    editorHtml += '<div style="padding:20px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:12px;">ğŸ“ é€‰æ‹©ä¸€ä¸ªä½ç½®</label>';
    editorHtml += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;" id="locationGrid">';
    
    memoryPalaceData.locations.forEach(function(loc) {
        var isSelected = existingPlacement && existingPlacement.locationId === loc.id;
        editorHtml += '<div onclick="selectPalaceLocation(\'' + loc.id + '\')" id="locBtn_' + loc.id + '" style="padding:14px;background:' + (isSelected ? '#e0e7ff' : '#f9fafb') + ';border:2px solid ' + (isSelected ? '#6366f1' : '#e5e7eb') + ';border-radius:12px;cursor:pointer;transition:all 0.2s;">';
        editorHtml += '<div style="font-size:16px;margin-bottom:4px;">' + loc.name + '</div>';
        editorHtml += '<div style="font-size:11px;color:#6b7280;">' + loc.description + '</div>';
        editorHtml += '</div>';
    });
    editorHtml += '</div>';
    
    // ç”»é¢æè¿°
    editorHtml += '<div style="margin-bottom:16px;">';
    editorHtml += '<label style="display:block;font-size:13px;font-weight:600;color:#4b5563;margin-bottom:8px;">ğŸ¨ æè¿°ä½ çœ‹åˆ°çš„ç”»é¢</label>';
    editorHtml += '<textarea id="palaceImage" placeholder="æƒ³è±¡è¿™ä¸ªå•è¯åœ¨è¿™ä¸ªä½ç½®å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…..." style="width:100%;height:80px;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;resize:none;box-sizing:border-box;">' + (existingPlacement ? existingPlacement.image : '') + '</textarea>';
    editorHtml += '<div style="font-size:11px;color:#9ca3af;margin-top:6px;">ğŸ’¡ æç¤ºï¼šç”»é¢è¶Šå¤¸å¼ ã€è¶Šæœ‰è¶£ï¼Œè®°å¿†è¶Šæ·±åˆ»ï¼</div>';
    editorHtml += '</div>';
    
    // ä¿å­˜æŒ‰é’®
    editorHtml += '<button onclick="saveMemoryPalacePlacement(\'' + word + '\')" style="width:100%;padding:14px;background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);border:none;border-radius:12px;color:white;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.3);">ğŸ›ï¸ æ”¾å…¥è®°å¿†å®«æ®¿</button>';
    
    editorHtml += '</div></div>';
    
    overlayEl.innerHTML = editorHtml;
    document.body.appendChild(overlayEl);
    
    window._selectedLocation = existingPlacement ? existingPlacement.locationId : null;
}

// é€‰æ‹©å®«æ®¿ä½ç½®
function selectPalaceLocation(locId) {
    window._selectedLocation = locId;
    var grid = document.getElementById('locationGrid');
    if (grid) {
        var buttons = grid.querySelectorAll('[id^="locBtn_"]');
        buttons.forEach(function(btn) {
            var id = btn.id.replace('locBtn_', '');
            if (id === locId) {
                btn.style.background = '#e0e7ff';
                btn.style.borderColor = '#6366f1';
            } else {
                btn.style.background = '#f9fafb';
                btn.style.borderColor = '#e5e7eb';
            }
        });
    }
}

// ä¿å­˜è®°å¿†å®«æ®¿ä½ç½®
function saveMemoryPalacePlacement(word) {
    var imageDesc = document.getElementById('palaceImage').value.trim();
    
    if (!window._selectedLocation) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªä½ç½®ï¼');
        return;
    }
    if (!imageDesc) {
        alert('è¯·æè¿°è¿™ä¸ªç”»é¢ï¼');
        return;
    }
    
    addToMemoryPalace(word, window._selectedLocation, imageDesc);
    
    closeMemoryPalaceEditor();
    showMeaning();
    
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:16px 28px;border-radius:16px;font-size:18px;font-weight:700;z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.2);';
    toast.innerHTML = 'ğŸ›ï¸ å·²æ”¾å…¥è®°å¿†å®«æ®¿ï¼';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 1500);
}

// å…³é—­è®°å¿†å®«æ®¿ç¼–è¾‘å™¨
function closeMemoryPalaceEditor() {
    var overlay = document.getElementById('memoryPalaceOverlay');
    if (overlay) overlay.remove();
}

// V14.10: æ·»åŠ åŠ©è®°åŠ¨ç”»æ ·å¼
(function addMnemonicAnimationStyles() {
    if (document.getElementById('mnemonicAnimStyles')) return;
    var style = document.createElement('style');
    style.id = 'mnemonicAnimStyles';
    style.textContent = `
        @keyframes mnemonicFeedback {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .word-mnemonic-v14 {
            animation: mnemonicSlideIn 0.4s ease-out;
        }
        
        @keyframes mnemonicSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #customMnemonicOverlay, #memoryPalaceOverlay {
            animation: overlayFadeIn 0.3s ease-out;
        }
        
        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #customMnemonicOverlay > div, #memoryPalaceOverlay > div {
            animation: modalSlideUp 0.3s ease-out;
        }
        
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
})();

// å¯¼å‡ºæ–°åŠŸèƒ½
window.rateMnemonicEffectiveness = rateMnemonicEffectiveness;
window.showCustomMnemonicEditor = showCustomMnemonicEditor;
window.selectMnemonicType = selectMnemonicType;
window.selectEmotion = selectEmotion;
window.saveCustomMnemonicFromEditor = saveCustomMnemonicFromEditor;
window.closeCustomMnemonicEditor = closeCustomMnemonicEditor;
window.showMemoryPalaceEditor = showMemoryPalaceEditor;
window.selectPalaceLocation = selectPalaceLocation;
window.saveMemoryPalacePlacement = saveMemoryPalacePlacement;
window.closeMemoryPalaceEditor = closeMemoryPalaceEditor;
