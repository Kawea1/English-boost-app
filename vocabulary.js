// vocabulary.js - æ ¸å¿ƒè¯æ±‡æ¨¡å—ï¼ˆå¸¦ä¸­æ–‡é‡Šä¹‰ï¼‰
window.vocabularyData = [
    // GREæ ¸å¿ƒè¯æ±‡ (50è¯)
    { word: 'aberrant', phonetic: '/É™ËˆberÉ™nt/', meaningEn: 'departing from the accepted standard', meaningCn: 'å¼‚å¸¸çš„ï¼Œåç¦»æ­£é“çš„', example: 'His aberrant behavior worried his parents.' },
    { word: 'abstruse', phonetic: '/Ã¦bËˆstruËs/', meaningEn: 'difficult to understand', meaningCn: 'æ·±å¥¥çš„ï¼Œéš¾æ‡‚çš„', example: 'The professor made abstruse concepts accessible.' },
    { word: 'acerbic', phonetic: '/É™ËˆsÉœËrbÉªk/', meaningEn: 'sharp and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè¾›è¾£çš„', example: 'Her acerbic wit made her famous.' },
    { word: 'acumen', phonetic: '/É™ËˆkjuËmÉ™n/', meaningEn: 'keen insight', meaningCn: 'æ•é”ï¼Œèªæ˜', example: 'His business acumen led to success.' },
    { word: 'adamant', phonetic: '/ËˆÃ¦dÉ™mÉ™nt/', meaningEn: 'refusing to change', meaningCn: 'åšå®šä¸ç§»çš„', example: 'She was adamant about her decision.' },
    { word: 'admonish', phonetic: '/É™dËˆmÉ‘ËnÉªÊƒ/', meaningEn: 'warn or reprimand firmly', meaningCn: 'å‘Šè¯«ï¼Œè­¦å‘Š', example: 'The teacher admonished the students.' },
    { word: 'aesthetic', phonetic: '/esËˆÎ¸etÉªk/', meaningEn: 'relating to beauty', meaningCn: 'ç¾å­¦çš„ï¼Œå®¡ç¾çš„', example: 'The building has great aesthetic appeal.' },
    { word: 'affable', phonetic: '/ËˆÃ¦fÉ™bl/', meaningEn: 'friendly and easy to talk to', meaningCn: 'å’Œè”¼å¯äº²çš„', example: 'The affable host welcomed everyone.' },
    { word: 'alacrity', phonetic: '/É™ËˆlÃ¦krÉ™ti/', meaningEn: 'brisk eagerness', meaningCn: 'æ•æ·ï¼Œæ¬£ç„¶', example: 'She accepted the offer with alacrity.' },
    { word: 'alleviate', phonetic: '/É™ËˆliËvieÉªt/', meaningEn: 'make less severe', meaningCn: 'å‡è½»ï¼Œç¼“è§£', example: 'The medicine helped alleviate the pain.' },
    { word: 'amalgamate', phonetic: '/É™ËˆmÃ¦lÉ¡É™meÉªt/', meaningEn: 'combine or unite', meaningCn: 'åˆå¹¶ï¼Œæ··åˆ', example: 'The two companies amalgamated.' },
    { word: 'ambiguous', phonetic: '/Ã¦mËˆbÉªÉ¡juÉ™s/', meaningEn: 'unclear in meaning', meaningCn: 'æ¨¡ç³Šçš„ï¼Œæ­§ä¹‰çš„', example: 'The statement was deliberately ambiguous.' },
    { word: 'ameliorate', phonetic: '/É™ËˆmiËliÉ™reÉªt/', meaningEn: 'make better', meaningCn: 'æ”¹å–„ï¼Œæ”¹è¿›', example: 'Steps were taken to ameliorate conditions.' },
    { word: 'amenable', phonetic: '/É™ËˆmiËnÉ™bl/', meaningEn: 'willing to agree', meaningCn: 'é¡ºä»çš„ï¼Œæ„¿æ„æ¥å—çš„', example: 'He was amenable to suggestions.' },
    { word: 'anachronistic', phonetic: '/É™ËŒnÃ¦krÉ™ËˆnÉªstÉªk/', meaningEn: 'belonging to a different time', meaningCn: 'æ—¶ä»£é”™è¯¯çš„', example: 'The customs seemed anachronistic.' },
    { word: 'analogous', phonetic: '/É™ËˆnÃ¦lÉ™É¡É™s/', meaningEn: 'comparable in certain respects', meaningCn: 'ç±»ä¼¼çš„ï¼Œç›¸ä¼¼çš„', example: 'The situation is analogous to ours.' },
    { word: 'anomaly', phonetic: '/É™ËˆnÉ‘ËmÉ™li/', meaningEn: 'something unusual', meaningCn: 'å¼‚å¸¸ï¼Œåå¸¸ç°è±¡', example: 'The results revealed an anomaly.' },
    { word: 'antipathy', phonetic: '/Ã¦nËˆtÉªpÉ™Î¸i/', meaningEn: 'strong dislike', meaningCn: 'åæ„Ÿï¼ŒåŒæ¶', example: 'She felt antipathy toward him.' },
    { word: 'apathy', phonetic: '/ËˆÃ¦pÉ™Î¸i/', meaningEn: 'lack of interest', meaningCn: 'å†·æ¼ ï¼Œæ— åŠ¨äºè¡·', example: 'Voter apathy was widespread.' },
    { word: 'appease', phonetic: '/É™ËˆpiËz/', meaningEn: 'pacify by giving in', meaningCn: 'å¹³æ¯ï¼Œå®‰æŠš', example: 'They tried to appease the angry crowd.' },
    { word: 'arbitrary', phonetic: '/ËˆÉ‘ËrbÉªtreri/', meaningEn: 'based on random choice', meaningCn: 'ä»»æ„çš„ï¼Œæ­¦æ–­çš„', example: 'The decision seemed arbitrary.' },
    { word: 'archaic', phonetic: '/É‘ËrËˆkeÉªÉªk/', meaningEn: 'very old or outdated', meaningCn: 'å¤è€çš„ï¼Œè¿‡æ—¶çš„', example: 'The law is archaic and needs reform.' },
    { word: 'arduous', phonetic: '/ËˆÉ‘ËrdÊ’uÉ™s/', meaningEn: 'difficult and tiring', meaningCn: 'è‰°è‹¦çš„ï¼Œè´¹åŠ›çš„', example: 'The climb was arduous but rewarding.' },
    { word: 'articulate', phonetic: '/É‘ËrËˆtÉªkjÉ™lÉ™t/', meaningEn: 'express clearly', meaningCn: 'æ¸…æ¥šè¡¨è¾¾çš„ï¼Œå–„äºè¡¨è¾¾çš„', example: 'She is an articulate speaker.' },
    { word: 'ascetic', phonetic: '/É™ËˆsetÉªk/', meaningEn: 'practicing self-denial', meaningCn: 'è‹¦è¡Œçš„ï¼Œç¦æ¬²çš„', example: 'He lived an ascetic life.' },
    { word: 'assiduous', phonetic: '/É™ËˆsÉªdÊ’uÉ™s/', meaningEn: 'showing great care', meaningCn: 'å‹¤å‹‰çš„ï¼Œåˆ»è‹¦çš„', example: 'She was assiduous in her studies.' },
    { word: 'astute', phonetic: '/É™ËˆstuËt/', meaningEn: 'shrewd and perceptive', meaningCn: 'ç²¾æ˜çš„ï¼Œæ•é”çš„', example: 'An astute observer noticed the change.' },
    { word: 'audacious', phonetic: '/É”ËËˆdeÉªÊƒÉ™s/', meaningEn: 'bold and daring', meaningCn: 'å¤§èƒ†çš„ï¼Œæ— ç•çš„', example: 'It was an audacious plan.' },
    { word: 'austere', phonetic: '/É”ËËˆstÉªr/', meaningEn: 'severe or strict', meaningCn: 'ç®€æœ´çš„ï¼Œä¸¥å³»çš„', example: 'The room had an austere appearance.' },
    { word: 'avarice', phonetic: '/ËˆÃ¦vÉ™rÉªs/', meaningEn: 'extreme greed', meaningCn: 'è´ªå©ªï¼Œè´ªè´¢', example: 'His avarice knew no bounds.' },
    { word: 'banal', phonetic: '/bÉ™ËˆnÉ‘Ël/', meaningEn: 'lacking originality', meaningCn: 'å¹³åº¸çš„ï¼Œé™ˆè…çš„', example: 'The movie had a banal plot.' },
    { word: 'belligerent', phonetic: '/bÉ™ËˆlÉªdÊ’É™rÉ™nt/', meaningEn: 'hostile and aggressive', meaningCn: 'å¥½æˆ˜çš„ï¼ŒæŒ‘è¡…çš„', example: 'His belligerent attitude caused problems.' },
    { word: 'benevolent', phonetic: '/bÉ™ËˆnevÉ™lÉ™nt/', meaningEn: 'well-meaning and kind', meaningCn: 'ä»æ…ˆçš„ï¼Œå–„æ„çš„', example: 'A benevolent donor funded the project.' },
    { word: 'bolster', phonetic: '/ËˆboÊŠlstÉ™r/', meaningEn: 'support or strengthen', meaningCn: 'æ”¯æŒï¼ŒåŠ å¼º', example: 'Evidence bolstered his argument.' },
    { word: 'burgeon', phonetic: '/ËˆbÉœËrdÊ’É™n/', meaningEn: 'grow rapidly', meaningCn: 'è¿…é€Ÿå‘å±•ï¼ŒèŒèŠ½', example: 'The industry began to burgeon.' },
    { word: 'cacophony', phonetic: '/kÉ™ËˆkÉ‘ËfÉ™ni/', meaningEn: 'harsh mixture of sounds', meaningCn: 'åˆºè€³çš„å£°éŸ³ï¼Œä¸å’Œè°', example: 'A cacophony of car horns filled the air.' },
    { word: 'candid', phonetic: '/ËˆkÃ¦ndÉªd/', meaningEn: 'truthful and straightforward', meaningCn: 'å¦ç‡çš„ï¼Œç›´è¨€ä¸è®³çš„', example: 'She gave a candid assessment.' },
    { word: 'capricious', phonetic: '/kÉ™ËˆprÉªÊƒÉ™s/', meaningEn: 'unpredictable', meaningCn: 'åå¤æ— å¸¸çš„ï¼Œä»»æ€§çš„', example: 'The weather was capricious.' },
    { word: 'castigate', phonetic: '/ËˆkÃ¦stÉªÉ¡eÉªt/', meaningEn: 'criticize severely', meaningCn: 'ä¸¥å‰æ‰¹è¯„ï¼Œæƒ©ç½š', example: 'Critics castigated the decision.' },
    { word: 'catalyst', phonetic: '/ËˆkÃ¦tÉ™lÉªst/', meaningEn: 'agent that causes change', meaningCn: 'å‚¬åŒ–å‰‚ï¼Œä¿ƒè¿›å› ç´ ', example: 'The event was a catalyst for reform.' },
    { word: 'caustic', phonetic: '/ËˆkÉ”ËstÉªk/', meaningEn: 'sarcastic and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè…èš€æ€§çš„', example: 'His caustic remarks hurt her.' },
    { word: 'chicanery', phonetic: '/ÊƒÉªËˆkeÉªnÉ™ri/', meaningEn: 'trickery and deception', meaningCn: 'æ¬ºéª—ï¼Œè¯¡è®¡', example: 'Political chicanery undermined trust.' },
    { word: 'circumspect', phonetic: '/ËˆsÉœËrkÉ™mspekt/', meaningEn: 'cautious and prudent', meaningCn: 'è°¨æ…çš„ï¼Œå°å¿ƒçš„', example: 'Be circumspect in your decisions.' },
    { word: 'clandestine', phonetic: '/klÃ¦nËˆdestÉªn/', meaningEn: 'kept secret', meaningCn: 'ç§˜å¯†çš„ï¼Œæš—ä¸­çš„', example: 'They held clandestine meetings.' },
    { word: 'coalesce', phonetic: '/ËŒkoÊŠÉ™Ëˆles/', meaningEn: 'come together', meaningCn: 'è”åˆï¼Œåˆå¹¶', example: 'Different groups coalesced into one.' },
    { word: 'cogent', phonetic: '/ËˆkoÊŠdÊ’É™nt/', meaningEn: 'clear and convincing', meaningCn: 'æœ‰è¯´æœåŠ›çš„ï¼Œä»¤äººä¿¡æœçš„', example: 'She presented a cogent argument.' },
    { word: 'commensurate', phonetic: '/kÉ™ËˆmenÊƒÉ™rÉ™t/', meaningEn: 'corresponding in size', meaningCn: 'ç›¸ç§°çš„ï¼Œç›¸å½“çš„', example: 'Salary commensurate with experience.' },
    { word: 'compelling', phonetic: '/kÉ™mËˆpelÉªÅ‹/', meaningEn: 'powerfully convincing', meaningCn: 'ä»¤äººä¿¡æœçš„ï¼Œå¼•äººæ³¨ç›®çš„', example: 'The evidence was compelling.' },
    { word: 'complacent', phonetic: '/kÉ™mËˆpleÉªsnt/', meaningEn: 'self-satisfied', meaningCn: 'è‡ªæ»¡çš„ï¼Œå¾—æ„çš„', example: 'Success made him complacent.' },
    { word: 'comprehensive', phonetic: '/ËŒkÉ‘ËmprÉªËˆhensÉªv/', meaningEn: 'complete and thorough', meaningCn: 'å…¨é¢çš„ï¼Œç»¼åˆçš„', example: 'A comprehensive study was conducted.' }
];

// å½“å‰å­¦ä¹ çŠ¶æ€
var currentWordIndex = 0;
var wordsPerSession = parseInt(localStorage.getItem('wordsPerSession') || '20'); // æ¯æ¬¡å­¦ä¹ å•è¯æ•°
var sessionWords = []; // æœ¬æ¬¡å­¦ä¹ çš„å•è¯
var learnedWords = [];
var wordRatings = {};

try {
    learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
    wordRatings = JSON.parse(localStorage.getItem('wordRatings') || '{}');
} catch(e) {
    learnedWords = [];
    wordRatings = {};
}

// åˆå§‹åŒ–è¯æ±‡æ¨¡å—
function initVocabulary() {
    // æ˜¾ç¤ºè®¾ç½®é¢æ¿
    showVocabSettings();
    // åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
    // speakWordå·²åœ¨showCurrentWordä¸­è°ƒç”¨ï¼Œæ— éœ€é‡å¤
}

// æ˜¾ç¤ºå•è¯æ•°é‡è®¾ç½®
function showVocabSettings() {
    var settingsEl = document.getElementById('vocabSettings');
    if (!settingsEl) {
        // åœ¨è¯æ±‡æ¨¡å—é¡¶éƒ¨æ·»åŠ è®¾ç½®
        var modalHeader = document.querySelector('#vocabularyModal .modal-header');
        if (modalHeader) {
            var settingsDiv = document.createElement('div');
            settingsDiv.id = 'vocabSettings';
            settingsDiv.style.cssText = 'padding:12px 20px;background:linear-gradient(180deg,#f8f7ff 0%,#f1f5f9 100%);display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(99,102,241,0.1);';
            settingsDiv.innerHTML = '<span style="color:#374151;font-weight:600;">ğŸ“š æ¯æ¬¡å­¦ä¹ :</span>' +
                '<select id="wordsPerSessionSelect" onchange="changeWordsPerSession(this.value)" style="padding:8px 16px;border-radius:10px;border:2px solid #6366f1;background:white;color:#1e1b4b;font-weight:600;cursor:pointer;outline:none;">' +
                '<option value="10"' + (wordsPerSession === 10 ? ' selected' : '') + '>10ä¸ª</option>' +
                '<option value="20"' + (wordsPerSession === 20 ? ' selected' : '') + '>20ä¸ª</option>' +
                '<option value="30"' + (wordsPerSession === 30 ? ' selected' : '') + '>30ä¸ª</option>' +
                '<option value="50"' + (wordsPerSession === 50 ? ' selected' : '') + '>50ä¸ª</option>' +
                '<option value="100"' + (wordsPerSession === 100 ? ' selected' : '') + '>100ä¸ª</option>' +
                '</select>' +
                '<span style="color:#6b7280;font-size:13px;">ï¼ˆé€‰æ‹©åè‡ªåŠ¨åˆ·æ–°ï¼‰</span>';
            modalHeader.after(settingsDiv);
        }
    }
}

// åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
function initSessionWords() {
    currentWordIndex = 0;
    sessionWords = [];
    
    if (!window.vocabularyData || window.vocabularyData.length === 0) return;
    
    // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å•è¯
    var allIndices = [];
    for (var i = 0; i < window.vocabularyData.length; i++) {
        allIndices.push(i);
    }
    
    // æ‰“ä¹±é¡ºåº
    for (var j = allIndices.length - 1; j > 0; j--) {
        var k = Math.floor(Math.random() * (j + 1));
        var temp = allIndices[j];
        allIndices[j] = allIndices[k];
        allIndices[k] = temp;
    }
    
    // å–å‰Nä¸ª
    var count = Math.min(wordsPerSession, allIndices.length);
    for (var m = 0; m < count; m++) {
        sessionWords.push(window.vocabularyData[allIndices[m]]);
    }
}

// ä¿®æ”¹æ¯æ¬¡å­¦ä¹ å•è¯æ•°
function changeWordsPerSession(value) {
    wordsPerSession = parseInt(value);
    localStorage.setItem('wordsPerSession', wordsPerSession.toString());
    
    // è‡ªåŠ¨åˆ·æ–°ï¼Œé‡æ–°å¼€å§‹å­¦ä¹ 
    currentWordIndex = 0;
    initSessionWords();
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    updateVocabProgress();
    showCurrentWord();
}

function updateVocabProgress() {
    var progress = document.getElementById('vocabProgress');
    if (progress) {
        progress.textContent = (currentWordIndex + 1) + '/' + sessionWords.length;
    }
}

function showCurrentWord() {
    if (!sessionWords || sessionWords.length === 0) {
        initSessionWords();
    }
    if (!sessionWords || sessionWords.length === 0) return;
    
    var wordData = sessionWords[currentWordIndex];
    if (!wordData) return;
    
    document.getElementById('wordMain').textContent = wordData.word;
    document.getElementById('wordPhonetic').textContent = wordData.phonetic || '';
    
    // éšè—é‡Šä¹‰åŒºåŸŸ
    document.getElementById('wordMeaning').classList.add('hidden');
    document.getElementById('rateButtons').classList.add('hidden');
    document.getElementById('showMeaningBtn').classList.remove('hidden');
    
    updateVocabProgress();
    
    // è‡ªåŠ¨æœ—è¯»æ–°å•è¯
    speakWord();
}

function showMeaning() {
    var wordData = sessionWords[currentWordIndex];
    if (!wordData) return;
    
    // æŸ¥è¯¢å­—å…¸æ•°æ®
    var dictData = null;
    if (typeof queryDictionary === 'function') {
        dictData = queryDictionary(wordData.word);
    }
    
    // æ„å»ºé‡Šä¹‰HTMLï¼ˆä¸­è‹±æ–‡åŒè¯­ï¼‰
    var meaningHtml = '';
    
    // å¦‚æœæœ‰å­—å…¸æ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (dictData) {
        meaningHtml += '<div class="dict-container" style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:10px;">';
        if (dictData.definitions && dictData.definitions.length > 0) {
            meaningHtml += '<div style="font-weight:600;margin-bottom:8px;">ğŸ“š è¯å…¸é‡Šä¹‰</div>';
            dictData.definitions.slice(0, 3).forEach(function(def, idx) {
                meaningHtml += '<div style="margin-bottom:6px;font-size:14px;color:#555;">â€¢ ' + def + '</div>';
            });
        }
        meaningHtml += '</div>';
    }
    
    meaningHtml += '<div class="meaning-cn" style="font-size:20px;color:#333;margin-bottom:10px;font-weight:600;">ğŸ“– ' + (wordData.meaningCn || 'æš‚æ— ä¸­æ–‡é‡Šä¹‰') + '</div>';
    meaningHtml += '<div class="meaning-en" style="color:#666;font-size:15px;margin-bottom:15px;">ğŸ“ ' + (wordData.meaningEn || wordData.meaning || '') + '</div>';
    
    if (wordData.example) {
        meaningHtml += '<div class="word-example" style="color:#888;font-size:14px;font-style:italic;padding-top:15px;border-top:1px solid #e0e0e0;">ğŸ’¬ ' + wordData.example + '</div>';
    }
    
    document.getElementById('meaningCn').innerHTML = meaningHtml;
    document.getElementById('meaningEn').innerHTML = '';
    document.getElementById('wordExample').innerHTML = '';
    
    document.getElementById('wordMeaning').classList.remove('hidden');
    document.getElementById('showMeaningBtn').classList.add('hidden');
    document.getElementById('rateButtons').classList.remove('hidden');
}

function rateWord(rating) {
    var wordData = sessionWords[currentWordIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // è®¡ç®—å¤ä¹ é—´éš”ï¼ˆè‰¾å®¾æµ©æ–¯æ›²çº¿ï¼‰
    var interval = 1; // é»˜è®¤1å¤©åå¤ä¹ 
    if (rating === 'easy') {
        interval = 7; // ç®€å•ï¼š7å¤©
    } else if (rating === 'medium') {
        interval = 3; // ä¸€èˆ¬ï¼š3å¤©
    } else if (rating === 'hard') {
        interval = 1; // å›°éš¾ï¼š1å¤©
    }
    
    // ä¿å­˜è¯„åˆ†
    var prevCount = wordRatings[word] ? wordRatings[word].count : 0;
    wordRatings[word] = {
        rating: rating,
        lastReview: new Date().toISOString(),
        count: prevCount + 1,
        interval: interval
    };
    localStorage.setItem('wordRatings', JSON.stringify(wordRatings));
    
    // è®°å½•å·²å­¦å•è¯
    if (learnedWords.indexOf(word) === -1) {
        learnedWords.push(word);
        localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
        localStorage.setItem('learnedCount', learnedWords.length.toString());
        
        // æ›´æ–°ä»Šæ—¥ç›®æ ‡è¿›åº¦
        if (typeof updateDailyProgress === 'function') {
            updateDailyProgress('vocabulary', 1);
        }
    }
    
    // å¦‚æœè¯„åˆ†ä¸ºç®€å•ï¼Œæ ‡è®°ä¸ºå·²æŒæ¡
    if (rating === 'easy') {
        var mastered = parseInt(localStorage.getItem('masteredCount') || '0');
        localStorage.setItem('masteredCount', (mastered + 1).toString());
    }
    
    // ä¸‹ä¸€ä¸ªè¯
    nextWord();
}

function nextWord() {
    if (currentWordIndex < sessionWords.length - 1) {
        currentWordIndex++;
        showCurrentWord();
    } else {
        // å­¦å®Œæœ¬ç»„ï¼Œæ˜¾ç¤ºæ€»ç»“é¡µé¢
        showSessionSummary();
    }
}

// æ˜¾ç¤ºæœ¬è½®å­¦ä¹ æ€»ç»“
function showSessionSummary() {
    var wordCard = document.getElementById('wordCard');
    var rateButtons = document.getElementById('rateButtons');
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    var vocabProgress = document.getElementById('vocabProgress');
    
    if (rateButtons) rateButtons.classList.add('hidden');
    if (showMeaningBtn) showMeaningBtn.classList.add('hidden');
    
    // æ„å»ºæ€»ç»“HTML
    var summaryHtml = '<div style="padding:20px;">';
    summaryHtml += '<div style="text-align:center;margin-bottom:24px;">';
    summaryHtml += '<div style="font-size:60px;margin-bottom:12px;">ğŸ‰</div>';
    summaryHtml += '<h2 style="margin:0;color:#1e1b4b;font-size:24px;font-weight:800;">æœ¬è½®å­¦ä¹ å®Œæˆï¼</h2>';
    summaryHtml += '<p style="color:#6b7280;margin-top:8px;">å…±å­¦ä¹  ' + sessionWords.length + ' ä¸ªå•è¯</p>';
    summaryHtml += '</div>';
    
    summaryHtml += '<div style="max-height:400px;overflow-y:auto;">';
    
    sessionWords.forEach(function(wordData, index) {
        var rating = wordRatings[wordData.word] ? wordRatings[wordData.word].rating : 'medium';
        var ratingEmoji = rating === 'easy' ? 'ğŸ˜Š' : (rating === 'hard' ? 'ğŸ˜°' : 'ğŸ¤”');
        var ratingColor = rating === 'easy' ? '#10b981' : (rating === 'hard' ? '#ef4444' : '#f59e0b');
        
        summaryHtml += '<div style="background:linear-gradient(180deg,#f8f7ff 0%,#f1f5f9 100%);border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.1);">';
        summaryHtml += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">';
        summaryHtml += '<div style="display:flex;align-items:center;gap:10px;">';
        summaryHtml += '<span style="background:linear-gradient(135deg,#6366f1,#a855f7);color:white;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;">' + (index + 1) + '</span>';
        summaryHtml += '<span style="font-size:18px;font-weight:700;color:#1e1b4b;">' + wordData.word + '</span>';
        summaryHtml += '<span style="font-size:12px;color:#6b7280;">' + (wordData.phonetic || '') + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<span style="font-size:20px;">' + ratingEmoji + '</span>';
        summaryHtml += '</div>';
        summaryHtml += '<div style="font-size:16px;color:#374151;font-weight:600;margin-bottom:6px;">ğŸ“– ' + (wordData.meaningCn || '') + '</div>';
        summaryHtml += '<div style="font-size:14px;color:#6b7280;margin-bottom:6px;">ğŸ“ ' + (wordData.meaningEn || wordData.meaning || '') + '</div>';
        if (wordData.example) {
            summaryHtml += '<div style="font-size:13px;color:#9ca3af;font-style:italic;">ğŸ’¬ ' + wordData.example + '</div>';
        }
        summaryHtml += '</div>';
    });
    
    summaryHtml += '</div>';
    
    summaryHtml += '<div style="display:flex;gap:12px;margin-top:20px;">';
    summaryHtml += '<button onclick="restartSession()" style="flex:1;padding:16px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#a855f7 100%);color:white;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 6px 25px rgba(99,102,241,0.35);">ğŸ”„ ç»§ç»­å­¦ä¹ </button>';
    summaryHtml += '<button onclick="closeModule()" style="flex:1;padding:16px;background:white;color:#6366f1;border:2px solid #6366f1;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;">âœ“ å®Œæˆ</button>';
    summaryHtml += '</div>';
    summaryHtml += '</div>';
    
    if (wordCard) {
        wordCard.innerHTML = summaryHtml;
    }
    
    // æ›´æ–°ç»Ÿè®¡
    var statWords = document.getElementById('stat_words');
    if (statWords) statWords.textContent = learnedWords.length;
}

// é‡æ–°å¼€å§‹å­¦ä¹ 
function restartSession() {
    currentWordIndex = 0;
    
    // æ¢å¤åŸå§‹è¯å¡ç»“æ„ï¼ˆåªæ¢å¤wordCardå†…éƒ¨çš„å†…å®¹ï¼Œä¸åŒ…æ‹¬æŒ‰é’®ï¼‰
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.innerHTML = '<div class="word-main" id="wordMain">Loading...</div>' +
            '<div class="word-phonetic" id="wordPhonetic">/ËˆlÉ™ÊŠdÉªÅ‹/</div>' +
            '<div class="word-meaning hidden" id="wordMeaning">' +
            '<div id="dictContainer"></div>' +
            '<div class="meaning-cn" id="meaningCn"></div>' +
            '<div class="meaning-en" id="meaningEn"></div>' +
            '<div class="word-example" id="wordExample"></div>' +
            '</div>';
    }
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    // é‡æ–°åˆå§‹åŒ–å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
}

function prevWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
    } else {
        currentWordIndex = sessionWords.length - 1;
    }
    showCurrentWord();
}

// é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
var cachedVoices = [];
var preferredVoice = null;

if ('speechSynthesis' in window) {
    cachedVoices = speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = function() {
        cachedVoices = speechSynthesis.getVoices();
        preferredVoice = selectBestUSVoice(cachedVoices);
        console.log('å¯ç”¨è¯­éŸ³:', cachedVoices.map(v => v.name + ' (' + v.lang + ')'));
        console.log('å·²é€‰æ‹©è¯­éŸ³:', preferredVoice ? preferredVoice.name : 'é»˜è®¤');
    };
}

// é€‰æ‹©æœ€ä½³ç¾å¼è‹±è¯­è¯­éŸ³
function selectBestUSVoice(voices) {
    if (!voices || voices.length === 0) return null;
    
    // macOS ä¸Šä¼˜è´¨ç¾å¼è‹±è¯­è¯­éŸ³ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    var preferredNames = [
        // macOS é«˜è´¨é‡ç¾å¼è¯­éŸ³
        'Samantha',           // ç¾å¼å¥³å£° - éå¸¸è‡ªç„¶
        'Alex',               // ç¾å¼ç”·å£° - éå¸¸è‡ªç„¶
        'Allison',            // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Ava',                // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Susan',              // ç¾å¼å¥³å£°
        'Tom',                // ç¾å¼ç”·å£°
        'Zoe',                // ç¾å¼å¥³å£°
        // iOS è¯­éŸ³
        'Samantha (Enhanced)',
        'Alex (Enhanced)',
        // Chrome/Edge è¯­éŸ³
        'Google US English',
        'Microsoft Zira',
        'Microsoft David',
    ];
    
    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾
    for (var i = 0; i < preferredNames.length; i++) {
        var voice = voices.find(function(v) {
            return v.name.includes(preferredNames[i]) && 
                   (v.lang === 'en-US' || v.lang.startsWith('en-US'));
        });
        if (voice) return voice;
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼ŒæŸ¥æ‰¾ä»»ä½•ç¾å¼è‹±è¯­è¯­éŸ³
    var usVoice = voices.find(function(v) {
        return v.lang === 'en-US' || v.lang.startsWith('en-US');
    });
    if (usVoice) return usVoice;
    
    // æœ€åé™çº§åˆ°ä»»ä½•è‹±è¯­è¯­éŸ³
    return voices.find(function(v) {
        return v.lang.startsWith('en');
    });
}

// ç¾å¼å‘éŸ³ - ä½¿ç”¨æµè§ˆå™¨å†…ç½®TTS
function speakWord() {
    var wordEl = document.getElementById('wordMain');
    var word = wordEl ? wordEl.textContent : '';
    if (!word) return;
    
    speakText(word);
}

// é€šç”¨è¯­éŸ³æ’­æ”¾å‡½æ•°
function speakText(text) {
    if (!('speechSynthesis' in window)) {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
        return;
    }
    
    // å–æ¶ˆæ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    speechSynthesis.cancel();
    
    // åˆ›å»ºè¯­éŸ³å¯¹è±¡
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.85;  // ç¨å¾®æ”¾æ…¢ï¼Œæ›´æ¸…æ™°
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // é€‰æ‹©æœ€ä½³è¯­éŸ³
    var voices = cachedVoices.length > 0 ? cachedVoices : speechSynthesis.getVoices();
    var voice = preferredVoice || selectBestUSVoice(voices);
    
    if (voice) {
        utterance.voice = voice;
        console.log('ä½¿ç”¨è¯­éŸ³:', voice.name);
    }
    
    // æ’­æ”¾
    speechSynthesis.speak(utterance);
}

// ä¿ç•™æ—§å‡½æ•°åå…¼å®¹
function speakWordTTS(word) {
    speakText(word);
}

function setVoiceAndSpeak(utterance, voices) {
    speechSynthesis.speak(utterance);
}

window.initVocabulary = initVocabulary;
window.showMeaning = showMeaning;
window.rateWord = rateWord;
window.speakWord = speakWord;
window.nextWord = nextWord;
window.prevWord = prevWord;
window.changeWordsPerSession = changeWordsPerSession;
window.initSessionWords = initSessionWords;
window.restartSession = restartSession;
window.showSessionSummary = showSessionSummary;
