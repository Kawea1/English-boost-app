// vocabulary.js - æ ¸å¿ƒè¯æ±‡æ¨¡å—ï¼ˆå¸¦ä¸­æ–‡é‡Šä¹‰ï¼‰
window.vocabularyData = [
    // GREæ ¸å¿ƒè¯æ±‡ (50è¯)
    { word: 'aberrant', phonetic: '/É™ËˆberÉ™nt/', meaningEn: 'departing from the accepted standard', meaningCn: 'å¼‚å¸¸çš„ï¼Œåç¦»æ­£é“çš„', example: 'His aberrant behavior worried his parents.' },
    { word: 'abstruse', phonetic: '/Ã¦bËˆstruËs/', meaningEn: 'difficult to understand', meaningCn: 'æ·±å¥¥çš„ï¼Œéš¾æ‡‚çš„', example: 'The professor made abstruse concepts accessible.' },
    { word: 'acerbic', phonetic: '/É™ËˆsÉœËrbÉªk/', meaningEn: 'sharp and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè¾›è¾£çš„', example: 'Her acerbic wit made her famous.' },
    { word: 'acumen', phonetic: '/É™ËˆkjuËmÉ™n/', meaningEn: 'keen insight', meaningCn: 'æ•é”ï¼Œèªæ˜', example: 'His business acumen led to success.' },
    { word: 'adamant', phonetic: '/ËˆÃ¦dÉ™mÉ™nt/', meaningEn: 'refusing to change', meaningCn: 'åšå®šä¸ç§»çš„', example: 'She was adamant about her decision.' },
    { word: 'admonish', phonetic: '/É™dËˆmÉ‘ËnÉªÊƒ/', meaningEn: 'warn or reprimand firmly', meaningCn: 'å‘Šè¯«ï¼Œè­¦å‘Š', example: 'The teacher admonished the students.' },
    { word: 'aesthetic', phonetic: '/esËˆÎ¸etÉªk/', meaningEn: 'relating to beauty', meaningCn: 'ç¾å­¦çš„ï¼Œå®¡ç¾çš„', example: 'The building has great aesthetic appeal.' },
    { word: 'affable', phonetic: '/ËˆÃ¦fÉ™bl/', meaningEn: 'friendly and easy to talk to', meaningCn: 'å’Œè”¼å¯äº²çš„', example: 'The affable host welcomed everyone.' },
    { word: 'alacrity', phonetic: '/É™ËˆlÃ¦krÉ™ti/', meaningEn: 'brisk eagerness', meaningCn: 'æ•æ·ï¼Œæ¬£ç„¶', example: 'She accepted the offer with alacrity.' },
    { word: 'alleviate', phonetic: '/É™ËˆliËvieÉªt/', meaningEn: 'make less severe', meaningCn: 'å‡è½»ï¼Œç¼“è§£', example: 'The medicine helped alleviate the pain.' },
    { word: 'amalgamate', phonetic: '/É™ËˆmÃ¦lÉ¡É™meÉªt/', meaningEn: 'combine or unite', meaningCn: 'åˆå¹¶ï¼Œæ··åˆ', example: 'The two companies amalgamated.' },
    { word: 'ambiguous', phonetic: '/Ã¦mËˆbÉªÉ¡juÉ™s/', meaningEn: 'unclear in meaning', meaningCn: 'æ¨¡ç³Šçš„ï¼Œæ­§ä¹‰çš„', example: 'The statement was deliberately ambiguous.' },
    { word: 'ameliorate', phonetic: '/É™ËˆmiËliÉ™reÉªt/', meaningEn: 'make better', meaningCn: 'æ”¹å–„ï¼Œæ”¹è¿›', example: 'Steps were taken to ameliorate conditions.' },
    { word: 'amenable', phonetic: '/É™ËˆmiËnÉ™bl/', meaningEn: 'willing to agree', meaningCn: 'é¡ºä»çš„ï¼Œæ„¿æ„æ¥å—çš„', example: 'He was amenable to suggestions.' },
    { word: 'anachronistic', phonetic: '/É™ËŒnÃ¦krÉ™ËˆnÉªstÉªk/', meaningEn: 'belonging to a different time', meaningCn: 'æ—¶ä»£é”™è¯¯çš„', example: 'The customs seemed anachronistic.' },
    { word: 'analogous', phonetic: '/É™ËˆnÃ¦lÉ™É¡É™s/', meaningEn: 'comparable in certain respects', meaningCn: 'ç±»ä¼¼çš„ï¼Œç›¸ä¼¼çš„', example: 'The situation is analogous to ours.' },
    { word: 'anomaly', phonetic: '/É™ËˆnÉ‘ËmÉ™li/', meaningEn: 'something unusual', meaningCn: 'å¼‚å¸¸ï¼Œåå¸¸ç°è±¡', example: 'The results revealed an anomaly.' },
    { word: 'antipathy', phonetic: '/Ã¦nËˆtÉªpÉ™Î¸i/', meaningEn: 'strong dislike', meaningCn: 'åæ„Ÿï¼ŒåŒæ¶', example: 'She felt antipathy toward him.' },
    { word: 'apathy', phonetic: '/ËˆÃ¦pÉ™Î¸i/', meaningEn: 'lack of interest', meaningCn: 'å†·æ¼ ï¼Œæ— åŠ¨äºè¡·', example: 'Voter apathy was widespread.' },
    { word: 'appease', phonetic: '/É™ËˆpiËz/', meaningEn: 'pacify by giving in', meaningCn: 'å¹³æ¯ï¼Œå®‰æŠš', example: 'They tried to appease the angry crowd.' },
    { word: 'arbitrary', phonetic: '/ËˆÉ‘ËrbÉªtreri/', meaningEn: 'based on random choice', meaningCn: 'ä»»æ„çš„ï¼Œæ­¦æ–­çš„', example: 'The decision seemed arbitrary.' },
    { word: 'archaic', phonetic: '/É‘ËrËˆkeÉªÉªk/', meaningEn: 'very old or outdated', meaningCn: 'å¤è€çš„ï¼Œè¿‡æ—¶çš„', example: 'The law is archaic and needs reform.' },
    { word: 'arduous', phonetic: '/ËˆÉ‘ËrdÊ’uÉ™s/', meaningEn: 'difficult and tiring', meaningCn: 'è‰°è‹¦çš„ï¼Œè´¹åŠ›çš„', example: 'The climb was arduous but rewarding.' },
    { word: 'articulate', phonetic: '/É‘ËrËˆtÉªkjÉ™lÉ™t/', meaningEn: 'express clearly', meaningCn: 'æ¸…æ¥šè¡¨è¾¾çš„ï¼Œå–„äºè¡¨è¾¾çš„', example: 'She is an articulate speaker.' },
    { word: 'ascetic', phonetic: '/É™ËˆsetÉªk/', meaningEn: 'practicing self-denial', meaningCn: 'è‹¦è¡Œçš„ï¼Œç¦æ¬²çš„', example: 'He lived an ascetic life.' },
    { word: 'assiduous', phonetic: '/É™ËˆsÉªdÊ’uÉ™s/', meaningEn: 'showing great care', meaningCn: 'å‹¤å‹‰çš„ï¼Œåˆ»è‹¦çš„', example: 'She was assiduous in her studies.' },
    { word: 'astute', phonetic: '/É™ËˆstuËt/', meaningEn: 'shrewd and perceptive', meaningCn: 'ç²¾æ˜çš„ï¼Œæ•é”çš„', example: 'An astute observer noticed the change.' },
    { word: 'audacious', phonetic: '/É”ËËˆdeÉªÊƒÉ™s/', meaningEn: 'bold and daring', meaningCn: 'å¤§èƒ†çš„ï¼Œæ— ç•çš„', example: 'It was an audacious plan.' },
    { word: 'austere', phonetic: '/É”ËËˆstÉªr/', meaningEn: 'severe or strict', meaningCn: 'ç®€æœ´çš„ï¼Œä¸¥å³»çš„', example: 'The room had an austere appearance.' },
    { word: 'avarice', phonetic: '/ËˆÃ¦vÉ™rÉªs/', meaningEn: 'extreme greed', meaningCn: 'è´ªå©ªï¼Œè´ªè´¢', example: 'His avarice knew no bounds.' },
    { word: 'banal', phonetic: '/bÉ™ËˆnÉ‘Ël/', meaningEn: 'lacking originality', meaningCn: 'å¹³åº¸çš„ï¼Œé™ˆè…çš„', example: 'The movie had a banal plot.' },
    { word: 'belligerent', phonetic: '/bÉ™ËˆlÉªdÊ’É™rÉ™nt/', meaningEn: 'hostile and aggressive', meaningCn: 'å¥½æˆ˜çš„ï¼ŒæŒ‘è¡…çš„', example: 'His belligerent attitude caused problems.' },
    { word: 'benevolent', phonetic: '/bÉ™ËˆnevÉ™lÉ™nt/', meaningEn: 'well-meaning and kind', meaningCn: 'ä»æ…ˆçš„ï¼Œå–„æ„çš„', example: 'A benevolent donor funded the project.' },
    { word: 'bolster', phonetic: '/ËˆboÊŠlstÉ™r/', meaningEn: 'support or strengthen', meaningCn: 'æ”¯æŒï¼ŒåŠ å¼º', example: 'Evidence bolstered his argument.' },
    { word: 'burgeon', phonetic: '/ËˆbÉœËrdÊ’É™n/', meaningEn: 'grow rapidly', meaningCn: 'è¿…é€Ÿå‘å±•ï¼ŒèŒèŠ½', example: 'The industry began to burgeon.' },
    { word: 'cacophony', phonetic: '/kÉ™ËˆkÉ‘ËfÉ™ni/', meaningEn: 'harsh mixture of sounds', meaningCn: 'åˆºè€³çš„å£°éŸ³ï¼Œä¸å’Œè°', example: 'A cacophony of car horns filled the air.' },
    { word: 'candid', phonetic: '/ËˆkÃ¦ndÉªd/', meaningEn: 'truthful and straightforward', meaningCn: 'å¦ç‡çš„ï¼Œç›´è¨€ä¸è®³çš„', example: 'She gave a candid assessment.' },
    { word: 'capricious', phonetic: '/kÉ™ËˆprÉªÊƒÉ™s/', meaningEn: 'unpredictable', meaningCn: 'åå¤æ— å¸¸çš„ï¼Œä»»æ€§çš„', example: 'The weather was capricious.' },
    { word: 'castigate', phonetic: '/ËˆkÃ¦stÉªÉ¡eÉªt/', meaningEn: 'criticize severely', meaningCn: 'ä¸¥å‰æ‰¹è¯„ï¼Œæƒ©ç½š', example: 'Critics castigated the decision.' },
    { word: 'catalyst', phonetic: '/ËˆkÃ¦tÉ™lÉªst/', meaningEn: 'agent that causes change', meaningCn: 'å‚¬åŒ–å‰‚ï¼Œä¿ƒè¿›å› ç´ ', example: 'The event was a catalyst for reform.' },
    { word: 'caustic', phonetic: '/ËˆkÉ”ËstÉªk/', meaningEn: 'sarcastic and critical', meaningCn: 'å°–åˆ»çš„ï¼Œè…èš€æ€§çš„', example: 'His caustic remarks hurt her.' },
    { word: 'chicanery', phonetic: '/ÊƒÉªËˆkeÉªnÉ™ri/', meaningEn: 'trickery and deception', meaningCn: 'æ¬ºéª—ï¼Œè¯¡è®¡', example: 'Political chicanery undermined trust.' },
    { word: 'circumspect', phonetic: '/ËˆsÉœËrkÉ™mspekt/', meaningEn: 'cautious and prudent', meaningCn: 'è°¨æ…çš„ï¼Œå°å¿ƒçš„', example: 'Be circumspect in your decisions.' },
    { word: 'clandestine', phonetic: '/klÃ¦nËˆdestÉªn/', meaningEn: 'kept secret', meaningCn: 'ç§˜å¯†çš„ï¼Œæš—ä¸­çš„', example: 'They held clandestine meetings.' },
    { word: 'coalesce', phonetic: '/ËŒkoÊŠÉ™Ëˆles/', meaningEn: 'come together', meaningCn: 'è”åˆï¼Œåˆå¹¶', example: 'Different groups coalesced into one.' },
    { word: 'cogent', phonetic: '/ËˆkoÊŠdÊ’É™nt/', meaningEn: 'clear and convincing', meaningCn: 'æœ‰è¯´æœåŠ›çš„ï¼Œä»¤äººä¿¡æœçš„', example: 'She presented a cogent argument.' },
    { word: 'commensurate', phonetic: '/kÉ™ËˆmenÊƒÉ™rÉ™t/', meaningEn: 'corresponding in size', meaningCn: 'ç›¸ç§°çš„ï¼Œç›¸å½“çš„', example: 'Salary commensurate with experience.' },
    { word: 'compelling', phonetic: '/kÉ™mËˆpelÉªÅ‹/', meaningEn: 'powerfully convincing', meaningCn: 'ä»¤äººä¿¡æœçš„ï¼Œå¼•äººæ³¨ç›®çš„', example: 'The evidence was compelling.' },
    { word: 'complacent', phonetic: '/kÉ™mËˆpleÉªsnt/', meaningEn: 'self-satisfied', meaningCn: 'è‡ªæ»¡çš„ï¼Œå¾—æ„çš„', example: 'Success made him complacent.' },
    { word: 'comprehensive', phonetic: '/ËŒkÉ‘ËmprÉªËˆhensÉªv/', meaningEn: 'complete and thorough', meaningCn: 'å…¨é¢çš„ï¼Œç»¼åˆçš„', example: 'A comprehensive study was conducted.' }
];

// å½“å‰å­¦ä¹ çŠ¶æ€
var currentWordIndex = 0;
var wordsPerSession = parseInt(localStorage.getItem('wordsPerSession') || '20'); // æ¯æ¬¡å­¦ä¹ å•è¯æ•°
var requiredLearningTimes = parseInt(localStorage.getItem('requiredLearningTimes') || '3'); // æ¯ä¸ªå•è¯éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
var sessionWords = []; // æœ¬æ¬¡å­¦ä¹ çš„å•è¯ï¼ˆåŸå§‹åˆ—è¡¨ï¼‰
var learningQueue = []; // å­¦ä¹ é˜Ÿåˆ—ï¼ˆåŒ…å«é‡å¤å‡ºç°çš„å•è¯ï¼‰
var currentQueueIndex = 0; // å½“å‰é˜Ÿåˆ—ç´¢å¼•
var learnedWords = [];
var wordRatings = {};
var wordLearningProgress = {}; // è®°å½•æ¯ä¸ªå•è¯çš„å­¦ä¹ è¿›åº¦
var sessionWordProgress = {}; // æœ¬è½®å­¦ä¹ ä¸­æ¯ä¸ªå•è¯çš„è¿›åº¦ï¼ˆç”¨äºé—´éš”é‡å¤ï¼‰

try {
    learnedWords = JSON.parse(localStorage.getItem('learnedWords') || '[]');
    wordRatings = JSON.parse(localStorage.getItem('wordRatings') || '{}');
    wordLearningProgress = JSON.parse(localStorage.getItem('wordLearningProgress') || '{}');
} catch(e) {
    learnedWords = [];
    wordRatings = {};
    wordLearningProgress = {};
}

// åˆå§‹åŒ–è¯æ±‡æ¨¡å—
function initVocabulary() {
    // æ˜¾ç¤ºè®¾ç½®é¢æ¿
    showVocabSettings();
    // åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
    // speakWordå·²åœ¨showCurrentWordä¸­è°ƒç”¨ï¼Œæ— éœ€é‡å¤
}

// æ˜¾ç¤ºå•è¯æ•°é‡è®¾ç½®
function showVocabSettings() {
    var settingsEl = document.getElementById('vocabSettings');
    if (!settingsEl) {
        // åœ¨è¯æ±‡æ¨¡å—é¡¶éƒ¨æ·»åŠ è®¾ç½®
        var modalHeader = document.querySelector('#vocabularyModal .modal-header');
        if (modalHeader) {
            var settingsDiv = document.createElement('div');
            settingsDiv.id = 'vocabSettings';
            settingsDiv.className = 'vocab-settings-panel';
            settingsDiv.innerHTML = 
                '<div class="settings-row">' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">âœ¦</span> æ¯æ¬¡å­¦ä¹ </span>' +
                        '<select id="wordsPerSessionSelect" onchange="changeWordsPerSession(this.value)" class="setting-select">' +
                            '<option value="10"' + (wordsPerSession === 10 ? ' selected' : '') + '>10ä¸ª</option>' +
                            '<option value="20"' + (wordsPerSession === 20 ? ' selected' : '') + '>20ä¸ª</option>' +
                            '<option value="30"' + (wordsPerSession === 30 ? ' selected' : '') + '>30ä¸ª</option>' +
                            '<option value="50"' + (wordsPerSession === 50 ? ' selected' : '') + '>50ä¸ª</option>' +
                            '<option value="100"' + (wordsPerSession === 100 ? ' selected' : '') + '>100ä¸ª</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="setting-item">' +
                        '<span class="setting-label"><span class="setting-icon">â—ˆ</span> å­¦ä¹ æ¬¡æ•°</span>' +
                        '<select id="learningTimesSelect" onchange="changeLearningTimes(this.value)" class="setting-select">' +
                            '<option value="1"' + (requiredLearningTimes === 1 ? ' selected' : '') + '>1æ¬¡</option>' +
                            '<option value="2"' + (requiredLearningTimes === 2 ? ' selected' : '') + '>2æ¬¡</option>' +
                            '<option value="3"' + (requiredLearningTimes === 3 ? ' selected' : '') + '>3æ¬¡</option>' +
                            '<option value="4"' + (requiredLearningTimes === 4 ? ' selected' : '') + '>4æ¬¡</option>' +
                            '<option value="5"' + (requiredLearningTimes === 5 ? ' selected' : '') + '>5æ¬¡</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="settings-tip"><span class="tip-icon">âœ§</span> æ¯ä¸ªå•è¯å­¦ä¹  <strong id="timesDisplay">' + requiredLearningTimes + '</strong> æ¬¡åæ‰ç®—æŒæ¡</div>';
            modalHeader.after(settingsDiv);
            
            // æ·»åŠ æ ·å¼
            addVocabSettingsStyles();
        }
    }
}

// æ·»åŠ è®¾ç½®é¢æ¿æ ·å¼
function addVocabSettingsStyles() {
    if (document.getElementById('vocabSettingsStyles')) return;
    
    var style = document.createElement('style');
    style.id = 'vocabSettingsStyles';
    style.textContent = `
        .vocab-settings-panel {
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8f7ff 0%, #e0e7ff 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-label {
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .setting-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        
        .tip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .setting-select {
            padding: 8px 14px;
            border-radius: 10px;
            border: 2px solid #6366f1;
            background: white;
            color: #1e1b4b;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .setting-select:hover {
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        .setting-select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .settings-tip {
            color: #6b7280;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .settings-tip strong {
            color: #6366f1;
            font-weight: 700;
        }
        
        /* å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨ */
        .learning-progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border-radius: 12px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .progress-dot.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        .progress-dot.current {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .progress-label {
            margin-left: 8px;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* è¯å¡ä¼˜åŒ–æ ·å¼ */
        .word-card-enhanced {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .word-main-enhanced {
            font-size: 42px;
            font-weight: 800;
            color: #1e1b4b;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .word-phonetic-enhanced {
            font-size: 18px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* è¯„åˆ†æŒ‰é’®ä¼˜åŒ– */
        .rate-btn-enhanced {
            flex: 1;
            padding: 16px 12px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .rate-btn-enhanced.hard {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 2px solid #fecaca;
        }
        
        .rate-btn-enhanced.hard:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
        }
        
        .rate-btn-enhanced.medium {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #d97706;
            border: 2px solid #fde68a;
        }
        
        .rate-btn-enhanced.medium:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.2);
        }
        
        .rate-btn-enhanced.easy {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
            border: 2px solid #a7f3d0;
        }
        
        .rate-btn-enhanced.easy:hover {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.2);
        }
        
        .rate-emoji {
            font-size: 24px;
        }
        
        .rate-text {
            font-size: 14px;
        }
        
        .rate-hint {
            font-size: 11px;
            opacity: 0.7;
            font-weight: 500;
        }
        
        /* å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç«  */
        .learning-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .learning-badge.new {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #fcd34d;
        }
        
        .learning-badge.new .badge-icon {
            font-size: 14px;
            animation: sparkle 1.5s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .learning-badge.learning {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 2px solid #a5b4fc;
        }
        
        .learning-badge.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #6ee7b7;
        }
        
        .learning-badge.completed .badge-icon {
            font-size: 14px;
            animation: checkBounce 0.5s ease;
        }
        
        @keyframes checkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .badge-count {
            font-size: 16px;
            font-weight: 800;
            color: #4f46e5;
        }
        
        .badge-separator {
            font-size: 12px;
            color: #9ca3af;
            margin: 0 1px;
        }
        
        .badge-total {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .badge-text {
            font-size: 12px;
            margin-left: 2px;
        }
        
        /* Toast åŠ¨ç”» */
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    `;
    document.head.appendChild(style);
}

// ä¿®æ”¹å­¦ä¹ æ¬¡æ•°è®¾ç½®
function changeLearningTimes(value) {
    requiredLearningTimes = parseInt(value);
    localStorage.setItem('requiredLearningTimes', requiredLearningTimes.toString());
    
    var timesDisplay = document.getElementById('timesDisplay');
    if (timesDisplay) {
        timesDisplay.textContent = requiredLearningTimes;
    }
    
    // ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šå­¦ä¹ æ¬¡æ•°æ›´æ–°åè‡ªåŠ¨åˆ·æ–° ======
    // é‡æ–°è®¡ç®—æ‰€æœ‰å•è¯çš„å®ŒæˆçŠ¶æ€
    sessionWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        if (progress) {
            // æ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼Œé‡æ–°åˆ¤æ–­æ˜¯å¦å®Œæˆ
            progress.completed = progress.times >= requiredLearningTimes;
        }
    });
    
    // é‡æ–°æ„å»ºå­¦ä¹ é˜Ÿåˆ—ï¼ˆæ ¹æ®æ–°çš„å­¦ä¹ æ¬¡æ•°è¦æ±‚ï¼‰
    buildLearningQueue();
    
    // å¦‚æœå½“å‰é˜Ÿåˆ—ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®
    if (currentQueueIndex >= learningQueue.length) {
        currentQueueIndex = Math.max(0, learningQueue.length - 1);
    }
    
    // åˆ·æ–°è¿›åº¦æ˜¾ç¤º
    updateVocabProgress();
    
    // æ›´æ–°å½“å‰å•è¯çš„è¿›åº¦æ˜¾ç¤º
    updateLearningProgressIndicator();
    
    // æ›´æ–°å­¦ä¹ å¾½ç« 
    updateLearningBadge();
    
    // æ˜¾ç¤ºè®¾ç½®æ›´æ–°æç¤º
    showSettingsUpdateToast('å­¦ä¹ æ¬¡æ•°å·²æ›´æ–°ä¸º ' + requiredLearningTimes + ' æ¬¡');
    
    // è§¦å‘è®¾ç½®æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularySettingsUpdated', {
            detail: {
                setting: 'learningTimes',
                value: requiredLearningTimes,
                queueLength: learningQueue.length
            }
        }));
    } catch(e) {}
}

// åˆå§‹åŒ–æœ¬æ¬¡å­¦ä¹ çš„å•è¯
function initSessionWords() {
    currentWordIndex = 0;
    currentQueueIndex = 0;
    sessionWords = [];
    learningQueue = [];
    sessionWordProgress = {}; // é‡ç½®æœ¬è½®å­¦ä¹ è¿›åº¦
    
    if (!window.vocabularyData || window.vocabularyData.length === 0) return;
    
    // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å•è¯
    var allIndices = [];
    for (var i = 0; i < window.vocabularyData.length; i++) {
        allIndices.push(i);
    }
    
    // æ‰“ä¹±é¡ºåº
    for (var j = allIndices.length - 1; j > 0; j--) {
        var k = Math.floor(Math.random() * (j + 1));
        var temp = allIndices[j];
        allIndices[j] = allIndices[k];
        allIndices[k] = temp;
    }
    
    // å–å‰Nä¸ª
    var count = Math.min(wordsPerSession, allIndices.length);
    for (var m = 0; m < count; m++) {
        var wordData = window.vocabularyData[allIndices[m]];
        sessionWords.push(wordData);
        // åˆå§‹åŒ–æœ¬è½®å­¦ä¹ è¿›åº¦
        sessionWordProgress[wordData.word] = {
            times: 0,           // æœ¬è½®å·²å­¦ä¹ æ¬¡æ•°
            completed: false,   // æœ¬è½®æ˜¯å¦å®Œæˆ
            lastIndex: -1       // ä¸Šæ¬¡å‡ºç°çš„ä½ç½®
        };
    }
    
    // æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
    buildLearningQueue();
}

// æ„å»ºé—´éš”é‡å¤çš„å­¦ä¹ é˜Ÿåˆ—
function buildLearningQueue() {
    learningQueue = [];
    
    // è·å–æ‰€æœ‰æœªå®Œæˆçš„å•è¯
    var pendingWords = sessionWords.filter(function(w) {
        return !sessionWordProgress[w.word].completed;
    });
    
    if (pendingWords.length === 0) return;
    
    // è®¡ç®—æ¯ä¸ªå•è¯è¿˜éœ€è¦å­¦ä¹ çš„æ¬¡æ•°
    var wordsNeedReview = [];
    pendingWords.forEach(function(wordData) {
        var progress = sessionWordProgress[wordData.word];
        var remaining = requiredLearningTimes - progress.times;
        for (var i = 0; i < remaining; i++) {
            wordsNeedReview.push({
                wordData: wordData,
                reviewRound: progress.times + i + 1
            });
        }
    });
    
    // æŒ‰ç…§é—´éš”é‡å¤çš„åŸåˆ™é‡æ–°æ’åˆ—
    // ç­–ç•¥ï¼šå…ˆå­¦æ–°è¯ï¼Œç„¶åç©¿æ’å¤ä¹ 
    var newWords = wordsNeedReview.filter(function(w) { return w.reviewRound === 1; });
    var reviewWords = wordsNeedReview.filter(function(w) { return w.reviewRound > 1; });
    
    // æ‰“ä¹±æ–°è¯é¡ºåº
    shuffleArray(newWords);
    
    // æ„å»ºé˜Ÿåˆ—ï¼šæ¯å­¦ä¹ 2-3ä¸ªæ–°è¯åï¼Œæ’å…¥éœ€è¦å¤ä¹ çš„è¯
    var result = [];
    var newWordIndex = 0;
    var reviewWordIndex = 0;
    var wordsSinceLastReview = {};
    var minGap = 3; // åŒä¸€ä¸ªå•è¯è‡³å°‘é—´éš”3ä¸ªä½ç½®å†å‡ºç°
    
    while (newWordIndex < newWords.length || reviewWordIndex < reviewWords.length) {
        // ä¼˜å…ˆæ·»åŠ æ–°è¯
        var addedNewWord = false;
        if (newWordIndex < newWords.length) {
            var newWord = newWords[newWordIndex];
            result.push(newWord.wordData);
            wordsSinceLastReview[newWord.wordData.word] = 0;
            newWordIndex++;
            addedNewWord = true;
        }
        
        // æ›´æ–°æ‰€æœ‰å•è¯çš„é—´éš”è®¡æ•°
        Object.keys(wordsSinceLastReview).forEach(function(w) {
            wordsSinceLastReview[w]++;
        });
        
        // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼ˆé—´éš”è¶³å¤Ÿï¼‰
        if (reviewWordIndex < reviewWords.length && result.length >= minGap) {
            // æ‰¾åˆ°ä¸€ä¸ªé—´éš”è¶³å¤Ÿçš„å¤ä¹ å•è¯
            for (var i = reviewWordIndex; i < reviewWords.length; i++) {
                var reviewWord = reviewWords[i];
                var gap = wordsSinceLastReview[reviewWord.wordData.word] || 999;
                
                if (gap >= minGap) {
                    // å¯ä»¥æ’å…¥è¿™ä¸ªå¤ä¹ å•è¯
                    result.push(reviewWord.wordData);
                    wordsSinceLastReview[reviewWord.wordData.word] = 0;
                    
                    // ä»å¤ä¹ åˆ—è¡¨ä¸­ç§»é™¤
                    reviewWords.splice(i, 1);
                    
                    // æ›´æ–°é—´éš”è®¡æ•°
                    Object.keys(wordsSinceLastReview).forEach(function(w) {
                        wordsSinceLastReview[w]++;
                    });
                    break;
                }
            }
        }
        
        // å¦‚æœæ²¡æœ‰æ–°è¯å¯åŠ ï¼Œç»§ç»­æ·»åŠ å¤ä¹ è¯
        if (!addedNewWord && reviewWordIndex < reviewWords.length) {
            var nextReview = reviewWords[0];
            var nextGap = wordsSinceLastReview[nextReview.wordData.word] || 999;
            
            if (nextGap >= minGap) {
                result.push(nextReview.wordData);
                wordsSinceLastReview[nextReview.wordData.word] = 0;
                reviewWords.shift();
            } else {
                // é—´éš”ä¸å¤Ÿï¼Œæ·»åŠ å ä½æˆ–è·³è¿‡
                // æ‰¾å…¶ä»–å¯ä»¥å¤ä¹ çš„è¯
                var foundAlternative = false;
                for (var j = 1; j < reviewWords.length; j++) {
                    var altWord = reviewWords[j];
                    var altGap = wordsSinceLastReview[altWord.wordData.word] || 999;
                    if (altGap >= minGap) {
                        result.push(altWord.wordData);
                        wordsSinceLastReview[altWord.wordData.word] = 0;
                        reviewWords.splice(j, 1);
                        foundAlternative = true;
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°æ›¿ä»£ï¼Œå¼ºåˆ¶æ·»åŠ ï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
                if (!foundAlternative) {
                    result.push(nextReview.wordData);
                    wordsSinceLastReview[nextReview.wordData.word] = 0;
                    reviewWords.shift();
                }
            }
            
            Object.keys(wordsSinceLastReview).forEach(function(w) {
                wordsSinceLastReview[w]++;
            });
        }
    }
    
    learningQueue = result;
}

// æ•°ç»„éšæœºæ‰“ä¹±
function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

// ä¿®æ”¹æ¯æ¬¡å­¦ä¹ å•è¯æ•°
function changeWordsPerSession(value) {
    wordsPerSession = parseInt(value);
    localStorage.setItem('wordsPerSession', wordsPerSession.toString());
    
    // è‡ªåŠ¨åˆ·æ–°ï¼Œé‡æ–°å¼€å§‹å­¦ä¹ 
    initSessionWords();
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    updateVocabProgress();
    showCurrentWord();
}

function updateVocabProgress() {
    var progress = document.getElementById('vocabProgress');
    if (progress) {
        // æ˜¾ç¤ºé˜Ÿåˆ—è¿›åº¦å’Œå•è¯å®Œæˆæ•°
        var completedCount = 0;
        sessionWords.forEach(function(w) {
            if (sessionWordProgress[w.word] && sessionWordProgress[w.word].completed) {
                completedCount++;
            }
        });
        progress.textContent = (currentQueueIndex + 1) + '/' + learningQueue.length + ' (å·²æŒæ¡: ' + completedCount + '/' + sessionWords.length + ')';
    }
}

function showCurrentWord() {
    if (!learningQueue || learningQueue.length === 0) {
        initSessionWords();
    }
    if (!learningQueue || learningQueue.length === 0) return;
    
    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰å­¦ä¹ 
    if (currentQueueIndex >= learningQueue.length) {
        showSessionSummary();
        return;
    }
    
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    document.getElementById('wordMain').textContent = wordData.word;
    document.getElementById('wordPhonetic').textContent = wordData.phonetic || '';
    
    // éšè—é‡Šä¹‰åŒºåŸŸ
    document.getElementById('wordMeaning').classList.add('hidden');
    document.getElementById('rateButtons').classList.add('hidden');
    document.getElementById('showMeaningBtn').classList.remove('hidden');
    
    updateVocabProgress();
    
    // æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
    updateLearningBadge();
    
    // æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
    updateLearningProgressIndicator();
    
    // è‡ªåŠ¨æœ—è¯»æ–°å•è¯
    speakWord();
}

// æ›´æ–°å³ä¸Šè§’å­¦ä¹ æ¬¡æ•°å¾½ç« 
function updateLearningBadge() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºå¾½ç« å®¹å™¨
    var badge = document.getElementById('learningBadge');
    if (!badge) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            // ç¡®ä¿ wordCard æ˜¯ç›¸å¯¹å®šä½
            wordCard.style.position = 'relative';
            
            badge = document.createElement('div');
            badge.id = 'learningBadge';
            badge.className = 'learning-badge';
            wordCard.insertBefore(badge, wordCard.firstChild);
        }
    }
    
    if (badge) {
        if (progress.completed) {
            badge.className = 'learning-badge completed';
            badge.innerHTML = '<span class="badge-icon">âœ“</span><span class="badge-text">å·²æŒæ¡</span>';
        } else {
            var remaining = requiredLearningTimes - currentTimes;
            badge.className = 'learning-badge';
            if (currentTimes === 0) {
                badge.classList.add('new');
                badge.innerHTML = '<span class="badge-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg></span><span class="badge-text">æ–°è¯</span>';
            } else {
                badge.classList.add('learning');
                badge.innerHTML = '<span class="badge-count">' + currentTimes + '</span><span class="badge-separator">/</span><span class="badge-total">' + requiredLearningTimes + '</span><span class="badge-text" style="margin-left:4px;">å¤ä¹ ä¸­</span>';
            }
        }
    }
}

// æ›´æ–°å­¦ä¹ è¿›åº¦æŒ‡ç¤ºå™¨
function updateLearningProgressIndicator() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    var progress = sessionWordProgress[word] || { times: 0, completed: false };
    var currentTimes = progress.times;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºè¿›åº¦æŒ‡ç¤ºå™¨å®¹å™¨
    var indicatorContainer = document.getElementById('learningProgressIndicator');
    if (!indicatorContainer) {
        var wordCard = document.getElementById('wordCard');
        if (wordCard) {
            indicatorContainer = document.createElement('div');
            indicatorContainer.id = 'learningProgressIndicator';
            indicatorContainer.className = 'learning-progress-indicator';
            wordCard.appendChild(indicatorContainer);
        }
    }
    
    if (indicatorContainer) {
        var dotsHtml = '';
        for (var i = 0; i < requiredLearningTimes; i++) {
            var dotClass = 'progress-dot';
            if (i < currentTimes) {
                dotClass += ' completed';
            } else if (i === currentTimes) {
                dotClass += ' current';
            }
            dotsHtml += '<div class="' + dotClass + '"></div>';
        }
        
        var statusText = '';
        if (progress.completed) {
            statusText = '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#10b981" stroke-width="2.5" style="vertical-align:middle;margin-right:4px;"><polyline points="20 6 9 17 4 12"/></svg>å·²æŒæ¡';
        } else {
            statusText = 'ç¬¬ ' + (currentTimes + 1) + '/' + requiredLearningTimes + ' æ¬¡å­¦ä¹ ';
        }
        
        indicatorContainer.innerHTML = dotsHtml + '<span class="progress-label">' + statusText + '</span>';
    }
}

function showMeaning() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    // æŸ¥è¯¢å­—å…¸æ•°æ®
    var dictData = null;
    if (typeof queryDictionary === 'function') {
        dictData = queryDictionary(wordData.word);
    }
    
    // æ„å»ºé‡Šä¹‰HTMLï¼ˆä¸­è‹±æ–‡åŒè¯­ï¼‰
    var meaningHtml = '';
    
    // å¦‚æœæœ‰å­—å…¸æ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤º
    if (dictData) {
        meaningHtml += '<div class="dict-container" style="background:linear-gradient(135deg,#f8f7ff 0%,#eef2ff 100%);padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.1);">';
        if (dictData.definitions && dictData.definitions.length > 0) {
            meaningHtml += '<div style="font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;"><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);border-radius:6px;box-shadow:0 2px 6px rgba(99,102,241,0.3);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span style="color:#4338ca;">è¯å…¸é‡Šä¹‰</span></div>';
            dictData.definitions.slice(0, 3).forEach(function(def, idx) {
                meaningHtml += '<div style="margin-bottom:6px;font-size:14px;color:#555;">â€¢ ' + def + '</div>';
            });
        }
        meaningHtml += '</div>';
    }
    
    meaningHtml += '<div class="meaning-cn" style="font-size:20px;color:#1e1b4b;margin-bottom:12px;font-weight:700;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:26px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:8px;box-shadow:0 2px 6px rgba(16,185,129,0.3);flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span><span>' + (wordData.meaningCn || 'æš‚æ— ä¸­æ–‡é‡Šä¹‰') + '</span></div>';
    meaningHtml += '<div class="meaning-en" style="color:#4b5563;font-size:15px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:7px;box-shadow:0 2px 6px rgba(59,130,246,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span><span>' + (wordData.meaningEn || wordData.meaning || '') + '</span></div>';
    
    if (wordData.example) {
        meaningHtml += '<div class="word-example" style="color:#6b7280;font-size:14px;font-style:italic;padding-top:16px;border-top:1px solid #e5e7eb;display:flex;align-items:flex-start;gap:10px;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:7px;box-shadow:0 2px 6px rgba(245,158,11,0.3);flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>' + wordData.example + '</span></div>';
    }
    
    document.getElementById('meaningCn').innerHTML = meaningHtml;
    document.getElementById('meaningEn').innerHTML = '';
    document.getElementById('wordExample').innerHTML = '';
    
    document.getElementById('wordMeaning').classList.remove('hidden');
    document.getElementById('showMeaningBtn').classList.add('hidden');
    document.getElementById('rateButtons').classList.remove('hidden');
    
    // V3: æ›´æ–°å¤ä¹ é—´éš”æ˜¾ç¤º
    updateIntervalDisplay();
}

// ==================== V1-V10: Ankié£æ ¼æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ ====================

// V2: æ™ºèƒ½å³æ—¶å¤ä¹ é˜Ÿåˆ—ç®¡ç†å™¨
var immediateReviewQueue = []; // å³æ—¶å¤ä¹ é˜Ÿåˆ—ï¼ˆå›°éš¾/é‡å­¦çš„å•è¯ï¼‰
var hardWordsInSession = []; // æœ¬è½®æ ‡è®°ä¸ºå›°éš¾çš„å•è¯

// V3: è®¡ç®—å¹¶æ˜¾ç¤ºå¤ä¹ é—´éš”
function calculateReviewInterval(word, rating) {
    var wordProgress = wordLearningProgress[word] || {};
    var easeFactor = wordProgress.easeFactor || 2.5;
    var currentInterval = wordProgress.interval || 0;
    var repetitions = wordProgress.repetitions || 0;
    
    var interval = 0;
    var nextEaseFactor = easeFactor;
    
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³å¤ä¹ 
            interval = 0; // ç«‹å³ï¼ˆ<1åˆ†é’Ÿï¼‰
            nextEaseFactor = Math.max(1.3, easeFactor - 0.2);
            break;
        case 'hard': // å›°éš¾ - 1å¤©å
            interval = Math.max(1, Math.round(currentInterval * 1.2));
            nextEaseFactor = Math.max(1.3, easeFactor - 0.15);
            break;
        case 'good': // è‰¯å¥½ - æ­£å¸¸é—´éš”
            if (repetitions === 0) {
                interval = 1;
            } else if (repetitions === 1) {
                interval = 3;
            } else {
                interval = Math.round(currentInterval * easeFactor);
            }
            break;
        case 'easy': // ç®€å• - å»¶é•¿é—´éš”
            if (repetitions === 0) {
                interval = 4;
            } else {
                interval = Math.round(currentInterval * easeFactor * 1.3);
            }
            nextEaseFactor = Math.min(2.5, easeFactor + 0.15);
            break;
    }
    
    return {
        interval: interval,
        easeFactor: nextEaseFactor,
        displayText: formatInterval(interval)
    };
}

// æ ¼å¼åŒ–é—´éš”æ—¶é—´æ˜¾ç¤º
function formatInterval(days) {
    if (days === 0) return '<1åˆ†é’Ÿ';
    if (days === 1) return '1å¤©';
    if (days < 7) return days + 'å¤©';
    if (days < 30) return Math.round(days / 7) + 'å‘¨';
    if (days < 365) return Math.round(days / 30) + 'æœˆ';
    return Math.round(days / 365) + 'å¹´';
}

// V3: æ›´æ–°é—´éš”æ˜¾ç¤º
function updateIntervalDisplay() {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // è®¡ç®—å„è¯„åˆ†å¯¹åº”çš„é—´éš”
    var intervals = {
        again: calculateReviewInterval(word, 'again'),
        hard: calculateReviewInterval(word, 'hard'),
        good: calculateReviewInterval(word, 'good'),
        easy: calculateReviewInterval(word, 'easy')
    };
    
    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    var againInterval = document.getElementById('againInterval');
    var hardInterval = document.getElementById('hardInterval');
    var goodInterval = document.getElementById('goodInterval');
    var easyInterval = document.getElementById('easyInterval');
    
    if (againInterval) againInterval.textContent = intervals.again.displayText;
    if (hardInterval) hardInterval.textContent = intervals.hard.displayText;
    if (goodInterval) goodInterval.textContent = intervals.good.displayText;
    if (easyInterval) easyInterval.textContent = intervals.easy.displayText;
}

// V1 & V2 & V4: é‡å†™è¯„åˆ†å‡½æ•° - Ankié£æ ¼æ™ºèƒ½å¤ä¹ 
function rateWord(rating) {
    var wordData = learningQueue[currentQueueIndex];
    if (!wordData) return;
    
    var word = wordData.word;
    
    // æ›´æ–°æœ¬è½®å­¦ä¹ è¿›åº¦
    var sessionProgress = sessionWordProgress[word] || { times: 0, completed: false };
    
    // V2: æ ¹æ®è¯„åˆ†å¤„ç†å³æ—¶å¤ä¹ é˜Ÿåˆ—
    switch(rating) {
        case 'again': // é‡å­¦ - ç«‹å³åŠ å…¥å³æ—¶å¤ä¹ é˜Ÿåˆ—
            // ä¸å¢åŠ å­¦ä¹ æ¬¡æ•°
            addToImmediateReview(wordData, 1); // 1ä¸ªå•è¯åç«‹å³å¤ä¹ 
            showRatingFeedback('again', 'é©¬ä¸Šå†æ¥ä¸€æ¬¡ï¼ğŸ’ª');
            break;
            
        case 'hard': // å›°éš¾ - ç¨ååœ¨æœ¬ç»„å†…å¤ä¹ 
            // å¢åŠ å­¦ä¹ æ¬¡æ•°ä½†æ ‡è®°ä¸ºå›°éš¾
            sessionProgress.times++;
            if (hardWordsInSession.indexOf(word) === -1) {
                hardWordsInSession.push(word);
            }
            addToImmediateReview(wordData, 3); // 3ä¸ªå•è¯åå¤ä¹ 
            showRatingFeedback('hard', 'ç¨åå†å¤ä¹  ğŸ“');
            break;
            
        case 'good': // è‰¯å¥½ - æ­£å¸¸è¿›åº¦
            sessionProgress.times++;
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var hardIndex = hardWordsInSession.indexOf(word);
            if (hardIndex > -1) hardWordsInSession.splice(hardIndex, 1);
            showRatingFeedback('good', 'ç»§ç»­ä¿æŒï¼âœ“');
            break;
            
        case 'easy': // ç®€å• - åŠ é€ŸæŒæ¡
            sessionProgress.times += 2; // ç®€å•ç›´æ¥+2æ¬¡è¿›åº¦
            sessionProgress.lastIndex = currentQueueIndex;
            // ä»å›°éš¾åˆ—è¡¨ç§»é™¤
            var easyHardIndex = hardWordsInSession.indexOf(word);
            if (easyHardIndex > -1) hardWordsInSession.splice(easyHardIndex, 1);
            showRatingFeedback('easy', 'å¤ªæ£’äº†ï¼ğŸ‰');
            break;
            
        // å…¼å®¹æ—§ç‰ˆè¯„åˆ†
        case 'medium':
            rating = 'good';
            sessionProgress.times++;
            break;
    }
    
    // åˆ¤æ–­æœ¬è½®æ˜¯å¦å®Œæˆ
    if (sessionProgress.times >= requiredLearningTimes) {
        sessionProgress.completed = true;
        showCompletionToast(word);
        
        // æ›´æ–°å…¨å±€å­¦ä¹ è¿›åº¦ (V4: SM-2ç®—æ³•)
        var intervalData = calculateReviewInterval(word, rating);
        var globalProgress = wordLearningProgress[word] || { 
            times: 0, 
            completed: false, 
            ratings: [],
            easeFactor: 2.5,
            interval: 0,
            repetitions: 0
        };
        
        globalProgress.times = sessionProgress.times;
        globalProgress.completed = true;
        globalProgress.ratings.push(rating);
        globalProgress.lastReview = new Date().toISOString();
        globalProgress.easeFactor = intervalData.easeFactor;
        globalProgress.interval = intervalData.interval;
        globalProgress.repetitions = (globalProgress.repetitions || 0) + 1;
        
        // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        var nextReview = new Date();
        nextReview.setDate(nextReview.getDate() + intervalData.interval);
        globalProgress.nextReview = nextReview.toISOString();
        
        wordLearningProgress[word] = globalProgress;
        localStorage.setItem('wordLearningProgress', JSON.stringify(wordLearningProgress));
        
        // è®°å½•ä¸ºå·²å­¦
        if (learnedWords.indexOf(word) === -1) {
            learnedWords.push(word);
            localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
            localStorage.setItem('learnedCount', learnedWords.length.toString());
            
            // æ›´æ–°ä»Šæ—¥ç›®æ ‡è¿›åº¦
            if (typeof updateDailyProgress === 'function') {
                updateDailyProgress('vocabulary', 1);
            }
            
            // v3.5.0: è§¦å‘æˆå°±æ£€æŸ¥
            if (window.UX && window.UX.Achievements) {
                window.UX.Achievements.checkWordCount(learnedWords.length);
                if (learnedWords.length % 10 === 0) {
                    const msg = window.UX.EncouragementSystem.getRandom('milestone');
                    window.UX.showSmartToast(msg, 'achievement');
                } else if (Math.random() < 0.3) {
                    const msg = window.UX.EncouragementSystem.getRandom('progress');
                    window.UX.showSmartToast(msg, 'success');
                }
                window.UX.LevelSystem.checkLevelUp();
            }
        }
        
        // å¦‚æœè¯„åˆ†ä¸ºç®€å•ï¼Œæ ‡è®°ä¸ºå·²æŒæ¡
        if (rating === 'easy') {
            var mastered = parseInt(localStorage.getItem('masteredCount') || '0');
            localStorage.setItem('masteredCount', (mastered + 1).toString());
        }
    }
    
    sessionWordProgress[word] = sessionProgress;
    
    // ä¿å­˜è¯„åˆ†ï¼ˆV4: åŒ…å«SM-2æ•°æ®ï¼‰
    var intervalInfo = calculateReviewInterval(word, rating);
    var prevCount = wordRatings[word] ? wordRatings[word].count : 0;
    wordRatings[word] = {
        rating: rating,
        lastReview: new Date().toISOString(),
        count: prevCount + 1,
        interval: intervalInfo.interval,
        easeFactor: intervalInfo.easeFactor,
        learningProgress: sessionProgress
    };
    localStorage.setItem('wordRatings', JSON.stringify(wordRatings));
    
    // åˆ·æ–°UI
    updateVocabProgress();
    updateLearningBadge();
    updateLearningProgressIndicator();
    
    // V9: æ›´æ–°å­¦ä¹ ç»Ÿè®¡
    updateSessionStats(rating);
    
    // è§¦å‘å…¨å±€å­¦ä¹ è¿›åº¦æ›´æ–°äº‹ä»¶
    try {
        window.dispatchEvent(new CustomEvent('vocabularyProgressUpdated', {
            detail: {
                word: word,
                rating: rating,
                sessionProgress: sessionProgress,
                totalLearned: learnedWords.length,
                interval: intervalInfo.interval
            }
        }));
    } catch(e) {}
    
    // ä¸‹ä¸€ä¸ªè¯
    nextWord();
}

// V2: æ·»åŠ åˆ°å³æ—¶å¤ä¹ é˜Ÿåˆ—
function addToImmediateReview(wordData, gap) {
    var insertIndex = Math.min(currentQueueIndex + gap, learningQueue.length);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„ç›¸è¿‘ä½ç½®
    var alreadyNearby = false;
    for (var i = currentQueueIndex + 1; i < Math.min(currentQueueIndex + gap + 2, learningQueue.length); i++) {
        if (learningQueue[i] && learningQueue[i].word === wordData.word) {
            alreadyNearby = true;
            break;
        }
    }
    
    if (!alreadyNearby) {
        learningQueue.splice(insertIndex, 0, wordData);
        immediateReviewQueue.push({
            word: wordData.word,
            insertedAt: insertIndex,
            timestamp: Date.now()
        });
    }
}

// V5: æ˜¾ç¤ºè¯„åˆ†åé¦ˆï¼ˆå¸¦çŠ¶æ€å¡ç‰‡æ•ˆæœï¼‰
function showRatingFeedback(rating, message) {
    var colors = {
        again: { bg: 'linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)', border: '#fecaca', text: '#dc2626', icon: 'ğŸ”„' },
        hard: { bg: 'linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%)', border: '#fed7aa', text: '#ea580c', icon: 'ğŸ’ª' },
        good: { bg: 'linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)', border: '#bbf7d0', text: '#16a34a', icon: 'âœ“' },
        easy: { bg: 'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)', border: '#bfdbfe', text: '#2563eb', icon: 'ğŸ‰' }
    };
    
    var style = colors[rating] || colors.good;
    
    var feedback = document.createElement('div');
    feedback.className = 'rating-feedback-card';
    feedback.innerHTML = '<span class="feedback-icon">' + style.icon + '</span><span class="feedback-text">' + message + '</span>';
    feedback.style.cssText = 'position:fixed;top:25%;left:50%;transform:translateX(-50%);background:' + style.bg + ';color:' + style.text + ';padding:16px 28px;border-radius:16px;font-size:16px;font-weight:700;z-index:10001;box-shadow:0 10px 40px rgba(0,0,0,0.15);animation:feedbackBounce 0.4s ease;border:2px solid ' + style.border + ';display:flex;align-items:center;gap:10px;';
    document.body.appendChild(feedback);
    
    setTimeout(function() {
        feedback.style.animation = 'feedbackOut 0.3s ease forwards';
        setTimeout(function() {
            if (feedback.parentNode) feedback.parentNode.removeChild(feedback);
        }, 300);
    }, 800);
}

// V9: å­¦ä¹ ç»Ÿè®¡
var sessionStats = {
    again: 0,
    hard: 0,
    good: 0,
    easy: 0,
    startTime: null
};

function updateSessionStats(rating) {
    if (!sessionStats.startTime) {
        sessionStats.startTime = Date.now();
    }
    
    if (sessionStats[rating] !== undefined) {
        sessionStats[rating]++;
    }
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('currentSessionStats', JSON.stringify(sessionStats));
}

function getSessionStats() {
    var duration = sessionStats.startTime ? Math.round((Date.now() - sessionStats.startTime) / 1000) : 0;
    var total = sessionStats.again + sessionStats.hard + sessionStats.good + sessionStats.easy;
    
    return {
        again: sessionStats.again,
        hard: sessionStats.hard,
        good: sessionStats.good,
        easy: sessionStats.easy,
        total: total,
        duration: duration,
        accuracy: total > 0 ? Math.round(((sessionStats.good + sessionStats.easy) / total) * 100) : 0
    };
}

// å°†å•è¯æ·»åŠ åˆ°é˜Ÿåˆ—åé¢ï¼ˆç”¨äºå›°éš¾å•è¯é‡å¤å­¦ä¹ ï¼‰- å…¼å®¹æ—§ç‰ˆ
function addWordToQueueLater(wordData, gap) {
    addToImmediateReview(wordData, gap);
}

// æ˜¾ç¤ºå›°éš¾åé¦ˆ - æ›´æ–°ä¸ºæ–°ç‰ˆ
function showDifficultyFeedback(message) {
    showRatingFeedback('hard', message);
}

// ====== ç‰ˆæœ¬2æ”¹è¿›ï¼šè®¾ç½®æ›´æ–°æç¤º ======
function showSettingsUpdateToast(message) {
    var toast = document.createElement('div');
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:10px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span><span style="font-weight:600;">' + message + '</span>';
    toast.style.cssText = 'position:fixed;top:15%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:white;padding:14px 24px;border-radius:14px;font-size:14px;z-index:10001;box-shadow:0 8px 30px rgba(99,102,241,0.35);animation:toastIn 0.3s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

// æ˜¾ç¤ºå•è¯å®Œæˆæç¤º
function showCompletionToast(word) {
    var toast = document.createElement('div');
    toast.className = 'word-completion-toast';
    toast.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:rgba(255,255,255,0.25);border-radius:50%;margin-right:12px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><div><strong style="font-size:18px;">' + word + '</strong><div style="font-size:13px;opacity:0.9;margin-top:2px;">å­¦ä¹ å®Œæˆï¼ç»§ç»­åŠ æ²¹ âœ“</div></div>';
    toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:20px 32px;border-radius:20px;font-size:16px;font-weight:600;z-index:10001;box-shadow:0 15px 50px rgba(16,185,129,0.45);animation:toastIn 0.4s ease;display:flex;align-items:center;';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.style.animation = 'toastOut 0.3s ease';
        setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }, 1500);
}

function nextWord() {
    currentQueueIndex++;
    
    if (currentQueueIndex < learningQueue.length) {
        showCurrentWord();
    } else {
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å•è¯éƒ½å·²å®Œæˆ
        var allCompleted = true;
        sessionWords.forEach(function(w) {
            if (!sessionWordProgress[w.word] || !sessionWordProgress[w.word].completed) {
                allCompleted = false;
            }
        });
        
        if (allCompleted) {
            // å­¦å®Œæœ¬ç»„ï¼Œæ˜¾ç¤ºæ€»ç»“é¡µé¢
            showSessionSummary();
        } else {
            // è¿˜æœ‰æœªå®Œæˆçš„å•è¯ï¼Œé‡æ–°æ„å»ºé˜Ÿåˆ—
            buildLearningQueue();
            currentQueueIndex = 0;
            if (learningQueue.length > 0) {
                showCurrentWord();
            } else {
                showSessionSummary();
            }
        }
    }
}

// æ˜¾ç¤ºæœ¬è½®å­¦ä¹ æ€»ç»“
function showSessionSummary() {
    var wordCard = document.getElementById('wordCard');
    var rateButtons = document.getElementById('rateButtons');
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    var vocabProgress = document.getElementById('vocabProgress');
    
    if (rateButtons) rateButtons.classList.add('hidden');
    if (showMeaningBtn) showMeaningBtn.classList.add('hidden');
    
    // æ„å»ºæ€»ç»“HTML
    var summaryHtml = '<div style="padding:20px;">';
    summaryHtml += '<div style="text-align:center;margin-bottom:28px;">';
    summaryHtml += '<div style="width:80px;height:80px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 10px 40px rgba(16,185,129,0.35);"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>';
    summaryHtml += '<h2 style="margin:0;color:#1e1b4b;font-size:26px;font-weight:800;">æœ¬è½®å­¦ä¹ å®Œæˆï¼</h2>';
    summaryHtml += '<p style="color:#6b7280;margin-top:10px;font-size:15px;">å…±å­¦ä¹  <span style="color:#6366f1;font-weight:700;">' + sessionWords.length + '</span> ä¸ªå•è¯</p>';
    summaryHtml += '</div>';
    
    summaryHtml += '<div style="max-height:400px;overflow-y:auto;">';
    
    sessionWords.forEach(function(wordData, index) {
        var rating = wordRatings[wordData.word] ? wordRatings[wordData.word].rating : 'medium';
        var ratingIcon = rating === 'easy' 
            ? '<span style="display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:50%;box-shadow:0 2px 8px rgba(16,185,129,0.3);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>'
            : (rating === 'hard' 
                ? '<span style="display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);border-radius:50%;box-shadow:0 2px 8px rgba(239,68,68,0.3);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>'
                : '<span style="display:flex;align-items:center;justify-content:center;width:28px;height:28px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:50%;box-shadow:0 2px 8px rgba(245,158,11,0.3);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"/></svg></span>');
        
        summaryHtml += '<div style="background:linear-gradient(180deg,#ffffff 0%,#f8f9fa 100%);border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.08);box-shadow:0 2px 8px rgba(0,0,0,0.04);">';
        summaryHtml += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">';
        summaryHtml += '<div style="display:flex;align-items:center;gap:12px;">';
        summaryHtml += '<span style="background:linear-gradient(135deg,#6366f1,#a855f7);color:white;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;box-shadow:0 2px 6px rgba(99,102,241,0.3);">' + (index + 1) + '</span>';
        summaryHtml += '<span style="font-size:18px;font-weight:700;color:#1e1b4b;">' + wordData.word + '</span>';
        summaryHtml += '<span style="font-size:12px;color:#9ca3af;background:#f3f4f6;padding:2px 8px;border-radius:6px;">' + (wordData.phonetic || '') + '</span>';
        summaryHtml += '</div>';
        summaryHtml += ratingIcon;
        summaryHtml += '</div>';
        summaryHtml += '<div style="font-size:15px;color:#374151;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:8px;"><span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:5px;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>' + (wordData.meaningCn || '') + '</div>';
        summaryHtml += '<div style="font-size:13px;color:#6b7280;margin-bottom:6px;display:flex;align-items:center;gap:8px;"><span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:5px;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span>' + (wordData.meaningEn || wordData.meaning || '') + '</div>';
        if (wordData.example) {
            summaryHtml += '<div style="font-size:12px;color:#9ca3af;font-style:italic;display:flex;align-items:flex-start;gap:8px;margin-top:8px;padding-top:8px;border-top:1px solid #f3f4f6;"><span style="display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:5px;flex-shrink:0;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>' + wordData.example + '</span></div>';
        }
        summaryHtml += '</div>';
    });
    
    summaryHtml += '</div>';
    
    summaryHtml += '<div style="display:flex;gap:12px;margin-top:24px;">';
    summaryHtml += '<button onclick="restartSession()" style="flex:1;padding:18px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#a855f7 100%);color:white;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(99,102,241,0.35);display:flex;align-items:center;justify-content:center;gap:10px;"><span style="display:flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,0.2);border-radius:50%;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></span>ç»§ç»­å­¦ä¹ </button>';
    summaryHtml += '<button onclick="closeModule()" style="flex:1;padding:18px;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#6366f1;border:2px solid rgba(99,102,241,0.3);border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;"><span style="display:flex;align-items:center;justify-content:center;width:24px;height:24px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);border-radius:50%;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></span>å®Œæˆ</button>';
    summaryHtml += '</div>';
    summaryHtml += '</div>';
    
    if (wordCard) {
        wordCard.innerHTML = summaryHtml;
    }
    
    // æ›´æ–°ç»Ÿè®¡
    var statWords = document.getElementById('stat_words');
    if (statWords) statWords.textContent = learnedWords.length;
}

// é‡æ–°å¼€å§‹å­¦ä¹ 
function restartSession() {
    currentWordIndex = 0;
    
    // æ¢å¤åŸå§‹è¯å¡ç»“æ„ï¼ˆåªæ¢å¤wordCardå†…éƒ¨çš„å†…å®¹ï¼Œä¸åŒ…æ‹¬æŒ‰é’®ï¼‰
    var wordCard = document.getElementById('wordCard');
    if (wordCard) {
        wordCard.innerHTML = '<div class="word-main" id="wordMain">Loading...</div>' +
            '<div class="word-phonetic" id="wordPhonetic">/ËˆlÉ™ÊŠdÉªÅ‹/</div>' +
            '<div class="word-meaning hidden" id="wordMeaning">' +
            '<div id="dictContainer"></div>' +
            '<div class="meaning-cn" id="meaningCn"></div>' +
            '<div class="meaning-en" id="meaningEn"></div>' +
            '<div class="word-example" id="wordExample"></div>' +
            '</div>';
    }
    
    // æ¢å¤"æ˜¾ç¤ºé‡Šä¹‰"æŒ‰é’®
    var showMeaningBtn = document.getElementById('showMeaningBtn');
    if (showMeaningBtn) {
        showMeaningBtn.classList.remove('hidden');
        showMeaningBtn.textContent = 'æ˜¾ç¤ºé‡Šä¹‰';
    }
    
    // éšè—è¯„åˆ†æŒ‰é’®
    var rateButtons = document.getElementById('rateButtons');
    if (rateButtons) rateButtons.classList.add('hidden');
    
    // éšè—é‡Šä¹‰
    var wordMeaning = document.getElementById('wordMeaning');
    if (wordMeaning) wordMeaning.classList.add('hidden');
    
    // é‡æ–°åˆå§‹åŒ–å•è¯
    initSessionWords();
    updateVocabProgress();
    showCurrentWord();
}

function prevWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
    } else {
        currentWordIndex = sessionWords.length - 1;
    }
    showCurrentWord();
}

// é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
var cachedVoices = [];
var preferredVoice = null;

if ('speechSynthesis' in window) {
    cachedVoices = speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = function() {
        cachedVoices = speechSynthesis.getVoices();
        preferredVoice = selectBestUSVoice(cachedVoices);
        console.log('å¯ç”¨è¯­éŸ³:', cachedVoices.map(v => v.name + ' (' + v.lang + ')'));
        console.log('å·²é€‰æ‹©è¯­éŸ³:', preferredVoice ? preferredVoice.name : 'é»˜è®¤');
    };
}

// é€‰æ‹©æœ€ä½³ç¾å¼è‹±è¯­è¯­éŸ³
function selectBestUSVoice(voices) {
    if (!voices || voices.length === 0) return null;
    
    // macOS ä¸Šä¼˜è´¨ç¾å¼è‹±è¯­è¯­éŸ³ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    var preferredNames = [
        // macOS é«˜è´¨é‡ç¾å¼è¯­éŸ³
        'Samantha',           // ç¾å¼å¥³å£° - éå¸¸è‡ªç„¶
        'Alex',               // ç¾å¼ç”·å£° - éå¸¸è‡ªç„¶
        'Allison',            // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Ava',                // ç¾å¼å¥³å£° - å¢å¼ºç‰ˆ
        'Susan',              // ç¾å¼å¥³å£°
        'Tom',                // ç¾å¼ç”·å£°
        'Zoe',                // ç¾å¼å¥³å£°
        // iOS è¯­éŸ³
        'Samantha (Enhanced)',
        'Alex (Enhanced)',
        // Chrome/Edge è¯­éŸ³
        'Google US English',
        'Microsoft Zira',
        'Microsoft David',
    ];
    
    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾
    for (var i = 0; i < preferredNames.length; i++) {
        var voice = voices.find(function(v) {
            return v.name.includes(preferredNames[i]) && 
                   (v.lang === 'en-US' || v.lang.startsWith('en-US'));
        });
        if (voice) return voice;
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ä¼˜å…ˆè¯­éŸ³ï¼ŒæŸ¥æ‰¾ä»»ä½•ç¾å¼è‹±è¯­è¯­éŸ³
    var usVoice = voices.find(function(v) {
        return v.lang === 'en-US' || v.lang.startsWith('en-US');
    });
    if (usVoice) return usVoice;
    
    // æœ€åé™çº§åˆ°ä»»ä½•è‹±è¯­è¯­éŸ³
    return voices.find(function(v) {
        return v.lang.startsWith('en');
    });
}

// ç¾å¼å‘éŸ³ - ä½¿ç”¨æµè§ˆå™¨å†…ç½®TTS
function speakWord() {
    var wordEl = document.getElementById('wordMain');
    var word = wordEl ? wordEl.textContent : '';
    if (!word) return;
    
    speakText(word);
}

// é€šç”¨è¯­éŸ³æ’­æ”¾å‡½æ•°
function speakText(text) {
    if (!('speechSynthesis' in window)) {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
        return;
    }
    
    // å–æ¶ˆæ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    speechSynthesis.cancel();
    
    // åˆ›å»ºè¯­éŸ³å¯¹è±¡
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.85;  // ç¨å¾®æ”¾æ…¢ï¼Œæ›´æ¸…æ™°
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // é€‰æ‹©æœ€ä½³è¯­éŸ³
    var voices = cachedVoices.length > 0 ? cachedVoices : speechSynthesis.getVoices();
    var voice = preferredVoice || selectBestUSVoice(voices);
    
    if (voice) {
        utterance.voice = voice;
        console.log('ä½¿ç”¨è¯­éŸ³:', voice.name);
    }
    
    // æ’­æ”¾
    speechSynthesis.speak(utterance);
}

// ä¿ç•™æ—§å‡½æ•°åå…¼å®¹
function speakWordTTS(word) {
    speakText(word);
}

function setVoiceAndSpeak(utterance, voices) {
    speechSynthesis.speak(utterance);
}

window.initVocabulary = initVocabulary;
window.showMeaning = showMeaning;
window.rateWord = rateWord;
window.speakWord = speakWord;
window.nextWord = nextWord;
window.prevWord = prevWord;
window.changeWordsPerSession = changeWordsPerSession;
window.changeLearningTimes = changeLearningTimes;
window.initSessionWords = initSessionWords;
window.restartSession = restartSession;
window.showSessionSummary = showSessionSummary;
window.updateLearningProgressIndicator = updateLearningProgressIndicator;
window.updateLearningBadge = updateLearningBadge;
