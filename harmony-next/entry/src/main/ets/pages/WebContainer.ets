import web_webview from '@ohos.web.webview';
import hilog from '@ohos.hilog';
import common from '@ohos.app.ability.common';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import vibrator from '@ohos.vibrator';
import promptAction from '@ohos.promptAction';
import deviceInfo from '@ohos.deviceInfo';
import window from '@ohos.window';

/**
 * å­¦æœ¯è‹±è¯­ç²¾è¿› - WebView å®¹å™¨é¡µé¢ v3.0
 * åŠ è½½ PWA Web åº”ç”¨
 * 
 * v1.0 - åŸºç¡€ WebView åŠ è½½
 * v2.0 - æ·»åŠ åŸç”Ÿæ¡¥æ¥ã€éœ‡åŠ¨åé¦ˆã€Toast
 * v3.0 - å®Œæ•´åŸç”ŸåŠŸèƒ½ï¼šé”™è¯¯å¤„ç†ã€å®‰å…¨åŒºåŸŸé€‚é…ã€å¼¹çª—å¤„ç†
 */
@Entry
@Component
struct WebContainer {
  // WebView æ§åˆ¶å™¨
  controller: web_webview.WebviewController = new web_webview.WebviewController();
  
  // Web èµ„æºè·¯å¾„
  @State webSrc: string = 'resource://rawfile/www/index.html';
  
  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = true;
  @State loadProgress: number = 0;
  @State loadError: boolean = false;
  @State errorMessage: string = '';
  
  // æ˜¯å¦å¯ä»¥è¿”å›
  @State canGoBack: boolean = false;
  
  // å®‰å…¨åŒºåŸŸï¼ˆåˆ˜æµ·å±é€‚é…ï¼‰
  @State safeAreaTop: number = 0;
  @State safeAreaBottom: number = 0;
  
  // è¿”å›é”®é˜²æŠ–
  private lastBackTime: number = 0;

  aboutToAppear(): void {
    // åˆå§‹åŒ– WebView è®¾ç½®
    web_webview.WebviewController.setWebDebuggingAccess(true);
    
    // è·å–å®‰å…¨åŒºåŸŸ
    this.getSafeAreaInsets();
    
    // è¯·æ±‚æ‰€éœ€æƒé™
    this.requestPermissions();
  }

  // è·å–å®‰å…¨åŒºåŸŸï¼ˆåˆ˜æµ·å±é€‚é…ï¼‰
  private async getSafeAreaInsets(): Promise<void> {
    try {
      const windowClass = await window.getLastWindow(getContext(this));
      const avoidArea = windowClass.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
      this.safeAreaTop = px2vp(avoidArea.topRect.height);
      this.safeAreaBottom = px2vp(avoidArea.bottomRect.height);
      hilog.info(0x0000, 'AcademicEnglish', 'Safe area: top=%{public}d, bottom=%{public}d', 
        this.safeAreaTop, this.safeAreaBottom);
    } catch (err) {
      hilog.error(0x0000, 'AcademicEnglish', 'Failed to get safe area: %{public}s', JSON.stringify(err));
    }
  }

  // è¯·æ±‚æ‰€éœ€æƒé™
  async requestPermissions(): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const atManager = abilityAccessCtrl.createAtManager();
      
      // è¯·æ±‚å¤šä¸ªæƒé™
      const permissions: Array<string> = [
        'ohos.permission.MICROPHONE',
        'ohos.permission.INTERNET',
        'ohos.permission.VIBRATE'
      ];
      
      const result = await atManager.requestPermissionsFromUser(context, permissions);
      
      hilog.info(0x0000, 'AcademicEnglish', 'Permissions result: %{public}s', 
        JSON.stringify(result));
    } catch (err) {
      hilog.error(0x0000, 'AcademicEnglish', 'Failed to request permissions: %{public}s', 
        JSON.stringify(err));
    }
  }

  // è§¦å‘éœ‡åŠ¨åé¦ˆ
  private triggerVibration(duration: number = 50): void {
    try {
      vibrator.startVibration({
        type: 'time',
        duration: duration
      }, {
        id: 0,
        usage: 'touch'
      });
    } catch (err) {
      hilog.error(0x0000, 'AcademicEnglish', 'Vibration failed: %{public}s', JSON.stringify(err));
    }
  }

  // æ˜¾ç¤º Toast
  private showToast(message: string): void {
    try {
      promptAction.showToast({
        message: message,
        duration: 2000,
        bottom: 100
      });
    } catch (err) {
      hilog.error(0x0000, 'AcademicEnglish', 'Toast failed: %{public}s', JSON.stringify(err));
    }
  }

  build() {
    Column() {
      // çŠ¶æ€æ å ä½ï¼ˆå®‰å…¨åŒºåŸŸé€‚é…ï¼‰
      Row()
        .width('100%')
        .height(this.safeAreaTop)
        .backgroundColor('#667eea')
      
      Stack({ alignContent: Alignment.Top }) {
        // é”™è¯¯é¡µé¢
        if (this.loadError) {
          Column() {
            Text('ğŸ˜')
              .fontSize(60)
              .margin({ bottom: 20 })
            
            Text('é¡µé¢åŠ è½½å¤±è´¥')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 10 })
            
            Text(this.errorMessage || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•')
              .fontSize(14)
              .fontColor('#666')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 30, left: 40, right: 40 })
            
            Button('é‡æ–°åŠ è½½')
              .width(150)
              .height(44)
              .fontSize(16)
              .fontColor(Color.White)
              .backgroundColor('#667eea')
              .borderRadius(22)
              .onClick(() => {
                this.loadError = false;
                this.errorMessage = '';
                this.controller.refresh();
              })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#f5f5f5')
        }
        
        // WebView ä¸»ä½“
        Web({ src: this.webSrc, controller: this.controller })
          .width('100%')
          .height('100%')
          .javaScriptAccess(true)
          .domStorageAccess(true)
          .databaseAccess(true)
          .fileAccess(true)
          .imageAccess(true)
          .mediaPlayGestureAccess(true)
          .mixedMode(MixedMode.All)
          .cacheMode(CacheMode.Default)
          .overviewModeAccess(true)
          .textZoomRatio(100)
          .zoomAccess(false)
          .verticalScrollBarAccess(false)
          .horizontalScrollBarAccess(false)
          .geolocationAccess(true)
          .userAgent('Mozilla/5.0 (HarmonyOS; Phone) AcademicEnglish/1.0')
          // é¡µé¢å¼€å§‹åŠ è½½
          .onPageBegin((event) => {
            this.isLoading = true;
            this.loadProgress = 0;
            this.loadError = false;
            hilog.info(0x0000, 'AcademicEnglish', 'Page begin: %{public}s', event?.url ?? '');
          })
          // é¡µé¢åŠ è½½å®Œæˆ
          .onPageEnd((event) => {
            this.isLoading = false;
            this.loadProgress = 100;
            this.canGoBack = this.controller.accessBackward();
            hilog.info(0x0000, 'AcademicEnglish', 'Page end: %{public}s', event?.url ?? '');
            
            // æ³¨å…¥ HarmonyOS æ¡¥æ¥ä»£ç 
            this.injectBridge();
          })
          // åŠ è½½è¿›åº¦
          .onProgressChange((event) => {
            this.loadProgress = event?.newProgress ?? 0;
          })
          // å¤„ç†æƒé™è¯·æ±‚
          .onPermissionRequest((event) => {
            if (event) {
              event.request.grant(event.request.getAccessibleResource());
              hilog.info(0x0000, 'AcademicEnglish', 'Permission granted');
            }
          })
          // HTTP é”™è¯¯
          .onHttpErrorReceive((event) => {
            const code = event?.response?.getResponseCode() ?? 0;
            if (code >= 400) {
              hilog.error(0x0000, 'AcademicEnglish', 'HTTP Error: %{public}d', code);
            }
          })
          // é”™è¯¯å¤„ç†
          .onErrorReceive((event) => {
            this.loadError = true;
            this.errorMessage = event?.error?.getErrorInfo() ?? 'åŠ è½½å¤±è´¥';
            hilog.error(0x0000, 'AcademicEnglish', 'Error: %{public}s', 
              JSON.stringify(event?.error) ?? '');
          })
          // JS æ§åˆ¶å°æ—¥å¿—
          .onConsole((event) => {
            hilog.info(0x0000, 'AcademicEnglish', 'Console: %{public}s', 
              event?.message?.getMessage() ?? '');
            return false;
          })
          // å¤„ç† Alert å¼¹çª—
          .onAlert((event) => {
            if (event) {
              promptAction.showDialog({
                title: 'æç¤º',
                message: event.message,
                buttons: [{ text: 'ç¡®å®š', color: '#667eea' }]
              }).then(() => {
                event.result.handleConfirm();
              });
              return true;
            }
            return false;
          })
          // å¤„ç† Confirm å¼¹çª—
          .onConfirm((event) => {
            if (event) {
              promptAction.showDialog({
                title: 'ç¡®è®¤',
                message: event.message,
                buttons: [
                  { text: 'å–æ¶ˆ', color: '#666' },
                  { text: 'ç¡®å®š', color: '#667eea' }
                ]
              }).then((result) => {
                if (result.index === 1) {
                  event.result.handleConfirm();
                } else {
                  event.result.handleCancel();
                }
              });
              return true;
            }
            return false;
          })
        
        // åŠ è½½è¿›åº¦æ¡
        if (this.isLoading && !this.loadError) {
          Column() {
            Progress({ value: this.loadProgress, total: 100, type: ProgressType.Linear })
              .width('100%')
              .height(3)
              .color('#667eea')
              .backgroundColor('#E0E0E0')
          }
          .width('100%')
        }
      }
      .width('100%')
      .layoutWeight(1)
      
      // åº•éƒ¨å®‰å…¨åŒºåŸŸ
      Row()
        .width('100%')
        .height(this.safeAreaBottom)
        .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
  }

  // æ³¨å…¥ HarmonyOS æ¡¥æ¥ä»£ç  v3.0
  private injectBridge(): void {
    // è·å–è®¾å¤‡ä¿¡æ¯
    const deviceType = deviceInfo.deviceType;
    const brand = deviceInfo.brand;
    const model = deviceInfo.productModel;
    const osVersion = deviceInfo.osFullName;
    
    const bridgeScript = `
      (function() {
        // é˜²æ­¢é‡å¤æ³¨å…¥
        if (window.HarmonyOS && window.HarmonyOS.initialized) {
          console.log('[HarmonyOS] Bridge already initialized');
          return;
        }
        
        // HarmonyOS åŸç”Ÿæ¡¥æ¥ v3.0
        window.HarmonyOS = {
          initialized: true,
          isHarmony: true,
          version: '3.0.0',
          
          // è®¾å¤‡ä¿¡æ¯
          deviceInfo: {
            platform: 'HarmonyOS',
            deviceType: '${deviceType}',
            brand: '${brand}',
            model: '${model}',
            osVersion: '${osVersion}',
            safeAreaTop: ${this.safeAreaTop},
            safeAreaBottom: ${this.safeAreaBottom}
          },
          
          // éœ‡åŠ¨åé¦ˆ
          vibrate: function(duration) {
            duration = duration || 50;
            console.log('[HarmonyOS] vibrate:', duration);
          },
          
          // æ˜¾ç¤º Toast
          showToast: function(message) {
            console.log('[HarmonyOS] toast:', message);
          },
          
          // è·å–ç³»ç»Ÿä¿¡æ¯
          getSystemInfo: function() {
            return this.deviceInfo;
          },
          
          // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
          isOnline: function() {
            return navigator.onLine;
          },
          
          // å¤åˆ¶åˆ°å‰ªè´´æ¿
          copyToClipboard: function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(function() {
                window.HarmonyOS.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
              });
            } else {
              var textarea = document.createElement('textarea');
              textarea.value = text;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              window.HarmonyOS.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
          }
        };
        
        // æ ‡è®°ä¸ºåŸç”Ÿ App ç¯å¢ƒ
        window.isNativeApp = true;
        window.isHarmonyOS = true;
        window.nativeAppVersion = '3.0.0';
        
        // æ·»åŠ  CSS å˜é‡é€‚é…å®‰å…¨åŒºåŸŸ
        document.documentElement.style.setProperty('--safe-area-top', '${this.safeAreaTop}px');
        document.documentElement.style.setProperty('--safe-area-bottom', '${this.safeAreaBottom}px');
        
        // ç¦ç”¨é•¿æŒ‰é€‰æ‹©ï¼ˆæå‡ä½“éªŒï¼‰
        document.body.style.webkitUserSelect = 'none';
        document.body.style.userSelect = 'none';
        
        // ç¦ç”¨æ©¡çš®ç­‹æ•ˆæœ
        document.body.style.overscrollBehavior = 'none';
        
        // è§¦å‘å°±ç»ªäº‹ä»¶
        var event = new CustomEvent('harmonyReady', { 
          detail: window.HarmonyOS.deviceInfo 
        });
        window.dispatchEvent(event);
        
        console.log('[HarmonyOS] Bridge v3.0 initialized');
        console.log('[HarmonyOS] Device:', JSON.stringify(window.HarmonyOS.deviceInfo));
      })();
    `;
    
    this.controller.runJavaScript(bridgeScript);
  }

  // å¤„ç†è¿”å›æŒ‰é’®ï¼ˆåŒå‡»é€€å‡ºï¼‰
  onBackPress(): boolean {
    if (this.loadError) {
      return false;
    }
    
    if (this.controller.accessBackward()) {
      this.controller.backward();
      this.triggerVibration(30);
      return true;
    }
    
    // åŒå‡»é€€å‡º
    const now = Date.now();
    if (now - this.lastBackTime < 2000) {
      return false;
    }
    
    this.lastBackTime = now;
    this.showToast('å†æŒ‰ä¸€æ¬¡é€€å‡ºåº”ç”¨');
    return true;
  }
}
